import*as t from"https://js13kgames.com/2025/webxr/three.module.js";(function(){const o=document.createElement("link").relList;if(o&&o.supports&&o.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))e(s);new MutationObserver(s=>{for(const r of s)if(r.type==="childList")for(const _ of r.addedNodes)_.tagName==="LINK"&&_.rel==="modulepreload"&&e(_)}).observe(document,{childList:!0,subtree:!0});function i(s){const r={};return s.integrity&&(r.integrity=s.integrity),s.referrerPolicy&&(r.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?r.credentials="include":s.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function e(s){if(s.ep)return;s.ep=!0;const r=i(s);fetch(s.href,r)}})();const $=()=>[["cube_case1_1_8_2_7.5_4_0_0_0_0_7.5_4_0_#0000ff","cube_case2_3_9_2_5.5_4.5_0_0_0_0_5.5_4.5_0_#0000ff","cube_case3_8_4_2_0_7_0_0_0_0_0_8.5_0_#0000ff","cube_case4_8_1_2_0_2.5_0_0_0_0_0_2.5_0_#0000ff","cube_case5_3_9_2_-5.5_4.5_0_0_0_0_-5.5_4.5_0_#0000ff","cube_case6_1_8_2_-7.5_4_0_0_0_0_-7.5_4_0_#0000ff"],"cube_base_12_2.1_2.4_0_0.95_0_0_0_0_0_0_0_#ff0000","cube_rightReel_2_2_1_2.72_3.89_0_0_0_-45_2.72_3.89_0_#ff7300","cube_rightTape_4_4_0.2_2.81_3.91_-0.1_0_0_-45_2.81_3.91_-0.1_#c300ff","cube_leftReel_2_2_1_-2.69_3.91_0_0_0_-45_-2.75_4_0_#ff7300","sphere_dot_1_1_1_0_4_0_0_0_0_0_4_0_#9999ff","plane_label_12_3_0_0_7_1.01_90_0_0_0_7_1.01_#d3d3d3","cylinder_base_16_8_16_0_-8_0_0_0_0_0_-8_0_#00ff00"],J=()=>[["cube_cube_2_1_1_0_0.5_-0.5_0_0_0_0_0_0_#0000ff","cube_cube_0.4_0.1_0.8_0.7_1.05_-0.5_0_0_0_1.5_1_-0.9_#b0ffb0","cube_cube_1.3_0.1_0.3_-0.25_1.05_-0.75_0_0_0_0.5_1_-0.9_#b0ffb0","cube_cube_0.3_0.1_0.4_-0.75_1.05_-0.3_0_0_0_-0.2_1_-0.4_#b0ffb0","cube_tableA_0.4_0.1_0.4_-0.3_1.05_-0.3_0_0_0_0.5_1_-0.7_#b0ffb0","cube_tableB_0.4_0.1_0.4_0.2_1.05_-0.3_0_0_0_1_1_-0.7_#b0ffb0","cylinder_cylinder_0.30000001192092896_0_0.30000001192092896_0.19999999999999998_1.11_-0.30000000000000004_0_0_0_0.19999999999999998_1.11_-0.30000000000000004_#00ff00","cylinder_cylinder_0.30000001192092896_0_0.30000001192092896_-0.30000000000000004_1.11_-0.30000000000000004_0_0_0_-0.30000000000000004_1.11_-0.30000000000000004_#00ff00"],"cube_cube_22_1_19_0_-2.5_-4.5_0_0_0_0_-3_-4_#ff00ff","cube_cube_12_1_12_0_-1.5_-4_0_0_0_0_-2_-4_#ff0000","cube_cube_8_1_3_0_-0.5_0.5_0_0_0_0_-1_-4_#c300ff","cube_pillar_1_4_1_7.5_0_-2.5_0_0_0_8_0_-3_#fffb00","cube_pillar_1_4_1_7.5_0_-6.5_0_0_0_8_0_-7_#fffb00","cube_pillar_1_4_1_7.5_0_-10.5_0_0_0_8_0_-11_#fffb00","cube_pillar_1_4_1_7.5_0_-10.5_0_0_0_8_0_-11_#fffb00","cube_pillar_1_4_1_-7.5_0_-2.5_0_0_0_-7_0_-3_#fffb00","cube_pillar_1_4_1_-7.5_0_1.5_0_0_0_-7_0_1_#fffb00","cube_pillar_1_4_1_7.5_0_1.5_0_0_0_8_0_1_#fffb00","cube_pillar_1_4_1_-7.5_0_-6.5_0_0_0_-7_0_-7_#fffb00","cube_pillar_1_4_1_-7.5_0_-10.5_0_0_0_-7_0_-11_#fffb00","cube_cube_4_1_16_9_2.5_-6_0_0_0_8_2_0_#00ff00","cube_cube_4_1_16_-9_2.5_-6_0_0_0_-10_2_0_#00ff00"],N={uniforms:{uDirLightPos:{value:new t.Vector3},uDirLightColor:{value:new t.Color(15658734)},uAmbientLightColor:{value:new t.Color(328965)},uBaseColor:{value:new t.Color(16777215)},uLineColor1:{value:new t.Color(0)}},vertexShader:`

		varying vec3 vNormal;

		void main() {

			gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
			vNormal = normalize( normalMatrix * normal );

		}`,fragmentShader:`

		uniform vec3 uBaseColor;
		uniform vec3 uLineColor1;
		uniform vec3 uLineColor2;
		uniform vec3 uLineColor3;
		uniform vec3 uLineColor4;

		uniform vec3 uDirLightPos;
		uniform vec3 uDirLightColor;

		uniform vec3 uAmbientLightColor;

		varying vec3 vNormal;

		void main() {

			float directionalLightWeighting = max( dot( normalize(vNormal), uDirLightPos ), 0.0);
			vec3 lightWeighting = uAmbientLightColor + uDirLightColor * directionalLightWeighting;

			gl_FragColor = vec4( uBaseColor, 1.0 );

			if ( length(lightWeighting) < 1.00 ) {

				if ( ( mod(gl_FragCoord.x, 4.001) + mod(gl_FragCoord.y, 4.0) ) > 6.00 ) {

					gl_FragColor = vec4( uLineColor1, 1.0 );

				}

			}

			if ( length(lightWeighting) < 0.50 ) {

				if ( ( mod(gl_FragCoord.x + 2.0, 4.001) + mod(gl_FragCoord.y + 2.0, 4.0) ) > 6.00 ) {

					gl_FragColor = vec4( uLineColor1, 1.0 );

				}

			}

			#include <colorspace_fragment>

		}`},U=a=>{const o=new t.Group;o.position.set(0,0,0),o.rotation.set(0,0,0),o.scale.set(1,1,1);const i=_=>{const[w,f,n,h,m,d,u,b,c,v,p,C,E,S,I]=_.split("_"),l=new t.BoxGeometry(n,h,m);return l.translate(d-C,u-E,b-S),l.rotateX(t.MathUtils.degToRad(c)),l.rotateY(t.MathUtils.degToRad(v)),l.rotateZ(t.MathUtils.degToRad(p)),l},e=_=>{const[w,f,n,h,m,d,u,b,c,v,p,C,E,S,I]=_.split("_"),l=new t.SphereGeometry(parseFloat(n)/2,32,16);return l.scale(n/n,h/n,m/n),l.translate(d-C,u-E,b-S),l.rotateX(t.MathUtils.degToRad(c)),l.rotateY(t.MathUtils.degToRad(v)),l.rotateZ(t.MathUtils.degToRad(p)),l},s=_=>{const[w,f,n,h,m,d,u,b,c,v,p,C,E,S,I]=_.split("_"),l=new t.PlaneGeometry(n,h);return l.rotateX(t.MathUtils.degToRad(-90)),l.translate(d-C,u-E,b-S),l.rotateX(t.MathUtils.degToRad(c)),l.rotateY(t.MathUtils.degToRad(v)),l.rotateZ(t.MathUtils.degToRad(p)),l},r=_=>{const[w,f,n,h,m,d,u,b,c,v,p,C,E,S,I]=_.split("_"),l=n/2,M=new t.CylinderGeometry(l,l,h,32);return M.translate(d-C,u-E,b-S),M.rotateX(t.MathUtils.degToRad(c)),M.rotateY(t.MathUtils.degToRad(v)),M.rotateZ(t.MathUtils.degToRad(p)),M};return a.forEach(_=>{if(Array.isArray(_))o.add(U(_));else{const[w,f,n,h,m,d,u,b,c,v,p,C,E,S,I]=_.split("_");let l=null;switch(w){case"cube":l=i(_);break;case"sphere":l=e(_);break;case"plane":l=s(_);break;case"cylinder":l=r(_);break;default:throw new Error(`Unknown shape: ${w}`)}let M=null;f.startsWith("case")?M=new t.ShaderMaterial({uniforms:{...N.uniforms},vertexShader:N.vertexShader,fragmentShader:N.fragmentShader}):M=new t.MeshStandardMaterial({color:I,side:t.DoubleSide});const G=new t.Mesh(l,M);G.name=f,G.position.set(C,E,S),o.add(G)}}),o},Y=a=>{const{radius:o,depth:i,color:e}=a,s=new t.CylinderGeometry(o,o,i,32),r=new t.MeshBasicMaterial({color:e});return new t.Mesh(s,r)},Z=a=>{if(a==="cassette"){const o=U($());return o.name="cassette",o}else if(a==="arena"){const o=U(J());return o.name="arena",o}return null},ee="#e81416",te="#ffa500",oe="#faeb36",ne="#79c314",re="#487de7",se="#70369d",ie="#000000",ae="#ff00ff",_e=(a=512)=>{const o=document.createElement("canvas");o.width=a,o.height=a;const i=o.getContext("2d");return[o,i]},V=(a,o,i=!1)=>{let e=0,s=o.findIndex(r=>r===a[0]);for(let r=0;r<a.length&&r<o.length&&a[r]===o[(s+r)%o.length];r++)e++;return e},H=[ee,te,oe,ne,re,se],le=["OFFSIDE","SHOWCASE","LOADOUT","BACKHAND","BOOKMARKS","MANPOWER"],ce=["Shiny Toy Guns","B.B. King","Jack White","Black Sabbath","Faith Hill","Cliff Sheen"],j=[[0,1,2,3,4,5],[0,2,4,1,5,3],[0,3,5,1,4,2]];class de{constructor(){this.reset()}addVinylByIndex(o){this.queue.unshift(o),this.updateComboCount()}updateComboCount(){const[o,i,e]=j;this.comboCount={color:V(this.queue,[...o].reverse(),!0),artist:V(this.queue,[...i].reverse()),title:V(this.queue,[...e].reverse())},this.solvedCombo={color:this.solvedCombo.color||this.comboCount.color===o.length,artist:this.solvedCombo.artist||this.comboCount.artist===i.length,title:this.solvedCombo.title||this.comboCount.title===e.length}}isSolved(o){return this.solvedCombo[o]}reset(){this.queue=[],this.rack=[],this.selected={};const[o,i,e]=j;this.vinyls=H.map((s,r)=>(this.rack.push(r),{index:r,color:H[o[r]],title:le[i[r]],artist:ce[e[r]]})),this.comboCount={color:0,artist:0,title:0},this.solvedCombo={color:!1,artist:!1,title:!1}}}class B{static createButton(o,i={}){const e=document.createElement("button");function s(){let n=null;async function h(u){u.addEventListener("end",m),await o.xr.setSession(u),e.textContent="EXIT VR",n=u}function m(){n.removeEventListener("end",m),e.textContent="ENTER VR",n=null}e.style.display="",e.style.cursor="pointer",e.style.left="calc(50% - 50px)",e.style.width="100px",e.textContent="ENTER VR";const d={...i,optionalFeatures:["local-floor","bounded-floor","layers",...i.optionalFeatures||[]]};e.onmouseenter=function(){e.style.opacity="1.0"},e.onmouseleave=function(){e.style.opacity="0.5"},e.onclick=function(){n===null?navigator.xr.requestSession("immersive-vr",d).then(h):(n.end(),navigator.xr.offerSession!==void 0&&navigator.xr.offerSession("immersive-vr",d).then(h).catch(u=>{console.warn(u)}))},navigator.xr.offerSession!==void 0&&navigator.xr.offerSession("immersive-vr",d).then(h).catch(u=>{console.warn(u)})}function r(){e.style.display="",e.style.cursor="auto",e.style.left="calc(50% - 75px)",e.style.width="150px",e.onmouseenter=null,e.onmouseleave=null,e.onclick=null}function _(){r(),e.textContent="VR NOT SUPPORTED"}function w(n){r(),console.warn("Exception when trying to call xr.isSessionSupported",n),e.textContent="VR NOT ALLOWED"}function f(n){n.style.position="absolute",n.style.bottom="20px",n.style.padding="12px 6px",n.style.border="1px solid #fff",n.style.borderRadius="4px",n.style.background="rgba(0,0,0,0.1)",n.style.color="#fff",n.style.font="normal 13px sans-serif",n.style.textAlign="center",n.style.opacity="0.5",n.style.outline="none",n.style.zIndex="999"}if("xr"in navigator)return e.id="VRButton",e.style.display="none",f(e),navigator.xr.isSessionSupported("immersive-vr").then(function(n){n?s():_(),n&&B.xrSessionIsGranted&&e.click()}).catch(w),e;{const n=document.createElement("a");return window.isSecureContext===!1?(n.href=document.location.href.replace(/^http:/,"https:"),n.innerHTML="WEBXR NEEDS HTTPS"):(n.href="https://immersiveweb.dev/",n.innerHTML="WEBXR NOT AVAILABLE"),n.style.left="calc(50% - 90px)",n.style.width="180px",n.style.textDecoration="none",f(n),n}}static registerSessionGrantedListener(){if(typeof navigator<"u"&&"xr"in navigator){if(/WebXRViewer\//i.test(navigator.userAgent))return;navigator.xr.addEventListener("sessiongranted",()=>{B.xrSessionIsGranted=!0})}}}B.xrSessionIsGranted=!1;B.registerSessionGrantedListener();const x=.0254,q=(a,o)=>{const[e,s]=_e(1024);s.fillStyle=ae,s.fillRect(0,0,e.width,e.height),s.fillStyle=ie,s.font="64px Helvetica",s.scale(1,o),s.textBaseline="top",s.textAlign="left";let r=64;if(a.length>0){const f=s.measureText(a[0]);r=Math.min(64*960/f.width,1024),s.font=`${r}px Helvetica`}a.forEach((f,n)=>{s.fillText(`${f}`,32,32+r*n)});const _=new t.CanvasTexture(e);return new t.MeshBasicMaterial({map:_})},ue=({color:a,title:o,artist:i})=>{const e=new t.Group,s=new t.RingGeometry(4,7,32);s.scale(x,x,x);const r=new t.MeshStandardMaterial({color:a,side:t.DoubleSide});e.add(new t.Mesh(s,r));const _=new t.RingGeometry(.25,4,32);_.scale(x,x,x);const w=new t.MeshStandardMaterial({color:16777215,side:t.DoubleSide});e.add(new t.Mesh(_,w));const f=new t.PlaneGeometry(5,2);f.translate(0,2,.001),f.scale(x,x,x);const n=q([i],5/2);e.add(new t.Mesh(f,n));const h=new t.PlaneGeometry(5,2);h.translate(0,-2,.001),h.scale(x,x,x);const m=q([o],5/2);e.add(new t.Mesh(h,m));const d=e.clone();return d.rotation.set(0,Math.PI,0),d.position.set(0,0,-.002),e.add(d),e};new t.Clock;let T,y,F,g,O,L,R,z,X,P,k;const W=new t.Vector3(0,0,.3),fe=async()=>{document.getElementById("intro").style.display="none";const o=document.getElementById("c");if(!o)return;o.style.display="block";const i=new de;y=new t.Scene,T=new t.PerspectiveCamera(75,window.innerWidth/window.innerHeight,.1,1e3),T.position.set(0,2,1),T.rotation.set(-1*Math.PI/12,0,0);const e=new t.AmbientLight(16777215,.8);y.add(e);const s=new t.DirectionalLight(16777215,.8);s.position.set(6,10,8),s.castShadow=!0,s.target.position.set(0,0,0),y.add(s),y.add(s.target),P=Z("cassette"),P.position.set(0,0,-20),P.userData.isPickable=!0,P.onPointerPick=()=>{console.log("PICK")},P.onPointerMove=()=>{console.log("MOVE")},y.add(P);const r=Z("arena"),_=r.getObjectByName("tableA"),w=r.getObjectByName("tableB");[_,w].forEach(u=>{u.onPointerPick=b=>{const c=i.selected[b.id];c&&(i.addVinylByIndex(c),delete i.selected[b.id]),u.userData.loaded=!0}}),y.add(r),i.vinyls.forEach((u,b)=>{const c=ue(u);c.name=`vinyl-${b}-${u.color}`;const v=new t.Vector3(.7,1.25,-.2-.125*b);c.position.copy(v),c.userData.originalPosition=v,c.userData.isPickable=!0,c.userData.recordIndex=b,c.onPointerPick=p=>{if(p.userData.selected)return;console.log("picked",c,p),i.selected[p.id]=b;const C=p.getObjectByName("target");C&&(C.add(c),c.position.set(0,0,0),p.userData.selected=c)},c.onPointerDrop=p=>{y.add(c),c.position.copy(v),c.setRotationFromQuaternion(new t.Quaternion),p.userData.selected=void 0},y.add(c)}),i.addVinylByIndex(2),console.log(i.comboCount),i.addVinylByIndex(4),console.log(i.comboCount),i.addVinylByIndex(1),console.log(i.comboCount),i.addVinylByIndex(3),console.log(i.comboCount),i.addVinylByIndex(0),console.log(i.comboCount),g=new t.WebGLRenderer({antialias:!0}),g.setPixelRatio(window.devicePixelRatio),g.setSize(window.innerWidth,window.innerHeight),g.setClearColor("#000000"),g.xr.addEventListener("sessionstart",he),g.xr.enabled=!0,g.setAnimationLoop(ge),document.body.appendChild(B.createButton(g)),document.body.appendChild(g.domElement),L=g.xr.getController(0),L.addEventListener("selectstart",D),L.addEventListener("selectend",A),L.addEventListener("squeezestart",D),L.addEventListener("squeezeend",A),y.add(L),R=g.xr.getController(1),R.addEventListener("selectstart",D),R.addEventListener("selectend",A),R.addEventListener("squeezestart",D),R.addEventListener("squeezeend",A),y.add(R),z=g.xr.getControllerGrip(0);const f=Y({radius:.01,depth:.2,color:16711935});f.name="controllerMesh1",f.rotateX(Math.PI/4),z.add(f),y.add(z),X=g.xr.getControllerGrip(1);const n=Y({radius:.01,depth:.2,color:65280});n.rotateX(Math.PI/4),X.add(n),y.add(X);const h=new t.BufferGeometry().setFromPoints([new t.Vector3(0,0,0),new t.Vector3(0,0,-1)]),m=new t.Line(h);m.name="line",m.scale.z=5,L.add(m.clone()),R.add(m.clone());const d=new t.Object3D;d.rotation.set(-1*Math.PI/2,0,0),d.position.set(0,-.05,-.12),d.name="target",L.add(d.clone()),R.add(d.clone()),F=new t.Raycaster,window.addEventListener("resize",me,!1)};function he(){k=g.xr.getReferenceSpace(),console.log(k);const a={x:-1*W.x,y:-1*W.y,z:-1*W.z,w:1},o=new t.Quaternion,i=new XRRigidTransform(a,o),e=k.getOffsetReferenceSpace(i);g.xr.setReferenceSpace(e)}function D(a){console.log("onSelectStart"),O=a.target;const o=Q(O);if(o.length>0){let i=!1;o.forEach(({object:e,distance:s})=>{if(i)return;let r=e;for(;r;){if(r.onPointerPick){r.onPointerPick(O),i=!0;break}r=r.parent}})}O.userData.targetRayMode=a.data.targetRayMode}function A(a){console.log("onSelectEnd"),O=a.target;const o=O.userData.selected;o?.onPointerDrop&&o.onPointerDrop(O)}function Q(a){return a.updateMatrixWorld(),F.setFromXRController(a),F.intersectObjects(y.children,!0)}function K(a){if(a.userData.targetRayMode==="screen"||a.userData.selected!==void 0)return;const o=a.getObjectByName("line"),i=Q(a);if(o.scale.z=5,i.length>0){let e=!1;i.forEach(({object:s,distance:r})=>{if(e)return;let _=s;for(;_;){if(_.userData.isPickable){o.scale.z=r,e=!0;break}_=_.parent}})}}function ge(){P.rotation.y+=.005,K(L),K(R),g.render(y,T)}const me=()=>{T.aspect=window.innerWidth/window.innerHeight,T.updateProjectionMatrix(),g.setSize(window.innerWidth,window.innerHeight)};window.addEventListener("DOMContentLoaded",()=>{const a=document.getElementById("playButton");a.onclick=fe});

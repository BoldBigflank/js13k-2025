import*as e from"https://js13kgames.com/2025/webxr/three.module.js";!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver(e=>{for(const n of e)if("childList"===n.type)for(const e of n.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)}).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();class t{static _instance;callbacks;constructor(){this.callbacks={}}static get Instance(){return t._instance||(t._instance=new t),t._instance}on(e,t){this.callbacks[e]=this.callbacks[e]||[],this.callbacks[e].push(t)}off(e,t){this.callbacks[e]=(this.callbacks[e]||[]).filter(e=>e!==t)}emit(e,...t){(this.callbacks[e]||[]).forEach(e=>e(...t))}_reset(){Object.keys(this.callbacks).forEach(e=>{delete this.callbacks[e]})}getCallbacks(){return this.callbacks}}const n="#e81416",r="#ffa500",o="#faeb36",s="#79c314",a="#487de7",i="#70369d",c="#ffffff",l="#000000",d="#abb7d0",u="#ff3b94",h="#f6ff00",p="#8ea5ff",m="#333333",f={color:n,artist:s,title:a},g=[n,r,o,s,a,i],y=["Shiny Toy Guns","B.B. King","Jack White","Black Sabbath","Faith Hill","Cliff Sheen"],w=["OFFSIDE","SHOWCASE","LOADOUT","BACKHAND","BOOKMARKS","MANPOWER"],b={color:g,artist:y,title:w},v={color:0,artist:24,title:34},M=[[0,1,2,3,4,5],[0,2,4,1,5,3],[0,3,5,1,4,2]],x=["color","artist","title"];class C{queue;selected;vinyls;progress;constructor(){this.queue=[],this.selected={},this.vinyls=[],this.reset(),this.progress.bestComboType="color"}addVinylByIndex(e){if(this.queue[0]===e)return;const{color:n,artist:r,title:o}=this.vinyls[e],s=g.indexOf(n),a=y.indexOf(r),i=w.indexOf(o);s===this.progress.color.currentIndex+1?(this.progress.color.correctCount++,this.progress.color.correctCount===g.length&&(this.progress.color.solved=!0),this.progress.color.currentIndex=s):(this.progress.color.currentIndex=-1,this.progress.color.correctCount=0),a===(this.progress.artist.currentIndex+1)%y.length?(this.progress.artist.correctCount++,this.progress.artist.correctCount===y.length&&(this.progress.artist.solved=!0)):this.progress.artist.correctCount=1,this.progress.artist.currentIndex=a,i===(this.progress.title.currentIndex+1)%w.length?(this.progress.title.correctCount++,this.progress.title.correctCount===w.length&&(this.progress.title.solved=!0)):this.progress.title.correctCount=1,this.progress.title.currentIndex=i;const c=Math.max(this.progress.color.correctCount,this.progress.artist.correctCount,this.progress.title.correctCount);this.progress.bestComboCount<6&&c<this.progress.bestComboCount&&t.Instance.emit("comboBroken"),this.progress.bestComboCount=c,this.progress.bestComboType=this.progress.color.correctCount===this.progress.bestComboCount?"color":this.progress.artist.correctCount===this.progress.bestComboCount?"artist":"title",this.queue.unshift(e),this.progress.displayText=this.getDisplayText(),t.Instance.emit("progress",this.progress)}getVinylInQueue(e){return this.vinyls[this.queue[e]]}isSolved(e){if(e)return this.progress.color.solved&&this.progress.artist.solved&&this.progress.title.solved,this.progress[e].solved}getDisplayText(){let e="";const{currentIndex:t,correctCount:n,solved:r}=this.progress[this.progress.bestComboType],o=b[this.progress.bestComboType];for(let s=0;s<n;s++){let n=t-s;n<0&&(n+=o.length),e=`${o[n]}â†’${e}`}return e}reset(){this.queue=[],this.selected={};const[e,n,r]=M;this.progress={color:{currentIndex:-1,correctCount:0,solved:!1},artist:{currentIndex:-2,correctCount:0,solved:!1},title:{currentIndex:-2,correctCount:0,solved:!1},bestComboType:"color",bestComboCount:0},this.vinyls=g.map((e,t)=>({index:t,color:e,artist:"",title:""})),e.forEach((e,t)=>{this.vinyls[e].color=g[t]}),n.forEach((e,t)=>{this.vinyls[e].artist=y[t]}),r.forEach((e,t)=>{this.vinyls[e].title=w[t]}),t.Instance.emit("progress",this.progress)}}class I{static createButton(e,t={}){const n=document.createElement("button");function r(){n.style.display="block",n.setAttribute("data-disabled","true"),n.onmouseenter=null,n.onmouseleave=null,n.onclick=null}if("xr"in navigator)return n.id="VRButton",n.style.display="none",navigator.xr.isSessionSupported("immersive-vr").then(function(o){o?function(){let r=null;async function o(t){t.addEventListener("end",s),await e.xr.setSession(t),n.textContent="EXIT VR",r=t}function s(){r.removeEventListener("end",s),n.textContent="ENTER VR",r=null}n.style.display="block",n.removeAttribute("data-disabled"),n.textContent="ENTER VR";const a={...t,optionalFeatures:["local-floor","bounded-floor","layers",...t.optionalFeatures||[]]};n.onclick=function(){null===r?navigator.xr.requestSession("immersive-vr",a).then(o):(r.end(),void 0!==navigator.xr.offerSession&&navigator.xr.offerSession("immersive-vr",a).then(o).catch(e=>{}))},void 0!==navigator.xr.offerSession&&navigator.xr.offerSession("immersive-vr",a).then(o).catch(e=>{})}():(r(),n.textContent="VR NOT SUPPORTED"),o&&I.xrSessionIsGranted&&n.click()}).catch(function(e){r(),n.textContent="VR NOT ALLOWED"}),n;{const e=document.createElement("a");return!1===window.isSecureContext?(e.href=document.location.href.replace(/^http:/,"https:"),e.innerHTML="WEBXR NEEDS HTTPS"):(e.href="https://immersiveweb.dev/",e.innerHTML="WEBXR NOT AVAILABLE"),e.className="webxr-message",e}}static registerSessionGrantedListener(){if("undefined"!=typeof navigator&&"xr"in navigator){if(/WebXRViewer\//i.test(navigator.userAgent))return;navigator.xr.addEventListener("sessiongranted",()=>{I.xrSessionIsGranted=!0})}}}I.xrSessionIsGranted=!1,I.registerSessionGrantedListener();const P=.0254,S=(e=1024,t=1024)=>{const n=document.createElement("canvas");n.width=e,n.height=t;const r=n.getContext("2d");return[n,r]},E=(t,n,r)=>{const o=new e.Vector3(1,0,0),s=new e.Euler(0,t,-Math.PI/2+n);return o.applyEuler(s).normalize().multiplyScalar(r)},B=e=>parseFloat(`${e||0}`),T=e=>e[Math.floor(Math.random()*e.length)],k={},R=new e.Color,D=(t,n)=>{const r=1==n?.glow,o=`color-${t}-${r}`;if(k[o])return k[o];const s=new(r?e.MeshBasicMaterial:e.MeshStandardMaterial)({color:t,side:e.FrontSide});return k[o]=s,s},O=(t,n)=>{const{color:r,bgColor:o,textAlign:s,ratio:a,fontSize:i}=n;R.set(r);const c="string"==typeof r?r:`#${R.getHexString()}`,d=`text-${c}-${t.join("")}`;if(k[d])return k[d];const u=1024,h=a?u/a:u,[p,m]=S(u,h);m.textAlign=s||"center";let f=16;"center"===m.textAlign&&(f=512),t.forEach((e,t)=>{const n=void 0!==i?i:64;m.strokeStyle=l,m.font=`${n}px monospace`,m.textBaseline="top",m.lineWidth=8,m.strokeText(e,f,16+n*t),m.fillStyle=c,m.fillText(e,f,16+n*t)});const g=new e.CanvasTexture(p),y=new e.MeshBasicMaterial({map:g,transparent:!0});return k[d]=y,y},L=e=>e*e,A=e=>e<.5?4*e*e*e:1-Math.pow(-2*e+2,3)/2,N=e=>.5*Math.cos(2*e*Math.PI+Math.PI)+.5;class G{static _instance;animations;scene;clock;constructor(){this.animations=[],this.scene=null,this.clock=new e.Clock}static get Instance(){return G._instance||(G._instance=new G),G._instance}initScene(e){this.scene||(this.scene=e,this.clock.start())}update(){const t=1e3*this.clock.getElapsedTime();this.animations=this.animations.filter(n=>{const{mesh:r,start:o,end:s,easeFunc:a,loop:i}=n,c=t-n.startTime,l=n.endTime-n.startTime,d=e.MathUtils.clamp(c/l,0,1);if(s.position&&r.position.lerpVectors(o.position,s.position,a(d)),s.rotation){const t=o.rotation,n=s.rotation,i=new e.Euler;i.order=t.order||e.Euler.DefaultOrder,i.x=t.x+(n.x-t.x)*a(d),i.y=t.y+(n.y-t.y)*a(d),i.z=t.z+(n.z-t.z)*a(d),r.rotation.copy(i)}return s.scaling&&r.scale.lerpVectors(o.scaling,s.scaling,a(d)),!(t>=n.endTime&&(i?(n.startTime=t,n.endTime=t+l,s.position&&r.position.copy(o.position),s.rotation&&r.rotation.copy(o.rotation),s.scaling&&r.scale.copy(o.scaling),0):(n.resolve&&(n.resolve(),n.resolve=void 0,n.reject=void 0),1)))})}animateTransform(e){const{mesh:t,end:n}=e,r=e.duration||1e3,o=e.delay||0,s=e.ease||L,a=1e3*this.clock.getElapsedTime();let i,c;const l=new Promise((e,t)=>{i=e,c=t});return this.animations.push({mesh:t,start:{position:t.position.clone(),rotation:t.rotation.clone(),scaling:t.scale.clone()},end:n,easeFunc:s,startTime:a+o,endTime:a+o+r,loop:e.loop||!1,resolve:i,reject:c}),l}cancelAnimation(e,t=!1){const n=this.animations.filter(t=>t.mesh===e);n.length&&(n.forEach(n=>{const{end:r}=n;t&&(r.position&&e.position.copy(r.position),r.rotation&&e.rotation.copy(r.rotation),r.scaling&&e.scale.copy(r.scaling)),n.reject&&(n.reject(),n.resolve=void 0,n.reject=void 0)}),this.animations=this.animations.filter(t=>t.mesh!==e))}}class V{constructor(){this.mOscillators=[this.osc_sin.bind(this),this.osc_square.bind(this),this.osc_saw.bind(this),this.osc_tri.bind(this)],this.mSong=null,this.mLastRow=0,this.mCurrentCol=0,this.mNumWords=0,this.mMixBuf=null}osc_sin(e){return Math.sin(6.283184*e)}osc_saw(e){return e%1*2-1}osc_square(e){return e%1<.5?1:-1}osc_tri(e){var t=e%1*4;return t<2?t-1:3-t}getnotefreq(e){return.003959503758*2**((e-128)/12)}createNote(e,t,n){var r,o,s,a,i,c,l=this.mOscillators[e.i[0]],d=e.i[1],u=e.i[3]/32,h=this.mOscillators[e.i[4]],p=e.i[5],m=e.i[8]/32,f=e.i[9],g=e.i[10]*e.i[10]*4,y=e.i[11]*e.i[11]*4,w=e.i[12]*e.i[12]*4,b=1/w,v=-e.i[13]/16,M=e.i[14],x=n*2**(2-e.i[15]),C=new Int32Array(g+y+w),I=0,P=0;for(r=0,o=0;r<g+y+w;r++,o++)o>=0&&(M=M>>8|(255&M)<<4,o-=x,i=this.getnotefreq(t+(15&M)+e.i[2]-128),c=this.getnotefreq(t+(15&M)+e.i[6]-128)*(1+8e-4*e.i[7])),s=1,r<g?s=r/g:r>=g+y&&(s=(1-(s=(r-g-y)*b))*3**(v*s)),a=l(I+=i*s**u)*d,a+=h(P+=c*s**m)*p,f&&(a+=(2*Math.random()-1)*f),C[r]=80*a*s|0;return C}async init(e){return new Promise(t=>{this.mSong=e,this.mLastRow=e.endPattern,this.mCurrentCol=0,this.mNumWords=e.rowLen*e.patternLen*(this.mLastRow+1)*2,this.mMixBuf=new Int32Array(this.mNumWords),t()})}generateChannel(e){return new Promise(t=>{var n,r,o,s,a,i,c,l,d,u,h,p,m,f,g=new Int32Array(this.mNumWords),y=this.mSong.songData[e],w=this.mSong.rowLen,b=this.mSong.patternLen,v=0,M=0,x=!1,C=[];for(o=0;o<=this.mLastRow;++o)for(c=y.p[o],s=0;s<b;++s){var I=c?y.c[c-1].f[s]:0;I&&(y.i[I-1]=y.c[c-1].f[s+b]||0,I<17&&(C=[]));var P=this.mOscillators[y.i[16]],S=y.i[17]/512,E=2**(y.i[18]-9)/w,B=y.i[19],T=y.i[20],k=43.23529*y.i[21]*3.141592/44100,R=1-y.i[22]/255,D=1e-5*y.i[23],O=y.i[24]/32,L=y.i[25]/512,A=6.283184*2**(y.i[26]-9)/w,N=y.i[27]/255,G=y.i[28]*w&-2;for(h=(o*b+s)*w,a=0;a<4;++a)if(i=c?y.c[c-1].n[s+a*b]:0){C[i]||(C[i]=this.createNote(y,i,w));var V=C[i];for(r=0,n=2*h;r<V.length;r++,n+=2)g[n]+=V[r]}for(r=0;r<w;r++)(u=g[l=2*(h+r)])||x?(p=k,B&&(p*=P(E*l)*S+.5),M+=(p=1.5*Math.sin(p))*(m=R*(u-M)-(v+=p*M)),u=3==T?M:1==T?m:v,D&&(u=(u*=D)<1?u>-1?this.osc_sin(.25*u):-1:1,u/=D),x=(u*=O)*u>1e-5,f=u*(1-(d=Math.sin(A*l)*L+.5)),u*=d):f=0,l>=G&&(f+=g[l-G+1]*N,u+=g[l-G]*N),g[l]=0|f,g[l+1]=0|u,this.mMixBuf[l]+=0|f,this.mMixBuf[l+1]+=0|u}t()})}async generate(){this.mMixBuf.fill(0),this.mCurrentCol=0;const e=[];for(let t=0;t<this.mSong.numChannels;t++)e.push(this.generateChannel(t));return await Promise.all(e),this.mCurrentCol=this.mSong.numChannels,1}createAudioBuffer(e){for(var t=e.createBuffer(2,this.mNumWords/2,44100),n=0;n<2;n++)for(var r=t.getChannelData(n),o=n;o<this.mNumWords;o+=2)r[o>>1]=this.mMixBuf[o]/65536;return t}createAudioBufferRange(e,t=0,n=null){(null===n||n>this.mNumWords/2)&&(n=this.mNumWords/2),t<0&&(t=0),t>=n&&(t=n-1);const r=n-t;for(var o=e.createBuffer(2,r,44100),s=0;s<2;s++)for(var a=o.getChannelData(s),i=0;i<r;i++){var c=2*(t+i)+s;a[i]=this.mMixBuf[c]/65536}return o}createWave(){var e=44+2*this.mNumWords-8,t=e-36,n=new Uint8Array(44+2*this.mNumWords);n.set([82,73,70,70,255&e,e>>8&255,e>>16&255,e>>24&255,87,65,86,69,102,109,116,32,16,0,0,0,1,0,2,0,68,172,0,0,16,177,2,0,4,0,16,0,100,97,116,97,255&t,t>>8&255,t>>16&255,t>>24&255]);for(var r=0,o=44;r<this.mNumWords;++r){var s=this.mMixBuf[r];s=s<-32767?-32767:s>32767?32767:s,n[o++]=255&s,n[o++]=s>>8&255}return n}createWaveRange(e=0,t=null){(null===t||t>this.mNumWords/2)&&(t=this.mNumWords/2),e<0&&(e=0),e>=t&&(e=t-1);const n=t-e;var r=44+2*n-8,o=r-36,s=new Uint8Array(44+2*n);s.set([82,73,70,70,255&r,r>>8&255,r>>16&255,r>>24&255,87,65,86,69,102,109,116,32,16,0,0,0,1,0,2,0,68,172,0,0,16,177,2,0,4,0,16,0,100,97,116,97,255&o,o>>8&255,o>>16&255,o>>24&255]);for(var a=0,i=44;a<n;++a){var c=this.mMixBuf[2*(e+a)];c=c<-32767?-32767:c>32767?32767:c,s[i++]=255&c,s[i++]=c>>8&255}return s}getData(e,t){for(var n=2*Math.floor(44100*e),r=new Array(t),o=0;o<2*t;o+=1){var s=n+o;r[o]=e>0&&s<this.mMixBuf.length?this.mMixBuf[s]/32768:0}return r}}const U=44100,W=new(window.AudioContext||window.webkitAudioContext),q=(...e)=>((...e)=>{let t=W.createBufferSource(),n=W.createBuffer(e.length,e[0].length,U);return e.map((e,t)=>n.getChannelData(t).set(e)),t.buffer=n,t.connect(W.destination),t.start(),t})(((e=1,t=.05,n=220,r=0,o=0,s=.1,a=0,i=1,c=0,l=0,d=0,u=0,h=0,p=0,m=0,f=0,g=0,y=1,w=0,b=0)=>{let v,M,x=2*Math.PI,C=c*=500*x/U**2,I=(0<m?1:-1)*x/4,P=n*=(1+2*t*Math.random()-t)*x/U,S=[],E=0,B=0,T=0,k=1,R=0,D=0,O=0;for(l*=500*x/U**3,m*=x/U,d*=x/U,u*=U,h=U*h|0,M=(r=99+U*r)+(w*=U)+(o*=U)+(s*=U)+(g*=U)|0;T<M;S[T++]=O)++D%(100*f|0)||(O=a?1<a?2<a?3<a?Math.sin((E%x)**3):Math.max(Math.min(Math.tan(E),1),-1):1-(2*E/x%2+2)%2:1-4*Math.abs(Math.round(E/x)-E/x):Math.sin(E),O=(h?1-b+b*Math.sin(2*Math.PI*T/h):1)*(0<O?1:-1)*Math.abs(O)**i*e*.3*(T<r?T/r:T<r+w?1-(T-r)/w*(1-y):T<r+w+o?y:T<M-g?(M-T-g)/s*y:0),O=g?O/2+(g>T?0:(T<M-g?1:(M-T)/g)*S[T-g|0]/2):O),v=(n+=c+=l)*Math.sin(B*m-I),E+=v-v*p*(1-1e9*(Math.sin(T)+1)%2),B+=v-v*p*(1-1e9*(Math.sin(T)**2+1)%2),k&&++k>u&&(n+=d,P+=d,k=0),!h||++R%h||(n=P,c=C,k=k||1);return S})(...e));var j={songData:[{i:[0,255,116,85,0,255,116,0,37,14,4,6,73,99,0,0,0,0,0,0,2,136,15,0,32,0,0,0,6],p:[1,1,1,2,,,1,1,2,2],c:[{n:[139,,,,139,,,,139,,,,139,,,,139,,,,139,,,,139,,139,,139,,139],f:[]},{n:[140,,140,,,,140,,,,140,,140,,140,,,,140,,140,,,,140,,140,,,,140],f:[]}]},{i:[0,160,128,64,0,160,128,0,64,210,4,7,52,85,0,0,0,60,4,1,2,255,0,0,32,61,5,0,6],p:[,1,2,1,2,1,2,1,1,1],c:[{n:[,,,,139,,,,,,,,139,,,,,,,,139,,,,,,,,139,,139],f:[]},{n:[,,,,,,,,,,,,139,,139,,,,,,,,,,,,,,139,,139],f:[]}]},{i:[0,255,106,64,0,255,106,0,64,0,5,7,164,0,0,0,0,0,0,0,2,255,0,2,32,83,5,25,1],p:[,,,,1,,2,1,1,2],c:[{n:[144,,,,,,,,,,,,,,,,144],f:[]},{n:[,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,156,,,,,,,,,,,,,,,,156],f:[]}]},{i:[0,91,128,0,0,95,128,12,0,0,12,0,72,0,0,0,0,0,0,0,2,255,0,0,32,83,3,130,4],p:[,,,,1,1,1,1,2,2],c:[{n:[132,,,,,,,,132,,,,,,,,144,,,,,,,,144],f:[]},{n:[],f:[]}]},{i:[1,192,128,0,1,191,116,9,0,0,6,22,34,0,0,0,0,69,3,1,1,23,167,0,32,77,6,25,6],p:[,,2,1,,2,1,2,2,1],c:[{n:[144,,,,144,,,,144,,,,142,,142,,144,,144,,144,,,,144,,,,144,,,,147,,,,151,,,,147,,,,149,,149,,147,,147,,151,,,,147,,,,147,,,,151,,,,154,,,,151,,,,151,,151,,151,,151,,154,,,,151,,,,151],f:[]},{n:[144,144,144,,144,,,,,,,,,,,,,,,,,,,,,,,,,,,,147,147,147,,147,,,,,,,,,,,,,,,,,,,,,,,,,,,,151,151,151,,151],f:[]}]}],rowLen:5513,patternLen:32,endPattern:9,numChannels:5};const z=new AudioContext;let _=0;t.Instance.on("progress",e=>{const t=e.bestComboCount||0;_=Math.min(t,6)});const $=()=>q(...[,,143,.03,.17,.09,2,1.5,10,-17,,,,,4,,,.73,.09]),F=["Light Blue","Yellow","Orange","Red","Purple","Blue","Green","Lime","Pink","Silver"],H={"Light Blue":"#9999ff",Yellow:"#fffb00",Orange:"#ff7300",Red:"#ff0000",Purple:"#c300ff",Blue:"#0000ff",Green:"#00ff00",Lime:"#b0ffb0",Pink:"#ff00ff",Silver:"#d3d3d3"},X=(t,n)=>{const r=new e.Group;r.position.set(0,0,0),r.rotation.set(0,0,0),r.scale.set(1,1,1);const o={...H,...n};return t.forEach(t=>{if(null!==t)if(Array.isArray(t))r.add(X(t,o));else{const[n,s,a,i,c,l,d,u,h,p,m,f,g,y,w]=t.split(","),b=(t=>{const[n]=t.split(",");switch(n){case"c":return(t=>{const[n,r,o,s,a,i,c,l,d,u,h,p,m,f,g]=t.split(","),y=B(o),w=B(s),b=B(a),v=B(i),M=B(c),x=B(l),C=B(p),I=B(m),P=B(f),S=B(d),E=B(u),T=B(h),k=new e.BoxGeometry(y,w,b);return k.translate(v-C,M-I,x-P),k.rotateX(e.MathUtils.degToRad(S)),k.rotateY(e.MathUtils.degToRad(E)),k.rotateZ(e.MathUtils.degToRad(T)),k.computeBoundingBox(),k})(t);case"s":return(t=>{const[n,r,o,s,a,i,c,l,d,u,h,p,m,f,g]=t.split(","),y=B(o),w=B(s),b=B(a),v=B(i),M=B(c),x=B(l),C=B(p),I=B(m),P=B(f),S=B(d),E=B(u),T=B(h),k=new e.SphereGeometry(y/2,32,16);return k.scale(y/y,w/y,b/y),k.translate(v-C,M-I,x-P),k.rotateX(e.MathUtils.degToRad(S)),k.rotateY(e.MathUtils.degToRad(E)),k.rotateZ(e.MathUtils.degToRad(T)),k})(t);case"p":return(t=>{const[n,r,o,s,a,i,c,l,d,u,h,p,m,f,g]=t.split(","),y=B(o),w=B(s),b=B(i),v=B(c),M=B(l),x=B(p),C=B(m),I=B(f),P=B(d),S=B(u),E=B(h),T=new e.PlaneGeometry(y,w);return T.rotateX(e.MathUtils.degToRad(-90)),T.translate(b-x,v-C,M-I),T.rotateX(e.MathUtils.degToRad(P)),T.rotateY(e.MathUtils.degToRad(S)),T.rotateZ(e.MathUtils.degToRad(E)),T.computeBoundingBox(),T})(t);case"cy":return(t=>{const[n,r,o,s,a,i,c,l,d,u,h,p,m,f,g]=t.split(","),y=B(o),w=B(s),b=B(a),v=B(i),M=B(c),x=B(l),C=B(p),I=B(m),P=B(f),S=B(d),E=B(u),T=B(h),k=y/2,R=new e.CylinderGeometry(k,k,w,32);R.translate(v-C,M-I,x-P),R.scale(1,1,b/y);const D=e.MathUtils.degToRad(S),O=e.MathUtils.degToRad(E),L=e.MathUtils.degToRad(T),A=new e.Euler(D,O,L);return R.applyQuaternion((new e.Quaternion).setFromEuler(A)),R.computeBoundingBox(),R})(t);case"py":return(t=>{const[n,r,o,s,a,i,c,l,d,u,h,p,m,f,g]=t.split(","),y=B(o),w=B(s),b=B(a),v=B(i),M=B(c),x=B(l),C=B(p),I=B(m),P=B(f),S=B(d),E=B(u),T=B(h),k=Math.sqrt(y*y+y*y)/2,R=new e.CylinderGeometry(0,k,w,4,1,!1,Math.PI/4);return R.scale(1,1,b/y),R.translate(v-C,M-I+.3*w,x-P),R.rotateX(e.MathUtils.degToRad(S)),R.rotateY(e.MathUtils.degToRad(E)),R.rotateZ(e.MathUtils.degToRad(T)),R})(t);default:throw new Error(`Unknown shape: ${n}`)}})(t);let v=new e.MeshStandardMaterial({color:o[F[w]],side:e.DoubleSide});const M=new e.Mesh(b,v);M.name=s,M.position.set(f,g,y),r.add(M)}}),r},Y=()=>["s,head,20,16,16,,8,,,,,,8,,4","s,head,16,16,16,,-5,,,,,,-5,,4",["cy,leftEye,4,1,4,-3,10,-7.1,-71,-5,16,-3,10,-7.1,1","s,leftPupil,2,2,4,-2.8,10.1,-7,-75,7,10,-2.8,10.1,-7,4","cy,rightEye,4,1,4,3,10,-7.2,-71,5,-17,3,10,-7.2,1","s,rightPupil,2,2,4,2.9,10,-7.1,-74,-4,-12,2.9,10,-7.1,4"],["c,rightCheek,4,4,2,1.84,6.03,-7.5,-25,,80,2.34,6.53,-7.5,9","c,leftCheek,4,4,2,-2.91,5.98,-7.5,,23,10,-2.41,6.48,-7.5,9","c,tongue,2,2,2,,5,-7,,,,,4,-7,3","py,pyramid,3,1.6,1,,8.2,-8,-180,,,,8.2,-8,8"],["py,ear,6,7,4,-4.86,13.55,-1.28,-14,20,31,-4.86,13.55,-1.28,4","py,ear,6,7,4,5.14,13.55,-1.28,-11,-15,-33,5.14,13.55,-1.28,4","py,ear,5.2,6.2,3.4,5.14,13.15,-1.78,-9,-16,-33,5.14,13.15,-1.78,1","py,ear,5,5.5,3.8,-5.04,13.54,-1.59,-17,19,32,-5.04,13.54,-1.59,1"],["cy,cylinder,0.2,11,0.2,-7.93,6,-10.12,,-15,90,-7.93,6,-10.12,9","cy,cylinder,0.2,9.2,0.2,-6.87,7.72,-9,,-15,75,-6.87,7.72,-9,9","cy,cylinder,0.2,9,0.2,-7.07,3.78,-9.3,,-15,105,-7.07,3.78,-9.3,9","cy,cylinder,0.2,7.8,0.2,6.87,7.62,-8.9,180,-15,-105,6.87,7.62,-8.9,9","cy,cylinder,0.2,9.4,0.2,6.93,6,-9.52,,-165,90,6.93,6,-9.52,9","cy,cylinder,0.2,8.8,0.2,6.87,3.88,-9.1,180,-15,-75,6.87,3.88,-9.1,9"]],Q={Purple:m,Red:u,Silver:c},K=(e={})=>{const t=X(["cy,cylinder,4,6,2,,-1,,,,,,-1,,4","s,sphere,4,4,2,,2,,,,,,2,,4","c,cube,0.3,1,0.3,-1.15,3.5,-0.55,-77,,,-1.15,3.5,-0.55,9","c,cube,0.3,1,0.3,-0.45,3.9,-0.55,-77,,,-0.45,3.9,-0.55,9","c,cube,0.3,1,0.3,0.45,3.9,-0.55,-77,,,0.45,3.9,-0.55,9","c,cube,0.3,1,0.3,1.05,3.6,-0.55,-77,,,1.05,3.6,-0.55,9","c,cube,2,0.7,0.4,,1.85,-0.9,,,,,1.5,-0.1,3","c,cube,0.8,0.5,1.1,,2.45,-0.55,,,,,2.2,-0.1,3","c,cube,0.3,0.6,0.6,-1.15,2.7,-0.8,,,,-1.15,2.7,-0.1,3","c,cube,0.3,0.6,0.6,-0.45,3.1,-0.8,,,,-0.45,3.1,-0.1,3","c,cube,0.3,0.6,0.6,0.45,3.1,-0.8,,,,0.45,3.1,-0.1,3","c,cube,0.3,0.6,0.6,1.05,2.7,-0.8,,,,1.05,2.7,-0.1,3"],{...Q,...e});return t.name="paw",t.scale.set(.03125,.03125,.03125),t.rotation.set(3*Math.PI/2,0,0),t},Z=[{Purple:m,Silver:"#888888",Yellow:d,Red:u},{Purple:r,Silver:o,Yellow:"#1aff1a",Red:u},{Purple:"#666666",Silver:d,Yellow:h,Red:u}];class J{clock;parent;_mesh;geometry;constructor(){this.clock=new e.Clock,this.parent=new e.Group,this.parent.name="Grid",this.geometry=new e.PlaneGeometry(20,26,20,26),this.geometry.rotateX(Math.PI/2),this._mesh=new e.Mesh(this.geometry,new e.MeshBasicMaterial({color:"#ff00ff",wireframe:!0})),this.parent.add(this._mesh),t.Instance.on("tick",e=>{const t=this.geometry.getAttribute("position");for(let n=0;n<t.array.length;n+=3){const e=t.array[n],r=t.array[n+2];t.array[n+1]=.5*Math.sin(Math.sqrt(e*e+r*r)-2*this.clock.getElapsedTime())}t.needsUpdate=!0}),t.Instance.on("progress",t=>{!this._mesh.material.visible&&t.bestComboCount>5&&(this._mesh.position.set(0,-5,0),G.Instance.animateTransform({mesh:this._mesh,end:{position:new e.Vector3(0,0,0)},ease:A,duration:2e3})),this._mesh.material.visible=t.bestComboCount>5})}get mesh(){return this.parent}}const ee=[{},{Orange:"#af3dff",Purple:l,Silver:p}],te=new e.Vector3(.05,.05,.05),ne=new e.Clock;let re,oe,se,ae,ie,ce,le,de,ue=0;const he=new e.Vector3(0,0,.3),pe=async()=>{document.getElementById("p").setAttribute("disabled","true"),document.getElementById("p").innerHTML="LOADING...",ae=new e.WebGLRenderer({antialias:!0}),ae.setPixelRatio(window.devicePixelRatio),ae.setSize(window.innerWidth,window.innerHeight),ae.setClearColor("#000000"),ae.xr.addEventListener("sessionstart",me),ae.xr.enabled=!0,ae.setAnimationLoop(ve),document.body.appendChild(I.createButton(ae)),document.body.appendChild(ae.domElement);const y=new C;oe=new e.Scene,re=new e.PerspectiveCamera(75,window.innerWidth/window.innerHeight,.1,1e3),re.position.set(0,2,1),re.rotation.set(-1*Math.PI/12,0,0),re.name="camera",oe.add(re),G.Instance.initScene(oe);const w=new e.AmbientLight(16777215,.8);oe.add(w);const b=new e.DirectionalLight(16777215,.8);b.position.set(6,10,8),b.castShadow=!0,b.target.position.set(0,0,0),oe.add(b),oe.add(b.target);const M=(()=>{const n=new e.Group;n.name="Sky";const r=new e.Object3D,o=30,s=new e.BoxGeometry,a=new e.MeshStandardMaterial,i=[];let c=0,l=0;const d=new e.InstancedMesh(s,a,900);d.instanceMatrix.setUsage(e.DynamicDrawUsage);const u=new e.Color,h=[new e.Color(65535),new e.Color(16776960),new e.Color(16711935)];let p=0;for(let e=0;e<o;e++)for(let t=0;t<o;t++){const n=E(0,2*t*Math.PI/o,15);n.z=4*-e,r.position.copy(n),r.scale.set(1,1,2),r.updateMatrix(),u.setHSL(1,.5+.5*Math.random(),.5+.5*Math.random()),i.push(u.getHex()),d.setMatrixAt(p,r.matrix),d.setColorAt(p,u.multiply(h[0])),p++}return n.add(d),t.Instance.on("tick",e=>{c+=e;for(let t=0;t<d.count;t++){d.getMatrixAt(t,r.matrix),r.matrix.decompose(r.position,r.quaternion,r.scale);const e=Math.floor(t/o),n=e%2?1:-1,s=4*-e,a=t%o*2*Math.PI/o,i=.05*n*c;r.position.copy(E(0,a+i,15)),r.position.z=s+l*n*Math.sin(c),r.updateMatrix(),d.setMatrixAt(t,r.matrix)}d.instanceMatrix.needsUpdate=!0}),t.Instance.on("progress",e=>{l=e.bestComboCount>=2?1:0}),n})();M.position.set(0,0,5),oe.add(M);const B=(y=>{const w=X([["c,desk,2,0.1,1,,0.85,-0.5,,,,,-0.1,,6","c,leg,0.1,0.8,0.1,-0.85,0.4,-0.85,,,,0.1,,-0.9,6","c,leg,0.1,0.8,0.1,-0.85,0.4,-0.15,,,,0.1,,-0.2,6","c,leg,0.1,0.8,0.1,0.85,0.4,-0.15,,,,1.8,,-0.2,6","c,leg,0.1,0.8,0.1,0.85,0.4,-0.85,,,,1.8,,-0.9,6","c,record-rack,0.4,0.1,0.8,0.7,0.95,-0.5,,,,0.7,0.95,-0.5,0","c,cube,0.3,0.1,0.4,-0.75,0.95,-0.3,,,,-0.75,0.95,-0.3,9","c,cube,0.4,0.1,0.4,-0.3,0.95,-0.3,,,,-0.3,0.95,-0.3,9","c,tableA,0.4,0.1,0.4,0.2,0.95,-0.3,,,,0.2,1.01,-0.3,0","cy,pad,0.4,0.02,0.4,0.2,1,-0.3,,,,0.2,1,-0.3,3"],"c,cube,22,1,4,,-1.5,-23,,,,,-2,-15,2","c,floor,20,1,20,,-2.5,-11,,,,,-3,-4,3","c,cube,20,1,6,,-2.5,2,,,,,-3,5,3","c,cube,8,2,3,,-1,0.5,,,,,-1,-4,2","c,pillar,1,4,1,6.5,,-6.5,,,,7,,-7,6","c,pillar,1,4,1,6.5,,-10.5,,,,7,,-11,6","c,pillar,1,3,1,6.5,0.5,-14.5,,,,7,,-15,6","c,pillar,1,4,1,6.5,,-18.5,,,,7,,-19,6","c,pillar,1,4,1,6.5,,-14.5,,,,7,,-15,6","c,pillar,1,4,1,-6.5,,-6.5,,,,-6,,-7,6","c,pillar,1,4,1,-6.5,,-2.5,,,,-6,,-3,6","c,pillar,1,4,1,6.5,,-2.5,,,,7,,-3,6","c,pillar,1,4,1,-6.5,,-10.5,,,,-6,,-11,6","c,pillar,1,4,1,-6.5,,-14.5,,,,-6,,-15,6","c,pillar,1,4,1,-6.5,,-18.5,,,,-6,,-19,6","c,cube,4,1,20,8,2.5,-11,,,,7,2,-3,1","c,cube,4,1,20,-8,2.5,-11,,,,-9,2,-3,1"],{Green:"#93e0a8",Yellow:d,Orange:"#687793",Red:"#42485d","Light Blue":a}),b=(()=>{const e=X(["c,base,13,1,3,-1.5,0.5,-0.5,,,,,,,5",["c,panel,12.4,2.7,1,-1.5,2.45,0.3,-60,,,-1.5,1.1,0.88,6","c,display-back,11.8,0.8,0.1,-1.5,3.2,0.85,-60,,,-1.5,1.1,0.88,3","c,progress-color-0,1.8,0.3,0.1,-6.5,2.45,0.85,-60,,,-11.5,1.1,0.88,9","c,progress-color-1,1.8,0.3,0.1,-4.5,2.45,0.85,-60,,,0.5,1.1,0.88,9","c,progress-color-2,1.8,0.3,0.1,-2.5,2.45,0.85,-60,,,0.5,1.1,0.88,9","c,progress-color-3,1.8,0.3,0.1,-0.5,2.45,0.85,-60,,,0.5,1.1,0.88,9","c,progress-color-4,1.8,0.3,0.1,1.5,2.45,0.85,-60,,,0.5,1.1,0.88,9","c,progress-color-5,1.8,0.3,0.1,3.5,2.45,0.85,-60,,,0.5,1.1,0.88,9","c,progress-artist-1,1.8,0.3,0.1,-4.5,1.95,0.85,-60,,,0.5,1.1,0.88,9","c,progress-artist-2,1.8,0.3,0.1,-2.5,1.95,0.85,-60,,,0.5,1.1,0.88,9","c,progress-artist-3,1.8,0.3,0.1,-0.5,1.95,0.85,-60,,,0.5,1.1,0.88,9","c,progress-artist-4,1.8,0.3,0.1,1.5,1.95,0.85,-60,,,0.5,1.1,0.88,9","c,progress-artist-5,1.8,0.3,0.1,3.5,1.95,0.85,-60,,,0.5,1.1,0.88,9","c,progress-artist-0,1.8,0.3,0.1,-6.5,1.95,0.85,-60,,,-11.5,1.1,0.88,9","c,progress-title-1,1.8,0.3,0.1,-4.5,1.45,0.85,-60,,,0.5,1.1,0.88,9","c,progress-title-2,1.8,0.3,0.1,-2.5,1.45,0.85,-60,,,0.5,1.1,0.88,9","c,progress-title-3,1.8,0.3,0.1,-0.5,1.45,0.85,-60,,,0.5,1.1,0.88,9","c,progress-title-4,1.8,0.3,0.1,1.5,1.45,0.85,-60,,,0.5,1.1,0.88,9","c,progress-title-5,1.8,0.3,0.1,3.5,1.45,0.85,-60,,,0.5,1.1,0.88,9","c,progress-title-0,1.8,0.3,0.1,-6.5,1.45,0.85,-60,,,-11.5,1.1,0.88,9","p,display,11.8,0.8,,-1.5,2.22,-0.88,30,,,-1.5,2.22,-0.88,8"]],{Red:l,Green:d,Blue:a,Silver:l});return e.scale.set(.1,.1,.1),t.Instance.on("progress",t=>{e.getObjectByName("display").material=O([t.displayText],{color:f[t.bestComboType],textAlign:"left",ratio:14.75,fontSize:v[t.bestComboType]}),x.forEach(n=>{for(let r=0;r<6;r++){const o=e.getObjectByName(`progress-${n}-${r}`);if(!o)continue;let s=m;(t[n].solved||r<t[n].correctCount)&&(s=f[n]),(t[n].solved||r<t[n].correctCount)&&"color"===n&&(s=g[r]);const a=s!==m;o.material.color.set(s),o.material.emissive.set(a?s:l),o.material.emissiveIntensity=a?1:0,o.material.needsUpdate=!0}})}),e})();w.add(b),b.position.set(-.1,.9,-.7);const M=(()=>{const e=X(["cy,lid,3.9,0.1,3.9,-0.27,2.1,,,,30,-0.27,2.1,,9","cy,label,4,0.8,4,,0.5,,,,,,0.5,,5","cy,can,3.9,1,3.9,,0.5,,,,,,0.5,,9","cy,tuna,3.8,0.6,3.8,,0.8,,,,,,0.8,,8"],{Blue:p,Red:u,Silver:c});return e.scale.set(.03125,.03125,.03125),e.userData.isPickable=!0,e.onPointerPick=e=>{$()},e})();w.add(M),M.position.set(-.4,1,-.3);const C=(n=>{const r=new e.Vector3(0,-1,0),o=[],s=[],a=new e.Group;for(let t=0;t<10;t++){const n=T(Z),r=X(Y(),n);r.scale.set(.03125,.03125,.03125),a.add(r);for(let e=0;e<2;e++){const o=K(n);o.name=`paw-${t}-${e}`,o.position.copy(r.position),o.position.z+=1,a.add(o)}r.userData.positionOffset=new e.Vector3(6*Math.random()-3,.5*Math.random()-.25,6*Math.random()-3),r.userData.poseOffset=e.MathUtils.randInt(0,s.length),r.lookAt(0,6,0),o.push(r)}return t.Instance.on("tick",()=>{if(!n.xr?.getCamera())return;const t=n.xr?.getCamera(),i=new e.Object3D,c={controllers:[]};t&&(c.camera=t.matrix.clone()),[0,1].forEach(e=>{const t=n.xr?.getController(e);if(t){const e=t.getObjectByName("paw");e&&c.controllers.push(e.matrixWorld.clone())}s.push(c)}),0!=s.length&&o.forEach((t,n)=>{const o=s[t.userData.poseOffset];i.matrix.copy(o.camera),i.matrix.decompose(i.position,i.quaternion,i.scale),t.quaternion.copy(i.quaternion),t.position.copy(i.position.add(t.userData.positionOffset).add(r)),o.controllers.forEach((e,r)=>{const o=a.getObjectByName(`paw-${n}-${r}`);o&&(i.matrix.copy(e),i.matrix.decompose(i.position,i.quaternion,i.scale),o.position.copy(i.position.add(t.userData.positionOffset)),o.quaternion.copy(i.quaternion))}),t.userData.poseOffset+=1,t.userData.poseOffset%600==0&&(t.userData.poseOffset=600*e.MathUtils.randInt(0,Math.floor(s.length/600)))})}),a})(y);C.name="Crowd",w.add(C),C.position.set(0,-1,-10),C.rotation.set(0,Math.PI,0);const I=X(["s,head,20,16,16,,8,,,,,,8,,4","s,head,16,16,16,,-5,,,,,,-5,,4",["cy,leftEye,4,1,4,-3,10,-7.1,-71,-5,16,-3,10,-7.1,1","s,leftPupil,2,2,4,-2.8,10.1,-7,-75,7,10,-2.8,10.1,-7,4","cy,rightEye,4,1,4,3,10,-7.2,-71,5,-17,3,10,-7.2,1","s,rightPupil,2,2,4,2.9,10,-7.1,-74,-4,-12,2.9,10,-7.1,4"],["c,rightCheek,4,4,2,1.84,6.03,-7.5,-25,,80,2.34,6.53,-7.5,9","c,leftCheek,4,4,2,-2.91,5.98,-7.5,,23,10,-2.41,6.48,-7.5,9","c,tongue,2,2,2,,5,-7,,,,,4,-7,3","py,pyramid,3,1.6,1,,8.2,-8,-180,,,,8.2,-8,8"],["py,ear,6,7,4,-4.86,13.55,-1.28,-14,20,31,-4.86,13.55,-1.28,4","py,ear,6,7,4,5.14,13.55,-1.28,-11,-15,-33,5.14,13.55,-1.28,4","py,ear,5.2,6.2,3.4,5.14,13.15,-1.78,-9,-16,-33,5.14,13.15,-1.78,1","py,ear,5,5.5,3.8,-5.04,13.54,-1.59,-17,19,32,-5.04,13.54,-1.59,1"],["cy,cylinder,0.2,11,0.2,-7.93,6,-10.12,,-15,90,-7.93,6,-10.12,9","cy,cylinder,0.2,9.2,0.2,-6.87,7.72,-9,,-15,75,-6.87,7.72,-9,9","cy,cylinder,0.2,9,0.2,-7.07,3.78,-9.3,,-15,105,-7.07,3.78,-9.3,9","cy,cylinder,0.2,7.8,0.2,6.87,7.62,-8.9,180,-15,-105,6.87,7.62,-8.9,9","cy,cylinder,0.2,9.4,0.2,6.93,6,-9.52,,-165,90,6.93,6,-9.52,9","cy,cylinder,0.2,8.8,0.2,6.87,3.88,-9.1,180,-15,-75,6.87,3.88,-9.1,9"]],{Purple:"#333333",Silver:"#888888"});I.name="catMesh",I.position.set(-3,1,0),I.scale.set(.1,.1,.1),I.rotation.set(0,-Math.PI/4,0),w.attach(I);const P=I.clone(!0);P.name="catMesh2",P.position.set(3,1,0),P.rotation.set(0,Math.PI/4,0),w.attach(P);const S=(()=>{const t=X([["c,case1,1,8,2,7.5,7,,,,,7.5,7,,5","c,case2,3,9,2,5.5,7.5,,,,,5.5,7.5,,5","c,case3,8,4,2,,10,,,,,,11.5,,5","c,case4,8,1,2,,5.5,,,,,,5.5,,5","c,case5,3,9,2,-5.5,7.5,,,,,-5.5,7.5,,5","c,case6,1,8,2,-7.5,7,,,,,-7.5,7,,5"],"c,base,12,2.1,2.8,,3.95,,,,,,3,,3","c,rightReel,2,2,1,2.72,6.89,,,,-45,2.72,6.89,,2","c,rightTape,4,4,0.2,2.81,6.91,-0.1,,,-45,2.81,6.91,-0.1,4","c,leftReel,2,2,1,-2.69,6.91,,,,-45,-2.75,7,,2","cy,base,16,8,16,,-4,,,,,,-4,,6","c,label,12,2,2.2,,10,,,,,,9,1,9"],{Blue:"#ffcc00",Silver:h,Red:u,Orange:d,Purple:"#39013a",Green:a});return G.Instance.animateTransform({mesh:t,end:{rotation:new e.Euler(0,2*Math.PI-.01,0)},duration:16e3,ease:e=>e,loop:!0}),t})();w.add(S),S.position.set(0,0,-30);const E=new J;w.add(E.mesh),E.mesh.position.set(0,-1,-7);const B=(()=>{const n=new e.Group;n.name="debugScreen",n.renderOrder=1;const r=new e.PlaneGeometry(5,5);r.translate(0,-2,0);const o=O(["You win!","Thanks for playing","Created by Alex Swan"],{color:"white"}),s=new e.Mesh(r,o);return n.add(s),s.position.set(0,0,-20),s.scale.set(.1,.1,.1),s.rotation.set(-Math.PI/2,0,0),s.visible=!1,t.Instance.on("progress",t=>{t.color.solved&&t.artist.solved&&t.title.solved&&(s.userData.solved=!0,s.visible=!0,s.material.needsUpdate=!0,G.Instance.animateTransform({mesh:s,end:{position:{x:0,y:0,z:0},scaling:{x:1,y:1,z:1},rotation:new e.Euler(0,0,0)},duration:1e3}))}),n})();w.add(B),B.position.set(0,2,-1);const k=(()=>{const c=new e.Group;c.name="Runner";let d=[n,r,o,s,a,i],u=[(e,t)=>0===e||0===t,(e,t)=>1===e||1===t,(e,t)=>2===e||2===t,(e,t)=>3===e||3===t,(e,t)=>4===e||4===t,(e,t)=>5===e||5===t,(e,t)=>t+e===0||12-e-t-2==0,(e,t)=>t+e===1||12-e-t-2==1,(e,t)=>t+e===2||12-e-t-2==2,(e,t)=>t+e===3||12-e-t-2==3,(e,t)=>t+e===4||12-e-t-2==4,(e,t)=>t+e===5||12-e-t-2==5,(e,t)=>(e+t)%2==0,(e,t)=>(e+t)%2==1,(e,t)=>(e+t)%2==0,(e,t)=>(e+t)%2==1,(e,t)=>(e+t)%2==0,(e,t)=>(e+t)%2==1];for(;d.length<6;)d.push(...d);d=d.slice(0,6);let h=-2;const p=new e.BoxGeometry;p.translate(.5,.5,.5),p.scale(.9,1.1,.9);for(let t=0;t<6;t++)for(let n=0;n<6;n++){const r=new e.MeshStandardMaterial({color:l}),o=new e.Mesh(p,r);o.name=`runner-${n}-${t}`,o.userData.x=n,o.userData.y=t,o.position.set(-3+n,0,-3+t),c.attach(o)}return t.Instance.on("beat",()=>{h+=1,h<0||c.children.forEach(t=>{const{x:n,y:r}=t.userData,o=u[h%u.length](n,r),s=o?d[h%d.length]:l;t.material.needsUpdate=!0,t.material.color.set(s),t.material.emissive.set(o?s:l),t.material.needsUpdate=!0,t.material.emissiveIntensity=o?1:0,o&&G.Instance.animateTransform({mesh:t,end:{scaling:new e.Vector3(1,o?1.1:1,1)},duration:500,ease:N})})}),c})();return w.add(k),k.position.set(0,-3,-10),k.scale.set(2,1,2),w})(ae);oe.add(B);const k=B.getObjectByName("tableA"),R=(()=>{new e.Vector3(1,0,0);const n=new e.Group;n.name="FishSwirl";const r=[];let o=!0;const s=new e.Group,a=X(["c,cube,6,6,8,,,,,,,,-3,,2","c,cube,4,4,11.1,,,-0.55,,,,,-3,,2","c,cube,2,2,2,-2,,-5,,,,-2,-1,-5,4","c,cube,2,2,2,2,,-5,,,,2,-1,-5,4","c,cube,2,6,2,,,6,,,,,-3,7,2","c,cube,1,4,6,,-3,9.5,15,,,,-3,8.5,9","c,cube,1,5,7,,2.5,9.9,-15,,,,2,8.4,2","c,cube,2,5,6,,2.2,,-30,,,,2.7,,2","c,cube,1,2,2,-2.5,-4,-2,,,-40,-3,-3,-2,9","c,cube,3,1,4,-4.5,-3.5,4,,,20,-3,-3,3,9","c,cube,1,2,2,2.5,-4,-2,,,40,3,-3,-2,9","c,cube,3,1,4,4.5,-3.5,4,,,-25,3,-3,3,9"],ee[e.MathUtils.randInt(0,ee.length)]);for(let t=0;t<10;t++){const t=a.clone(!0);t.position.set(10*Math.random()-5,0,0),r.push(t),s.attach(t),t.userData.velocity=new e.Vector3(0,5+3*Math.random(),-5),t.scale.set(0,0,0)}return s.rotation.set(0,0,0),n.attach(s),t.Instance.on("tick",t=>{r.forEach(n=>{if(n.userData.velocity.y-=10*t,n.position.addScaledVector(n.userData.velocity,t),n.position.y<0){const t=new e.Vector3(4*Math.random()-2,0,4*Math.random()-2).sub(n.position).normalize(),r=new e.Quaternion;r.setFromUnitVectors(new e.Vector3(0,0,-1),t),n.quaternion.copy(r),n.position.y=0;const o=new e.Vector3(0,0,-1);o.applyQuaternion(n.quaternion),o.multiplyScalar(5),n.userData.velocity.x=o.x,n.userData.velocity.z=o.z,n.userData.velocity.y=5+6*Math.random()}const r=new e.Quaternion;r.setFromUnitVectors(new e.Vector3(0,0,-1),n.userData.velocity),n.quaternion.copy(r)})}),t.Instance.on("progress",t=>{const n=t.bestComboCount>=4,s=n!==o;r.forEach(t=>{s&&(G.Instance.cancelAnimation(t),G.Instance.animateTransform({mesh:t,end:{scaling:n?te:new e.Vector3(0,0,0)},duration:n?2e3:1e3}))}),o=n}),n})();R.position.set(0,0,-10),oe.attach(R),y.vinyls.forEach((t,n)=>{const r=(({color:t,artist:n,title:r})=>{const o=new e.Group,i=new e.RingGeometry(4,7,32);i.scale(P,P,P);const c=D(t,{glow:!0});o.add(new e.Mesh(i,c));const d=new e.RingGeometry(.25,4,32);d.scale(P,P,P);const u=D(16777215,{});o.add(new e.Mesh(d,u));const h=new e.PlaneGeometry(14,14);h.translate(0,0,.001),h.scale(P,P,P);const p=((t,n)=>{const[r,o]=S();o.fillStyle=l,o.strokeStyle=l,o.lineWidth=8,o.beginPath(),o.arc(512,512,20,0,2*Math.PI),o.stroke(),o.beginPath(),o.arc(512,512,288,0,2*Math.PI),o.stroke(),o.textAlign="center",t&&(o.font="64px monospace",o.textBaseline="middle",o.strokeStyle=l,o.lineWidth=8,o.strokeText(t,512,430.08),o.fillStyle=s,o.fillText(t,512,430.08)),n&&(o.font="96px monospace",o.textBaseline="bottom",o.fillStyle=a,o.strokeText(n,512,696.32),o.fillText(n,512,696.32));const i=new e.CanvasTexture(r);return i.encoding=e.LinearSRGBColorSpace,new e.MeshBasicMaterial({map:i,transparent:!0})})(n,r);o.add(new e.Mesh(h,p));const m=o.clone();return m.rotation.set(0,Math.PI,0),m.position.set(0,0,-.002),o.add(m),o})(t);r.name=`vinyl-${n}`;const o=new e.Vector3(.7,1.15,-.2-.125*n);r.position.copy(o),r.userData.originalPosition=o,r.userData.isPickable=!0,r.userData.recordIndex=n,r.userData.returnToOriginalPosition=()=>{oe.attach(r),G.Instance.cancelAnimation(r),G.Instance.animateTransform({mesh:r,end:{position:r.userData.originalPosition,rotation:new e.Euler(0,0,0)},duration:100})},r.onPointerPick=t=>{if(t.userData.selected)return;if(y.isSolved())return;y.selected[t.id]=n;const o=t.getObjectByName("target");o&&(G.Instance.cancelAnimation(r),o.attach(r),G.Instance.animateTransform({mesh:r,end:{position:new e.Vector3(0,0,0),rotation:new e.Euler(0,Math.PI/2,0)},duration:60}),t.userData.selected=r)},r.onPointerDrop=t=>{if(G.Instance.cancelAnimation(r,!0),r.getWorldPosition(new e.Vector3).distanceTo(k.getWorldPosition(new e.Vector3))<.3)return y.addVinylByIndex(r.userData.recordIndex),delete y.selected[t.id],t.userData.selected=void 0,k.children.forEach(e=>{e.userData.returnToOriginalPosition&&e.userData.returnToOriginalPosition()}),k.attach(r),q(...[1.01,,275,.01,.01,.15,1,1.03,-3.7,,-93,.07,,,,-.1,,.5,.04,.09]),void G.Instance.animateTransform({mesh:r,end:{position:new e.Vector3(0,.01,0),rotation:new e.Euler(-1*Math.PI/2,0,0)},duration:60}).then(()=>{G.Instance.animateTransform({mesh:r,end:{rotation:new e.Euler(-1*Math.PI/2,0,-2*Math.PI)},ease:e=>e,duration:1800,loop:!0})});r.userData.returnToOriginalPosition(),t.userData.selected=void 0},oe.add(r)}),ce=ae.xr.getController(0),ce.addEventListener("connected",fe),ce.addEventListener("selectstart",ge),ce.addEventListener("selectend",ye),ce.addEventListener("squeezestart",ge),ce.addEventListener("squeezeend",ye),oe.add(ce),le=ae.xr.getController(1),le.addEventListener("connected",fe),le.addEventListener("selectstart",ge),le.addEventListener("selectend",ye),le.addEventListener("squeezestart",ge),le.addEventListener("squeezeend",ye),oe.add(le),se=new e.Raycaster,window.addEventListener("resize",Me,!1),t.Instance.on("comboBroken",()=>{$()}),(async()=>{const e=new V;await e.init(j),await e.generate();const n=[];for(let t=0;t<6;t++){const r=176400*t,o=r+176400,s=e.createAudioBufferRange(z,r,o);n.push(s)}const r=e.createAudioBufferRange(z,1058400,1764e3),o=[...n,r];let s=null,a=!1;const i=e=>{let n;s&&(s.stop(),s.disconnect()),n=e<6?e:6;const r=o[n];s=z.createBufferSource(),s.buffer=r,s.connect(z.destination),s.loop=!0,s.start();const c=setInterval(()=>{t.Instance.emit("downbeat"),_!==e&&(clearInterval(c),i(_))},2e3);a=!0};i(_)})(),t.Instance.on("downbeat",()=>{ue>100&&(t.Instance.emit("beat"),ue=0)}),y.reset(),document.getElementById("intro").style.display="none",document.getElementById("c").style.display="block"};function me(){de=ae.xr.getReferenceSpace();const t={x:-1*he.x,y:-1*he.y,z:-1*he.z,w:1},n=new e.Quaternion,r=new XRRigidTransform(t,n),o=de.getOffsetReferenceSpace(r);ae.xr.setReferenceSpace(o)}function fe(t){const n=t.target,r="left"===t.data.handedness?-1:1,o=t.data.hand?0:r*Math.PI/2;if(!n.getObjectByName("target")){const t=new e.Group;t.name="target",t.rotation.set(0,0,0),t.position.set(-1*r*.035,.05,-.12),n.add(t)}let s=n.getObjectByName("paw");s||(s=K(),s.position.set(0,0,.15),s.rotation.set(3*Math.PI/2,o,0),n.add(s));let a=n.getObjectByName("line");if(!a){const t=(new e.BufferGeometry).setFromPoints([new e.Vector3(0,0,0),new e.Vector3(0,0,-1)]);a=new e.Line(t),a.material.color.set(16711680),a.name="line",a.scale.z=5,n.add(a)}}function ge(e){ie=e.target;const t=we(ie);if(t.length>0){let e=!1;t.forEach(({object:t,distance:n})=>{if(e)return;let r=t;for(;r;){if(r.onPointerPick){r.onPointerPick(ie),e=!0,ie.getObjectByName("line").visible=!1;break}r=r.parent}})}ie.userData.targetRayMode=e.data.targetRayMode}function ye(e){ie=e.target;const t=ie.userData.selected;t?.onPointerDrop&&t.onPointerDrop(ie),ie.getObjectByName("line").visible=!0}function we(e){return e.updateMatrixWorld(),se.setFromXRController(e),se.intersectObjects(oe.children,!0)}function be(e){if("screen"===e.userData.targetRayMode)return;if(void 0!==e.userData.selected)return;const t=e.getObjectByName("line"),n=we(e);if(t&&(t.scale.z=5),n.length>0){let e=!1;n.forEach(({object:n,distance:r})=>{if(e)return;let o=n;for(;o;){if(o.userData.isPickable){t&&(t.scale.z=r),e=!0;break}o=o.parent}})}}function ve(){const e=ne.getDelta();ue+=e,ue>=.5&&(t.Instance.emit("beat"),ue-=.5),G.Instance.update(),t.Instance.emit("tick",e),be(ce),be(le),ae.render(oe,re)}const Me=()=>{re.aspect=window.innerWidth/window.innerHeight,re.updateProjectionMatrix(),ae.setSize(window.innerWidth,window.innerHeight)};window.addEventListener("DOMContentLoaded",()=>{document.getElementById("p").onclick=pe});

import*as t from"https://js13kgames.com/2025/webxr/three.module.js";(function(){const o=document.createElement("link").relList;if(o&&o.supports&&o.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))e(s);new MutationObserver(s=>{for(const r of s)if(r.type==="childList")for(const _ of r.addedNodes)_.tagName==="LINK"&&_.rel==="modulepreload"&&e(_)}).observe(document,{childList:!0,subtree:!0});function i(s){const r={};return s.integrity&&(r.integrity=s.integrity),s.referrerPolicy&&(r.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?r.credentials="include":s.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function e(s){if(s.ep)return;s.ep=!0;const r=i(s);fetch(s.href,r)}})();const K=()=>[["cube_case1_1_8_2_7.5_4_0_0_0_0_7.5_4_0_#0000ff","cube_case2_3_9_2_5.5_4.5_0_0_0_0_5.5_4.5_0_#0000ff","cube_case3_8_4_2_0_7_0_0_0_0_0_8.5_0_#0000ff","cube_case4_8_1_2_0_2.5_0_0_0_0_0_2.5_0_#0000ff","cube_case5_3_9_2_-5.5_4.5_0_0_0_0_-5.5_4.5_0_#0000ff","cube_case6_1_8_2_-7.5_4_0_0_0_0_-7.5_4_0_#0000ff"],"cube_base_12_2.1_2.4_0_0.95_0_0_0_0_0_0_0_#ff0000","cube_rightReel_2_2_1_2.72_3.89_0_0_0_-45_2.72_3.89_0_#ff7300","cube_rightTape_4_4_0.2_2.81_3.91_-0.1_0_0_-45_2.81_3.91_-0.1_#c300ff","cube_leftReel_2_2_1_-2.69_3.91_0_0_0_-45_-2.75_4_0_#ff7300","sphere_dot_1_1_1_0_4_0_0_0_0_0_4_0_#9999ff","plane_label_12_3_0_0_7_1.01_90_0_0_0_7_1.01_#d3d3d3","cylinder_base_16_8_16_0_-8_0_0_0_0_0_-8_0_#00ff00"],Q=()=>[["cube_cube_2_1_1_0_0.5_-0.5_0_0_0_0_0_0_#0000ff","cube_cube_0.4_0.1_0.8_0.7_1.05_-0.5_0_0_0_1.5_1_-0.9_#b0ffb0","cube_cube_1.3_0.1_0.3_-0.25_1.05_-0.75_0_0_0_0.5_1_-0.9_#b0ffb0","cube_cube_0.3_0.1_0.4_-0.75_1.05_-0.3_0_0_0_-0.2_1_-0.4_#b0ffb0","cube_tableA_0.4_0.1_0.4_-0.3_1.05_-0.3_0_0_0_0.5_1_-0.7_#b0ffb0","cube_tableB_0.4_0.1_0.4_0.2_1.05_-0.3_0_0_0_1_1_-0.7_#b0ffb0","cylinder_cylinder_0.30000001192092896_0_0.30000001192092896_0.19999999999999998_1.11_-0.30000000000000004_0_0_0_0.19999999999999998_1.11_-0.30000000000000004_#00ff00","cylinder_cylinder_0.30000001192092896_0_0.30000001192092896_-0.30000000000000004_1.11_-0.30000000000000004_0_0_0_-0.30000000000000004_1.11_-0.30000000000000004_#00ff00"],"cube_cube_22_1_19_0_-2.5_-4.5_0_0_0_0_-3_-4_#ff00ff","cube_cube_12_1_12_0_-1.5_-4_0_0_0_0_-2_-4_#ff0000","cube_cube_8_1_3_0_-0.5_0.5_0_0_0_0_-1_-4_#c300ff","cube_pillar_1_4_1_7.5_0_-2.5_0_0_0_8_0_-3_#fffb00","cube_pillar_1_4_1_7.5_0_-6.5_0_0_0_8_0_-7_#fffb00","cube_pillar_1_4_1_7.5_0_-10.5_0_0_0_8_0_-11_#fffb00","cube_pillar_1_4_1_7.5_0_-10.5_0_0_0_8_0_-11_#fffb00","cube_pillar_1_4_1_-7.5_0_-2.5_0_0_0_-7_0_-3_#fffb00","cube_pillar_1_4_1_-7.5_0_1.5_0_0_0_-7_0_1_#fffb00","cube_pillar_1_4_1_7.5_0_1.5_0_0_0_8_0_1_#fffb00","cube_pillar_1_4_1_-7.5_0_-6.5_0_0_0_-7_0_-7_#fffb00","cube_pillar_1_4_1_-7.5_0_-10.5_0_0_0_-7_0_-11_#fffb00","cube_cube_4_1_16_9_2.5_-6_0_0_0_8_2_0_#00ff00","cube_cube_4_1_16_-9_2.5_-6_0_0_0_-10_2_0_#00ff00"],A={uniforms:{uDirLightPos:{value:new t.Vector3},uDirLightColor:{value:new t.Color(15658734)},uAmbientLightColor:{value:new t.Color(328965)},uBaseColor:{value:new t.Color(16777215)},uLineColor1:{value:new t.Color(0)}},vertexShader:`

		varying vec3 vNormal;

		void main() {

			gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
			vNormal = normalize( normalMatrix * normal );

		}`,fragmentShader:`

		uniform vec3 uBaseColor;
		uniform vec3 uLineColor1;
		uniform vec3 uLineColor2;
		uniform vec3 uLineColor3;
		uniform vec3 uLineColor4;

		uniform vec3 uDirLightPos;
		uniform vec3 uDirLightColor;

		uniform vec3 uAmbientLightColor;

		varying vec3 vNormal;

		void main() {

			float directionalLightWeighting = max( dot( normalize(vNormal), uDirLightPos ), 0.0);
			vec3 lightWeighting = uAmbientLightColor + uDirLightColor * directionalLightWeighting;

			gl_FragColor = vec4( uBaseColor, 1.0 );

			if ( length(lightWeighting) < 1.00 ) {

				if ( ( mod(gl_FragCoord.x, 4.001) + mod(gl_FragCoord.y, 4.0) ) > 6.00 ) {

					gl_FragColor = vec4( uLineColor1, 1.0 );

				}

			}

			if ( length(lightWeighting) < 0.50 ) {

				if ( ( mod(gl_FragCoord.x + 2.0, 4.001) + mod(gl_FragCoord.y + 2.0, 4.0) ) > 6.00 ) {

					gl_FragColor = vec4( uLineColor1, 1.0 );

				}

			}

			#include <colorspace_fragment>

		}`},X=a=>{const o=new t.Group;o.position.set(0,0,0),o.rotation.set(0,0,0),o.scale.set(1,1,1);const i=_=>{const[y,d,n,h,g,c,u,b,f,w,C,x,E,S,I]=_.split("_"),l=new t.BoxGeometry(n,h,g);return l.translate(c-x,u-E,b-S),l.rotateX(t.MathUtils.degToRad(f)),l.rotateY(t.MathUtils.degToRad(w)),l.rotateZ(t.MathUtils.degToRad(C)),l},e=_=>{const[y,d,n,h,g,c,u,b,f,w,C,x,E,S,I]=_.split("_"),l=new t.SphereGeometry(parseFloat(n)/2,32,16);return l.scale(n/n,h/n,g/n),l.translate(c-x,u-E,b-S),l.rotateX(t.MathUtils.degToRad(f)),l.rotateY(t.MathUtils.degToRad(w)),l.rotateZ(t.MathUtils.degToRad(C)),l},s=_=>{const[y,d,n,h,g,c,u,b,f,w,C,x,E,S,I]=_.split("_"),l=new t.PlaneGeometry(n,h);return l.rotateX(t.MathUtils.degToRad(-90)),l.translate(c-x,u-E,b-S),l.rotateX(t.MathUtils.degToRad(f)),l.rotateY(t.MathUtils.degToRad(w)),l.rotateZ(t.MathUtils.degToRad(C)),l},r=_=>{const[y,d,n,h,g,c,u,b,f,w,C,x,E,S,I]=_.split("_"),l=n/2,M=new t.CylinderGeometry(l,l,h,32);return M.translate(c-x,u-E,b-S),M.rotateX(t.MathUtils.degToRad(f)),M.rotateY(t.MathUtils.degToRad(w)),M.rotateZ(t.MathUtils.degToRad(C)),M};return a.forEach(_=>{if(Array.isArray(_))o.add(X(_));else{const[y,d,n,h,g,c,u,b,f,w,C,x,E,S,I]=_.split("_");let l=null;switch(y){case"cube":l=i(_);break;case"sphere":l=e(_);break;case"plane":l=s(_);break;case"cylinder":l=r(_);break;default:throw new Error(`Unknown shape: ${y}`)}let M=null;d.startsWith("case")?M=new t.ShaderMaterial({uniforms:{...A.uniforms},vertexShader:A.vertexShader,fragmentShader:A.fragmentShader}):M=new t.MeshStandardMaterial({color:I,side:t.DoubleSide});const G=new t.Mesh(l,M);G.name=d,G.position.set(x,E,S),o.add(G)}}),o},W=a=>{const{radius:o,depth:i,color:e}=a,s=new t.CylinderGeometry(o,o,i,32),r=new t.MeshBasicMaterial({color:e});return new t.Mesh(s,r)},z=a=>{if(a==="cassette"){const o=X(K());return o.name="cassette",o}else if(a==="arena"){const o=X(Q());return o.name="arena",o}return null},$="#e81416",J="#ffa500",ee="#faeb36",te="#79c314",oe="#487de7",ne="#70369d",re="#000000",se="#ff00ff",ie=(a=512)=>{const o=document.createElement("canvas");o.width=a,o.height=a;const i=o.getContext("2d");return[o,i]},D=(a,o,i=!1)=>{let e=0,s=o.findIndex(r=>r===a[0]);for(let r=0;r<a.length&&r<o.length&&a[r]===o[(s+r)%o.length];r++)e++;return e},U=[$,J,ee,te,oe,ne],ae=["OFFSIDE","SHOWCASE","LOADOUT","BACKHAND","BOOKMARKS","MANPOWER"],_e=["Shiny Toy Guns","B.B. King","Jack White","Black Sabbath","Faith Hill","Cliff Sheen"],F=[[0,1,2,3,4,5],[0,2,4,1,5,3],[0,3,5,1,4,2]];class le{constructor(){this.reset()}addVinylByIndex(o){this.queue.unshift(o),this.updateComboCount()}updateComboCount(){const[o,i,e]=F;this.comboCount={color:D(this.queue,[...o].reverse(),!0),artist:D(this.queue,[...i].reverse()),title:D(this.queue,[...e].reverse())},this.solvedCombo={color:this.solvedCombo.color||this.comboCount.color===o.length,artist:this.solvedCombo.artist||this.comboCount.artist===i.length,title:this.solvedCombo.title||this.comboCount.title===e.length}}isSolved(o){return this.solvedCombo[o]}reset(){this.queue=[],this.rack=[],this.selected={};const[o,i,e]=F;this.vinyls=U.map((s,r)=>(this.rack.push(r),{index:r,color:U[o[r]],title:ae[i[r]],artist:_e[e[r]]})),this.comboCount={color:0,artist:0,title:0},this.solvedCombo={color:!1,artist:!1,title:!1}}}class T{static createButton(o,i={}){const e=document.createElement("button");function s(){let n=null;async function h(u){u.addEventListener("end",g),await o.xr.setSession(u),e.textContent="EXIT VR",n=u}function g(){n.removeEventListener("end",g),e.textContent="ENTER VR",n=null}e.style.display="",e.style.cursor="pointer",e.style.left="calc(50% - 50px)",e.style.width="100px",e.textContent="ENTER VR";const c={...i,optionalFeatures:["local-floor","bounded-floor","layers",...i.optionalFeatures||[]]};e.onmouseenter=function(){e.style.opacity="1.0"},e.onmouseleave=function(){e.style.opacity="0.5"},e.onclick=function(){n===null?navigator.xr.requestSession("immersive-vr",c).then(h):(n.end(),navigator.xr.offerSession!==void 0&&navigator.xr.offerSession("immersive-vr",c).then(h).catch(u=>{console.warn(u)}))},navigator.xr.offerSession!==void 0&&navigator.xr.offerSession("immersive-vr",c).then(h).catch(u=>{console.warn(u)})}function r(){e.style.display="",e.style.cursor="auto",e.style.left="calc(50% - 75px)",e.style.width="150px",e.onmouseenter=null,e.onmouseleave=null,e.onclick=null}function _(){r(),e.textContent="VR NOT SUPPORTED"}function y(n){r(),console.warn("Exception when trying to call xr.isSessionSupported",n),e.textContent="VR NOT ALLOWED"}function d(n){n.style.position="absolute",n.style.bottom="20px",n.style.padding="12px 6px",n.style.border="1px solid #fff",n.style.borderRadius="4px",n.style.background="rgba(0,0,0,0.1)",n.style.color="#fff",n.style.font="normal 13px sans-serif",n.style.textAlign="center",n.style.opacity="0.5",n.style.outline="none",n.style.zIndex="999"}if("xr"in navigator)return e.id="VRButton",e.style.display="none",d(e),navigator.xr.isSessionSupported("immersive-vr").then(function(n){n?s():_(),n&&T.xrSessionIsGranted&&e.click()}).catch(y),e;{const n=document.createElement("a");return window.isSecureContext===!1?(n.href=document.location.href.replace(/^http:/,"https:"),n.innerHTML="WEBXR NEEDS HTTPS"):(n.href="https://immersiveweb.dev/",n.innerHTML="WEBXR NOT AVAILABLE"),n.style.left="calc(50% - 90px)",n.style.width="180px",n.style.textDecoration="none",d(n),n}}static registerSessionGrantedListener(){if(typeof navigator<"u"&&"xr"in navigator){if(/WebXRViewer\//i.test(navigator.userAgent))return;navigator.xr.addEventListener("sessiongranted",()=>{T.xrSessionIsGranted=!0})}}}T.xrSessionIsGranted=!1;T.registerSessionGrantedListener();const v=.0254,Y=(a,o)=>{const[e,s]=ie(1024);s.fillStyle=se,s.fillRect(0,0,e.width,e.height),s.fillStyle=re,s.font="64px Helvetica",s.scale(1,o),s.textBaseline="top",s.textAlign="left";let r=64;if(a.length>0){const d=s.measureText(a[0]);r=Math.min(64*960/d.width,1024),s.font=`${r}px Helvetica`}a.forEach((d,n)=>{s.fillText(`${d}`,32,32+r*n)});const _=new t.CanvasTexture(e);return new t.MeshBasicMaterial({map:_})},ce=({color:a,title:o,artist:i})=>{const e=new t.Group,s=new t.RingGeometry(4,7,32);s.scale(v,v,v);const r=new t.MeshStandardMaterial({color:a,side:t.DoubleSide});e.add(new t.Mesh(s,r));const _=new t.RingGeometry(.25,4,32);_.scale(v,v,v);const y=new t.MeshStandardMaterial({color:16777215,side:t.DoubleSide});e.add(new t.Mesh(_,y));const d=new t.PlaneGeometry(5,2);d.translate(0,2,.001),d.scale(v,v,v);const n=Y([i],5/2);e.add(new t.Mesh(d,n));const h=new t.PlaneGeometry(5,2);h.translate(0,-2,.001),h.scale(v,v,v);const g=Y([o],5/2);e.add(new t.Mesh(h,g));const c=e.clone();return c.rotation.set(0,Math.PI,0),c.position.set(0,0,-.002),e.add(c),e};new t.Clock;let P,p,k,m,L,R,B,N,V,O;const de=async()=>{document.getElementById("intro").style.display="none";const o=document.getElementById("c");if(!o)return;o.style.display="block";const i=new le;p=new t.Scene,P=new t.PerspectiveCamera(75,window.innerWidth/window.innerHeight,.1,1e3),P.position.set(0,2,1),P.rotation.set(-1*Math.PI/12,0,0);const e=new t.AmbientLight(16777215,.8);p.add(e);const s=new t.DirectionalLight(16777215,.8);s.position.set(6,10,8),s.castShadow=!0,s.target.position.set(0,0,0),p.add(s),p.add(s.target),O=z("cassette"),O.position.set(0,0,-20),O.userData.isPickable=!0,O.onPointerPick=()=>{console.log("PICK")},O.onPointerMove=()=>{console.log("MOVE")},p.add(O);const r=z("arena"),_=r.getObjectByName("tableA"),y=r.getObjectByName("tableB");[_,y].forEach(u=>{u.onPointerPick=b=>{const f=i.selected[b.id];f&&(i.addVinylByIndex(f),delete i.selected[b.id]),u.userData.loaded=!0}}),p.add(r),i.vinyls.forEach((u,b)=>{const f=ce(u);f.position.set(.7,1.25,-.2-.125*b),f.userData.isPickable=!0,f.userData.recordIndex=b,f.onPointerPick=w=>{console.log("picked",f,w),i.selected[w.id]=b;const C=w.getObjectByName("target");C&&(C.add(f),f.position.set(0,0,0))},p.add(f)}),i.addVinylByIndex(2),console.log(i.comboCount),i.addVinylByIndex(4),console.log(i.comboCount),i.addVinylByIndex(1),console.log(i.comboCount),i.addVinylByIndex(3),console.log(i.comboCount),i.addVinylByIndex(0),console.log(i.comboCount),m=new t.WebGLRenderer({antialias:!0}),m.setPixelRatio(window.devicePixelRatio),m.setSize(window.innerWidth,window.innerHeight),m.setClearColor("#000000"),m.xr.addEventListener("sessionstart",()=>m.xr.getReferenceSpace()),m.xr.enabled=!0,m.setAnimationLoop(ue),document.body.appendChild(T.createButton(m)),document.body.appendChild(m.domElement),R=m.xr.getController(0),R.addEventListener("selectstart",Z),R.addEventListener("selectend",H),p.add(R),B=m.xr.getController(1),B.addEventListener("selectstart",Z),B.addEventListener("selectend",H),p.add(B),N=m.xr.getControllerGrip(0);const d=W({radius:.01,depth:.2,color:16711935});d.name="controllerMesh1",d.rotateX(Math.PI/4),N.add(d),p.add(N),V=m.xr.getControllerGrip(1);const n=W({radius:.01,depth:.2,color:65280});n.rotateX(Math.PI/4),V.add(n),p.add(V);const h=new t.BufferGeometry().setFromPoints([new t.Vector3(0,0,0),new t.Vector3(0,0,-1)]),g=new t.Line(h);g.name="line",g.scale.z=5,R.add(g.clone()),B.add(g.clone());const c=new t.Object3D;c.rotation.set(-1*Math.PI/2,0,0),c.position.set(0,-.05,-.12),c.name="target",R.add(c.clone()),B.add(c.clone()),k=new t.Raycaster,window.addEventListener("resize",fe,!1)};function Z(a){console.log("onSelectStart"),L=a.target;const o=q(L);if(o.length>0){let i=!1;o.forEach(({object:e,distance:s})=>{if(i)return;let r=e;for(;r;){if(r.onPointerPick){r.onPointerPick(L),i=!0;break}r=r.parent}})}L.userData.targetRayMode=a.data.targetRayMode}function H(a){console.log("onSelectEnd"),L=a.target,L.userData.selected!==void 0&&(L.userData.selected,L.userData.selected=void 0)}function q(a){return a.updateMatrixWorld(),k.setFromXRController(a),k.intersectObjects(p.children,!0)}function j(a){if(a.userData.targetRayMode==="screen"||a.userData.selected!==void 0)return;const o=a.getObjectByName("line"),i=q(a);if(o.scale.z=5,i.length>0){let e=!1;i.forEach(({object:s,distance:r})=>{if(e)return;let _=s;for(;_;){if(_.userData.isPickable){o.scale.z=r,e=!0;break}_=_.parent}})}}function ue(){O.rotation.y+=.005,j(R),j(B),m.render(p,P)}const fe=()=>{P.aspect=window.innerWidth/window.innerHeight,P.updateProjectionMatrix(),m.setSize(window.innerWidth,window.innerHeight)};window.addEventListener("DOMContentLoaded",()=>{const a=document.getElementById("playButton");a.onclick=de});

import*as e from"https://js13kgames.com/2025/webxr/three.module.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))o(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const c of r.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&o(c)}).observe(document,{childList:!0,subtree:!0});function n(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function o(i){if(i.ep)return;i.ep=!0;const r=n(i);fetch(i.href,r)}})();const J=()=>[["cube_case1_1_8_2_7.5_4_0_0_0_0_7.5_4_0_#0000ff","cube_case2_3_9_2_5.5_4.5_0_0_0_0_5.5_4.5_0_#0000ff","cube_case3_8_4_2_0_7_0_0_0_0_0_8.5_0_#0000ff","cube_case4_8_1_2_0_2.5_0_0_0_0_0_2.5_0_#0000ff","cube_case5_3_9_2_-5.5_4.5_0_0_0_0_-5.5_4.5_0_#0000ff","cube_case6_1_8_2_-7.5_4_0_0_0_0_-7.5_4_0_#0000ff"],"cube_base_12_2.1_2.4_0_0.95_0_0_0_0_0_0_0_#ff0000","cube_rightReel_2_2_1_2.72_3.89_0_0_0_-45_2.72_3.89_0_#ff7300","cube_rightTape_4_4_0.2_2.81_3.91_-0.1_0_0_-45_2.81_3.91_-0.1_#c300ff","cube_leftReel_2_2_1_-2.69_3.91_0_0_0_-45_-2.75_4_0_#ff7300","sphere_dot_1_1_1_0_4_0_0_0_0_0_4_0_#9999ff","plane_label_12_3_0_0_7_1.01_90_0_0_0_7_1.01_#d3d3d3","cylinder_base_16_8_16_0_-8_0_0_0_0_0_-8_0_#00ff00"],ee=()=>[["cube_cube_2_1_1_0_0.5_-0.5_0_0_0_0_0_0_#fffb00","cube_cube_0.4_0.1_0.8_0.7_1.05_-0.5_0_0_0_0.7_1.05_-0.5_#b0ffb0","cube_cube_1.3_0.1_0.3_-0.25_1.05_-0.75_0_0_0_-0.25_1.05_-0.75_#d3d3d3","cube_cube_0.3_0.1_0.4_-0.75_1.05_-0.3_0_0_0_-0.75_1.05_-0.3_#9999ff","cube_cube_0.4_0.1_0.4_-0.3_1.05_-0.3_0_0_0_-0.35_1.05_-0.3_#d3d3d3","cube_tableA_0.4_0.1_0.4_0.2_1.05_-0.3_0_0_0_0.2_1.05_-0.3_#b0ffb0","cylinder_cylinder_0.30000001192092896_0_0.30000001192092896_0.19999999999999998_1.1100000000000003_-0.2999999999999998_0_0_0_0.19999999999999998_1.1100000000000003_-0.2999999999999998_#00ff00"],"cube_cube_22_1_19_0_-2.5_-4.5_0_0_0_0_-3_-4_#ff00ff","cube_cube_12_1_12_0_-1.5_-4_0_0_0_0_-2_-4_#ff0000","cube_cube_8_1_3_0_-0.5_0.5_0_0_0_0_-1_-4_#c300ff","cube_pillar_1_4_1_7.5_0_-2.5_0_0_0_8_0_-3_#fffb00","cube_pillar_1_4_1_7.5_0_-6.5_0_0_0_8_0_-7_#fffb00","cube_pillar_1_4_1_7.5_0_-10.5_0_0_0_8_0_-11_#fffb00","cube_pillar_1_4_1_7.5_0_-10.5_0_0_0_8_0_-11_#fffb00","cube_pillar_1_4_1_-7.5_0_-2.5_0_0_0_-7_0_-3_#fffb00","cube_pillar_1_4_1_-7.5_0_1.5_0_0_0_-7_0_1_#fffb00","cube_pillar_1_4_1_7.5_0_1.5_0_0_0_8_0_1_#fffb00","cube_pillar_1_4_1_-7.5_0_-6.5_0_0_0_-7_0_-7_#fffb00","cube_pillar_1_4_1_-7.5_0_-10.5_0_0_0_-7_0_-11_#fffb00","cube_cube_4_1_16_9_2.5_-6_0_0_0_8_2_0_#00ff00","cube_cube_4_1_16_-9_2.5_-6_0_0_0_-10_2_0_#00ff00"],z={uniforms:{uDirLightPos:{value:new e.Vector3},uDirLightColor:{value:new e.Color(15658734)},uAmbientLightColor:{value:new e.Color(328965)},uBaseColor:{value:new e.Color(16777215)},uLineColor1:{value:new e.Color(0)}},vertexShader:`

		varying vec3 vNormal;

		void main() {

			gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
			vNormal = normalize( normalMatrix * normal );

		}`,fragmentShader:`

		uniform vec3 uBaseColor;
		uniform vec3 uLineColor1;
		uniform vec3 uLineColor2;
		uniform vec3 uLineColor3;
		uniform vec3 uLineColor4;

		uniform vec3 uDirLightPos;
		uniform vec3 uDirLightColor;

		uniform vec3 uAmbientLightColor;

		varying vec3 vNormal;

		void main() {

			float directionalLightWeighting = max( dot( normalize(vNormal), uDirLightPos ), 0.0);
			vec3 lightWeighting = uAmbientLightColor + uDirLightColor * directionalLightWeighting;

			gl_FragColor = vec4( uBaseColor, 1.0 );

			if ( length(lightWeighting) < 1.00 ) {

				if ( ( mod(gl_FragCoord.x, 4.001) + mod(gl_FragCoord.y, 4.0) ) > 6.00 ) {

					gl_FragColor = vec4( uLineColor1, 1.0 );

				}

			}

			if ( length(lightWeighting) < 0.50 ) {

				if ( ( mod(gl_FragCoord.x + 2.0, 4.001) + mod(gl_FragCoord.y + 2.0, 4.0) ) > 6.00 ) {

					gl_FragColor = vec4( uLineColor1, 1.0 );

				}

			}

			#include <colorspace_fragment>

		}`},F=a=>{const t=new e.Group;t.position.set(0,0,0),t.rotation.set(0,0,0),t.scale.set(1,1,1);const n=c=>{const[h,d,s,u,p,g,f,l,w,m,v,x,S,M,D]=c.split("_"),_=new e.BoxGeometry(s,u,p);return _.translate(g-x,f-S,l-M),_.rotateX(e.MathUtils.degToRad(w)),_.rotateY(e.MathUtils.degToRad(m)),_.rotateZ(e.MathUtils.degToRad(v)),_},o=c=>{const[h,d,s,u,p,g,f,l,w,m,v,x,S,M,D]=c.split("_"),_=new e.SphereGeometry(parseFloat(s)/2,32,16);return _.scale(s/s,u/s,p/s),_.translate(g-x,f-S,l-M),_.rotateX(e.MathUtils.degToRad(w)),_.rotateY(e.MathUtils.degToRad(m)),_.rotateZ(e.MathUtils.degToRad(v)),_},i=c=>{const[h,d,s,u,p,g,f,l,w,m,v,x,S,M,D]=c.split("_"),_=new e.PlaneGeometry(s,u);return _.rotateX(e.MathUtils.degToRad(-90)),_.translate(g-x,f-S,l-M),_.rotateX(e.MathUtils.degToRad(w)),_.rotateY(e.MathUtils.degToRad(m)),_.rotateZ(e.MathUtils.degToRad(v)),_},r=c=>{const[h,d,s,u,p,g,f,l,w,m,v,x,S,M,D]=c.split("_"),_=s/2,L=new e.CylinderGeometry(_,_,u,32);return L.translate(g-x,f-S,l-M),L.rotateX(e.MathUtils.degToRad(w)),L.rotateY(e.MathUtils.degToRad(m)),L.rotateZ(e.MathUtils.degToRad(v)),L};return a.forEach(c=>{if(Array.isArray(c))t.add(F(c));else{const[h,d,s,u,p,g,f,l,w,m,v,x,S,M,D]=c.split("_");let _=null;switch(h){case"cube":_=n(c);break;case"sphere":_=o(c);break;case"plane":_=i(c);break;case"cylinder":_=r(c);break;default:throw new Error(`Unknown shape: ${h}`)}let L=null;d.startsWith("case")?L=new e.ShaderMaterial({uniforms:{...z.uniforms},vertexShader:z.vertexShader,fragmentShader:z.fragmentShader}):L=new e.MeshStandardMaterial({color:D,side:e.DoubleSide});const N=new e.Mesh(_,L);N.name=d,N.position.set(x,S,M),t.add(N)}}),t},Y=a=>{const{radius:t,depth:n,color:o}=a,i=new e.CylinderGeometry(t,t,n,32),r=new e.MeshBasicMaterial({color:o});return new e.Mesh(i,r)},Z=a=>{if(a==="cassette"){const t=F(J());return t.name="cassette",t}else if(a==="arena"){const t=F(ee());return t.name="arena",t}return null},te="#e81416",ne="#ffa500",oe="#faeb36",re="#79c314",se="#487de7",ie="#70369d",ae="#000000",ce="#ff00ff",_e=(a,t,n)=>Math.min(Math.max(a,t),n),le=(a=512)=>{const t=document.createElement("canvas");t.width=a,t.height=a;const n=t.getContext("2d");return[t,n]},V=(a,t,n=!1)=>{let o=0,i=t.findIndex(r=>r===a[0]);for(let r=0;r<a.length&&r<t.length&&a[r]===t[(i+r)%t.length];r++)o++;return o},H=[te,ne,oe,re,se,ie],de=["OFFSIDE","SHOWCASE","LOADOUT","BACKHAND","BOOKMARKS","MANPOWER"],ue=["Shiny Toy Guns","B.B. King","Jack White","Black Sabbath","Faith Hill","Cliff Sheen"],Q=[[0,1,2,3,4,5],[0,2,4,1,5,3],[0,3,5,1,4,2]];class fe{constructor(){this.reset()}addVinylByIndex(t){this.queue.unshift(t),this.updateComboCount()}updateComboCount(){const[t,n,o]=Q;this.comboCount={color:V(this.queue,[...t].reverse(),!0),artist:V(this.queue,[...n].reverse()),title:V(this.queue,[...o].reverse())},this.solvedCombo={color:this.solvedCombo.color||this.comboCount.color===t.length,artist:this.solvedCombo.artist||this.comboCount.artist===n.length,title:this.solvedCombo.title||this.comboCount.title===o.length}}isSolved(t){return this.solvedCombo[t]}reset(){this.queue=[],this.rack=[],this.selected={};const[t,n,o]=Q;this.vinyls=H.map((i,r)=>(this.rack.push(r),{index:r,color:H[t[r]],title:de[n[r]],artist:ue[o[r]]})),this.comboCount={color:0,artist:0,title:0},this.solvedCombo={color:!1,artist:!1,title:!1}}}class I{static createButton(t,n={}){const o=document.createElement("button");function i(){let s=null;async function u(f){f.addEventListener("end",p),await t.xr.setSession(f),o.textContent="EXIT VR",s=f}function p(){s.removeEventListener("end",p),o.textContent="ENTER VR",s=null}o.style.display="",o.style.cursor="pointer",o.style.left="calc(50% - 50px)",o.style.width="100px",o.textContent="ENTER VR";const g={...n,optionalFeatures:["local-floor","bounded-floor","layers",...n.optionalFeatures||[]]};o.onmouseenter=function(){o.style.opacity="1.0"},o.onmouseleave=function(){o.style.opacity="0.5"},o.onclick=function(){s===null?navigator.xr.requestSession("immersive-vr",g).then(u):(s.end(),navigator.xr.offerSession!==void 0&&navigator.xr.offerSession("immersive-vr",g).then(u).catch(f=>{console.warn(f)}))},navigator.xr.offerSession!==void 0&&navigator.xr.offerSession("immersive-vr",g).then(u).catch(f=>{console.warn(f)})}function r(){o.style.display="",o.style.cursor="auto",o.style.left="calc(50% - 75px)",o.style.width="150px",o.onmouseenter=null,o.onmouseleave=null,o.onclick=null}function c(){r(),o.textContent="VR NOT SUPPORTED"}function h(s){r(),console.warn("Exception when trying to call xr.isSessionSupported",s),o.textContent="VR NOT ALLOWED"}function d(s){s.style.position="absolute",s.style.bottom="20px",s.style.padding="12px 6px",s.style.border="1px solid #fff",s.style.borderRadius="4px",s.style.background="rgba(0,0,0,0.1)",s.style.color="#fff",s.style.font="normal 13px sans-serif",s.style.textAlign="center",s.style.opacity="0.5",s.style.outline="none",s.style.zIndex="999"}if("xr"in navigator)return o.id="VRButton",o.style.display="none",d(o),navigator.xr.isSessionSupported("immersive-vr").then(function(s){s?i():c(),s&&I.xrSessionIsGranted&&o.click()}).catch(h),o;{const s=document.createElement("a");return window.isSecureContext===!1?(s.href=document.location.href.replace(/^http:/,"https:"),s.innerHTML="WEBXR NEEDS HTTPS"):(s.href="https://immersiveweb.dev/",s.innerHTML="WEBXR NOT AVAILABLE"),s.style.left="calc(50% - 90px)",s.style.width="180px",s.style.textDecoration="none",d(s),s}}static registerSessionGrantedListener(){if(typeof navigator<"u"&&"xr"in navigator){if(/WebXRViewer\//i.test(navigator.userAgent))return;navigator.xr.addEventListener("sessiongranted",()=>{I.xrSessionIsGranted=!0})}}}I.xrSessionIsGranted=!1;I.registerSessionGrantedListener();const E=.0254,j=(a,t)=>{const[o,i]=le(1024);i.fillStyle=ce,i.fillRect(0,0,o.width,o.height),i.fillStyle=ae,i.font="64px Helvetica",i.scale(1,t),i.textBaseline="top",i.textAlign="left";let r=64;if(a.length>0){const d=i.measureText(a[0]);r=Math.min(64*960/d.width,1024),i.font=`${r}px Helvetica`}a.forEach((d,s)=>{i.fillText(`${d}`,32,32+r*s)});const c=new e.CanvasTexture(o);return new e.MeshBasicMaterial({map:c})},he=({color:a,title:t,artist:n})=>{const o=new e.Group,i=new e.RingGeometry(4,7,32);i.scale(E,E,E);const r=new e.MeshStandardMaterial({color:a,side:e.DoubleSide});o.add(new e.Mesh(i,r));const c=new e.RingGeometry(.25,4,32);c.scale(E,E,E);const h=new e.MeshStandardMaterial({color:16777215,side:e.DoubleSide});o.add(new e.Mesh(c,h));const d=new e.PlaneGeometry(5,2);d.translate(0,2,.001),d.scale(E,E,E);const s=j([n],5/2);o.add(new e.Mesh(d,s));const u=new e.PlaneGeometry(5,2);u.translate(0,-2,.001),u.scale(E,E,E);const p=j([t],5/2);o.add(new e.Mesh(u,p));const g=o.clone();return g.rotation.set(0,Math.PI,0),g.position.set(0,0,-.002),o.add(g),o},ge=a=>a*a;class C{constructor(){this.animations=[],this.scene=null,this.clock=new e.Clock}static get Instance(){return C._instance||(C._instance=new C),C._instance}initScene(t){this.scene||(this.scene=t,this.clock.start())}update(){const t=this.clock.getElapsedTime()*1e3;this.animations=this.animations.filter(n=>{const o=t-n.startTime,i=n.endTime-n.startTime,r=_e(o/i,0,1);if(t>=n.endTime)return n.end.position&&n.mesh.position.copy(n.end.position),n.end.rotation&&n.mesh.rotation.copy(n.end.rotation),n.end.scaling&&n.mesh.scale.copy(n.end.scaling),!1;if(n.end.position&&n.mesh.position.lerpVectors(n.start.position,n.end.position,n.easeFunc(r)),n.end.rotation){const c=new e.Quaternion().setFromEuler(n.start.rotation),h=new e.Quaternion().setFromEuler(n.end.rotation),d=new e.Quaternion;d.slerpQuaternions(c,h,n.easeFunc(r)),n.mesh.rotation.setFromQuaternion(d)}return n.end.scaling&&n.mesh.scale.lerpVectors(n.start.scaling,n.end.scaling,n.easeFunc(r)),!0})}animateTransform(t){const{mesh:n,end:o}=t,i=t.duration||1e3,r=t.delay||0,c=t.ease||ge,h=this.clock.getElapsedTime()*1e3;this.animations.push({mesh:n,start:{position:n.position.clone(),rotation:n.rotation.clone(),scaling:n.scale.clone()},end:o,easeFunc:c,startTime:h+r,endTime:h+r+i})}}new e.Clock;let O,y,U,b,P,R,T,X,k,B,q;const W=new e.Vector3(0,0,.3),pe=async()=>{document.getElementById("intro").style.display="none";const t=document.getElementById("c");if(!t)return;t.style.display="block";const n=new fe;y=new e.Scene,O=new e.PerspectiveCamera(75,window.innerWidth/window.innerHeight,.1,1e3),O.position.set(0,2,1),O.rotation.set(-1*Math.PI/12,0,0),C.Instance.initScene(y);const o=new e.AmbientLight(16777215,.8);y.add(o);const i=new e.DirectionalLight(16777215,.8);i.position.set(6,10,8),i.castShadow=!0,i.target.position.set(0,0,0),y.add(i),y.add(i.target),B=Z("cassette"),B.position.set(0,0,-20),B.userData.isPickable=!0,y.add(B);const r=Z("arena"),c=r.getObjectByName("tableA");y.add(r),n.vinyls.forEach((g,f)=>{const l=he(g);l.name=`vinyl-${f}`;const w=new e.Vector3(.7,1.25,-.2-.125*f);l.position.copy(w),l.userData.originalPosition=w,l.userData.isPickable=!0,l.userData.recordIndex=f,l.onPointerPick=m=>{if(m.userData.selected)return;n.selected[m.id]=f;const v=m.getObjectByName("target");v&&(v.attach(l),C.Instance.animateTransform({mesh:l,end:{position:new e.Vector3(0,0,0),rotation:new e.Euler(0,0,0)},duration:60}),m.userData.selected=l)},l.onPointerDrop=m=>{if(l.getWorldPosition(new e.Vector3).distanceTo(c.getWorldPosition(new e.Vector3))<.3){n.addVinylByIndex(l.userData.recordIndex),delete n.selected[m.id],m.userData.selected=void 0,c.attach(l),C.Instance.animateTransform({mesh:l,end:{position:new e.Vector3(0,.1,0),rotation:new e.Euler(-1*Math.PI/2,0,0)},duration:60});return}else y.attach(l),C.Instance.animateTransform({mesh:l,end:{position:w,rotation:new e.Euler},duration:60}),m.userData.selected=void 0},y.add(l)}),b=new e.WebGLRenderer({antialias:!0}),b.setPixelRatio(window.devicePixelRatio),b.setSize(window.innerWidth,window.innerHeight),b.setClearColor("#000000"),b.xr.addEventListener("sessionstart",me),b.xr.enabled=!0,b.setAnimationLoop(be),document.body.appendChild(I.createButton(b)),document.body.appendChild(b.domElement),R=b.xr.getController(0),R.addEventListener("selectstart",G),R.addEventListener("selectend",A),R.addEventListener("squeezestart",G),R.addEventListener("squeezeend",A),y.add(R),T=b.xr.getController(1),T.addEventListener("selectstart",G),T.addEventListener("selectend",A),T.addEventListener("squeezestart",G),T.addEventListener("squeezeend",A),y.add(T),X=b.xr.getControllerGrip(0);const h=Y({radius:.01,depth:.2,color:16711935});h.name="controllerMesh1",h.rotateX(Math.PI/4),X.add(h),y.add(X),k=b.xr.getControllerGrip(1);const d=Y({radius:.01,depth:.2,color:65280});d.rotateX(Math.PI/4),k.add(d),y.add(k);const s=new e.BufferGeometry().setFromPoints([new e.Vector3(0,0,0),new e.Vector3(0,0,-1)]),u=new e.Line(s);u.name="line",u.scale.z=5,R.add(u.clone()),T.add(u.clone());const p=new e.Group;p.rotation.set(-1*Math.PI/2,0,0),p.position.set(0,-.05,-.12),p.name="target",R.add(p.clone()),T.add(p.clone()),U=new e.Raycaster,window.addEventListener("resize",ye,!1)};function me(){q=b.xr.getReferenceSpace();const a={x:-1*W.x,y:-1*W.y,z:-1*W.z,w:1},t=new e.Quaternion,n=new XRRigidTransform(a,t),o=q.getOffsetReferenceSpace(n);b.xr.setReferenceSpace(o)}function G(a){P=a.target;const t=$(P);if(t.length>0){let n=!1;t.forEach(({object:o,distance:i})=>{if(n)return;let r=o;for(;r;){if(r.onPointerPick){r.onPointerPick(P),n=!0;break}r=r.parent}})}P.userData.targetRayMode=a.data.targetRayMode}function A(a){P=a.target;const t=P.userData.selected;t?.onPointerDrop&&t.onPointerDrop(P)}function $(a){return a.updateMatrixWorld(),U.setFromXRController(a),U.intersectObjects(y.children,!0)}function K(a){if(a.userData.targetRayMode==="screen"||a.userData.selected!==void 0)return;const t=a.getObjectByName("line"),n=$(a);if(t.scale.z=5,n.length>0){let o=!1;n.forEach(({object:i,distance:r})=>{if(o)return;let c=i;for(;c;){if(c.userData.isPickable){t.scale.z=r,o=!0;break}c=c.parent}})}}function be(){C.Instance.update(),B.rotation.y+=.005,K(R),K(T),b.render(y,O)}const ye=()=>{O.aspect=window.innerWidth/window.innerHeight,O.updateProjectionMatrix(),b.setSize(window.innerWidth,window.innerHeight)};window.addEventListener("DOMContentLoaded",()=>{const a=document.getElementById("playButton");a.onclick=pe});

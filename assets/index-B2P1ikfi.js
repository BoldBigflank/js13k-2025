import*as n from"https://js13kgames.com/2025/webxr/three.module.js";(function(){const r=document.createElement("link").relList;if(r&&r.supports&&r.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))o(t);new MutationObserver(t=>{for(const s of t)if(s.type==="childList")for(const c of s.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&o(c)}).observe(document,{childList:!0,subtree:!0});function e(t){const s={};return t.integrity&&(s.integrity=t.integrity),t.referrerPolicy&&(s.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?s.credentials="include":t.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function o(t){if(t.ep)return;t.ep=!0;const s=e(t);fetch(t.href,s)}})();const ge=()=>[["cube_case1_1_8_2_7.50_4_0_0_0_0_7.50_4_0_#0000ff","cube_case2_3_9_2_5.50_4.50_0_0_0_0_5.50_4.50_0_#0000ff","cube_case3_8_4_2_0_7_0_0_0_0_0_8.50_0_#0000ff","cube_case4_8_1_2_0_2.50_0_0_0_0_0_2.50_0_#0000ff","cube_case5_3_9_2_-5.50_4.50_0_0_0_0_-5.50_4.50_0_#0000ff","cube_case6_1_8_2_-7.50_4_0_0_0_0_-7.50_4_0_#0000ff"],"cube_base_12_2.10_2.40_0_0.95_0_0_0_0_0_0_0_#ff0000","cube_rightReel_2_2_1_2.72_3.89_0_0_0_-45_2.72_3.89_0_#ff7300","cube_rightTape_4_4_0.20_2.81_3.91_-0.10_0_0_-45_2.81_3.91_-0.10_#c300ff","cube_leftReel_2_2_1_-2.69_3.91_0_0_0_-45_-2.75_4_0_#ff7300","sphere_dot_1_1_1_0_4_0_0_0_0_0_4_0_#9999ff","plane_label_12_3_0_0_7_1.01_90_0_0_0_7_1.01_#d3d3d3","cylinder_base_16_8_16_0_-4_0_0_0_0_0_-4_0_#00ff00"],ye=()=>[[["cube_complete-0_0.3_0.1_0.1_-0.75_1.05_-0.45_0_0_0_-0.75_1.05_-0.45_#ff0000","cube_complete-1_0.3_0.1_0.1_-0.75_1.05_-0.35_0_0_0_-0.75_1.05_-0.35_#00ff00","cube_complete-2_0.3_0.1_0.1_-0.75_1.05_-0.25_0_0_0_-0.75_1.05_-0.25_#0000ff"],["sphere_progress-0_0.2_0.2_0.2_-0.75_1.05_-0.75_0_0_0_-0.75_1.05_-0.75_#fffb00","sphere_progress-1_0.2_0.2_0.2_-0.55_1.05_-0.75_0_0_0_-0.55_1.05_-0.75_#fffb00","sphere_progress-2_0.2_0.2_0.2_-0.35_1.05_-0.75_0_0_0_-0.35_1.05_-0.75_#fffb00","sphere_progress-3_0.2_0.2_0.2_-0.15_1.05_-0.75_0_0_0_-0.15_1.05_-0.75_#fffb00","sphere_progress-4_0.2_0.2_0.2_0.05_1.05_-0.75_0_0_0_0.05_1.05_-0.75_#fffb00","sphere_progress-5_0.2_0.2_0.2_0.25_1.05_-0.75_0_0_0_0.25_1.05_-0.75_#fffb00"],"cube_desk_2_0.9_1_0_0.45_-0.5_0_0_0_0_-0.1_0_#fffb00","cube_record-rack_0.4_0.1_0.8_0.7_0.95_-0.5_0_0_0_0.7_0.95_-0.5_#b0ffb0","cube_progress-bar_1.3_0.1_0.3_-0.25_0.95_-0.75_0_0_0_-0.25_0.95_-0.75_#d3d3d3","cube_cube_0.3_0.1_0.4_-0.75_0.95_-0.3_0_0_0_-0.75_0.95_-0.3_#9999ff","cube_cube_0.4_0.1_0.4_-0.3_0.95_-0.3_0_0_0_-0.3_0.95_-0.3_#d3d3d3","cube_tableA_0.4_0.1_0.4_0.2_0.95_-0.3_0_0_0_0.2_1.01_-0.3_#b0ffb0","cylinder_pad_0.4_0.02_0.4_0.2_1_-0.3_0_0_0_0.2_1_-0.3_#ff0000"],"cube_cube_22_1_19_0_-2.5_-4.5_0_0_0_0_-3_-4_#ff00ff","cube_cube_12_1_12_0_-1.5_-4_0_0_0_0_-2_-4_#ff0000","cube_cube_8_1_3_0_-0.5_0.5_0_0_0_0_-1_-4_#c300ff","cube_pillar_1_4_1_7.5_0_-2.5_0_0_0_8_0_-3_#fffb00","cube_pillar_1_4_1_7.5_0_-6.5_0_0_0_8_0_-7_#fffb00","cube_pillar_1_4_1_7.5_0_-10.5_0_0_0_8_0_-11_#fffb00","cube_pillar_1_4_1_7.5_0_-10.5_0_0_0_8_0_-11_#fffb00","cube_pillar_1_4_1_-7.5_0_-2.5_0_0_0_-7_0_-3_#fffb00","cube_pillar_1_4_1_-7.5_0_1.5_0_0_0_-7_0_1_#fffb00","cube_pillar_1_4_1_7.5_0_1.5_0_0_0_8_0_1_#fffb00","cube_pillar_1_4_1_-7.5_0_-6.5_0_0_0_-7_0_-7_#fffb00","cube_pillar_1_4_1_-7.5_0_-10.5_0_0_0_-7_0_-11_#fffb00","cube_cube_4_1_16_9_2.5_-6_0_0_0_8_2_0_#00ff00","cube_cube_4_1_16_-9_2.5_-6_0_0_0_-10_2_0_#00ff00"],me=()=>["sphere_head_16_16_16_0_8_0_0_0_0_0_8_0_#c300ff",["cylinder_leftEye_4_1_4_-3_11_-6.3_-60_0_25_-3_11_-6.3_#fffb00","sphere_leftPupil_2_2_4_-3.6_11.3_-7_-60_0_25_-3.6_11.3_-7_#c300ff","cylinder_rightEye_4_1_4_3_11_-6.3_-60_0_-25_3_11_-6.3_#fffb00","sphere_rightPupil_2_2_4_3.4_11.3_-7_-60_0_-25_3.4_11.3_-7_#c300ff"],["cube_rightCheek_3_3_2_1.84_6.53_-7.5_-25_0_80_1.84_6.53_-7.5_#0000ff","cube_leftCheek_3_3_2_-1.91_6.48_-7.5_0_23_10_-1.91_6.48_-7.5_#0000ff","cube_tongue_2_2_2_0_5_-7_0_0_0_0_4_-7_#ff0000","pyramid_pyramid_3_1.6_1_0_8.2_-8_-180_0_0_0_8.2_-8_#ff00ff"],["pyramid_ear_6_11_4_-4.86_15.55_-1.28_-14_-6_24_-4.86_15.55_-1.28_#c300ff","pyramid_ear_5_9.5_4_-5.04_15.94_-1.59_-14_-6_24_-5.04_15.94_-1.59_#fffb00","pyramid_ear_6_11_4_4.86_15.55_-1.28_-14_6_-24_4.86_15.55_-1.28_#c300ff","pyramid_ear_5_9.5_4_5.04_15.94_-1.59_-14_6_-24_5.04_15.94_-1.59_#fffb00"],["cylinder_cylinder_0.2_6_0.2_-3.93_6_-8.92_0_-15_90_-3.93_6_-8.92_#d3d3d3","cylinder_cylinder_0.2_4_0.2_-4.87_7.52_-8.5_0_-15_75_-4.87_7.52_-8.5_#d3d3d3","cylinder_cylinder_0.2_4_0.2_-4.87_4.48_-8.5_0_-15_105_-4.87_4.48_-8.5_#d3d3d3","cylinder_cylinder_0.2_4_0.2_4.87_7.52_-8.5_180_-15_-105_4.87_7.52_-8.5_#d3d3d3","cylinder_cylinder_0.2_6_0.2_3.93_6_-8.92_0_-165_90_3.93_6_-8.92_#d3d3d3","cylinder_cylinder_0.2_4_0.2_4.87_4.48_-8.5_180_-15_-75_4.87_4.48_-8.5_#d3d3d3"]],$={uniforms:{uDirLightPos:{value:new n.Vector3},uDirLightColor:{value:new n.Color(15658734)},uAmbientLightColor:{value:new n.Color(328965)},uBaseColor:{value:new n.Color(16777215)},uLineColor1:{value:new n.Color(0)}},vertexShader:`

		varying vec3 vNormal;

		void main() {

			gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
			vNormal = normalize( normalMatrix * normal );

		}`,fragmentShader:`

		uniform vec3 uBaseColor;
		uniform vec3 uLineColor1;
		uniform vec3 uLineColor2;
		uniform vec3 uLineColor3;
		uniform vec3 uLineColor4;

		uniform vec3 uDirLightPos;
		uniform vec3 uDirLightColor;

		uniform vec3 uAmbientLightColor;

		varying vec3 vNormal;

		void main() {

			float directionalLightWeighting = max( dot( normalize(vNormal), uDirLightPos ), 0.0);
			vec3 lightWeighting = uAmbientLightColor + uDirLightColor * directionalLightWeighting;

			gl_FragColor = vec4( uBaseColor, 1.0 );

			if ( length(lightWeighting) < 1.00 ) {

				if ( ( mod(gl_FragCoord.x, 4.001) + mod(gl_FragCoord.y, 4.0) ) > 6.00 ) {

					gl_FragColor = vec4( uLineColor1, 1.0 );

				}

			}

			if ( length(lightWeighting) < 0.50 ) {

				if ( ( mod(gl_FragCoord.x + 2.0, 4.001) + mod(gl_FragCoord.y + 2.0, 4.0) ) > 6.00 ) {

					gl_FragColor = vec4( uLineColor1, 1.0 );

				}

			}

			#include <colorspace_fragment>

		}`},q=i=>{const r=new n.Group;r.position.set(0,0,0),r.rotation.set(0,0,0),r.scale.set(1,1,1);const e=a=>{const[f,_,u,b,w,x,E,M,p,y,l,g,d,m,R]=a.split("_"),h=u/2,v=new n.CylinderGeometry(0,h,b,4);return v.scale(1,1,w/u),v.translate(x-g,E-d,M-m),v.rotateX(n.MathUtils.degToRad(p)),v.rotateY(n.MathUtils.degToRad(y)),v.rotateZ(n.MathUtils.degToRad(l)),v},o=a=>{const[f,_,u,b,w,x,E,M,p,y,l,g,d,m,R]=a.split("_"),h=new n.BoxGeometry(u,b,w);return h.translate(x-g,E-d,M-m),h.rotateX(n.MathUtils.degToRad(p)),h.rotateY(n.MathUtils.degToRad(y)),h.rotateZ(n.MathUtils.degToRad(l)),h},t=a=>{const[f,_,u,b,w,x,E,M,p,y,l,g,d,m,R]=a.split("_"),h=new n.SphereGeometry(parseFloat(u)/2,32,16);return h.scale(u/u,b/u,w/u),h.translate(x-g,E-d,M-m),h.rotateX(n.MathUtils.degToRad(p)),h.rotateY(n.MathUtils.degToRad(y)),h.rotateZ(n.MathUtils.degToRad(l)),h},s=a=>{const[f,_,u,b,w,x,E,M,p,y,l,g,d,m,R]=a.split("_"),h=new n.PlaneGeometry(u,b);return h.rotateX(n.MathUtils.degToRad(-90)),h.translate(x-g,E-d,M-m),h.rotateX(n.MathUtils.degToRad(p)),h.rotateY(n.MathUtils.degToRad(y)),h.rotateZ(n.MathUtils.degToRad(l)),h},c=a=>{const[f,_,u,b,w,x,E,M,p,y,l,g,d,m,R]=a.split("_"),h=u/2,v=new n.CylinderGeometry(h,h,b,32);return v.translate(x-g,E-d,M-m),v.rotateX(n.MathUtils.degToRad(p)),v.rotateY(n.MathUtils.degToRad(y)),v.rotateZ(n.MathUtils.degToRad(l)),v};return i.forEach(a=>{if(a===null){console.error("ITEM IS NULL");return}if(Array.isArray(a))r.add(q(a));else{const[f,_,u,b,w,x,E,M,p,y,l,g,d,m,R]=a.split("_");let h=null;switch(f){case"cube":h=o(a);break;case"sphere":h=t(a);break;case"plane":h=s(a);break;case"cylinder":h=c(a);break;case"pyramid":h=e(a);break;default:throw new Error(`Unknown shape: ${f}`)}let v=null;_.startsWith("case")?v=new n.ShaderMaterial({uniforms:{...$.uniforms},vertexShader:$.vertexShader,fragmentShader:$.fragmentShader}):v=new n.MeshStandardMaterial({color:R,side:n.DoubleSide});const P=new n.Mesh(h,v);P.name=_,P.position.set(g,d,m),r.add(P)}}),r},ie=i=>{const{radius:r,depth:e,color:o}=i,t=new n.CylinderGeometry(r,r,e,32),s=new n.MeshBasicMaterial({color:o});return new n.Mesh(t,s)},K=i=>{if(i==="cassette"){const r=q(ge());return r.name="cassette",r}else if(i==="arena"){const r=q(ye());return r.name="arena",r}else if(i==="cat"){const r=q(me());return r.name="cat",r}return null};class O{static _instance;callbacks;constructor(){this.callbacks={}}static get Instance(){return O._instance||(O._instance=new O),O._instance}on(r,e){this.callbacks[r]=this.callbacks[r]||[],this.callbacks[r].push(e)}off(r,e){this.callbacks[r]=(this.callbacks[r]||[]).filter(o=>o!==e)}emit(r,...e){(this.callbacks[r]||[]).forEach(o=>o(...e))}_reset(){Object.keys(this.callbacks).forEach(r=>{delete this.callbacks[r]})}getCallbacks(){return this.callbacks}}const de="#e81416",be="#ffa500",we="#faeb36",ne="#79c314",se="#487de7",xe="#70369d",J="#000000",U=[de,be,we,ne,se,xe],j=["Shiny Toy Guns","B.B. King","Jack White","Black Sabbath","Faith Hill","Cliff Sheen"],F=["OFFSIDE","SHOWCASE","LOADOUT","BACKHAND","BOOKMARKS","MANPOWER"],ve=[[0,1,2,3,4,5],[0,2,4,1,5,3],[0,3,5,1,4,2]];class Se{queue;selected;vinyls;progress;constructor(){this.queue=[],this.selected={},this.vinyls=[],this.reset()}addVinylByIndex(r){const{color:e,artist:o,title:t}=this.vinyls[r],s=U.indexOf(e),c=j.indexOf(o),a=F.indexOf(t);s===this.progress.color.currentIndex+1?(this.progress.color.correctCount++,this.progress.color.correctCount===U.length&&(this.progress.color.solved=!0)):(this.progress.color.currentIndex=-1,this.progress.color.correctCount=0),this.progress.color.currentIndex=s,c===(this.progress.artist.currentIndex+1)%j.length?(this.progress.artist.correctCount++,this.progress.artist.correctCount===j.length&&(this.progress.artist.solved=!0)):this.progress.artist.correctCount=1,this.progress.artist.currentIndex=c,a===(this.progress.title.currentIndex+1)%F.length?(this.progress.title.correctCount++,this.progress.title.correctCount===F.length&&(this.progress.title.solved=!0)):this.progress.title.correctCount=1,this.progress.title.currentIndex=a,O.Instance.emit("progress",this.progress),O.Instance.emit("debug",JSON.stringify(this.progress))}isSolved(r){return this.progress[r].solved}reset(){this.queue=[],this.selected={};const[r,e,o]=ve;this.progress={color:{currentIndex:-1,correctCount:0,solved:!1},artist:{currentIndex:-1,correctCount:0,solved:!1},title:{currentIndex:-1,correctCount:0,solved:!1}},this.vinyls=U.map((t,s)=>({index:s,color:U[r[s]],artist:j[e[s]],title:F[o[s]]})),r.forEach((t,s)=>{this.vinyls[t].color=U[s]}),e.forEach((t,s)=>{this.vinyls[t].artist=j[s]}),o.forEach((t,s)=>{this.vinyls[t].title=F[s]}),O.Instance.emit("progress",this.progress)}}class X{static createButton(r,e={}){const o=document.createElement("button");function t(){let _=null;async function u(x){x.addEventListener("end",b),await r.xr.setSession(x),o.textContent="EXIT VR",_=x}function b(){_.removeEventListener("end",b),o.textContent="ENTER VR",_=null}o.style.display="",o.style.cursor="pointer",o.style.left="calc(50% - 50px)",o.style.width="100px",o.textContent="ENTER VR";const w={...e,optionalFeatures:["local-floor","bounded-floor","layers",...e.optionalFeatures||[]]};o.onmouseenter=function(){o.style.opacity="1.0"},o.onmouseleave=function(){o.style.opacity="0.5"},o.onclick=function(){_===null?navigator.xr.requestSession("immersive-vr",w).then(u):(_.end(),navigator.xr.offerSession!==void 0&&navigator.xr.offerSession("immersive-vr",w).then(u).catch(x=>{console.warn(x)}))},navigator.xr.offerSession!==void 0&&navigator.xr.offerSession("immersive-vr",w).then(u).catch(x=>{console.warn(x)})}function s(){o.style.display="",o.style.cursor="auto",o.style.left="calc(50% - 75px)",o.style.width="150px",o.onmouseenter=null,o.onmouseleave=null,o.onclick=null}function c(){s(),o.textContent="VR NOT SUPPORTED"}function a(_){s(),console.warn("Exception when trying to call xr.isSessionSupported",_),o.textContent="VR NOT ALLOWED"}function f(_){_.style.position="absolute",_.style.bottom="20px",_.style.padding="12px 6px",_.style.border="1px solid #fff",_.style.borderRadius="4px",_.style.background="rgba(0,0,0,0.1)",_.style.color="#fff",_.style.font="normal 13px sans-serif",_.style.textAlign="center",_.style.opacity="0.5",_.style.outline="none",_.style.zIndex="999"}if("xr"in navigator)return o.id="VRButton",o.style.display="none",f(o),navigator.xr.isSessionSupported("immersive-vr").then(function(_){_?t():c(),_&&X.xrSessionIsGranted&&o.click()}).catch(a),o;{const _=document.createElement("a");return window.isSecureContext===!1?(_.href=document.location.href.replace(/^http:/,"https:"),_.innerHTML="WEBXR NEEDS HTTPS"):(_.href="https://immersiveweb.dev/",_.innerHTML="WEBXR NOT AVAILABLE"),_.style.left="calc(50% - 90px)",_.style.width="180px",_.style.textDecoration="none",f(_),_}}static registerSessionGrantedListener(){if(typeof navigator<"u"&&"xr"in navigator){if(/WebXRViewer\//i.test(navigator.userAgent))return;navigator.xr.addEventListener("sessiongranted",()=>{X.xrSessionIsGranted=!0})}}}X.xrSessionIsGranted=!1;X.registerSessionGrantedListener();const Ee=.3,L=44100,Q=new(window.AudioContext||window.webkitAudioContext),Me=(i=1,r=.05,e=220,o=0,t=0,s=.1,c=0,a=1,f=0,_=0,u=0,b=0,w=0,x=0,E=0,M=0,p=0,y=1,l=0,g=0)=>{let d=2*Math.PI,m=f*=500*d/L**2,R=(0<E?1:-1)*d/4,h=e*=(1+2*r*Math.random()-r)*d/L,v=[],P=0,_e=0,T=0,W=1,he=0,pe=0,G=0,V,N;for(o=99+L*o,l*=L,t*=L,s*=L,p*=L,_*=500*d/L**3,E*=d/L,u*=d/L,b*=L,w=L*w|0,N=o+l+t+s+p|0;T<N;v[T++]=G)++pe%(100*M|0)||(G=c?1<c?2<c?3<c?Math.sin((P%d)**3):Math.max(Math.min(Math.tan(P),1),-1):1-(2*P/d%2+2)%2:1-4*Math.abs(Math.round(P/d)-P/d):Math.sin(P),G=(w?1-g+g*Math.sin(2*Math.PI*T/w):1)*(0<G?1:-1)*Math.abs(G)**a*i*Ee*(T<o?T/o:T<o+l?1-(T-o)/l*(1-y):T<o+l+t?y:T<N-p?(N-T-p)/s*y:0),G=p?G/2+(p>T?0:(T<N-p?1:(N-T)/p)*v[T-p|0]/2):G),V=(e+=f+=_)*Math.sin(_e*E-R),P+=V-V*x*(1-1e9*(Math.sin(T)+1)%2),_e+=V-V*x*(1-1e9*(Math.sin(T)**2+1)%2),W&&++W>b&&(e+=u,h+=u,W=0),!w||++he%w||(e=h,f=m,W=W||1);return v},Ce=(...i)=>{let r=Q.createBufferSource(),e=Q.createBuffer(i.length,i[0].length,L);return i.map((o,t)=>e.getChannelData(t).set(o)),r.buffer=e,r.connect(Q.destination),r.start(),r},Re=(...i)=>Ce(Me(...i)),Te=()=>Re(1.01,void 0,275,.01,.01,.15,1,1.03,-3.7,void 0,-93,.07,void 0,void 0,void 0,-.1,void 0,.5,.04,.09);let Ie=0;const Le=(i,r)=>{const e=new n.Group;e.name=`Witch${++Ie}`;const o=[],t=K("cat");t.scale.set(.03,.03,.03),e.add(t),t.position.set(0,-.25,-.05);const s=()=>{if(r.xr?.getCamera()&&r.xr?.getCamera()){const c=r.xr?.getCamera();if(o.push(c.quaternion.clone()),o.length>60){let a=o.shift();const f=new n.Quaternion().setFromEuler(new n.Euler(0,Math.PI,0));a&&e.quaternion.copy(f.multiply(a))}}};return O.Instance.on("tick",s),e.userData.isPickable=!0,e.onPointerPick=()=>{Te()},i.add(e),e},Oe=(i,r,e)=>Math.min(Math.max(i,r),e),fe=(i=512)=>{const r=document.createElement("canvas");r.width=i,r.height=i;const e=r.getContext("2d");return[r,e]},k=.0254,Pe=(i,r)=>{const[o,t]=fe(1024);t.fillStyle=J,t.strokeStyle=J,t.lineWidth=8,t.beginPath(),t.arc(1024/2,1024/2,20,0,2*Math.PI),t.stroke(),t.beginPath(),t.arc(1024/2,1024/2,288,0,2*Math.PI),t.stroke(),t.textAlign="center",i&&(t.font="64px monospace",t.textBaseline="middle",t.strokeStyle=J,t.lineWidth=8,t.strokeText(i,.5*1024,.42*1024),t.fillStyle=ne,t.fillText(i,.5*1024,.42*1024)),r&&(t.font="96px monospace",t.textBaseline="bottom",t.fillStyle=se,t.strokeText(r,.5*1024,.68*1024),t.fillText(r,.5*1024,.68*1024));const s=new n.CanvasTexture(o);return s.encoding=n.LinearSRGBColorSpace,new n.MeshBasicMaterial({map:s,transparent:!0})},ke=({color:i,artist:r,title:e})=>{const o=new n.Group,t=new n.RingGeometry(4,7,32);t.scale(k,k,k);const s=new n.MeshPhongMaterial({color:i,side:n.DoubleSide,emissive:0,specular:1118481,shininess:50});o.add(new n.Mesh(t,s));const c=new n.RingGeometry(.25,4,32);c.scale(k,k,k);const a=new n.MeshStandardMaterial({color:16777215,side:n.DoubleSide});o.add(new n.Mesh(c,a));const f=new n.PlaneGeometry(14,14);f.translate(0,0,.001),f.scale(k,k,k);const _=Pe(r,e);o.add(new n.Mesh(f,_));const u=o.clone();return u.rotation.set(0,Math.PI,0),u.position.set(0,0,-.002),o.add(u),o},De=i=>i*i;class I{static _instance;animations;scene;clock;constructor(){this.animations=[],this.scene=null,this.clock=new n.Clock}static get Instance(){return I._instance||(I._instance=new I),I._instance}initScene(r){this.scene||(this.scene=r,this.clock.start())}update(){const r=this.clock.getElapsedTime()*1e3;this.animations=this.animations.filter(e=>{const o=r-e.startTime,t=e.endTime-e.startTime,s=Oe(o/t,0,1);if(r>=e.endTime)return e.loop?(e.startTime=r,e.endTime=r+t,e.end.position&&e.mesh.position.copy(e.start.position),e.end.rotation&&e.mesh.rotation.copy(e.start.rotation),e.end.scaling&&e.mesh.scale.copy(e.start.scaling),!0):(e.end.position&&e.mesh.position.copy(e.end.position),e.end.rotation&&e.mesh.rotation.copy(e.end.rotation),e.end.scaling&&e.mesh.scale.copy(e.end.scaling),e.resolve&&(e.resolve(),e.resolve=void 0,e.reject=void 0),!1);if(e.end.position&&e.mesh.position.lerpVectors(e.start.position,e.end.position,e.easeFunc(s)),e.end.rotation){const c=e.start.rotation,a=e.end.rotation,f=new n.Euler;f.x=c.x+(a.x-c.x)*e.easeFunc(s),f.y=c.y+(a.y-c.y)*e.easeFunc(s),f.z=c.z+(a.z-c.z)*e.easeFunc(s),e.mesh.rotation.copy(f)}return e.end.scaling&&e.mesh.scale.lerpVectors(e.start.scaling,e.end.scaling,e.easeFunc(s)),!0})}animateTransform(r){const{mesh:e,end:o}=r,t=r.duration||1e3,s=r.delay||0,c=r.ease||De,a=this.clock.getElapsedTime()*1e3;let f,_;const u=new Promise((b,w)=>{f=b,_=w});return this.animations.push({mesh:e,start:{position:e.position.clone(),rotation:e.rotation.clone(),scaling:e.scale.clone()},end:o,easeFunc:c,startTime:a+s,endTime:a+s+t,loop:r.loop||!1,resolve:f,reject:_}),u}cancelAnimation(r,e=!1){const o=this.animations.filter(t=>t.mesh===r);o.length&&(o.forEach(t=>{e&&(t.end.position&&r.position.copy(t.end.position),t.end.rotation&&r.rotation.copy(t.end.rotation),t.end.scaling&&r.scale.copy(t.end.scaling)),t.reject&&(t.reject(),t.resolve=void 0,t.reject=void 0)}),this.animations=this.animations.filter(t=>t.mesh!==r))}}const ze=()=>{const i=new n.Group;i.name="debugScreen",i.renderOrder=1;const r=["You win!","Thanks for playing","Created by Alex Swan"],e=new n.PlaneGeometry(5,5);e.translate(0,-2,0);const[o,t]=fe(1024),s=new n.CanvasTexture(o);s.encoding=n.LinearSRGBColorSpace;const c=new n.MeshBasicMaterial({map:s,transparent:!0}),a=new n.Mesh(e,c);i.add(a),a.position.set(0,0,0);const f=()=>{if(!a.userData.solved)return;t.clearRect(0,0,o.width,o.height),t.globalAlpha=.5,t.fillStyle="black",t.fillRect(0,0,o.width,o.height*.2),t.globalAlpha=1;const _=64;t.fillStyle="white",t.textBaseline="top",t.textAlign="center",t.font=`${_}px monospace`,r.forEach((u,b)=>{t.fillText(u,o.width/2,_*b)}),s.needsUpdate=!0};return O.Instance.on("progress",_=>{_.color.solved&&_.artist.solved&&_.title.solved&&(a.userData.solved=!0),f()}),i},ae={color:de,artist:ne,title:se};let A,S,oe,C,B,D,z,ee,te,Y,ce;const re=new n.Vector3(0,0,.3),Be=async()=>{document.getElementById("intro").style.display="none";const r=document.getElementById("c");if(!r)return;r.style.display="block",C=new n.WebGLRenderer({antialias:!0}),C.setPixelRatio(window.devicePixelRatio),C.setSize(window.innerWidth,window.innerHeight),C.setClearColor("#000000"),C.xr.addEventListener("sessionstart",Ge),C.xr.enabled=!0,C.setAnimationLoop(Ae),document.body.appendChild(X.createButton(C)),document.body.appendChild(C.domElement);const e=new Se;S=new n.Scene,A=new n.PerspectiveCamera(75,window.innerWidth/window.innerHeight,.1,1e3),A.position.set(0,2,1),A.rotation.set(-1*Math.PI/12,0,0),A.name="camera",S.add(A),I.Instance.initScene(S);const o=new n.AmbientLight(16777215,.8);S.add(o);const t=new n.DirectionalLight(16777215,.8);t.position.set(6,10,8),t.castShadow=!0,t.target.position.set(0,0,0),S.add(t),S.add(t.target);const s=ze();s.position.set(0,1.5,-1),S.add(s),Y=K("cassette"),Y.position.set(0,0,-20),Y.userData.isPickable=!0,S.add(Y),I.Instance.animateTransform({mesh:Y,end:{rotation:new n.Euler(0,2*Math.PI-.01,0)},duration:3e3,ease:p=>p,loop:!0});const c=K("arena"),a=c.getObjectByName("tableA");S.add(c);const f=K("cat");f.position.set(-3,1,0),f.scale.set(.1,.1,.1),S.add(f);const _=f.clone(!0);_.name="catMesh2",_.position.set(3,1,-1),_.rotation.set(0,Math.PI/2,0),S.add(_);const u=Le(S,C);u.position.set(0,1.5,-1),u.rotation.set(0,Math.PI,0),e.vinyls.forEach((p,y)=>{const l=ke(p);l.name=`vinyl-${y}`;const g=new n.Vector3(.7,1.15,-.2-.125*y);l.position.copy(g),l.userData.originalPosition=g,l.userData.isPickable=!0,l.userData.recordIndex=y,l.userData.returnToOriginalPosition=()=>{S.attach(l),I.Instance.cancelAnimation(l),I.Instance.animateTransform({mesh:l,end:{position:l.userData.originalPosition,rotation:new n.Euler(0,0,0)},duration:100})},l.onPointerPick=d=>{if(d.userData.selected)return;e.selected[d.id]=y;const m=d.getObjectByName("target");m&&(I.Instance.cancelAnimation(l),m.attach(l),I.Instance.animateTransform({mesh:l,end:{position:new n.Vector3(0,0,0),rotation:new n.Euler(0,0,0)},duration:60}),d.userData.selected=l)},l.onPointerDrop=d=>{if(I.Instance.cancelAnimation(l,!0),l.getWorldPosition(new n.Vector3).distanceTo(a.getWorldPosition(new n.Vector3))<.3){e.addVinylByIndex(l.userData.recordIndex),delete e.selected[d.id],d.userData.selected=void 0,a.children.forEach(R=>{R.userData.returnToOriginalPosition&&R.userData.returnToOriginalPosition()}),a.attach(l),I.Instance.animateTransform({mesh:l,end:{position:new n.Vector3(0,.01,0),rotation:new n.Euler(-1*Math.PI/2,0,0)},duration:60}).then(()=>{I.Instance.animateTransform({mesh:l,end:{rotation:new n.Euler(-1*Math.PI/2,0,-2*Math.PI)},ease:R=>R,duration:1800,loop:!0})});return}else l.userData.returnToOriginalPosition(),d.userData.selected=void 0},S.add(l)}),D=C.xr.getController(0),D.addEventListener("selectstart",Z),D.addEventListener("selectend",H),D.addEventListener("squeezestart",Z),D.addEventListener("squeezeend",H),S.add(D),z=C.xr.getController(1),z.addEventListener("selectstart",Z),z.addEventListener("selectend",H),z.addEventListener("squeezestart",Z),z.addEventListener("squeezeend",H),S.add(z),ee=C.xr.getControllerGrip(0);const b=ie({radius:.01,depth:.2,color:16711935});b.name="controllerMesh1",b.rotateX(Math.PI/4),ee.add(b),S.add(ee),te=C.xr.getControllerGrip(1);const w=ie({radius:.01,depth:.2,color:65280});w.rotateX(Math.PI/4),te.add(w),S.add(te);const x=new n.BufferGeometry().setFromPoints([new n.Vector3(0,0,0),new n.Vector3(0,0,-1)]),E=new n.Line(x);E.name="line",E.scale.z=5,D.add(E.clone()),z.add(E.clone());const M=new n.Group;M.rotation.set(-1*Math.PI/2,0,0),M.position.set(0,-.05,-.12),M.name="target",D.add(M.clone()),z.add(M.clone()),oe=new n.Raycaster,window.addEventListener("resize",Ne,!1),O.Instance.on("progress",p=>{let y="color";p.artist.correctCount>=p[y].correctCount&&(y="artist"),p.title.correctCount>=p[y].correctCount&&(y="title");for(let g=0;g<6;g++){const d=c.getObjectByName(`progress-${g}`);let m=g<p[y].correctCount?ae[y]:0;g<p[y].correctCount&&y==="color"&&(m=U[g]),d&&(d.visible=!0,d.material.color.set(m),d.material.emissive.set(m),d.material.needsUpdate=!0)}const l=Object.keys(p);for(let g=0;g<l.length;g++){const d=l[g],m=c.getObjectByName(`complete-${g}`),R=p[d].solved?ae[d]:0;m&&(m.visible=!0,m.material.color.set(R),m.material.emissive.set(R),m.material.needsUpdate=!0)}}),e.reset()};function Ge(){ce=C.xr.getReferenceSpace();const i={x:-1*re.x,y:-1*re.y,z:-1*re.z,w:1},r=new n.Quaternion,e=new XRRigidTransform(i,r),o=ce.getOffsetReferenceSpace(e);C.xr.setReferenceSpace(o)}function Z(i){B=i.target;const r=ue(B);if(r.length>0){let e=!1;r.forEach(({object:o,distance:t})=>{if(e)return;let s=o;for(;s;){if(s.onPointerPick){s.onPointerPick(B),e=!0;const c=B.getObjectByName("line");c.visible=!1;break}s=s.parent}})}B.userData.targetRayMode=i.data.targetRayMode}function H(i){B=i.target;const r=B.userData.selected;r?.onPointerDrop&&r.onPointerDrop(B);const e=B.getObjectByName("line");e.visible=!0}function ue(i){return i.updateMatrixWorld(),oe.setFromXRController(i),oe.intersectObjects(S.children,!0)}function le(i){if(i.userData.targetRayMode==="screen"||i.userData.selected!==void 0)return;const r=i.getObjectByName("line"),e=ue(i);if(r.scale.z=5,e.length>0){let o=!1;e.forEach(({object:t,distance:s})=>{if(o)return;let c=t;for(;c;){if(c.userData.isPickable){r.scale.z=s,o=!0;break}c=c.parent}})}}function Ae(){I.Instance.update(),O.Instance.emit("tick"),le(D),le(z),C.render(S,A)}const Ne=()=>{A.aspect=window.innerWidth/window.innerHeight,A.updateProjectionMatrix(),C.setSize(window.innerWidth,window.innerHeight)};window.addEventListener("DOMContentLoaded",()=>{const i=document.getElementById("playButton");i.onclick=Be});

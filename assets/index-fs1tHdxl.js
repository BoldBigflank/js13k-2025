import*as e from"https://js13kgames.com/2025/webxr/three.module.js";!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver(e=>{for(const n of e)if("childList"===n.type)for(const e of n.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)}).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();const t={uDirLightPos:{value:new e.Vector3},uDirLightColor:{value:new e.Color(15658734)},uAmbientLightColor:{value:new e.Color(328965)},uBaseColor:{value:new e.Color(16777215)},uLineColor1:{value:new e.Color(0)}},n=r=>{const _=new e.Group;return _.position.set(0,0,0),_.rotation.set(0,0,0),_.scale.set(1,1,1),r.forEach(r=>{if(null!==r)if(Array.isArray(r))_.add(n(r));else{const[n,o,s,a,i,c,l,d,u,f,h,p,m,g,b]=r.split("_"),y=(t=>{const[n]=t.split("_");switch(n){case"cube":return(t=>{const[n,r,_,o,s,a,i,c,l,d,u,f,h,p,m]=t.split("_"),g=parseFloat(_),b=parseFloat(o),y=parseFloat(s),v=parseFloat(a),w=parseFloat(i),x=parseFloat(c),C=parseFloat(f),M=parseFloat(h),F=parseFloat(p),I=parseFloat(l),E=parseFloat(d),P=parseFloat(u),B=new e.BoxGeometry(g,b,y);return B.translate(v-C,w-M,x-F),B.rotateX(e.MathUtils.degToRad(I)),B.rotateY(e.MathUtils.degToRad(E)),B.rotateZ(e.MathUtils.degToRad(P)),B.computeBoundingBox(),B})(t);case"sphere":return(t=>{const[n,r,_,o,s,a,i,c,l,d,u,f,h,p,m]=t.split("_"),g=parseFloat(_),b=parseFloat(o),y=parseFloat(s),v=parseFloat(a),w=parseFloat(i),x=parseFloat(c),C=parseFloat(f),M=parseFloat(h),F=parseFloat(p),I=parseFloat(l),E=parseFloat(d),P=parseFloat(u),B=new e.SphereGeometry(g/2,32,16);return B.scale(g/g,b/g,y/g),B.translate(v-C,w-M,x-F),B.rotateX(e.MathUtils.degToRad(I)),B.rotateY(e.MathUtils.degToRad(E)),B.rotateZ(e.MathUtils.degToRad(P)),B})(t);case"plane":return(t=>{const[n,r,_,o,s,a,i,c,l,d,u,f,h,p,m]=t.split("_"),g=parseFloat(_),b=parseFloat(o),y=parseFloat(a),v=parseFloat(i),w=parseFloat(c),x=parseFloat(f),C=parseFloat(h),M=parseFloat(p),F=parseFloat(l),I=parseFloat(d),E=parseFloat(u),P=new e.PlaneGeometry(g,b);return P.rotateX(e.MathUtils.degToRad(-90)),P.translate(y-x,v-C,w-M),P.rotateX(e.MathUtils.degToRad(F)),P.rotateY(e.MathUtils.degToRad(I)),P.rotateZ(e.MathUtils.degToRad(E)),P.computeBoundingBox(),P})(t);case"cylinder":return(t=>{const[n,r,_,o,s,a,i,c,l,d,u,f,h,p,m]=t.split("_"),g=parseFloat(_),b=parseFloat(o),y=parseFloat(s),v=parseFloat(a),w=parseFloat(i),x=parseFloat(c),C=parseFloat(f),M=parseFloat(h),F=parseFloat(p),I=parseFloat(l),E=parseFloat(d),P=parseFloat(u),B=g/2,L=new e.CylinderGeometry(B,B,b,32);L.translate(v-C,w-M,x-F),L.scale(1,1,y/g);const S=e.MathUtils.degToRad(I),T=e.MathUtils.degToRad(E),R=e.MathUtils.degToRad(P),k=new e.Euler(S,T,R);return L.applyQuaternion((new e.Quaternion).setFromEuler(k)),L.computeBoundingBox(),L})(t);case"pyramid":return(t=>{const[n,r,_,o,s,a,i,c,l,d,u,f,h,p,m]=t.split("_"),g=parseFloat(_),b=parseFloat(o),y=parseFloat(s),v=parseFloat(a),w=parseFloat(i),x=parseFloat(c),C=parseFloat(f),M=parseFloat(h),F=parseFloat(p),I=parseFloat(l),E=parseFloat(d),P=parseFloat(u),B=Math.sqrt(g*g+g*g)/2,L=new e.CylinderGeometry(0,B,b,4,1,!1,Math.PI/4);return L.scale(1,1,y/g),L.translate(v-C,w-M+.3*b,x-F),L.rotateX(e.MathUtils.degToRad(I)),L.rotateY(e.MathUtils.degToRad(E)),L.rotateZ(e.MathUtils.degToRad(P)),L})(t);default:throw new Error(`Unknown shape: ${n}`)}})(r);let v=null;v="string"==typeof o&&o.startsWith("case")?new e.ShaderMaterial({uniforms:{...t},vertexShader:"\n\n\t\tvarying vec3 vNormal;\n\n\t\tvoid main() {\n\n\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\t\t\tvNormal = normalize( normalMatrix * normal );\n\n\t\t}",fragmentShader:"\n\n\t\tuniform vec3 uBaseColor;\n\t\tuniform vec3 uLineColor1;\n\t\tuniform vec3 uLineColor2;\n\t\tuniform vec3 uLineColor3;\n\t\tuniform vec3 uLineColor4;\n\n\t\tuniform vec3 uDirLightPos;\n\t\tuniform vec3 uDirLightColor;\n\n\t\tuniform vec3 uAmbientLightColor;\n\n\t\tvarying vec3 vNormal;\n\n\t\tvoid main() {\n\n\t\t\tfloat directionalLightWeighting = max( dot( normalize(vNormal), uDirLightPos ), 0.0);\n\t\t\tvec3 lightWeighting = uAmbientLightColor + uDirLightColor * directionalLightWeighting;\n\n\t\t\tgl_FragColor = vec4( uBaseColor, 1.0 );\n\n\t\t\tif ( length(lightWeighting) < 1.00 ) {\n\n\t\t\t\tif ( ( mod(gl_FragCoord.x, 4.001) + mod(gl_FragCoord.y, 4.0) ) > 6.00 ) {\n\n\t\t\t\t\tgl_FragColor = vec4( uLineColor1, 1.0 );\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\tif ( length(lightWeighting) < 0.50 ) {\n\n\t\t\t\tif ( ( mod(gl_FragCoord.x + 2.0, 4.001) + mod(gl_FragCoord.y + 2.0, 4.0) ) > 6.00 ) {\n\n\t\t\t\t\tgl_FragColor = vec4( uLineColor1, 1.0 );\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\t#include <colorspace_fragment>\n\n\t\t}"}):new e.MeshStandardMaterial({color:b,side:e.DoubleSide});const w=new e.Mesh(y,v);w.name=o,w.position.set(p,m,g),_.add(w)}}),_},r=e=>{if("cassette"===e){const e=n([["cube_case1_1_8_2_7.50_4_0_0_0_0_7.50_4_0_#0000ff","cube_case2_3_9_2_5.50_4.50_0_0_0_0_5.50_4.50_0_#0000ff","cube_case3_8_4_2_0_7_0_0_0_0_0_8.50_0_#0000ff","cube_case4_8_1_2_0_2.50_0_0_0_0_0_2.50_0_#0000ff","cube_case5_3_9_2_-5.50_4.50_0_0_0_0_-5.50_4.50_0_#0000ff","cube_case6_1_8_2_-7.50_4_0_0_0_0_-7.50_4_0_#0000ff"],"cube_base_12_2.10_2.40_0_0.95_0_0_0_0_0_0_0_#ff0000","cube_rightReel_2_2_1_2.72_3.89_0_0_0_-45_2.72_3.89_0_#ff7300","cube_rightTape_4_4_0.20_2.81_3.91_-0.10_0_0_-45_2.81_3.91_-0.10_#c300ff","cube_leftReel_2_2_1_-2.69_3.91_0_0_0_-45_-2.75_4_0_#ff7300","sphere_dot_1_1_1_0_4_0_0_0_0_0_4_0_#9999ff","plane_label_12_3_0_0_7_1.01_90_0_0_0_7_1.01_#d3d3d3","cylinder_base_16_8_16_0_-4_0_0_0_0_0_-4_0_#00ff00"]);return e.name="cassette",e}if("arena"===e){const e=n([[["cube_complete-0_0.3_0.1_0.1_-0.75_1.05_-0.45_0_0_0_-0.75_1.05_-0.45_#ff0000","cube_complete-1_0.3_0.1_0.1_-0.75_1.05_-0.35_0_0_0_-0.75_1.05_-0.35_#00ff00","cube_complete-2_0.3_0.1_0.1_-0.75_1.05_-0.25_0_0_0_-0.75_1.05_-0.25_#0000ff"],["sphere_progress-0_0.2_0.2_0.2_-0.75_1.05_-0.75_0_0_0_-0.75_1.05_-0.75_#fffb00","sphere_progress-1_0.2_0.2_0.2_-0.55_1.05_-0.75_0_0_0_-0.55_1.05_-0.75_#fffb00","sphere_progress-2_0.2_0.2_0.2_-0.35_1.05_-0.75_0_0_0_-0.35_1.05_-0.75_#fffb00","sphere_progress-3_0.2_0.2_0.2_-0.15_1.05_-0.75_0_0_0_-0.15_1.05_-0.75_#fffb00","sphere_progress-4_0.2_0.2_0.2_0.05_1.05_-0.75_0_0_0_0.05_1.05_-0.75_#fffb00","sphere_progress-5_0.2_0.2_0.2_0.25_1.05_-0.75_0_0_0_0.25_1.05_-0.75_#fffb00"],"cube_desk_2_0.1_1_0_0.85_-0.5_0_0_0_0_-0.1_0_#fffb00","cube_leg_0.1_0.8_0.1_-0.85_0.4_-0.85_0_0_0_0.1_0_-0.9_#fffb00","cube_leg_0.1_0.8_0.1_-0.85_0.4_-0.15_0_0_0_0.1_0_-0.2_#fffb00","cube_leg_0.1_0.8_0.1_0.85_0.4_-0.15_0_0_0_1.8_0_-0.2_#fffb00","cube_leg_0.1_0.8_0.1_0.85_0.4_-0.85_0_0_0_1.8_0_-0.9_#fffb00","cube_record-rack_0.4_0.1_0.8_0.7_0.95_-0.5_0_0_0_0.7_0.95_-0.5_#b0ffb0","cube_progress-bar_1.3_0.1_0.3_-0.25_0.95_-0.75_0_0_0_-0.25_0.95_-0.75_#d3d3d3","cube_cube_0.3_0.1_0.4_-0.75_0.95_-0.3_0_0_0_-0.75_0.95_-0.3_#9999ff","cube_cube_0.4_0.1_0.4_-0.3_0.95_-0.3_0_0_0_-0.3_0.95_-0.3_#d3d3d3","cube_tableA_0.4_0.1_0.4_0.2_0.95_-0.3_0_0_0_0.2_1.01_-0.3_#b0ffb0","cylinder_pad_0.4_0.02_0.4_0.2_1_-0.3_0_0_0_0.2_1_-0.3_#ff0000"],"cube_cube_22_1_4_0_-1.5_-12_0_0_0_0_-2_-4_#ff00ff","cube_floor_22_1_9_0_-2.5_-5.5_0_0_0_0_-3_-4_#ff0000","cube_cube_22_1_6_0_-2.5_2_0_0_0_0_-3_5_#ff0000","cube_cube_8_2_3_0_-1_0.5_0_0_0_0_-1_-4_#c300ff","cube_pillar_1_4_1_7.5_0_-2.5_0_0_0_8_0_-3_#fffb00","cube_pillar_1_4_1_7.5_0_-6.5_0_0_0_8_0_-7_#fffb00","cube_pillar_1_3_1_7.5_0.5_-10.5_0_0_0_8_0_-11_#fffb00","cube_pillar_1_4_1_7.5_0_-10.5_0_0_0_8_0_-11_#fffb00","cube_pillar_1_4_1_-7.5_0_-2.5_0_0_0_-7_0_-3_#fffb00","cube_pillar_1_4_1_-7.5_0_1.5_0_0_0_-7_0_1_#fffb00","cube_pillar_1_4_1_7.5_0_1.5_0_0_0_8_0_1_#fffb00","cube_pillar_1_4_1_-7.5_0_-6.5_0_0_0_-7_0_-7_#fffb00","cube_pillar_1_3_1_-7.5_0.5_-10.5_0_0_0_-7_0_-11_#fffb00","cube_cube_4_1_16_9_2.5_-6_0_0_0_8_2_0_#00ff00","cube_cube_4_1_16_-9_2.5_-6_0_0_0_-10_2_0_#00ff00"]);return e.name="arena",e}if("cat"===e){const e=n(["sphere_head_16_16_16_0_8_0_0_0_0_0_8_0_#c300ff",["cylinder_leftEye_4_1_4_-3_11_-6.3_-60_0_25_-3_11_-6.3_#fffb00","sphere_leftPupil_2_2_4_-3.6_11.3_-7_-60_0_25_-3.6_11.3_-7_#c300ff","cylinder_rightEye_4_1_4_3_11_-6.3_-60_0_-25_3_11_-6.3_#fffb00","sphere_rightPupil_2_2_4_3.4_11.3_-7_-60_0_-25_3.4_11.3_-7_#c300ff"],["cube_rightCheek_3_3_2_1.84_6.53_-7.5_-25_0_80_1.84_6.53_-7.5_#0000ff","cube_leftCheek_3_3_2_-1.91_6.48_-7.5_0_23_10_-1.91_6.48_-7.5_#0000ff","cube_tongue_2_2_2_0_5_-7_0_0_0_0_4_-7_#ff0000","pyramid_pyramid_3_1.6_1_0_8.2_-8_-180_0_0_0_8.2_-8_#ff00ff"],["pyramid_ear_6_11_4_-4.86_15.55_-1.28_-14_-6_24_-4.86_15.55_-1.28_#c300ff","pyramid_ear_5_9.5_4_-5.04_15.94_-1.59_-14_-6_24_-5.04_15.94_-1.59_#fffb00","pyramid_ear_6_11_4_4.86_15.55_-1.28_-14_6_-24_4.86_15.55_-1.28_#c300ff","pyramid_ear_5_9.5_4_5.04_15.94_-1.59_-14_6_-24_5.04_15.94_-1.59_#fffb00"],["cylinder_cylinder_0.2_6_0.2_-3.93_6_-8.92_0_-15_90_-3.93_6_-8.92_#d3d3d3","cylinder_cylinder_0.2_4_0.2_-4.87_7.52_-8.5_0_-15_75_-4.87_7.52_-8.5_#d3d3d3","cylinder_cylinder_0.2_4_0.2_-4.87_4.48_-8.5_0_-15_105_-4.87_4.48_-8.5_#d3d3d3","cylinder_cylinder_0.2_4_0.2_4.87_7.52_-8.5_180_-15_-105_4.87_7.52_-8.5_#d3d3d3","cylinder_cylinder_0.2_6_0.2_3.93_6_-8.92_0_-165_90_3.93_6_-8.92_#d3d3d3","cylinder_cylinder_0.2_4_0.2_4.87_4.48_-8.5_180_-15_-75_4.87_4.48_-8.5_#d3d3d3"]]);return e.name="cat",e}if("paw"===e){const e=n(["cylinder_cylinder_4_6_2_0_-1_0_0_0_0_0_-1_0_#c300ff","sphere_sphere_4_4_2_0_2_0_0_0_0_0_2_0_#c300ff","cube_cube_0.3_1_0.3_-1.15_3.5_-0.55_-77_0_0_-1.15_3.5_-0.55_#d3d3d3","cube_cube_0.3_1_0.3_-0.45_3.9_-0.55_-77_0_0_-0.45_3.9_-0.55_#d3d3d3","cube_cube_0.3_1_0.3_0.45_3.9_-0.55_-77_0_0_0.45_3.9_-0.55_#d3d3d3","cube_cube_0.3_1_0.3_1.05_3.6_-0.55_-77_0_0_1.05_3.6_-0.55_#d3d3d3","cube_cube_2_0.7_0.4_0_1.85_-0.9_0_0_0_0_1.5_-0.1_#ff0000","cube_cube_0.8_0.5_1.1_0_2.45_-0.55_0_0_0_0_2.2_-0.1_#ff0000","cube_cube_0.3_0.6_0.6_-1.15_2.7_-0.8_0_0_0_-1.15_2.7_-0.1_#ff0000","cube_cube_0.3_0.6_0.6_-0.45_3.1_-0.8_0_0_0_-0.45_3.1_-0.1_#ff0000","cube_cube_0.3_0.6_0.6_0.45_3.1_-0.8_0_0_0_0.45_3.1_-0.1_#ff0000","cube_cube_0.3_0.6_0.6_1.05_2.7_-0.8_0_0_0_1.05_2.7_-0.1_#ff0000"]);return e.name="paw",e.scale.set(.03125,.03125,.03125),e}return null};class _{static _instance;callbacks;constructor(){this.callbacks={}}static get Instance(){return _._instance||(_._instance=new _),_._instance}on(e,t){this.callbacks[e]=this.callbacks[e]||[],this.callbacks[e].push(t)}off(e,t){this.callbacks[e]=(this.callbacks[e]||[]).filter(e=>e!==t)}emit(e,...t){(this.callbacks[e]||[]).forEach(e=>e(...t))}_reset(){Object.keys(this.callbacks).forEach(e=>{delete this.callbacks[e]})}getCallbacks(){return this.callbacks}}const o="#e81416",s="#79c314",a="#487de7",i="#000000",c=[o,"#ffa500","#faeb36",s,a,"#70369d"],l=["Shiny Toy Guns","B.B. King","Jack White","Black Sabbath","Faith Hill","Cliff Sheen"],d=["OFFSIDE","SHOWCASE","LOADOUT","BACKHAND","BOOKMARKS","MANPOWER"],u=[[0,1,2,3,4,5],[0,2,4,1,5,3],[0,3,5,1,4,2]];class f{queue;selected;vinyls;progress;constructor(){this.queue=[],this.selected={},this.vinyls=[],this.reset(),this.progress.bestComboType="color"}addVinylByIndex(e){if(this.queue[0]===e)return;const{color:t,artist:n,title:r}=this.vinyls[e],o=c.indexOf(t),s=l.indexOf(n),a=d.indexOf(r);o===this.progress.color.currentIndex+1?(this.progress.color.correctCount++,this.progress.color.correctCount===c.length&&(this.progress.color.solved=!0),this.progress.color.currentIndex=o):(this.progress.color.currentIndex=-1,this.progress.color.correctCount=0),s===(this.progress.artist.currentIndex+1)%l.length?(this.progress.artist.correctCount++,this.progress.artist.correctCount===l.length&&(this.progress.artist.solved=!0)):this.progress.artist.correctCount=1,this.progress.artist.currentIndex=s,a===(this.progress.title.currentIndex+1)%d.length?(this.progress.title.correctCount++,this.progress.title.correctCount===d.length&&(this.progress.title.solved=!0)):this.progress.title.correctCount=1,this.progress.title.currentIndex=a,this.progress.bestComboCount=Math.max(this.progress.color.correctCount,this.progress.artist.correctCount,this.progress.title.correctCount),this.progress.bestComboType=this.progress.color.correctCount===this.progress.bestComboCount?"color":this.progress.artist.correctCount===this.progress.bestComboCount?"artist":"title",this.queue.unshift(e),_.Instance.emit("progress",this.progress),_.Instance.emit("debug",JSON.stringify(this.progress))}getVinylInQueue(e){return this.vinyls[this.queue[e]]}isSolved(e){return this.progress[e].solved}reset(){this.queue=[],this.selected={};const[e,t,n]=u;this.progress={color:{currentIndex:-1,correctCount:0,solved:!1},artist:{currentIndex:-2,correctCount:0,solved:!1},title:{currentIndex:-2,correctCount:0,solved:!1},bestComboType:"color",bestComboCount:0},this.vinyls=c.map((e,t)=>({index:t,color:e,artist:"",title:""})),e.forEach((e,t)=>{this.vinyls[e].color=c[t]}),t.forEach((e,t)=>{this.vinyls[e].artist=l[t]}),n.forEach((e,t)=>{this.vinyls[e].title=d[t]}),_.Instance.emit("progress",this.progress)}}class h{static createButton(e,t={}){const n=document.createElement("button");function r(){n.style.display="",n.style.cursor="auto",n.style.left="calc(50% - 75px)",n.style.width="150px",n.onmouseenter=null,n.onmouseleave=null,n.onclick=null}function _(e){e.style.position="absolute",e.style.bottom="20px",e.style.padding="12px 6px",e.style.border="1px solid #fff",e.style.borderRadius="4px",e.style.background="rgba(0,0,0,0.1)",e.style.color="#fff",e.style.font="normal 13px sans-serif",e.style.textAlign="center",e.style.opacity="0.5",e.style.outline="none",e.style.zIndex="999"}if("xr"in navigator)return n.id="VRButton",n.style.display="none",_(n),navigator.xr.isSessionSupported("immersive-vr").then(function(_){_?function(){let r=null;async function _(t){t.addEventListener("end",o),await e.xr.setSession(t),n.textContent="EXIT VR",r=t}function o(){r.removeEventListener("end",o),n.textContent="ENTER VR",r=null}n.style.display="",n.style.cursor="pointer",n.style.left="calc(50% - 50px)",n.style.width="100px",n.textContent="ENTER VR";const s={...t,optionalFeatures:["local-floor","bounded-floor","layers",...t.optionalFeatures||[]]};n.onmouseenter=function(){n.style.opacity="1.0"},n.onmouseleave=function(){n.style.opacity="0.5"},n.onclick=function(){null===r?navigator.xr.requestSession("immersive-vr",s).then(_):(r.end(),void 0!==navigator.xr.offerSession&&navigator.xr.offerSession("immersive-vr",s).then(_).catch(e=>{}))},void 0!==navigator.xr.offerSession&&navigator.xr.offerSession("immersive-vr",s).then(_).catch(e=>{})}():(r(),n.textContent="VR NOT SUPPORTED"),_&&h.xrSessionIsGranted&&n.click()}).catch(function(e){r(),n.textContent="VR NOT ALLOWED"}),n;{const e=document.createElement("a");return!1===window.isSecureContext?(e.href=document.location.href.replace(/^http:/,"https:"),e.innerHTML="WEBXR NEEDS HTTPS"):(e.href="https://immersiveweb.dev/",e.innerHTML="WEBXR NOT AVAILABLE"),e.style.left="calc(50% - 90px)",e.style.width="180px",e.style.textDecoration="none",_(e),e}}static registerSessionGrantedListener(){if("undefined"!=typeof navigator&&"xr"in navigator){if(/WebXRViewer\//i.test(navigator.userAgent))return;navigator.xr.addEventListener("sessiongranted",()=>{h.xrSessionIsGranted=!0})}}}h.xrSessionIsGranted=!1,h.registerSessionGrantedListener();const p=(e=512)=>{const t=document.createElement("canvas");t.width=e,t.height=e;const n=t.getContext("2d");return[t,n]},m={},g=new e.Color,b=(t,n)=>{const r=1==n?.glow,_=`color-${t}-${r}`;if(m[_])return m[_];const o=new(r?e.MeshBasicMaterial:e.MeshStandardMaterial)({color:t,side:e.FrontSide});return m[_]=o,o},y=(t,n)=>{g.set(n);const r="string"==typeof n?n:`#${g.getHexString()}`,_=`text-${r}-${t.join("")}`;if(m[_])return m[_];const o=1024,[s,a]=p(o);a.textAlign="center",t.forEach((e,n)=>{a.strokeStyle=i,a.font="64px monospace",a.textBaseline="middle",a.lineWidth=8,a.strokeText(e,512,.5*(o-64*t.length)+64*n),a.fillStyle=r,a.fillText(e,512,.5*(o-64*t.length)+64*n)});const c=new e.CanvasTexture(s),l=new e.MeshBasicMaterial({map:c,transparent:!0});return m[_]=l,l},v=.0254,w=e=>e*e;class x{static _instance;animations;scene;clock;constructor(){this.animations=[],this.scene=null,this.clock=new e.Clock}static get Instance(){return x._instance||(x._instance=new x),x._instance}initScene(e){this.scene||(this.scene=e,this.clock.start())}update(){const t=1e3*this.clock.getElapsedTime();this.animations=this.animations.filter(n=>{const r=t-n.startTime,_=n.endTime-n.startTime,o=(s=r/_,Math.min(Math.max(s,0),1));var s;if(t>=n.endTime)return n.loop?(n.startTime=t,n.endTime=t+_,n.end.position&&n.mesh.position.copy(n.start.position),n.end.rotation&&n.mesh.rotation.copy(n.start.rotation),n.end.scaling&&n.mesh.scale.copy(n.start.scaling),!0):(n.end.position&&n.mesh.position.copy(n.end.position),n.end.rotation&&n.mesh.rotation.copy(n.end.rotation),n.end.scaling&&n.mesh.scale.copy(n.end.scaling),n.resolve&&(n.resolve(),n.resolve=void 0,n.reject=void 0),!1);if(n.end.position&&n.mesh.position.lerpVectors(n.start.position,n.end.position,n.easeFunc(o)),n.end.rotation){const t=n.start.rotation,r=n.end.rotation,_=new e.Euler;_.x=t.x+(r.x-t.x)*n.easeFunc(o),_.y=t.y+(r.y-t.y)*n.easeFunc(o),_.z=t.z+(r.z-t.z)*n.easeFunc(o),n.mesh.rotation.copy(_)}return n.end.scaling&&n.mesh.scale.lerpVectors(n.start.scaling,n.end.scaling,n.easeFunc(o)),!0})}animateTransform(e){const{mesh:t,end:n}=e,r=e.duration||1e3,_=e.delay||0,o=e.ease||w,s=1e3*this.clock.getElapsedTime();let a,i;const c=new Promise((e,t)=>{a=e,i=t});return this.animations.push({mesh:t,start:{position:t.position.clone(),rotation:t.rotation.clone(),scaling:t.scale.clone()},end:n,easeFunc:o,startTime:s+_,endTime:s+_+r,loop:e.loop||!1,resolve:a,reject:i}),c}cancelAnimation(e,t=!1){const n=this.animations.filter(t=>t.mesh===e);n.length&&(n.forEach(n=>{t&&(n.end.position&&e.position.copy(n.end.position),n.end.rotation&&e.rotation.copy(n.end.rotation),n.end.scaling&&e.scale.copy(n.end.scaling)),n.reject&&(n.reject(),n.resolve=void 0,n.reject=void 0)}),this.animations=this.animations.filter(t=>t.mesh!==e))}}class C{constructor(){this.mOscillators=[this.osc_sin.bind(this),this.osc_square.bind(this),this.osc_saw.bind(this),this.osc_tri.bind(this)],this.mSong=null,this.mLastRow=0,this.mCurrentCol=0,this.mNumWords=0,this.mMixBuf=null}osc_sin(e){return Math.sin(6.283184*e)}osc_saw(e){return e%1*2-1}osc_square(e){return e%1<.5?1:-1}osc_tri(e){var t=e%1*4;return t<2?t-1:3-t}getnotefreq(e){return.003959503758*2**((e-128)/12)}createNote(e,t,n){var r,_,o,s,a,i,c=this.mOscillators[e.i[0]],l=e.i[1],d=e.i[3]/32,u=this.mOscillators[e.i[4]],f=e.i[5],h=e.i[8]/32,p=e.i[9],m=e.i[10]*e.i[10]*4,g=e.i[11]*e.i[11]*4,b=e.i[12]*e.i[12]*4,y=1/b,v=-e.i[13]/16,w=e.i[14],x=n*2**(2-e.i[15]),C=new Int32Array(m+g+b),M=0,F=0;for(r=0,_=0;r<m+g+b;r++,_++)_>=0&&(w=w>>8|(255&w)<<4,_-=x,a=this.getnotefreq(t+(15&w)+e.i[2]-128),i=this.getnotefreq(t+(15&w)+e.i[6]-128)*(1+8e-4*e.i[7])),o=1,r<m?o=r/m:r>=m+g&&(o=(1-(o=(r-m-g)*y))*3**(v*o)),s=c(M+=a*o**d)*l,s+=u(F+=i*o**h)*f,p&&(s+=(2*Math.random()-1)*p),C[r]=80*s*o|0;return C}async init(e){return new Promise(t=>{this.mSong=e,this.mLastRow=e.endPattern,this.mCurrentCol=0,this.mNumWords=e.rowLen*e.patternLen*(this.mLastRow+1)*2,this.mMixBuf=new Int32Array(this.mNumWords),t()})}generateChannel(e){return new Promise(t=>{var n,r,_,o,s,a,i,c,l,d,u,f,h,p,m=new Int32Array(this.mNumWords),g=this.mSong.songData[e],b=this.mSong.rowLen,y=this.mSong.patternLen,v=0,w=0,x=!1,C=[];for(_=0;_<=this.mLastRow;++_)for(i=g.p[_],o=0;o<y;++o){var M=i?g.c[i-1].f[o]:0;M&&(g.i[M-1]=g.c[i-1].f[o+y]||0,M<17&&(C=[]));var F=this.mOscillators[g.i[16]],I=g.i[17]/512,E=2**(g.i[18]-9)/b,P=g.i[19],B=g.i[20],L=43.23529*g.i[21]*3.141592/44100,S=1-g.i[22]/255,T=1e-5*g.i[23],R=g.i[24]/32,k=g.i[25]/512,D=6.283184*2**(g.i[26]-9)/b,O=g.i[27]/255,A=g.i[28]*b&-2;for(u=(_*y+o)*b,s=0;s<4;++s)if(a=i?g.c[i-1].n[o+s*y]:0){C[a]||(C[a]=this.createNote(g,a,b));var N=C[a];for(r=0,n=2*u;r<N.length;r++,n+=2)m[n]+=N[r]}for(r=0;r<b;r++)(d=m[c=2*(u+r)])||x?(f=L,P&&(f*=F(E*c)*I+.5),w+=(f=1.5*Math.sin(f))*(h=S*(d-w)-(v+=f*w)),d=3==B?w:1==B?h:v,T&&(d=(d*=T)<1?d>-1?this.osc_sin(.25*d):-1:1,d/=T),x=(d*=R)*d>1e-5,p=d*(1-(l=Math.sin(D*c)*k+.5)),d*=l):p=0,c>=A&&(p+=m[c-A+1]*O,d+=m[c-A]*O),m[c]=0|p,m[c+1]=0|d,this.mMixBuf[c]+=0|p,this.mMixBuf[c+1]+=0|d}t()})}async generate(){this.mMixBuf.fill(0),this.mCurrentCol=0;const e=[];for(let t=0;t<this.mSong.numChannels;t++)e.push(this.generateChannel(t));return await Promise.all(e),this.mCurrentCol=this.mSong.numChannels,1}createAudioBuffer(e){for(var t=e.createBuffer(2,this.mNumWords/2,44100),n=0;n<2;n++)for(var r=t.getChannelData(n),_=n;_<this.mNumWords;_+=2)r[_>>1]=this.mMixBuf[_]/65536;return t}createAudioBufferRange(e,t=0,n=null){(null===n||n>this.mNumWords/2)&&(n=this.mNumWords/2),t<0&&(t=0),t>=n&&(t=n-1);const r=n-t;for(var _=e.createBuffer(2,r,44100),o=0;o<2;o++)for(var s=_.getChannelData(o),a=0;a<r;a++){var i=2*(t+a)+o;s[a]=this.mMixBuf[i]/65536}return _}createWave(){var e=44+2*this.mNumWords-8,t=e-36,n=new Uint8Array(44+2*this.mNumWords);n.set([82,73,70,70,255&e,e>>8&255,e>>16&255,e>>24&255,87,65,86,69,102,109,116,32,16,0,0,0,1,0,2,0,68,172,0,0,16,177,2,0,4,0,16,0,100,97,116,97,255&t,t>>8&255,t>>16&255,t>>24&255]);for(var r=0,_=44;r<this.mNumWords;++r){var o=this.mMixBuf[r];o=o<-32767?-32767:o>32767?32767:o,n[_++]=255&o,n[_++]=o>>8&255}return n}createWaveRange(e=0,t=null){(null===t||t>this.mNumWords/2)&&(t=this.mNumWords/2),e<0&&(e=0),e>=t&&(e=t-1);const n=t-e;var r=44+2*n-8,_=r-36,o=new Uint8Array(44+2*n);o.set([82,73,70,70,255&r,r>>8&255,r>>16&255,r>>24&255,87,65,86,69,102,109,116,32,16,0,0,0,1,0,2,0,68,172,0,0,16,177,2,0,4,0,16,0,100,97,116,97,255&_,_>>8&255,_>>16&255,_>>24&255]);for(var s=0,a=44;s<n;++s){var i=this.mMixBuf[2*(e+s)];i=i<-32767?-32767:i>32767?32767:i,o[a++]=255&i,o[a++]=i>>8&255}return o}getData(e,t){for(var n=2*Math.floor(44100*e),r=new Array(t),_=0;_<2*t;_+=1){var o=n+_;r[_]=e>0&&o<this.mMixBuf.length?this.mMixBuf[o]/32768:0}return r}}new(window.AudioContext||window.webkitAudioContext);var M={songData:[{i:[0,255,116,85,0,255,116,0,37,14,4,6,73,99,0,0,0,0,0,0,2,136,15,0,32,0,0,0,6],p:[1,1,1,,2,,1,1,2,2],c:[{n:[139,,,,139,,,,139,,,,139,,,,139,,,,139,,,,139,,139,,139,,139],f:[]},{n:[140,,140,,,,140,,,,140,,140,,140,,,,140,,140,,,,140,,140,,,,140],f:[]}]},{i:[0,160,128,64,0,160,128,0,64,210,4,7,52,85,0,0,0,60,4,1,2,255,0,0,32,61,5,0,6],p:[,1,2,1,2,1,2,1,1,1],c:[{n:[,,,,139,,,,,,,,139,,,,,,,,139,,,,,,,,139,,139],f:[]},{n:[,,,,,,,,,,,,139,,139,,,,,,,,,,,,,,139,,139],f:[]}]},{i:[0,255,106,64,0,255,106,0,64,0,5,7,164,0,0,0,0,0,0,0,2,255,0,2,32,83,5,25,1],p:[,,,1,,,2,1,1,2],c:[{n:[144,,,,,,,,,,,,,,,,144],f:[]},{n:[,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,156,,,,,,,,,,,,,,,,156],f:[]}]},{i:[0,91,128,0,0,95,128,12,0,0,12,0,72,0,0,0,0,0,0,0,2,255,0,0,32,83,3,130,4],p:[,,,1,,1,1,1,2,2],c:[{n:[132,,,,,,,,132,,,,,,,,144,,,,,,,,144],f:[]},{n:[],f:[]}]},{i:[1,192,128,0,1,191,116,9,0,0,6,22,34,0,0,0,0,69,3,1,1,23,167,0,32,77,6,25,6],p:[,,2,,1,,1,2,2,1],c:[{n:[144,,,,144,,,,144,,,,142,,142,,144,,144,,144,,,,144,,,,144,,,,147,,,,151,,,,147,,,,149,,149,,147,,147,,151,,,,147,,,,147,,,,151,,,,154,,,,151,,,,151,,151,,151,,151,,154,,,,151,,,,151],f:[]},{n:[144,144,144,,144,,,,,,,,,,,,,,,,,,,,,,,,,,,,147,147,147,,147,,,,,,,,,,,,,,,,,,,,,,,,,,,,151,151,151,,151],f:[]}]}],rowLen:5513,patternLen:32,endPattern:9,numChannels:5};const F=new AudioContext;let I=0;_.Instance.on("progress",e=>{const t=e.bestComboCount||0;I=Math.min(t,6)});const E={color:o,artist:s,title:a};let P,B,L,S,T,R,k,D,O;const A=new e.Vector3(0,0,.3),N=async()=>{(async()=>{const e=new C;await e.init(M),await e.generate();const t=[];for(let a=0;a<6;a++){const n=176400*a,r=n+176400,_=e.createAudioBufferRange(F,n,r);t.push(_)}const n=e.createAudioBufferRange(F,1058400,1764e3),r=[...t,n];let _=null,o=!1;const s=e=>{let t;_&&(_.stop(),_.disconnect()),t=e<6?e:6;const n=r[t];_=F.createBufferSource(),_.buffer=n,_.connect(F.destination),_.loop=!0,_.start();const a=setInterval(()=>{I!==e&&(clearInterval(a),s(I))},2e3);o=!0};s(I)})(),document.getElementById("intro").style.display="none",document.getElementById("playButton").setAttribute("disabled","true");const t=document.getElementById("c");if(!t)return;t.style.display="block",S=new e.WebGLRenderer({antialias:!0}),S.setPixelRatio(window.devicePixelRatio),S.setSize(window.innerWidth,window.innerHeight),S.setClearColor("#000000"),S.xr.addEventListener("sessionstart",W),S.xr.enabled=!0,S.setAnimationLoop(z),document.body.appendChild(h.createButton(S)),document.body.appendChild(S.domElement);const n=new f;B=new e.Scene,P=new e.PerspectiveCamera(75,window.innerWidth/window.innerHeight,.1,1e3),P.position.set(0,2,1),P.rotation.set(-1*Math.PI/12,0,0),P.name="camera",B.add(P),x.Instance.initScene(B);const o=new e.AmbientLight(16777215,.8);B.add(o);const l=new e.DirectionalLight(16777215,.8);l.position.set(6,10,8),l.castShadow=!0,l.target.position.set(0,0,0),B.add(l),B.add(l.target);const d=(()=>{const t=new e.Group;t.name="debugScreen",t.renderOrder=1;const n=new e.PlaneGeometry(5,5);n.translate(0,-2,0);const r=y(["You win!","Thanks for playing","Created by Alex Swan"],"white"),o=new e.Mesh(n,r);return t.add(o),o.position.set(0,0,0),o.visible=!1,_.Instance.on("progress",e=>{e.color.solved&&e.artist.solved&&e.title.solved&&(o.userData.solved=!0,o.visible=!0,o.material.needsUpdate=!0)}),t})();d.position.set(0,4,-1),B.add(d),D=r("cassette"),D.position.set(0,0,-20),D.userData.isPickable=!0,B.add(D),x.Instance.animateTransform({mesh:D,end:{rotation:new e.Euler(0,2*Math.PI-.01,0)},duration:3e3,ease:e=>e,loop:!0});const u=r("arena"),m=u.getObjectByName("tableA");B.add(u),((t,n)=>{const o=[];let s=0;const a=[],i=new e.Group,c=r("cat");c.scale.set(.03125,.03125,.03125);for(let r=0;r<10;r++){const t=c.clone();t.position.set(e.MathUtils.randFloat(-6,6),e.MathUtils.randFloat(1.5,2.5),e.MathUtils.randFloat(-5,5)),t.rotation.set(0,e.MathUtils.randFloat(Math.PI,3*Math.PI),0),t.userData.offset=60*e.MathUtils.randInt(0,1e3),i.add(t),o.push(t)}return t.add(i),_.Instance.on("tick",()=>{if(!n.xr?.getCamera())return;const t=n.xr?.getCamera();if(t){s++;const n=(new e.Quaternion).setFromEuler(new e.Euler(0,Math.PI,0)).multiply(t.quaternion.clone());a.push(n)}o.forEach(e=>{const t=a[(e.userData.offset+s)%a.length];t&&e.quaternion.copy(t)})}),i})(u.getObjectByName("floor"),S).name="Crowd";const g=r("cat");g.position.set(-3,1,0),g.scale.set(.1,.1,.1),g.rotation.set(0,-Math.PI/4,0),B.add(g);const w=g.clone(!0);w.name="catMesh2",w.position.set(3,1,0),w.rotation.set(0,Math.PI/4,0),B.add(w),n.vinyls.forEach((t,r)=>{const _=(({color:t,artist:n,title:r})=>{const _=new e.Group,o=new e.RingGeometry(4,7,32);o.scale(v,v,v);const c=b(t,{glow:!0});_.add(new e.Mesh(o,c));const l=new e.RingGeometry(.25,4,32);l.scale(v,v,v);const d=b(16777215,{});_.add(new e.Mesh(l,d));const u=new e.PlaneGeometry(14,14);u.translate(0,0,.001),u.scale(v,v,v);const f=((t,n)=>{const[r,_]=p(1024);_.fillStyle=i,_.strokeStyle=i,_.lineWidth=8,_.beginPath(),_.arc(512,512,20,0,2*Math.PI),_.stroke(),_.beginPath(),_.arc(512,512,288,0,2*Math.PI),_.stroke(),_.textAlign="center",t&&(_.font="64px monospace",_.textBaseline="middle",_.strokeStyle=i,_.lineWidth=8,_.strokeText(t,512,430.08),_.fillStyle=s,_.fillText(t,512,430.08)),n&&(_.font="96px monospace",_.textBaseline="bottom",_.fillStyle=a,_.strokeText(n,512,696.32),_.fillText(n,512,696.32));const o=new e.CanvasTexture(r);return o.encoding=e.LinearSRGBColorSpace,new e.MeshBasicMaterial({map:o,transparent:!0})})(n,r);_.add(new e.Mesh(u,f));const h=_.clone();return h.rotation.set(0,Math.PI,0),h.position.set(0,0,-.002),_.add(h),_})(t);_.name=`vinyl-${r}`;const o=new e.Vector3(.7,1.15,-.2-.125*r);_.position.copy(o),_.userData.originalPosition=o,_.userData.isPickable=!0,_.userData.recordIndex=r,_.userData.returnToOriginalPosition=()=>{B.attach(_),x.Instance.cancelAnimation(_),x.Instance.animateTransform({mesh:_,end:{position:_.userData.originalPosition,rotation:new e.Euler(0,0,0)},duration:100})},_.onPointerPick=t=>{if(t.userData.selected)return;n.selected[t.id]=r;const o=t.getObjectByName("target");o&&(x.Instance.cancelAnimation(_),o.attach(_),x.Instance.animateTransform({mesh:_,end:{position:new e.Vector3(0,0,0),rotation:new e.Euler(0,Math.PI/2,0)},duration:60}),t.userData.selected=_)},_.onPointerDrop=t=>{if(x.Instance.cancelAnimation(_,!0),_.getWorldPosition(new e.Vector3).distanceTo(m.getWorldPosition(new e.Vector3))<.3)return n.addVinylByIndex(_.userData.recordIndex),delete n.selected[t.id],t.userData.selected=void 0,m.children.forEach(e=>{e.userData.returnToOriginalPosition&&e.userData.returnToOriginalPosition()}),m.attach(_),void x.Instance.animateTransform({mesh:_,end:{position:new e.Vector3(0,.01,0),rotation:new e.Euler(-1*Math.PI/2,0,0)},duration:60}).then(()=>{x.Instance.animateTransform({mesh:_,end:{rotation:new e.Euler(-1*Math.PI/2,0,-2*Math.PI)},ease:e=>e,duration:1800,loop:!0})});_.userData.returnToOriginalPosition(),t.userData.selected=void 0},B.add(_)}),R=S.xr.getController(0),R.addEventListener("connected",U),R.addEventListener("selectstart",j),R.addEventListener("selectend",G),R.addEventListener("squeezestart",j),R.addEventListener("squeezeend",G),B.add(R),k=S.xr.getController(1),k.addEventListener("connected",U),k.addEventListener("selectstart",j),k.addEventListener("selectend",G),k.addEventListener("squeezestart",j),k.addEventListener("squeezeend",G),B.add(k),L=new e.Raycaster,window.addEventListener("resize",H,!1),_.Instance.on("progress",t=>{let r="color";t.artist.correctCount>=t[r].correctCount&&(r="artist"),t.title.correctCount>=t[r].correctCount&&(r="title");for(let o=0;o<6;o++){const _=n.getVinylInQueue(t[r].correctCount-o-1),s=u.getObjectByName(`progress-${o}`);let a=o<t[r].correctCount?E[r]:0;if(o<t[r].correctCount&&"color"===r&&(a=c[o]),s){s.visible=!0,s.material.color.set(a),s.material.emissive.set(a),s.material.needsUpdate=!0;let n=s.getObjectByName("progress-label");if(!n){const t=new e.PlaneGeometry(1,1);t.translate(.1,.1,.15),t.rotateZ(Math.PI/8),n=new e.Mesh(t),n.renderOrder=1,n.name="progress-label",s.add(n)}n.visible=!!(o<t[r].correctCount&&_),_&&(n.material=y([_[r]],a)),"color"===r&&(n.visible=!1),t[r].solved&&(n.visible=!1)}}const _=Object.keys(t);for(let e=0;e<_.length;e++){const n=_[e],r=u.getObjectByName(`complete-${e}`),o=t[n].solved?E[n]:0;r&&(r.visible=!0,r.material.color.set(o),r.material.emissive.set(o),r.material.needsUpdate=!0)}}),n.reset()};function W(){O=S.xr.getReferenceSpace();const t={x:-1*A.x,y:-1*A.y,z:-1*A.z,w:1},n=new e.Quaternion,r=new XRRigidTransform(t,n),_=O.getOffsetReferenceSpace(r);S.xr.setReferenceSpace(_)}function U(t){const n=t.target,o="left"===t.data.handedness?-1:1,s=t.data.hand?0:o*Math.PI/2;if(_.Instance.emit("debug",`Hand: ${t.data.hand}`),!n.getObjectByName("target")){const t=new e.Group;t.name="target",t.rotation.set(0,0,0),t.position.set(-1*o*.035,.05,-.12),n.add(t)}let a=n.getObjectByName("paw");a||(a=r("paw"),a.position.set(0,0,.15),a.rotation.set(3*Math.PI/2,s,0),n.add(a.clone(!0)));let i=n.getObjectByName("line");if(!i){const t=(new e.BufferGeometry).setFromPoints([new e.Vector3(0,0,0),new e.Vector3(0,0,-1)]);i=new e.Line(t),i.material.color.set(16711680),i.name="line",i.scale.z=5,n.add(i)}}function j(e){T=e.target;const t=V(T);if(t.length>0){let e=!1;t.forEach(({object:t,distance:n})=>{if(e)return;let r=t;for(;r;){if(r.onPointerPick){r.onPointerPick(T),e=!0,T.getObjectByName("line").visible=!1;break}r=r.parent}})}T.userData.targetRayMode=e.data.targetRayMode}function G(e){T=e.target;const t=T.userData.selected;t?.onPointerDrop&&t.onPointerDrop(T),T.getObjectByName("line").visible=!0}function V(e){return e.updateMatrixWorld(),L.setFromXRController(e),L.intersectObjects(B.children,!0)}function q(e){if("screen"===e.userData.targetRayMode)return;if(void 0!==e.userData.selected)return;const t=e.getObjectByName("line"),n=V(e);if(t&&(t.scale.z=5),n.length>0){let e=!1;n.forEach(({object:n,distance:r})=>{if(e)return;let _=n;for(;_;){if(_.userData.isPickable){t&&(t.scale.z=r),e=!0;break}_=_.parent}})}}function z(){x.Instance.update(),_.Instance.emit("tick"),q(R),q(k),S.render(B,P)}const H=()=>{P.aspect=window.innerWidth/window.innerHeight,P.updateProjectionMatrix(),S.setSize(window.innerWidth,window.innerHeight)};window.addEventListener("DOMContentLoaded",()=>{document.getElementById("playButton").onclick=N});

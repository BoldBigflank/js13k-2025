import*as e from"https://js13kgames.com/2025/webxr/three.module.js";!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver(e=>{for(const n of e)if("childList"===n.type)for(const e of n.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)}).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();const t={uDirLightPos:{value:new e.Vector3},uDirLightColor:{value:new e.Color(15658734)},uAmbientLightColor:{value:new e.Color(328965)},uBaseColor:{value:new e.Color(16777215)},uLineColor1:{value:new e.Color(0)}},n=_=>{const r=new e.Group;return r.position.set(0,0,0),r.rotation.set(0,0,0),r.scale.set(1,1,1),_.forEach(_=>{if(null!==_)if(Array.isArray(_))r.add(n(_));else{const[n,o,s,i,a,c,l,d,u,f,h,m,g,p,b]=_.split("_");let y=null;switch(n){case"cube":y=(t=>{const[n,_,r,o,s,i,a,c,l,d,u,f,h,m,g]=t.split("_"),p=new e.BoxGeometry(r,o,s);return p.translate(i-f,a-h,c-m),p.rotateX(e.MathUtils.degToRad(l)),p.rotateY(e.MathUtils.degToRad(d)),p.rotateZ(e.MathUtils.degToRad(u)),p})(_);break;case"sphere":y=(t=>{const[n,_,r,o,s,i,a,c,l,d,u,f,h,m,g]=t.split("_"),p=new e.SphereGeometry(parseFloat(r)/2,32,16);return p.scale(r/r,o/r,s/r),p.translate(i-f,a-h,c-m),p.rotateX(e.MathUtils.degToRad(l)),p.rotateY(e.MathUtils.degToRad(d)),p.rotateZ(e.MathUtils.degToRad(u)),p})(_);break;case"plane":y=(t=>{const[n,_,r,o,s,i,a,c,l,d,u,f,h,m,g]=t.split("_"),p=new e.PlaneGeometry(r,o);return p.rotateX(e.MathUtils.degToRad(-90)),p.translate(i-f,a-h,c-m),p.rotateX(e.MathUtils.degToRad(l)),p.rotateY(e.MathUtils.degToRad(d)),p.rotateZ(e.MathUtils.degToRad(u)),p})(_);break;case"cylinder":y=(t=>{const[n,_,r,o,s,i,a,c,l,d,u,f,h,m,g]=t.split("_"),p=r/2,b=new e.CylinderGeometry(p,p,o,32);b.translate(i-f,a-h,c-m),b.scale(1,1,s/r);const y=e.MathUtils.degToRad(l),v=e.MathUtils.degToRad(d),w=e.MathUtils.degToRad(u),x=new e.Euler(y,v,w);return b.applyQuaternion((new e.Quaternion).setFromEuler(x)),b})(_);break;case"pyramid":y=(t=>{const[n,_,r,o,s,i,a,c,l,d,u,f,h,m,g]=t.split("_"),p=Math.sqrt(r*r+r*r)/2,b=new e.CylinderGeometry(0,p,o,4,1,!1,Math.PI/4);return b.scale(1,1,s/r),b.translate(i-f,a-h+.3*o,c-m),b.rotateX(e.MathUtils.degToRad(l)),b.rotateY(e.MathUtils.degToRad(d)),b.rotateZ(e.MathUtils.degToRad(u)),b})(_);break;default:throw new Error(`Unknown shape: ${n}`)}let v=null;v=o.startsWith("case")?new e.ShaderMaterial({uniforms:{...t},vertexShader:"\n\n\t\tvarying vec3 vNormal;\n\n\t\tvoid main() {\n\n\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\t\t\tvNormal = normalize( normalMatrix * normal );\n\n\t\t}",fragmentShader:"\n\n\t\tuniform vec3 uBaseColor;\n\t\tuniform vec3 uLineColor1;\n\t\tuniform vec3 uLineColor2;\n\t\tuniform vec3 uLineColor3;\n\t\tuniform vec3 uLineColor4;\n\n\t\tuniform vec3 uDirLightPos;\n\t\tuniform vec3 uDirLightColor;\n\n\t\tuniform vec3 uAmbientLightColor;\n\n\t\tvarying vec3 vNormal;\n\n\t\tvoid main() {\n\n\t\t\tfloat directionalLightWeighting = max( dot( normalize(vNormal), uDirLightPos ), 0.0);\n\t\t\tvec3 lightWeighting = uAmbientLightColor + uDirLightColor * directionalLightWeighting;\n\n\t\t\tgl_FragColor = vec4( uBaseColor, 1.0 );\n\n\t\t\tif ( length(lightWeighting) < 1.00 ) {\n\n\t\t\t\tif ( ( mod(gl_FragCoord.x, 4.001) + mod(gl_FragCoord.y, 4.0) ) > 6.00 ) {\n\n\t\t\t\t\tgl_FragColor = vec4( uLineColor1, 1.0 );\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\tif ( length(lightWeighting) < 0.50 ) {\n\n\t\t\t\tif ( ( mod(gl_FragCoord.x + 2.0, 4.001) + mod(gl_FragCoord.y + 2.0, 4.0) ) > 6.00 ) {\n\n\t\t\t\t\tgl_FragColor = vec4( uLineColor1, 1.0 );\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\t#include <colorspace_fragment>\n\n\t\t}"}):new e.MeshStandardMaterial({color:b,side:e.DoubleSide});const w=new e.Mesh(y,v);w.name=o,w.position.set(m,g,p),r.add(w)}}),r},_=e=>{if("cassette"===e){const e=n([["cube_case1_1_8_2_7.50_4_0_0_0_0_7.50_4_0_#0000ff","cube_case2_3_9_2_5.50_4.50_0_0_0_0_5.50_4.50_0_#0000ff","cube_case3_8_4_2_0_7_0_0_0_0_0_8.50_0_#0000ff","cube_case4_8_1_2_0_2.50_0_0_0_0_0_2.50_0_#0000ff","cube_case5_3_9_2_-5.50_4.50_0_0_0_0_-5.50_4.50_0_#0000ff","cube_case6_1_8_2_-7.50_4_0_0_0_0_-7.50_4_0_#0000ff"],"cube_base_12_2.10_2.40_0_0.95_0_0_0_0_0_0_0_#ff0000","cube_rightReel_2_2_1_2.72_3.89_0_0_0_-45_2.72_3.89_0_#ff7300","cube_rightTape_4_4_0.20_2.81_3.91_-0.10_0_0_-45_2.81_3.91_-0.10_#c300ff","cube_leftReel_2_2_1_-2.69_3.91_0_0_0_-45_-2.75_4_0_#ff7300","sphere_dot_1_1_1_0_4_0_0_0_0_0_4_0_#9999ff","plane_label_12_3_0_0_7_1.01_90_0_0_0_7_1.01_#d3d3d3","cylinder_base_16_8_16_0_-4_0_0_0_0_0_-4_0_#00ff00"]);return e.name="cassette",e}if("arena"===e){const e=n([[["cube_complete-0_0.3_0.1_0.1_-0.75_1.05_-0.45_0_0_0_-0.75_1.05_-0.45_#ff0000","cube_complete-1_0.3_0.1_0.1_-0.75_1.05_-0.35_0_0_0_-0.75_1.05_-0.35_#00ff00","cube_complete-2_0.3_0.1_0.1_-0.75_1.05_-0.25_0_0_0_-0.75_1.05_-0.25_#0000ff"],["sphere_progress-0_0.2_0.2_0.2_-0.75_1.05_-0.75_0_0_0_-0.75_1.05_-0.75_#fffb00","sphere_progress-1_0.2_0.2_0.2_-0.55_1.05_-0.75_0_0_0_-0.55_1.05_-0.75_#fffb00","sphere_progress-2_0.2_0.2_0.2_-0.35_1.05_-0.75_0_0_0_-0.35_1.05_-0.75_#fffb00","sphere_progress-3_0.2_0.2_0.2_-0.15_1.05_-0.75_0_0_0_-0.15_1.05_-0.75_#fffb00","sphere_progress-4_0.2_0.2_0.2_0.05_1.05_-0.75_0_0_0_0.05_1.05_-0.75_#fffb00","sphere_progress-5_0.2_0.2_0.2_0.25_1.05_-0.75_0_0_0_0.25_1.05_-0.75_#fffb00"],"cube_desk_2_0.1_1_0_0.85_-0.5_0_0_0_0_-0.1_0_#fffb00","cube_leg_0.1_0.8_0.1_-0.85_0.4_-0.85_0_0_0_0.1_0_-0.9_#fffb00","cube_leg_0.1_0.8_0.1_-0.85_0.4_-0.15_0_0_0_0.1_0_-0.2_#fffb00","cube_leg_0.1_0.8_0.1_0.85_0.4_-0.15_0_0_0_1.8_0_-0.2_#fffb00","cube_leg_0.1_0.8_0.1_0.85_0.4_-0.85_0_0_0_1.8_0_-0.9_#fffb00","cube_record-rack_0.4_0.1_0.8_0.7_0.95_-0.5_0_0_0_0.7_0.95_-0.5_#b0ffb0","cube_progress-bar_1.3_0.1_0.3_-0.25_0.95_-0.75_0_0_0_-0.25_0.95_-0.75_#d3d3d3","cube_cube_0.3_0.1_0.4_-0.75_0.95_-0.3_0_0_0_-0.75_0.95_-0.3_#9999ff","cube_cube_0.4_0.1_0.4_-0.3_0.95_-0.3_0_0_0_-0.3_0.95_-0.3_#d3d3d3","cube_tableA_0.4_0.1_0.4_0.2_0.95_-0.3_0_0_0_0.2_1.01_-0.3_#b0ffb0","cylinder_pad_0.4_0.02_0.4_0.2_1_-0.3_0_0_0_0.2_1_-0.3_#ff0000"],"cube_cube_22_1_4_0_-1.5_-12_0_0_0_0_-2_-4_#ff00ff","cube_cube_22_1_15_0_-2.5_-2.5_0_0_0_0_-3_-4_#ff0000","cube_cube_8_2_3_0_-1_0.5_0_0_0_0_-1_-4_#c300ff","cube_pillar_1_4_1_7.5_0_-2.5_0_0_0_8_0_-3_#fffb00","cube_pillar_1_4_1_7.5_0_-6.5_0_0_0_8_0_-7_#fffb00","cube_pillar_1_3_1_7.5_0.5_-10.5_0_0_0_8_0_-11_#fffb00","cube_pillar_1_4_1_7.5_0_-10.5_0_0_0_8_0_-11_#fffb00","cube_pillar_1_4_1_-7.5_0_-2.5_0_0_0_-7_0_-3_#fffb00","cube_pillar_1_4_1_-7.5_0_1.5_0_0_0_-7_0_1_#fffb00","cube_pillar_1_4_1_7.5_0_1.5_0_0_0_8_0_1_#fffb00","cube_pillar_1_4_1_-7.5_0_-6.5_0_0_0_-7_0_-7_#fffb00","cube_pillar_1_3_1_-7.5_0.5_-10.5_0_0_0_-7_0_-11_#fffb00","cube_cube_4_1_16_9_2.5_-6_0_0_0_8_2_0_#00ff00","cube_cube_4_1_16_-9_2.5_-6_0_0_0_-10_2_0_#00ff00"]);return e.name="arena",e}if("cat"===e){const e=n(["sphere_head_16_16_16_0_8_0_0_0_0_0_8_0_#c300ff",["cylinder_leftEye_4_1_4_-3_11_-6.3_-60_0_25_-3_11_-6.3_#fffb00","sphere_leftPupil_2_2_4_-3.6_11.3_-7_-60_0_25_-3.6_11.3_-7_#c300ff","cylinder_rightEye_4_1_4_3_11_-6.3_-60_0_-25_3_11_-6.3_#fffb00","sphere_rightPupil_2_2_4_3.4_11.3_-7_-60_0_-25_3.4_11.3_-7_#c300ff"],["cube_rightCheek_3_3_2_1.84_6.53_-7.5_-25_0_80_1.84_6.53_-7.5_#0000ff","cube_leftCheek_3_3_2_-1.91_6.48_-7.5_0_23_10_-1.91_6.48_-7.5_#0000ff","cube_tongue_2_2_2_0_5_-7_0_0_0_0_4_-7_#ff0000","pyramid_pyramid_3_1.6_1_0_8.2_-8_-180_0_0_0_8.2_-8_#ff00ff"],["pyramid_ear_6_11_4_-4.86_15.55_-1.28_-14_-6_24_-4.86_15.55_-1.28_#c300ff","pyramid_ear_5_9.5_4_-5.04_15.94_-1.59_-14_-6_24_-5.04_15.94_-1.59_#fffb00","pyramid_ear_6_11_4_4.86_15.55_-1.28_-14_6_-24_4.86_15.55_-1.28_#c300ff","pyramid_ear_5_9.5_4_5.04_15.94_-1.59_-14_6_-24_5.04_15.94_-1.59_#fffb00"],["cylinder_cylinder_0.2_6_0.2_-3.93_6_-8.92_0_-15_90_-3.93_6_-8.92_#d3d3d3","cylinder_cylinder_0.2_4_0.2_-4.87_7.52_-8.5_0_-15_75_-4.87_7.52_-8.5_#d3d3d3","cylinder_cylinder_0.2_4_0.2_-4.87_4.48_-8.5_0_-15_105_-4.87_4.48_-8.5_#d3d3d3","cylinder_cylinder_0.2_4_0.2_4.87_7.52_-8.5_180_-15_-105_4.87_7.52_-8.5_#d3d3d3","cylinder_cylinder_0.2_6_0.2_3.93_6_-8.92_0_-165_90_3.93_6_-8.92_#d3d3d3","cylinder_cylinder_0.2_4_0.2_4.87_4.48_-8.5_180_-15_-75_4.87_4.48_-8.5_#d3d3d3"]]);return e.name="cat",e}if("paw"===e){const e=n(["cylinder_cylinder_4_6_2_0_-1_0_0_0_0_0_-1_0_#c300ff","sphere_sphere_4_4_2_0_2_0_0_0_0_0_2_0_#c300ff","cube_cube_0.3_1_0.3_-1.15_3.5_-0.55_-77_0_0_-1.15_3.5_-0.55_#d3d3d3","cube_cube_0.3_1_0.3_-0.45_3.9_-0.55_-77_0_0_-0.45_3.9_-0.55_#d3d3d3","cube_cube_0.3_1_0.3_0.45_3.9_-0.55_-77_0_0_0.45_3.9_-0.55_#d3d3d3","cube_cube_0.3_1_0.3_1.05_3.6_-0.55_-77_0_0_1.05_3.6_-0.55_#d3d3d3","cube_cube_2_0.7_0.4_0_1.85_-0.9_0_0_0_0_1.5_-0.1_#ff0000","cube_cube_0.8_0.5_1.1_0_2.45_-0.55_0_0_0_0_2.2_-0.1_#ff0000","cube_cube_0.3_0.6_0.6_-1.15_2.7_-0.8_0_0_0_-1.15_2.7_-0.1_#ff0000","cube_cube_0.3_0.6_0.6_-0.45_3.1_-0.8_0_0_0_-0.45_3.1_-0.1_#ff0000","cube_cube_0.3_0.6_0.6_0.45_3.1_-0.8_0_0_0_0.45_3.1_-0.1_#ff0000","cube_cube_0.3_0.6_0.6_1.05_2.7_-0.8_0_0_0_1.05_2.7_-0.1_#ff0000"]);return e.name="paw",e.scale.set(.03125,.03125,.03125),e}return null};class r{static _instance;callbacks;constructor(){this.callbacks={}}static get Instance(){return r._instance||(r._instance=new r),r._instance}on(e,t){this.callbacks[e]=this.callbacks[e]||[],this.callbacks[e].push(t)}off(e,t){this.callbacks[e]=(this.callbacks[e]||[]).filter(e=>e!==t)}emit(e,...t){(this.callbacks[e]||[]).forEach(e=>e(...t))}_reset(){Object.keys(this.callbacks).forEach(e=>{delete this.callbacks[e]})}getCallbacks(){return this.callbacks}}const o="#e81416",s="#79c314",i="#487de7",a="#000000",c=[o,"#ffa500","#faeb36",s,i,"#70369d"],l=["Shiny Toy Guns","B.B. King","Jack White","Black Sabbath","Faith Hill","Cliff Sheen"],d=["OFFSIDE","SHOWCASE","LOADOUT","BACKHAND","BOOKMARKS","MANPOWER"],u=[[0,1,2,3,4,5],[0,2,4,1,5,3],[0,3,5,1,4,2]];class f{queue;selected;vinyls;progress;constructor(){this.queue=[],this.selected={},this.vinyls=[],this.reset(),this.progress.bestComboType="color"}addVinylByIndex(e){if(this.queue[0]===e)return;const{color:t,artist:n,title:_}=this.vinyls[e],o=c.indexOf(t),s=l.indexOf(n),i=d.indexOf(_);o===this.progress.color.currentIndex+1?(this.progress.color.correctCount++,this.progress.color.correctCount===c.length&&(this.progress.color.solved=!0),this.progress.color.currentIndex=o):(this.progress.color.currentIndex=-1,this.progress.color.correctCount=0),s===(this.progress.artist.currentIndex+1)%l.length?(this.progress.artist.correctCount++,this.progress.artist.correctCount===l.length&&(this.progress.artist.solved=!0)):this.progress.artist.correctCount=1,this.progress.artist.currentIndex=s,i===(this.progress.title.currentIndex+1)%d.length?(this.progress.title.correctCount++,this.progress.title.correctCount===d.length&&(this.progress.title.solved=!0)):this.progress.title.correctCount=1,this.progress.title.currentIndex=i,this.progress.bestComboCount=Math.max(this.progress.color.correctCount,this.progress.artist.correctCount,this.progress.title.correctCount),this.progress.bestComboType=this.progress.color.correctCount===this.progress.bestComboCount?"color":this.progress.artist.correctCount===this.progress.bestComboCount?"artist":"title",this.queue.unshift(e),r.Instance.emit("progress",this.progress),r.Instance.emit("debug",JSON.stringify(this.progress))}getVinylInQueue(e){return this.vinyls[this.queue[e]]}isSolved(e){return this.progress[e].solved}reset(){this.queue=[],this.selected={};const[e,t,n]=u;this.progress={color:{currentIndex:-1,correctCount:0,solved:!1},artist:{currentIndex:-2,correctCount:0,solved:!1},title:{currentIndex:-2,correctCount:0,solved:!1},bestComboType:"color",bestComboCount:0},this.vinyls=c.map((e,t)=>({index:t,color:e,artist:"",title:""})),e.forEach((e,t)=>{this.vinyls[e].color=c[t]}),t.forEach((e,t)=>{this.vinyls[e].artist=l[t]}),n.forEach((e,t)=>{this.vinyls[e].title=d[t]}),r.Instance.emit("progress",this.progress)}}class h{static createButton(e,t={}){const n=document.createElement("button");function _(){n.style.display="",n.style.cursor="auto",n.style.left="calc(50% - 75px)",n.style.width="150px",n.onmouseenter=null,n.onmouseleave=null,n.onclick=null}function r(e){e.style.position="absolute",e.style.bottom="20px",e.style.padding="12px 6px",e.style.border="1px solid #fff",e.style.borderRadius="4px",e.style.background="rgba(0,0,0,0.1)",e.style.color="#fff",e.style.font="normal 13px sans-serif",e.style.textAlign="center",e.style.opacity="0.5",e.style.outline="none",e.style.zIndex="999"}if("xr"in navigator)return n.id="VRButton",n.style.display="none",r(n),navigator.xr.isSessionSupported("immersive-vr").then(function(r){r?function(){let _=null;async function r(t){t.addEventListener("end",o),await e.xr.setSession(t),n.textContent="EXIT VR",_=t}function o(){_.removeEventListener("end",o),n.textContent="ENTER VR",_=null}n.style.display="",n.style.cursor="pointer",n.style.left="calc(50% - 50px)",n.style.width="100px",n.textContent="ENTER VR";const s={...t,optionalFeatures:["local-floor","bounded-floor","layers",...t.optionalFeatures||[]]};n.onmouseenter=function(){n.style.opacity="1.0"},n.onmouseleave=function(){n.style.opacity="0.5"},n.onclick=function(){null===_?navigator.xr.requestSession("immersive-vr",s).then(r):(_.end(),void 0!==navigator.xr.offerSession&&navigator.xr.offerSession("immersive-vr",s).then(r).catch(e=>{}))},void 0!==navigator.xr.offerSession&&navigator.xr.offerSession("immersive-vr",s).then(r).catch(e=>{})}():(_(),n.textContent="VR NOT SUPPORTED"),r&&h.xrSessionIsGranted&&n.click()}).catch(function(e){_(),n.textContent="VR NOT ALLOWED"}),n;{const e=document.createElement("a");return!1===window.isSecureContext?(e.href=document.location.href.replace(/^http:/,"https:"),e.innerHTML="WEBXR NEEDS HTTPS"):(e.href="https://immersiveweb.dev/",e.innerHTML="WEBXR NOT AVAILABLE"),e.style.left="calc(50% - 90px)",e.style.width="180px",e.style.textDecoration="none",r(e),e}}static registerSessionGrantedListener(){if("undefined"!=typeof navigator&&"xr"in navigator){if(/WebXRViewer\//i.test(navigator.userAgent))return;navigator.xr.addEventListener("sessiongranted",()=>{h.xrSessionIsGranted=!0})}}}h.xrSessionIsGranted=!1,h.registerSessionGrantedListener();class m{constructor(){this.mOscillators=[this.osc_sin.bind(this),this.osc_square.bind(this),this.osc_saw.bind(this),this.osc_tri.bind(this)],this.mSong=null,this.mLastRow=0,this.mCurrentCol=0,this.mNumWords=0,this.mMixBuf=null}osc_sin(e){return Math.sin(6.283184*e)}osc_saw(e){return e%1*2-1}osc_square(e){return e%1<.5?1:-1}osc_tri(e){var t=e%1*4;return t<2?t-1:3-t}getnotefreq(e){return.003959503758*2**((e-128)/12)}createNote(e,t,n){var _,r,o,s,i,a,c=this.mOscillators[e.i[0]],l=e.i[1],d=e.i[3]/32,u=this.mOscillators[e.i[4]],f=e.i[5],h=e.i[8]/32,m=e.i[9],g=e.i[10]*e.i[10]*4,p=e.i[11]*e.i[11]*4,b=e.i[12]*e.i[12]*4,y=1/b,v=-e.i[13]/16,w=e.i[14],x=n*2**(2-e.i[15]),C=new Int32Array(g+p+b),M=0,I=0;for(_=0,r=0;_<g+p+b;_++,r++)r>=0&&(w=w>>8|(255&w)<<4,r-=x,i=this.getnotefreq(t+(15&w)+e.i[2]-128),a=this.getnotefreq(t+(15&w)+e.i[6]-128)*(1+8e-4*e.i[7])),o=1,_<g?o=_/g:_>=g+p&&(o=(1-(o=(_-g-p)*y))*3**(v*o)),s=c(M+=i*o**d)*l,s+=u(I+=a*o**h)*f,m&&(s+=(2*Math.random()-1)*m),C[_]=80*s*o|0;return C}async init(e){return new Promise(t=>{this.mSong=e,this.mLastRow=e.endPattern,this.mCurrentCol=0,this.mNumWords=e.rowLen*e.patternLen*(this.mLastRow+1)*2,this.mMixBuf=new Int32Array(this.mNumWords),t()})}generateChannel(e){return new Promise(t=>{var n,_,r,o,s,i,a,c,l,d,u,f,h,m,g=new Int32Array(this.mNumWords),p=this.mSong.songData[e],b=this.mSong.rowLen,y=this.mSong.patternLen,v=0,w=0,x=!1,C=[];for(r=0;r<=this.mLastRow;++r)for(a=p.p[r],o=0;o<y;++o){var M=a?p.c[a-1].f[o]:0;M&&(p.i[M-1]=p.c[a-1].f[o+y]||0,M<17&&(C=[]));var I=this.mOscillators[p.i[16]],P=p.i[17]/512,E=2**(p.i[18]-9)/b,S=p.i[19],L=p.i[20],T=43.23529*p.i[21]*3.141592/44100,k=1-p.i[22]/255,B=1e-5*p.i[23],R=p.i[24]/32,D=p.i[25]/512,O=6.283184*2**(p.i[26]-9)/b,A=p.i[27]/255,N=p.i[28]*b&-2;for(u=(r*y+o)*b,s=0;s<4;++s)if(i=a?p.c[a-1].n[o+s*y]:0){C[i]||(C[i]=this.createNote(p,i,b));var W=C[i];for(_=0,n=2*u;_<W.length;_++,n+=2)g[n]+=W[_]}for(_=0;_<b;_++)(d=g[c=2*(u+_)])||x?(f=T,S&&(f*=I(E*c)*P+.5),w+=(f=1.5*Math.sin(f))*(h=k*(d-w)-(v+=f*w)),d=3==L?w:1==L?h:v,B&&(d=(d*=B)<1?d>-1?this.osc_sin(.25*d):-1:1,d/=B),x=(d*=R)*d>1e-5,m=d*(1-(l=Math.sin(O*c)*D+.5)),d*=l):m=0,c>=N&&(m+=g[c-N+1]*A,d+=g[c-N]*A),g[c]=0|m,g[c+1]=0|d,this.mMixBuf[c]+=0|m,this.mMixBuf[c+1]+=0|d}t()})}async generate(){this.mMixBuf.fill(0),this.mCurrentCol=0;const e=[];for(let t=0;t<this.mSong.numChannels;t++)e.push(this.generateChannel(t));return await Promise.all(e),this.mCurrentCol=this.mSong.numChannels,1}createAudioBuffer(e){for(var t=e.createBuffer(2,this.mNumWords/2,44100),n=0;n<2;n++)for(var _=t.getChannelData(n),r=n;r<this.mNumWords;r+=2)_[r>>1]=this.mMixBuf[r]/65536;return t}createAudioBufferRange(e,t=0,n=null){(null===n||n>this.mNumWords/2)&&(n=this.mNumWords/2),t<0&&(t=0),t>=n&&(t=n-1);const _=n-t;for(var r=e.createBuffer(2,_,44100),o=0;o<2;o++)for(var s=r.getChannelData(o),i=0;i<_;i++){var a=2*(t+i)+o;s[i]=this.mMixBuf[a]/65536}return r}createWave(){var e=44+2*this.mNumWords-8,t=e-36,n=new Uint8Array(44+2*this.mNumWords);n.set([82,73,70,70,255&e,e>>8&255,e>>16&255,e>>24&255,87,65,86,69,102,109,116,32,16,0,0,0,1,0,2,0,68,172,0,0,16,177,2,0,4,0,16,0,100,97,116,97,255&t,t>>8&255,t>>16&255,t>>24&255]);for(var _=0,r=44;_<this.mNumWords;++_){var o=this.mMixBuf[_];o=o<-32767?-32767:o>32767?32767:o,n[r++]=255&o,n[r++]=o>>8&255}return n}createWaveRange(e=0,t=null){(null===t||t>this.mNumWords/2)&&(t=this.mNumWords/2),e<0&&(e=0),e>=t&&(e=t-1);const n=t-e;var _=44+2*n-8,r=_-36,o=new Uint8Array(44+2*n);o.set([82,73,70,70,255&_,_>>8&255,_>>16&255,_>>24&255,87,65,86,69,102,109,116,32,16,0,0,0,1,0,2,0,68,172,0,0,16,177,2,0,4,0,16,0,100,97,116,97,255&r,r>>8&255,r>>16&255,r>>24&255]);for(var s=0,i=44;s<n;++s){var a=this.mMixBuf[2*(e+s)];a=a<-32767?-32767:a>32767?32767:a,o[i++]=255&a,o[i++]=a>>8&255}return o}getData(e,t){for(var n=2*Math.floor(44100*e),_=new Array(t),r=0;r<2*t;r+=1){var o=n+r;_[r]=e>0&&o<this.mMixBuf.length?this.mMixBuf[o]/32768:0}return _}}const g=44100,p=new(window.AudioContext||window.webkitAudioContext);var b={songData:[{i:[0,255,116,85,0,255,116,0,37,14,4,6,73,99,0,0,0,0,0,0,2,136,15,0,32,0,0,0,6],p:[1,1,1,,2,,1,1,2,2],c:[{n:[139,,,,139,,,,139,,,,139,,,,139,,,,139,,,,139,,139,,139,,139],f:[]},{n:[140,,140,,,,140,,,,140,,140,,140,,,,140,,140,,,,140,,140,,,,140],f:[]}]},{i:[0,160,128,64,0,160,128,0,64,210,4,7,52,85,0,0,0,60,4,1,2,255,0,0,32,61,5,0,6],p:[,1,2,1,2,1,2,1,1,1],c:[{n:[,,,,139,,,,,,,,139,,,,,,,,139,,,,,,,,139,,139],f:[]},{n:[,,,,,,,,,,,,139,,139,,,,,,,,,,,,,,139,,139],f:[]}]},{i:[0,255,106,64,0,255,106,0,64,0,5,7,164,0,0,0,0,0,0,0,2,255,0,2,32,83,5,25,1],p:[,,,1,,,2,1,1,2],c:[{n:[144,,,,,,,,,,,,,,,,144],f:[]},{n:[,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,156,,,,,,,,,,,,,,,,156],f:[]}]},{i:[0,91,128,0,0,95,128,12,0,0,12,0,72,0,0,0,0,0,0,0,2,255,0,0,32,83,3,130,4],p:[,,,1,,1,1,1,2,2],c:[{n:[132,,,,,,,,132,,,,,,,,144,,,,,,,,144],f:[]},{n:[],f:[]}]},{i:[1,192,128,0,1,191,116,9,0,0,6,22,34,0,0,0,0,69,3,1,1,23,167,0,32,77,6,25,6],p:[,,2,,1,,1,2,2,1],c:[{n:[144,,,,144,,,,144,,,,142,,142,,144,,144,,144,,,,144,,,,144,,,,147,,,,151,,,,147,,,,149,,149,,147,,147,,151,,,,147,,,,147,,,,151,,,,154,,,,151,,,,151,,151,,151,,151,,154,,,,151,,,,151],f:[]},{n:[144,144,144,,144,,,,,,,,,,,,,,,,,,,,,,,,,,,,147,147,147,,147,,,,,,,,,,,,,,,,,,,,,,,,,,,,151,151,151,,151],f:[]}]}],rowLen:5513,patternLen:32,endPattern:9,numChannels:5};const y=new AudioContext;let v=0;r.Instance.on("progress",e=>{const t=e.bestComboCount||0;v=Math.min(t,6)});let w=0;const x=(e=512)=>{const t=document.createElement("canvas");t.width=e,t.height=e;const n=t.getContext("2d");return[t,n]},C={},M=new e.Color,I=(t,n)=>{const _=1==n?.glow,r=`color-${t}-${_}`;if(C[r])return C[r];const o=new(_?e.MeshBasicMaterial:e.MeshStandardMaterial)({color:t,side:e.FrontSide});return C[r]=o,o},P=(t,n)=>{M.set(n);const _="string"==typeof n?n:`#${M.getHexString()}`,r=`text-${_}-${t.join("")}`;if(C[r])return C[r];const o=1024,[s,i]=x(o);i.textAlign="center",t.forEach((e,n)=>{i.strokeStyle=a,i.font="64px monospace",i.textBaseline="middle",i.lineWidth=8,i.strokeText(e,512,.5*(o-64*t.length)+64*n),i.fillStyle=_,i.fillText(e,512,.5*(o-64*t.length)+64*n)});const c=new e.CanvasTexture(s),l=new e.MeshBasicMaterial({map:c,transparent:!0});return C[r]=l,l},E=.0254,S=e=>e*e;class L{static _instance;animations;scene;clock;constructor(){this.animations=[],this.scene=null,this.clock=new e.Clock}static get Instance(){return L._instance||(L._instance=new L),L._instance}initScene(e){this.scene||(this.scene=e,this.clock.start())}update(){const t=1e3*this.clock.getElapsedTime();this.animations=this.animations.filter(n=>{const _=t-n.startTime,r=n.endTime-n.startTime,o=(s=_/r,Math.min(Math.max(s,0),1));var s;if(t>=n.endTime)return n.loop?(n.startTime=t,n.endTime=t+r,n.end.position&&n.mesh.position.copy(n.start.position),n.end.rotation&&n.mesh.rotation.copy(n.start.rotation),n.end.scaling&&n.mesh.scale.copy(n.start.scaling),!0):(n.end.position&&n.mesh.position.copy(n.end.position),n.end.rotation&&n.mesh.rotation.copy(n.end.rotation),n.end.scaling&&n.mesh.scale.copy(n.end.scaling),n.resolve&&(n.resolve(),n.resolve=void 0,n.reject=void 0),!1);if(n.end.position&&n.mesh.position.lerpVectors(n.start.position,n.end.position,n.easeFunc(o)),n.end.rotation){const t=n.start.rotation,_=n.end.rotation,r=new e.Euler;r.x=t.x+(_.x-t.x)*n.easeFunc(o),r.y=t.y+(_.y-t.y)*n.easeFunc(o),r.z=t.z+(_.z-t.z)*n.easeFunc(o),n.mesh.rotation.copy(r)}return n.end.scaling&&n.mesh.scale.lerpVectors(n.start.scaling,n.end.scaling,n.easeFunc(o)),!0})}animateTransform(e){const{mesh:t,end:n}=e,_=e.duration||1e3,r=e.delay||0,o=e.ease||S,s=1e3*this.clock.getElapsedTime();let i,a;const c=new Promise((e,t)=>{i=e,a=t});return this.animations.push({mesh:t,start:{position:t.position.clone(),rotation:t.rotation.clone(),scaling:t.scale.clone()},end:n,easeFunc:o,startTime:s+r,endTime:s+r+_,loop:e.loop||!1,resolve:i,reject:a}),c}cancelAnimation(e,t=!1){const n=this.animations.filter(t=>t.mesh===e);n.length&&(n.forEach(n=>{t&&(n.end.position&&e.position.copy(n.end.position),n.end.rotation&&e.rotation.copy(n.end.rotation),n.end.scaling&&e.scale.copy(n.end.scaling)),n.reject&&(n.reject(),n.resolve=void 0,n.reject=void 0)}),this.animations=this.animations.filter(t=>t.mesh!==e))}}const T={color:o,artist:s,title:i};let k,B,R,D,O,A,N,W,j;const F=new e.Vector3(0,0,.3),G=async()=>{(async()=>{const e=new m;await e.init(b),await e.generate();const t=[];for(let i=0;i<6;i++){const n=176400*i,_=n+176400,r=e.createAudioBufferRange(y,n,_);t.push(r)}const n=e.createAudioBufferRange(y,1058400,1764e3),_=[...t,n];let r=null,o=!1;const s=e=>{let t;r&&(r.stop(),r.disconnect()),t=e<6?e:6;const n=_[t];r=y.createBufferSource(),r.buffer=n,r.connect(y.destination),r.loop=!0,r.start();const i=setInterval(()=>{v!==e&&(clearInterval(i),s(v))},2e3);o=!0};s(v)})(),document.getElementById("intro").style.display="none",document.getElementById("playButton").setAttribute("disabled","true");const t=document.getElementById("c");if(!t)return;t.style.display="block",D=new e.WebGLRenderer({antialias:!0}),D.setPixelRatio(window.devicePixelRatio),D.setSize(window.innerWidth,window.innerHeight),D.setClearColor("#000000"),D.xr.addEventListener("sessionstart",U),D.xr.enabled=!0,D.setAnimationLoop($),document.body.appendChild(h.createButton(D)),document.body.appendChild(D.domElement);const n=new f;B=new e.Scene,k=new e.PerspectiveCamera(75,window.innerWidth/window.innerHeight,.1,1e3),k.position.set(0,2,1),k.rotation.set(-1*Math.PI/12,0,0),k.name="camera",B.add(k),L.Instance.initScene(B);const o=new e.AmbientLight(16777215,.8);B.add(o);const l=new e.DirectionalLight(16777215,.8);l.position.set(6,10,8),l.castShadow=!0,l.target.position.set(0,0,0),B.add(l),B.add(l.target);const d=(()=>{const t=new e.Group;t.name="debugScreen",t.renderOrder=1;const n=new e.PlaneGeometry(5,5);n.translate(0,-2,0);const _=P(["You win!","Thanks for playing","Created by Alex Swan"],"white"),o=new e.Mesh(n,_);return t.add(o),o.position.set(0,0,0),o.visible=!1,r.Instance.on("progress",e=>{e.color.solved&&e.artist.solved&&e.title.solved&&(o.userData.solved=!0,o.visible=!0,o.material.needsUpdate=!0)}),t})();d.position.set(0,4,-1),B.add(d),W=_("cassette"),W.position.set(0,0,-20),W.userData.isPickable=!0,B.add(W),L.Instance.animateTransform({mesh:W,end:{rotation:new e.Euler(0,2*Math.PI-.01,0)},duration:3e3,ease:e=>e,loop:!0});const u=_("arena"),C=u.getObjectByName("tableA");B.add(u);const M=_("cat");M.position.set(-3,1,0),M.scale.set(.1,.1,.1),B.add(M);const S=M.clone(!0);S.name="catMesh2",S.position.set(3,1,-1),S.rotation.set(0,Math.PI/2,0),B.add(S);const O=((t,n)=>{const o=new e.Group;o.name="Witch"+ ++w;const s=[],i=_("cat");return i.scale.set(.03,.03,.03),o.add(i),i.position.set(0,-.25,-.05),r.Instance.on("tick",()=>{if(n.xr?.getCamera()&&n.xr?.getCamera()){const t=n.xr?.getCamera();if(s.push(t.quaternion.clone()),s.length>60){let t=s.shift();const n=(new e.Quaternion).setFromEuler(new e.Euler(0,Math.PI,0));t&&o.quaternion.copy(n.multiply(t))}}}),o.userData.isPickable=!0,o.onPointerPick=()=>{((...e)=>{((...e)=>{let t=p.createBufferSource(),n=p.createBuffer(e.length,e[0].length,g);e.map((e,t)=>n.getChannelData(t).set(e)),t.buffer=n,t.connect(p.destination),t.start()})(((e=1,t=.05,n=220,_=0,r=0,o=.1,s=0,i=1,a=0,c=0,l=0,d=0,u=0,f=0,h=0,m=0,p=0,b=1,y=0,v=0)=>{let w,x,C=2*Math.PI,M=a*=500*C/g**2,I=(0<h?1:-1)*C/4,P=n*=(1+2*t*Math.random()-t)*C/g,E=[],S=0,L=0,T=0,k=1,B=0,R=0,D=0;for(c*=500*C/g**3,h*=C/g,l*=C/g,d*=g,u=g*u|0,x=(_=99+g*_)+(y*=g)+(r*=g)+(o*=g)+(p*=g)|0;T<x;E[T++]=D)++R%(100*m|0)||(D=s?1<s?2<s?3<s?Math.sin((S%C)**3):Math.max(Math.min(Math.tan(S),1),-1):1-(2*S/C%2+2)%2:1-4*Math.abs(Math.round(S/C)-S/C):Math.sin(S),D=(u?1-v+v*Math.sin(2*Math.PI*T/u):1)*(0<D?1:-1)*Math.abs(D)**i*e*.3*(T<_?T/_:T<_+y?1-(T-_)/y*(1-b):T<_+y+r?b:T<x-p?(x-T-p)/o*b:0),D=p?D/2+(p>T?0:(T<x-p?1:(x-T)/p)*E[T-p|0]/2):D),w=(n+=a+=c)*Math.sin(L*h-I),S+=w-w*f*(1-1e9*(Math.sin(T)+1)%2),L+=w-w*f*(1-1e9*(Math.sin(T)**2+1)%2),k&&++k>d&&(n+=l,P+=l,k=0),!u||++B%u||(n=P,a=M,k=k||1);return E})(...e))})(...[1.01,,275,.01,.01,.15,1,1.03,-3.7,,-93,.07,,,,-.1,,.5,.04,.09])},t.add(o),o})(B,D);O.position.set(0,1.5,-1),O.rotation.set(0,Math.PI,0),n.vinyls.forEach((t,_)=>{const r=(({color:t,artist:n,title:_})=>{const r=new e.Group,o=new e.RingGeometry(4,7,32);o.scale(E,E,E);const c=I(t,{glow:!0});r.add(new e.Mesh(o,c));const l=new e.RingGeometry(.25,4,32);l.scale(E,E,E);const d=I(16777215,{});r.add(new e.Mesh(l,d));const u=new e.PlaneGeometry(14,14);u.translate(0,0,.001),u.scale(E,E,E);const f=((t,n)=>{const[_,r]=x(1024);r.fillStyle=a,r.strokeStyle=a,r.lineWidth=8,r.beginPath(),r.arc(512,512,20,0,2*Math.PI),r.stroke(),r.beginPath(),r.arc(512,512,288,0,2*Math.PI),r.stroke(),r.textAlign="center",t&&(r.font="64px monospace",r.textBaseline="middle",r.strokeStyle=a,r.lineWidth=8,r.strokeText(t,512,430.08),r.fillStyle=s,r.fillText(t,512,430.08)),n&&(r.font="96px monospace",r.textBaseline="bottom",r.fillStyle=i,r.strokeText(n,512,696.32),r.fillText(n,512,696.32));const o=new e.CanvasTexture(_);return o.encoding=e.LinearSRGBColorSpace,new e.MeshBasicMaterial({map:o,transparent:!0})})(n,_);r.add(new e.Mesh(u,f));const h=r.clone();return h.rotation.set(0,Math.PI,0),h.position.set(0,0,-.002),r.add(h),r})(t);r.name=`vinyl-${_}`;const o=new e.Vector3(.7,1.15,-.2-.125*_);r.position.copy(o),r.userData.originalPosition=o,r.userData.isPickable=!0,r.userData.recordIndex=_,r.userData.returnToOriginalPosition=()=>{B.attach(r),L.Instance.cancelAnimation(r),L.Instance.animateTransform({mesh:r,end:{position:r.userData.originalPosition,rotation:new e.Euler(0,0,0)},duration:100})},r.onPointerPick=t=>{if(t.userData.selected)return;n.selected[t.id]=_;const o=t.getObjectByName("target");o&&(L.Instance.cancelAnimation(r),o.attach(r),L.Instance.animateTransform({mesh:r,end:{position:new e.Vector3(0,0,0),rotation:new e.Euler(0,Math.PI/2,0)},duration:60}),t.userData.selected=r)},r.onPointerDrop=t=>{if(L.Instance.cancelAnimation(r,!0),r.getWorldPosition(new e.Vector3).distanceTo(C.getWorldPosition(new e.Vector3))<.3)return n.addVinylByIndex(r.userData.recordIndex),delete n.selected[t.id],t.userData.selected=void 0,C.children.forEach(e=>{e.userData.returnToOriginalPosition&&e.userData.returnToOriginalPosition()}),C.attach(r),void L.Instance.animateTransform({mesh:r,end:{position:new e.Vector3(0,.01,0),rotation:new e.Euler(-1*Math.PI/2,0,0)},duration:60}).then(()=>{L.Instance.animateTransform({mesh:r,end:{rotation:new e.Euler(-1*Math.PI/2,0,-2*Math.PI)},ease:e=>e,duration:1800,loop:!0})});r.userData.returnToOriginalPosition(),t.userData.selected=void 0},B.add(r)}),A=D.xr.getController(0),A.addEventListener("connected",V),A.addEventListener("selectstart",q),A.addEventListener("selectend",z),A.addEventListener("squeezestart",q),A.addEventListener("squeezeend",z),B.add(A),N=D.xr.getController(1),N.addEventListener("connected",V),N.addEventListener("selectstart",q),N.addEventListener("selectend",z),N.addEventListener("squeezestart",q),N.addEventListener("squeezeend",z),B.add(N),R=new e.Raycaster,window.addEventListener("resize",Q,!1),r.Instance.on("progress",t=>{let _="color";t.artist.correctCount>=t[_].correctCount&&(_="artist"),t.title.correctCount>=t[_].correctCount&&(_="title");for(let o=0;o<6;o++){const r=n.getVinylInQueue(t[_].correctCount-o-1),s=u.getObjectByName(`progress-${o}`);let i=o<t[_].correctCount?T[_]:0;if(o<t[_].correctCount&&"color"===_&&(i=c[o]),s){s.visible=!0,s.material.color.set(i),s.material.emissive.set(i),s.material.needsUpdate=!0;let n=s.getObjectByName("progress-label");if(!n){const t=new e.PlaneGeometry(1,1);t.translate(.1,.1,.15),t.rotateZ(Math.PI/8),n=new e.Mesh(t),n.renderOrder=1,n.name="progress-label",s.add(n)}n.visible=!!(o<t[_].correctCount&&r),r&&(n.material=P([r[_]],i)),"color"===_&&(n.visible=!1),t[_].solved&&(n.visible=!1)}}const r=Object.keys(t);for(let e=0;e<r.length;e++){const n=r[e],_=u.getObjectByName(`complete-${e}`),o=t[n].solved?T[n]:0;_&&(_.visible=!0,_.material.color.set(o),_.material.emissive.set(o),_.material.needsUpdate=!0)}}),n.reset()};function U(){j=D.xr.getReferenceSpace();const t={x:-1*F.x,y:-1*F.y,z:-1*F.z,w:1},n=new e.Quaternion,_=new XRRigidTransform(t,n),r=j.getOffsetReferenceSpace(_);D.xr.setReferenceSpace(r)}function V(t){const n=t.target,o="left"===t.data.handedness?-1:1,s=t.data.hand?0:o*Math.PI/2;if(r.Instance.emit("debug",`Hand: ${t.data.hand}`),!n.getObjectByName("target")){const t=new e.Group;t.name="target",t.rotation.set(0,0,0),t.position.set(-1*o*.035,.05,-.12),n.add(t)}let i=n.getObjectByName("paw");i||(i=_("paw"),i.position.set(0,0,.15),i.rotation.set(3*Math.PI/2,s,0),n.add(i.clone(!0)));let a=n.getObjectByName("line");if(!a){const t=(new e.BufferGeometry).setFromPoints([new e.Vector3(0,0,0),new e.Vector3(0,0,-1)]);a=new e.Line(t),a.material.color.set(16711680),a.name="line",a.scale.z=5,n.add(a)}}function q(e){O=e.target;const t=H(O);if(t.length>0){let e=!1;t.forEach(({object:t,distance:n})=>{if(e)return;let _=t;for(;_;){if(_.onPointerPick){_.onPointerPick(O),e=!0,O.getObjectByName("line").visible=!1;break}_=_.parent}})}O.userData.targetRayMode=e.data.targetRayMode}function z(e){O=e.target;const t=O.userData.selected;t?.onPointerDrop&&t.onPointerDrop(O),O.getObjectByName("line").visible=!0}function H(e){return e.updateMatrixWorld(),R.setFromXRController(e),R.intersectObjects(B.children,!0)}function X(e){if("screen"===e.userData.targetRayMode)return;if(void 0!==e.userData.selected)return;const t=e.getObjectByName("line"),n=H(e);if(t&&(t.scale.z=5),n.length>0){let e=!1;n.forEach(({object:n,distance:_})=>{if(e)return;let r=n;for(;r;){if(r.userData.isPickable){t&&(t.scale.z=_),e=!0;break}r=r.parent}})}}function $(){L.Instance.update(),r.Instance.emit("tick"),X(A),X(N),D.render(B,k)}const Q=()=>{k.aspect=window.innerWidth/window.innerHeight,k.updateProjectionMatrix(),D.setSize(window.innerWidth,window.innerHeight)};window.addEventListener("DOMContentLoaded",()=>{document.getElementById("playButton").onclick=G});

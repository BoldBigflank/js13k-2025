import*as o from"https://js13kgames.com/2025/webxr/three.module.js";(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))r(t);new MutationObserver(t=>{for(const _ of t)if(_.type==="childList")for(const c of _.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&r(c)}).observe(document,{childList:!0,subtree:!0});function e(t){const _={};return t.integrity&&(_.integrity=t.integrity),t.referrerPolicy&&(_.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?_.credentials="include":t.crossOrigin==="anonymous"?_.credentials="omit":_.credentials="same-origin",_}function r(t){if(t.ep)return;t.ep=!0;const _=e(t);fetch(t.href,_)}})();const ge=()=>[["cube_case1_1_8_2_7.50_4_0_0_0_0_7.50_4_0_#0000ff","cube_case2_3_9_2_5.50_4.50_0_0_0_0_5.50_4.50_0_#0000ff","cube_case3_8_4_2_0_7_0_0_0_0_0_8.50_0_#0000ff","cube_case4_8_1_2_0_2.50_0_0_0_0_0_2.50_0_#0000ff","cube_case5_3_9_2_-5.50_4.50_0_0_0_0_-5.50_4.50_0_#0000ff","cube_case6_1_8_2_-7.50_4_0_0_0_0_-7.50_4_0_#0000ff"],"cube_base_12_2.10_2.40_0_0.95_0_0_0_0_0_0_0_#ff0000","cube_rightReel_2_2_1_2.72_3.89_0_0_0_-45_2.72_3.89_0_#ff7300","cube_rightTape_4_4_0.20_2.81_3.91_-0.10_0_0_-45_2.81_3.91_-0.10_#c300ff","cube_leftReel_2_2_1_-2.69_3.91_0_0_0_-45_-2.75_4_0_#ff7300","sphere_dot_1_1_1_0_4_0_0_0_0_0_4_0_#9999ff","plane_label_12_3_0_0_7_1.01_90_0_0_0_7_1.01_#d3d3d3","cylinder_base_16_8_16_0_-4_0_0_0_0_0_-4_0_#00ff00"],ye=()=>[[["cube_complete-0_0.3_0.1_0.1_-0.75_1.05_-0.45_0_0_0_-0.75_1.05_-0.45_#ff0000","cube_complete-1_0.3_0.1_0.1_-0.75_1.05_-0.35_0_0_0_-0.75_1.05_-0.35_#00ff00","cube_complete-2_0.3_0.1_0.1_-0.75_1.05_-0.25_0_0_0_-0.75_1.05_-0.25_#0000ff"],["sphere_progress-0_0.2_0.2_0.2_-0.75_1.05_-0.75_0_0_0_-0.75_1.05_-0.75_#fffb00","sphere_progress-1_0.2_0.2_0.2_-0.55_1.05_-0.75_0_0_0_-0.55_1.05_-0.75_#fffb00","sphere_progress-2_0.2_0.2_0.2_-0.35_1.05_-0.75_0_0_0_-0.35_1.05_-0.75_#fffb00","sphere_progress-3_0.2_0.2_0.2_-0.15_1.05_-0.75_0_0_0_-0.15_1.05_-0.75_#fffb00","sphere_progress-4_0.2_0.2_0.2_0.05_1.05_-0.75_0_0_0_0.05_1.05_-0.75_#fffb00","sphere_progress-5_0.2_0.2_0.2_0.25_1.05_-0.75_0_0_0_0.25_1.05_-0.75_#fffb00"],"cube_desk_2_0.9_1_0_0.45_-0.5_0_0_0_0_-0.1_0_#fffb00","cube_record-rack_0.4_0.1_0.8_0.7_0.95_-0.5_0_0_0_0.7_0.95_-0.5_#b0ffb0","cube_progress-bar_1.3_0.1_0.3_-0.25_0.95_-0.75_0_0_0_-0.25_0.95_-0.75_#d3d3d3","cube_cube_0.3_0.1_0.4_-0.75_0.95_-0.3_0_0_0_-0.75_0.95_-0.3_#9999ff","cube_cube_0.4_0.1_0.4_-0.3_0.95_-0.3_0_0_0_-0.3_0.95_-0.3_#d3d3d3","cube_tableA_0.4_0.1_0.4_0.2_0.95_-0.3_0_0_0_0.2_1.01_-0.3_#b0ffb0","cylinder_pad_0.4_0.02_0.4_0.2_1_-0.3_0_0_0_0.2_1_-0.3_#ff0000"],"cube_cube_22_1_19_0_-2.5_-4.5_0_0_0_0_-3_-4_#ff00ff","cube_cube_12_1_12_0_-1.5_-4_0_0_0_0_-2_-4_#ff0000","cube_cube_8_1_3_0_-0.5_0.5_0_0_0_0_-1_-4_#c300ff","cube_pillar_1_4_1_7.5_0_-2.5_0_0_0_8_0_-3_#fffb00","cube_pillar_1_4_1_7.5_0_-6.5_0_0_0_8_0_-7_#fffb00","cube_pillar_1_4_1_7.5_0_-10.5_0_0_0_8_0_-11_#fffb00","cube_pillar_1_4_1_7.5_0_-10.5_0_0_0_8_0_-11_#fffb00","cube_pillar_1_4_1_-7.5_0_-2.5_0_0_0_-7_0_-3_#fffb00","cube_pillar_1_4_1_-7.5_0_1.5_0_0_0_-7_0_1_#fffb00","cube_pillar_1_4_1_7.5_0_1.5_0_0_0_8_0_1_#fffb00","cube_pillar_1_4_1_-7.5_0_-6.5_0_0_0_-7_0_-7_#fffb00","cube_pillar_1_4_1_-7.5_0_-10.5_0_0_0_-7_0_-11_#fffb00","cube_cube_4_1_16_9_2.5_-6_0_0_0_8_2_0_#00ff00","cube_cube_4_1_16_-9_2.5_-6_0_0_0_-10_2_0_#00ff00"],me=()=>["sphere_head_16_16_16_0_8_0_0_0_0_0_8_0_#c300ff",["cylinder_leftEye_4_1_4_-3_11_-6.3_-60_0_25_-3_11_-6.3_#fffb00","sphere_leftPupil_2_2_4_-3.6_11.3_-7_-60_0_25_-3.6_11.3_-7_#c300ff","cylinder_rightEye_4_1_4_3_11_-6.3_-60_0_-25_3_11_-6.3_#fffb00","sphere_rightPupil_2_2_4_3.4_11.3_-7_-60_0_-25_3.4_11.3_-7_#c300ff"],["cube_rightCheek_3_3_2_1.84_6.53_-7.5_-25_0_80_1.84_6.53_-7.5_#0000ff","cube_leftCheek_3_3_2_-1.91_6.48_-7.5_0_23_10_-1.91_6.48_-7.5_#0000ff","cube_tongue_2_2_2_0_5_-7_0_0_0_0_4_-7_#ff0000","pyramid_pyramid_3_1.6_1_0_8.2_-8_-180_0_0_0_8.2_-8_#ff00ff"],["pyramid_ear_6_11_4_-4.86_15.55_-1.28_-14_-6_24_-4.86_15.55_-1.28_#c300ff","pyramid_ear_5_9.5_4_-5.04_15.94_-1.59_-14_-6_24_-5.04_15.94_-1.59_#fffb00","pyramid_ear_6_11_4_4.86_15.55_-1.28_-14_6_-24_4.86_15.55_-1.28_#c300ff","pyramid_ear_5_9.5_4_5.04_15.94_-1.59_-14_6_-24_5.04_15.94_-1.59_#fffb00"],["cylinder_cylinder_0.2_6_0.2_-3.93_6_-8.92_0_-15_90_-3.93_6_-8.92_#d3d3d3","cylinder_cylinder_0.2_4_0.2_-4.87_7.52_-8.5_0_-15_75_-4.87_7.52_-8.5_#d3d3d3","cylinder_cylinder_0.2_4_0.2_-4.87_4.48_-8.5_0_-15_105_-4.87_4.48_-8.5_#d3d3d3","cylinder_cylinder_0.2_4_0.2_4.87_7.52_-8.5_180_-15_-105_4.87_7.52_-8.5_#d3d3d3","cylinder_cylinder_0.2_6_0.2_3.93_6_-8.92_0_-165_90_3.93_6_-8.92_#d3d3d3","cylinder_cylinder_0.2_4_0.2_4.87_4.48_-8.5_180_-15_-75_4.87_4.48_-8.5_#d3d3d3"]],q={uniforms:{uDirLightPos:{value:new o.Vector3},uDirLightColor:{value:new o.Color(15658734)},uAmbientLightColor:{value:new o.Color(328965)},uBaseColor:{value:new o.Color(16777215)},uLineColor1:{value:new o.Color(0)}},vertexShader:`

		varying vec3 vNormal;

		void main() {

			gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
			vNormal = normalize( normalMatrix * normal );

		}`,fragmentShader:`

		uniform vec3 uBaseColor;
		uniform vec3 uLineColor1;
		uniform vec3 uLineColor2;
		uniform vec3 uLineColor3;
		uniform vec3 uLineColor4;

		uniform vec3 uDirLightPos;
		uniform vec3 uDirLightColor;

		uniform vec3 uAmbientLightColor;

		varying vec3 vNormal;

		void main() {

			float directionalLightWeighting = max( dot( normalize(vNormal), uDirLightPos ), 0.0);
			vec3 lightWeighting = uAmbientLightColor + uDirLightColor * directionalLightWeighting;

			gl_FragColor = vec4( uBaseColor, 1.0 );

			if ( length(lightWeighting) < 1.00 ) {

				if ( ( mod(gl_FragCoord.x, 4.001) + mod(gl_FragCoord.y, 4.0) ) > 6.00 ) {

					gl_FragColor = vec4( uLineColor1, 1.0 );

				}

			}

			if ( length(lightWeighting) < 0.50 ) {

				if ( ( mod(gl_FragCoord.x + 2.0, 4.001) + mod(gl_FragCoord.y + 2.0, 4.0) ) > 6.00 ) {

					gl_FragColor = vec4( uLineColor1, 1.0 );

				}

			}

			#include <colorspace_fragment>

		}`},Z=a=>{const n=new o.Group;n.position.set(0,0,0),n.rotation.set(0,0,0),n.scale.set(1,1,1);const e=i=>{const[u,s,f,b,w,x,R,C,g,y,m,l,h,p,S]=i.split("_"),d=f/2,M=new o.CylinderGeometry(0,d,b,4);return M.scale(1,1,w/f),M.translate(x-l,R-h,C-p),M.rotateX(o.MathUtils.degToRad(g)),M.rotateY(o.MathUtils.degToRad(y)),M.rotateZ(o.MathUtils.degToRad(m)),M},r=i=>{const[u,s,f,b,w,x,R,C,g,y,m,l,h,p,S]=i.split("_"),d=new o.BoxGeometry(f,b,w);return d.translate(x-l,R-h,C-p),d.rotateX(o.MathUtils.degToRad(g)),d.rotateY(o.MathUtils.degToRad(y)),d.rotateZ(o.MathUtils.degToRad(m)),d},t=i=>{const[u,s,f,b,w,x,R,C,g,y,m,l,h,p,S]=i.split("_"),d=new o.SphereGeometry(parseFloat(f)/2,32,16);return d.scale(f/f,b/f,w/f),d.translate(x-l,R-h,C-p),d.rotateX(o.MathUtils.degToRad(g)),d.rotateY(o.MathUtils.degToRad(y)),d.rotateZ(o.MathUtils.degToRad(m)),d},_=i=>{const[u,s,f,b,w,x,R,C,g,y,m,l,h,p,S]=i.split("_"),d=new o.PlaneGeometry(f,b);return d.rotateX(o.MathUtils.degToRad(-90)),d.translate(x-l,R-h,C-p),d.rotateX(o.MathUtils.degToRad(g)),d.rotateY(o.MathUtils.degToRad(y)),d.rotateZ(o.MathUtils.degToRad(m)),d},c=i=>{const[u,s,f,b,w,x,R,C,g,y,m,l,h,p,S]=i.split("_"),d=f/2,M=new o.CylinderGeometry(d,d,b,32);return M.translate(x-l,R-h,C-p),M.rotateX(o.MathUtils.degToRad(g)),M.rotateY(o.MathUtils.degToRad(y)),M.rotateZ(o.MathUtils.degToRad(m)),M};return a.forEach(i=>{if(i===null){console.error("ITEM IS NULL");return}if(Array.isArray(i))n.add(Z(i));else{const[u,s,f,b,w,x,R,C,g,y,m,l,h,p,S]=i.split("_");let d=null;switch(u){case"cube":d=r(i);break;case"sphere":d=t(i);break;case"plane":d=_(i);break;case"cylinder":d=c(i);break;case"pyramid":d=e(i);break;default:throw new Error(`Unknown shape: ${u}`)}let M=null;s.startsWith("case")?M=new o.ShaderMaterial({uniforms:{...q.uniforms},vertexShader:q.vertexShader,fragmentShader:q.fragmentShader}):M=new o.MeshStandardMaterial({color:S,side:o.DoubleSide});const O=new o.Mesh(d,M);O.name=s,O.position.set(l,h,p),n.add(O)}}),n},ie=a=>{const{radius:n,depth:e,color:r}=a,t=new o.CylinderGeometry(n,n,e,32),_=new o.MeshBasicMaterial({color:r});return new o.Mesh(t,_)},H=a=>{if(a==="cassette"){const n=Z(ge());return n.name="cassette",n}else if(a==="arena"){const n=Z(ye());return n.name="arena",n}else if(a==="cat"){const n=Z(me());return n.name="cat",n}return null};class P{static _instance;callbacks;constructor(){this.callbacks={}}static get Instance(){return P._instance||(P._instance=new P),P._instance}on(n,e){this.callbacks[n]=this.callbacks[n]||[],this.callbacks[n].push(e)}off(n,e){this.callbacks[n]=(this.callbacks[n]||[]).filter(r=>r!==e)}emit(n,...e){(this.callbacks[n]||[]).forEach(r=>r(...e))}_reset(){Object.keys(this.callbacks).forEach(n=>{delete this.callbacks[n]})}getCallbacks(){return this.callbacks}}const fe="#e81416",be="#ffa500",we="#faeb36",oe="#79c314",se="#487de7",xe="#70369d",K="#000000",W=[fe,be,we,oe,se,xe],$=["Shiny Toy Guns","B.B. King","Jack White","Black Sabbath","Faith Hill","Cliff Sheen"],J=["OFFSIDE","SHOWCASE","LOADOUT","BACKHAND","BOOKMARKS","MANPOWER"],Se=[[0,1,2,3,4,5],[0,2,4,1,5,3],[0,3,5,1,4,2]];class ve{queue;selected;vinyls;progress;constructor(){this.reset()}addVinylByIndex(n){const{color:e,artist:r,title:t}=this.vinyls[n],_=W.indexOf(e),c=$.indexOf(r),i=J.indexOf(t);_===(this.progress.color.currentIndex+1)%W.length?(this.progress.color.correctCount++,this.progress.color.correctCount===W.length&&(this.progress.color.solved=!0)):this.progress.color.correctCount=1,this.progress.color.currentIndex=_,c===(this.progress.artist.currentIndex+1)%$.length?this.progress.artist.correctCount++:this.progress.artist.correctCount=1,this.progress.artist.currentIndex=c,i===(this.progress.title.currentIndex+1)%J.length?this.progress.title.correctCount++:this.progress.title.correctCount=1,this.progress.title.currentIndex=i,P.Instance.emit("progress",this.progress)}isSolved(n){return this.progress[n].solved}reset(){this.queue=[],this.selected={};const[n,e,r]=Se;this.progress={color:{currentIndex:-1,correctCount:0,solved:!1},artist:{currentIndex:-1,correctCount:0,solved:!1},title:{currentIndex:-1,correctCount:0,solved:!1}},this.vinyls=W.map((t,_)=>({index:_,color:W[n[_]],artist:$[e[_]],title:J[r[_]]})),P.Instance.emit("progress",this.progress)}}class U{static createButton(n,e={}){const r=document.createElement("button");function t(){let s=null;async function f(x){x.addEventListener("end",b),await n.xr.setSession(x),r.textContent="EXIT VR",s=x}function b(){s.removeEventListener("end",b),r.textContent="ENTER VR",s=null}r.style.display="",r.style.cursor="pointer",r.style.left="calc(50% - 50px)",r.style.width="100px",r.textContent="ENTER VR";const w={...e,optionalFeatures:["local-floor","bounded-floor","layers",...e.optionalFeatures||[]]};r.onmouseenter=function(){r.style.opacity="1.0"},r.onmouseleave=function(){r.style.opacity="0.5"},r.onclick=function(){s===null?navigator.xr.requestSession("immersive-vr",w).then(f):(s.end(),navigator.xr.offerSession!==void 0&&navigator.xr.offerSession("immersive-vr",w).then(f).catch(x=>{console.warn(x)}))},navigator.xr.offerSession!==void 0&&navigator.xr.offerSession("immersive-vr",w).then(f).catch(x=>{console.warn(x)})}function _(){r.style.display="",r.style.cursor="auto",r.style.left="calc(50% - 75px)",r.style.width="150px",r.onmouseenter=null,r.onmouseleave=null,r.onclick=null}function c(){_(),r.textContent="VR NOT SUPPORTED"}function i(s){_(),console.warn("Exception when trying to call xr.isSessionSupported",s),r.textContent="VR NOT ALLOWED"}function u(s){s.style.position="absolute",s.style.bottom="20px",s.style.padding="12px 6px",s.style.border="1px solid #fff",s.style.borderRadius="4px",s.style.background="rgba(0,0,0,0.1)",s.style.color="#fff",s.style.font="normal 13px sans-serif",s.style.textAlign="center",s.style.opacity="0.5",s.style.outline="none",s.style.zIndex="999"}if("xr"in navigator)return r.id="VRButton",r.style.display="none",u(r),navigator.xr.isSessionSupported("immersive-vr").then(function(s){s?t():c(),s&&U.xrSessionIsGranted&&r.click()}).catch(i),r;{const s=document.createElement("a");return window.isSecureContext===!1?(s.href=document.location.href.replace(/^http:/,"https:"),s.innerHTML="WEBXR NEEDS HTTPS"):(s.href="https://immersiveweb.dev/",s.innerHTML="WEBXR NOT AVAILABLE"),s.style.left="calc(50% - 90px)",s.style.width="180px",s.style.textDecoration="none",u(s),s}}static registerSessionGrantedListener(){if(typeof navigator<"u"&&"xr"in navigator){if(/WebXRViewer\//i.test(navigator.userAgent))return;navigator.xr.addEventListener("sessiongranted",()=>{U.xrSessionIsGranted=!0})}}}U.xrSessionIsGranted=!1;U.registerSessionGrantedListener();const Me=.3,L=44100,Q=new(window.AudioContext||window.webkitAudioContext),Ee=(a=1,n=.05,e=220,r=0,t=0,_=.1,c=0,i=1,u=0,s=0,f=0,b=0,w=0,x=0,R=0,C=0,g=0,y=1,m=0,l=0)=>{let h=2*Math.PI,p=u*=500*h/L**2,S=(0<R?1:-1)*h/4,d=e*=(1+2*n*Math.random()-n)*h/L,M=[],O=0,ae=0,I=0,V=1,he=0,pe=0,G=0,X,N;for(r=99+L*r,m*=L,t*=L,_*=L,g*=L,s*=500*h/L**3,R*=h/L,f*=h/L,b*=L,w=L*w|0,N=r+m+t+_+g|0;I<N;M[I++]=G)++pe%(100*C|0)||(G=c?1<c?2<c?3<c?Math.sin((O%h)**3):Math.max(Math.min(Math.tan(O),1),-1):1-(2*O/h%2+2)%2:1-4*Math.abs(Math.round(O/h)-O/h):Math.sin(O),G=(w?1-l+l*Math.sin(2*Math.PI*I/w):1)*(0<G?1:-1)*Math.abs(G)**i*a*Me*(I<r?I/r:I<r+m?1-(I-r)/m*(1-y):I<r+m+t?y:I<N-g?(N-I-g)/_*y:0),G=g?G/2+(g>I?0:(I<N-g?1:(N-I)/g)*M[I-g|0]/2):G),X=(e+=u+=s)*Math.sin(ae*R-S),O+=X-X*x*(1-1e9*(Math.sin(I)+1)%2),ae+=X-X*x*(1-1e9*(Math.sin(I)**2+1)%2),V&&++V>b&&(e+=f,d+=f,V=0),!w||++he%w||(e=d,u=p,V=V||1);return M},Ce=(...a)=>{let n=Q.createBufferSource(),e=Q.createBuffer(a.length,a[0].length,L);return a.map((r,t)=>e.getChannelData(t).set(r)),n.buffer=e,n.connect(Q.destination),n.start(),n},Re=(...a)=>Ce(Ee(...a)),Ie=()=>Re(1.01,void 0,275,.01,.01,.15,1,1.03,-3.7,void 0,-93,.07,void 0,void 0,void 0,-.1,void 0,.5,.04,.09);let Te=0;const Le=(a,n)=>{const e=new o.Group;e.name=`Witch${++Te}`;const r=[],t=H("cat");t.scale.set(.03,.03,.03),e.add(t),t.position.set(0,-.25,-.05);const _=()=>{if(n.xr?.getCamera()&&n.xr?.getCamera()){const c=n.xr?.getCamera();if(r.push(c.quaternion.clone()),r.length>60){let i=r.shift();const u=new o.Quaternion().setFromEuler(new o.Euler(0,Math.PI,0));i&&e.quaternion.copy(u.multiply(i))}}};return P.Instance.on("tick",_),e.userData.isPickable=!0,e.onPointerPick=()=>{Ie()},a.add(e),e},Pe=(a,n,e)=>Math.min(Math.max(a,n),e),_e=(a=512)=>{const n=document.createElement("canvas");n.width=a,n.height=a;const e=n.getContext("2d");return[n,e]},k=.0254,Oe=(a,n)=>{const[r,t]=_e(1024);t.fillStyle=K,t.strokeStyle=K,t.lineWidth=8,t.beginPath(),t.arc(1024/2,1024/2,20,0,2*Math.PI),t.stroke(),t.beginPath(),t.arc(1024/2,1024/2,288,0,2*Math.PI),t.stroke(),t.textAlign="center",a&&(t.font="64px monospace",t.textBaseline="middle",t.strokeStyle=K,t.lineWidth=8,t.strokeText(a,.5*1024,.42*1024),t.fillStyle=oe,t.fillText(a,.5*1024,.42*1024)),n&&(t.font="96px monospace",t.textBaseline="bottom",t.fillStyle=se,t.strokeText(n,.5*1024,.68*1024),t.fillText(n,.5*1024,.68*1024));const _=new o.CanvasTexture(r);return _.encoding=o.LinearSRGBColorSpace,new o.MeshBasicMaterial({map:_,transparent:!0})},ke=({color:a,artist:n,title:e})=>{const r=new o.Group,t=new o.RingGeometry(4,7,32);t.scale(k,k,k);const _=new o.MeshPhongMaterial({color:a,side:o.DoubleSide,emissive:0,specular:1118481,shininess:50});r.add(new o.Mesh(t,_));const c=new o.RingGeometry(.25,4,32);c.scale(k,k,k);const i=new o.MeshStandardMaterial({color:16777215,side:o.DoubleSide});r.add(new o.Mesh(c,i));const u=new o.PlaneGeometry(14,14);u.translate(0,0,.001),u.scale(k,k,k);const s=Oe(n,e);r.add(new o.Mesh(u,s));const f=r.clone();return f.rotation.set(0,Math.PI,0),f.position.set(0,0,-.002),r.add(f),r},De=a=>a*a;class T{static _instance;animations;scene;clock;constructor(){this.animations=[],this.scene=null,this.clock=new o.Clock}static get Instance(){return T._instance||(T._instance=new T),T._instance}initScene(n){this.scene||(this.scene=n,this.clock.start())}update(){const n=this.clock.getElapsedTime()*1e3;this.animations=this.animations.filter(e=>{const r=n-e.startTime,t=e.endTime-e.startTime,_=Pe(r/t,0,1);if(n>=e.endTime)return e.loop?(e.startTime=n,e.endTime=n+t,e.end.position&&e.mesh.position.copy(e.start.position),e.end.rotation&&e.mesh.rotation.copy(e.start.rotation),e.end.scaling&&e.mesh.scale.copy(e.start.scaling),!0):(e.end.position&&e.mesh.position.copy(e.end.position),e.end.rotation&&e.mesh.rotation.copy(e.end.rotation),e.end.scaling&&e.mesh.scale.copy(e.end.scaling),e.resolve&&(e.resolve(),e.resolve=void 0,e.reject=void 0),!1);if(e.end.position&&e.mesh.position.lerpVectors(e.start.position,e.end.position,e.easeFunc(_)),e.end.rotation){const c=e.start.rotation,i=e.end.rotation,u=new o.Euler;u.x=c.x+(i.x-c.x)*e.easeFunc(_),u.y=c.y+(i.y-c.y)*e.easeFunc(_),u.z=c.z+(i.z-c.z)*e.easeFunc(_),e.mesh.rotation.copy(u)}return e.end.scaling&&e.mesh.scale.lerpVectors(e.start.scaling,e.end.scaling,e.easeFunc(_)),!0})}animateTransform(n){const{mesh:e,end:r}=n,t=n.duration||1e3,_=n.delay||0,c=n.ease||De,i=this.clock.getElapsedTime()*1e3;let u,s;const f=new Promise((b,w)=>{u=b,s=w});return this.animations.push({mesh:e,start:{position:e.position.clone(),rotation:e.rotation.clone(),scaling:e.scale.clone()},end:r,easeFunc:c,startTime:i+_,endTime:i+_+t,loop:n.loop||!1,resolve:u,reject:s}),f}cancelAnimation(n,e=!1){const r=this.animations.filter(t=>t.mesh===n);r.length&&(r.forEach(t=>{e&&(t.end.position&&n.position.copy(t.end.position),t.end.rotation&&n.rotation.copy(t.end.rotation),t.end.scaling&&n.scale.copy(t.end.scaling)),t.reject&&(t.reject(),t.resolve=void 0,t.reject=void 0)}),this.animations=this.animations.filter(t=>t.mesh!==n))}}const Be=()=>{const a=new o.Group;a.name="debugScreen",a.renderOrder=1;const n=[],e=new o.PlaneGeometry(5,5),[r,t]=_e(1024),_=new o.CanvasTexture(r);_.encoding=o.LinearSRGBColorSpace;const c=new o.MeshBasicMaterial({map:_,transparent:!0}),i=new o.Mesh(e,c);a.add(i),i.position.set(0,0,0);const u=()=>{t.clearRect(0,0,r.width,r.height),t.globalAlpha=.5,t.fillStyle="black",t.fillRect(0,0,r.width,r.height),t.globalAlpha=1;const s=32;t.fillStyle="white",t.textBaseline="top",t.textAlign="left",t.font=`${s}px monospace`,n.forEach((f,b)=>{t.fillText(f,0,s*b)}),_.needsUpdate=!0};return P.Instance.on("debug",(s="")=>{typeof s=="string"&&(console.log(s),n.unshift(s),n.length>10&&n.pop(),u())}),a},ze=()=>{const a=new o.Group;a.name="debugScreen",a.renderOrder=1;const n=["You win!","Thanks for playing","Created by Alex Swan"],e=new o.PlaneGeometry(5,5);e.translate(0,-2,0);const[r,t]=_e(1024),_=new o.CanvasTexture(r);_.encoding=o.LinearSRGBColorSpace;const c=new o.MeshBasicMaterial({map:_,transparent:!0}),i=new o.Mesh(e,c);a.add(i),i.position.set(0,0,0);const u=()=>{if(!i.userData.solved)return;t.clearRect(0,0,r.width,r.height),t.globalAlpha=.5,t.fillStyle="black",t.fillRect(0,0,r.width,r.height*.2),t.globalAlpha=1;const s=64;t.fillStyle="white",t.textBaseline="top",t.textAlign="center",t.font=`${s}px monospace`,n.forEach((f,b)=>{t.fillText(f,r.width/2,s*b)}),_.needsUpdate=!0};return P.Instance.on("solved",s=>{s.color&&s.artist&&s.title&&(i.userData.solved=!0),u()}),a},ce={color:fe,artist:oe,title:se};let A,v,re,E,z,D,B,ee,te,j,le;const ne=new o.Vector3(0,0,.3),Ge=async()=>{document.getElementById("intro").style.display="none";const n=document.getElementById("c");if(!n)return;n.style.display="block",E=new o.WebGLRenderer({antialias:!0}),E.setPixelRatio(window.devicePixelRatio),E.setSize(window.innerWidth,window.innerHeight),E.setClearColor("#000000"),E.xr.addEventListener("sessionstart",Ae),E.xr.enabled=!0,E.setAnimationLoop(Ne),document.body.appendChild(U.createButton(E)),document.body.appendChild(E.domElement);const e=new ve;v=new o.Scene,A=new o.PerspectiveCamera(75,window.innerWidth/window.innerHeight,.1,1e3),A.position.set(0,2,1),A.rotation.set(-1*Math.PI/12,0,0),A.name="camera",v.add(A),T.Instance.initScene(v);const r=new o.AmbientLight(16777215,.8);v.add(r);const t=new o.DirectionalLight(16777215,.8);t.position.set(6,10,8),t.castShadow=!0,t.target.position.set(0,0,0),v.add(t),v.add(t.target);const _=Be();_.position.set(0,1,-5),P.Instance.emit("debug","Hello🔒, world!"),v.add(_);const c=ze();c.position.set(0,1.5,-1),v.add(c),j=H("cassette"),j.position.set(0,0,-20),j.userData.isPickable=!0,v.add(j),T.Instance.animateTransform({mesh:j,end:{rotation:new o.Euler(0,2*Math.PI-.01,0)},duration:3e3,ease:y=>y,loop:!0});const i=H("arena"),u=i.getObjectByName("tableA");v.add(i);const s=H("cat");s.position.set(-3,1,0),s.scale.set(.1,.1,.1),v.add(s);const f=s.clone(!0);f.name="catMesh2",f.position.set(3,1,-1),f.rotation.set(0,Math.PI/2,0),v.add(f);const b=Le(v,E);b.position.set(0,1.5,-1),b.rotation.set(0,Math.PI,0),e.vinyls.forEach((y,m)=>{const l=ke(y);l.name=`vinyl-${m}`;const h=new o.Vector3(.7,1.15,-.2-.125*m);l.position.copy(h),l.userData.originalPosition=h,l.userData.isPickable=!0,l.userData.recordIndex=m,l.userData.returnToOriginalPosition=()=>{v.attach(l),T.Instance.cancelAnimation(l),T.Instance.animateTransform({mesh:l,end:{position:l.userData.originalPosition,rotation:new o.Euler(0,0,0)},duration:100})},l.onPointerPick=p=>{if(p.userData.selected)return;e.selected[p.id]=m;const S=p.getObjectByName("target");S&&(T.Instance.cancelAnimation(l),S.attach(l),T.Instance.animateTransform({mesh:l,end:{position:new o.Vector3(0,0,0),rotation:new o.Euler(0,0,0)},duration:60}),p.userData.selected=l)},l.onPointerDrop=p=>{if(T.Instance.cancelAnimation(l,!0),l.getWorldPosition(new o.Vector3).distanceTo(u.getWorldPosition(new o.Vector3))<.3){e.addVinylByIndex(l.userData.recordIndex),delete e.selected[p.id],p.userData.selected=void 0,u.children.forEach(d=>{d.userData.returnToOriginalPosition&&d.userData.returnToOriginalPosition()}),u.attach(l),T.Instance.animateTransform({mesh:l,end:{position:new o.Vector3(0,.01,0),rotation:new o.Euler(-1*Math.PI/2,0,0)},duration:60}).then(()=>{T.Instance.animateTransform({mesh:l,end:{rotation:new o.Euler(-1*Math.PI/2,0,-2*Math.PI)},ease:d=>d,duration:1800,loop:!0})});return}else l.userData.returnToOriginalPosition(),p.userData.selected=void 0},v.add(l)}),D=E.xr.getController(0),D.addEventListener("selectstart",F),D.addEventListener("selectend",Y),D.addEventListener("squeezestart",F),D.addEventListener("squeezeend",Y),v.add(D),B=E.xr.getController(1),B.addEventListener("selectstart",F),B.addEventListener("selectend",Y),B.addEventListener("squeezestart",F),B.addEventListener("squeezeend",Y),v.add(B),ee=E.xr.getControllerGrip(0);const w=ie({radius:.01,depth:.2,color:16711935});w.name="controllerMesh1",w.rotateX(Math.PI/4),ee.add(w),v.add(ee),te=E.xr.getControllerGrip(1);const x=ie({radius:.01,depth:.2,color:65280});x.rotateX(Math.PI/4),te.add(x),v.add(te);const R=new o.BufferGeometry().setFromPoints([new o.Vector3(0,0,0),new o.Vector3(0,0,-1)]),C=new o.Line(R);C.name="line",C.scale.z=5,D.add(C.clone()),B.add(C.clone());const g=new o.Group;g.rotation.set(-1*Math.PI/2,0,0),g.position.set(0,-.05,-.12),g.name="target",D.add(g.clone()),B.add(g.clone()),re=new o.Raycaster,window.addEventListener("resize",Ue,!1),P.Instance.on("progress",y=>{let m="color";y.artist.correctCount>=y.title.correctCount&&(m="artist"),y.title.correctCount>=y.artist.correctCount&&(m="title");for(let h=0;h<6;h++){const p=i.getObjectByName(`progress-${h}`),S=h<y[m].correctCount?ce[m]:0;p&&(p.visible=!0,p.material.color.set(S),p.material.emissive.set(S),p.material.needsUpdate=!0)}const l=Object.keys(y);for(let h=0;h<l.length;h++){const p=l[h],S=i.getObjectByName(`complete-${h}`),d=y[p].solved?ce[p]:0;S&&(S.visible=!0,S.material.color.set(d),S.material.emissive.set(d),S.material.needsUpdate=!0)}}),e.reset(),e.addVinylByIndex(2),e.addVinylByIndex(4),e.addVinylByIndex(1),e.addVinylByIndex(5),e.addVinylByIndex(2)};function Ae(){le=E.xr.getReferenceSpace();const a={x:-1*ne.x,y:-1*ne.y,z:-1*ne.z,w:1},n=new o.Quaternion,e=new XRRigidTransform(a,n),r=le.getOffsetReferenceSpace(e);E.xr.setReferenceSpace(r)}function F(a){z=a.target;const n=ue(z);if(n.length>0){let e=!1;n.forEach(({object:r,distance:t})=>{if(e)return;let _=r;for(;_;){if(_.onPointerPick){_.onPointerPick(z),e=!0;const c=z.getObjectByName("line");c.visible=!1;break}_=_.parent}})}z.userData.targetRayMode=a.data.targetRayMode}function Y(a){z=a.target;const n=z.userData.selected;n?.onPointerDrop&&n.onPointerDrop(z);const e=z.getObjectByName("line");e.visible=!0}function ue(a){return a.updateMatrixWorld(),re.setFromXRController(a),re.intersectObjects(v.children,!0)}function de(a){if(a.userData.targetRayMode==="screen"||a.userData.selected!==void 0)return;const n=a.getObjectByName("line"),e=ue(a);if(n.scale.z=5,e.length>0){let r=!1;e.forEach(({object:t,distance:_})=>{if(r)return;let c=t;for(;c;){if(c.userData.isPickable){n.scale.z=_,r=!0;break}c=c.parent}})}}function Ne(){T.Instance.update(),P.Instance.emit("tick"),de(D),de(B),E.render(v,A)}const Ue=()=>{A.aspect=window.innerWidth/window.innerHeight,A.updateProjectionMatrix(),E.setSize(window.innerWidth,window.innerHeight)};window.addEventListener("DOMContentLoaded",()=>{const a=document.getElementById("playButton");a.onclick=Ge});

import*as e from"https://js13kgames.com/2025/webxr/three.module.js";!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver(e=>{for(const _ of e)if("childList"===_.type)for(const e of _.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)}).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();class t{static _instance;callbacks;constructor(){this.callbacks={}}static get Instance(){return t._instance||(t._instance=new t),t._instance}on(e,t){this.callbacks[e]=this.callbacks[e]||[],this.callbacks[e].push(t)}off(e,t){this.callbacks[e]=(this.callbacks[e]||[]).filter(e=>e!==t)}emit(e,...t){(this.callbacks[e]||[]).forEach(e=>e(...t))}_reset(){Object.keys(this.callbacks).forEach(e=>{delete this.callbacks[e]})}getCallbacks(){return this.callbacks}}const _="#e81416",n="#ffa500",r="#faeb36",o="#79c314",s="#487de7",a="#70369d",i="#000000",c="#abb7d0",l="#333333",u={color:_,artist:o,title:s},d=[_,n,r,o,s,a],h=["Shiny Toy Guns","B.B. King","Jack White","Black Sabbath","Faith Hill","Cliff Sheen"],p=["OFFSIDE","SHOWCASE","LOADOUT","BACKHAND","BOOKMARKS","MANPOWER"],m={color:d,artist:h,title:p},g={color:0,artist:24,title:34},f=[[0,1,2,3,4,5],[0,2,4,1,5,3],[0,3,5,1,4,2]],b=["color","artist","title"];class y{queue;selected;vinyls;progress;constructor(){this.queue=[],this.selected={},this.vinyls=[],this.reset(),this.progress.bestComboType="color"}addVinylByIndex(e){if(this.queue[0]===e)return;const{color:_,artist:n,title:r}=this.vinyls[e],o=d.indexOf(_),s=h.indexOf(n),a=p.indexOf(r);o===this.progress.color.currentIndex+1?(this.progress.color.correctCount++,this.progress.color.correctCount===d.length&&(this.progress.color.solved=!0),this.progress.color.currentIndex=o):(this.progress.color.currentIndex=-1,this.progress.color.correctCount=0),s===(this.progress.artist.currentIndex+1)%h.length?(this.progress.artist.correctCount++,this.progress.artist.correctCount===h.length&&(this.progress.artist.solved=!0)):this.progress.artist.correctCount=1,this.progress.artist.currentIndex=s,a===(this.progress.title.currentIndex+1)%p.length?(this.progress.title.correctCount++,this.progress.title.correctCount===p.length&&(this.progress.title.solved=!0)):this.progress.title.correctCount=1,this.progress.title.currentIndex=a;const i=Math.max(this.progress.color.correctCount,this.progress.artist.correctCount,this.progress.title.correctCount);this.progress.bestComboCount<6&&i<this.progress.bestComboCount&&t.Instance.emit("comboBroken"),this.progress.bestComboCount=i,this.progress.bestComboType=this.progress.color.correctCount===this.progress.bestComboCount?"color":this.progress.artist.correctCount===this.progress.bestComboCount?"artist":"title",this.queue.unshift(e),this.progress.displayText=this.getDisplayText(),t.Instance.emit("progress",this.progress),t.Instance.emit("debug",JSON.stringify(this.progress))}getVinylInQueue(e){return this.vinyls[this.queue[e]]}isSolved(e){return this.progress[e].solved}getDisplayText(){let e="";const{currentIndex:t,correctCount:_,solved:n}=this.progress[this.progress.bestComboType],r=m[this.progress.bestComboType];for(let o=0;o<_;o++){let _=t-o;_<0&&(_+=r.length),e=`${r[_]}â†’${e}`}return e}reset(){this.queue=[],this.selected={};const[e,_,n]=f;this.progress={color:{currentIndex:-1,correctCount:0,solved:!1},artist:{currentIndex:-2,correctCount:0,solved:!1},title:{currentIndex:-2,correctCount:0,solved:!1},bestComboType:"color",bestComboCount:0},this.vinyls=d.map((e,t)=>({index:t,color:e,artist:"",title:""})),e.forEach((e,t)=>{this.vinyls[e].color=d[t]}),_.forEach((e,t)=>{this.vinyls[e].artist=h[t]}),n.forEach((e,t)=>{this.vinyls[e].title=p[t]}),t.Instance.emit("progress",this.progress)}}class w{static createButton(e,t={}){const _=document.createElement("button");function n(){_.style.display="",_.style.cursor="auto",_.style.left="calc(50% - 75px)",_.style.width="150px",_.onmouseenter=null,_.onmouseleave=null,_.onclick=null}function r(e){e.style.position="absolute",e.style.bottom="20px",e.style.padding="12px 6px",e.style.border="1px solid #fff",e.style.borderRadius="4px",e.style.background="rgba(0,0,0,0.1)",e.style.color="#fff",e.style.font="normal 13px sans-serif",e.style.textAlign="center",e.style.opacity="0.5",e.style.outline="none",e.style.zIndex="999"}if("xr"in navigator)return _.id="VRButton",_.style.display="none",r(_),navigator.xr.isSessionSupported("immersive-vr").then(function(r){r?function(){let n=null;async function r(t){t.addEventListener("end",o),await e.xr.setSession(t),_.textContent="EXIT VR",n=t}function o(){n.removeEventListener("end",o),_.textContent="ENTER VR",n=null}_.style.display="",_.style.cursor="pointer",_.style.left="calc(50% - 50px)",_.style.width="100px",_.textContent="ENTER VR";const s={...t,optionalFeatures:["local-floor","bounded-floor","layers",...t.optionalFeatures||[]]};_.onmouseenter=function(){_.style.opacity="1.0"},_.onmouseleave=function(){_.style.opacity="0.5"},_.onclick=function(){null===n?navigator.xr.requestSession("immersive-vr",s).then(r):(n.end(),void 0!==navigator.xr.offerSession&&navigator.xr.offerSession("immersive-vr",s).then(r).catch(e=>{}))},void 0!==navigator.xr.offerSession&&navigator.xr.offerSession("immersive-vr",s).then(r).catch(e=>{})}():(n(),_.textContent="VR NOT SUPPORTED"),r&&w.xrSessionIsGranted&&_.click()}).catch(function(e){n(),_.textContent="VR NOT ALLOWED"}),_;{const e=document.createElement("a");return!1===window.isSecureContext?(e.href=document.location.href.replace(/^http:/,"https:"),e.innerHTML="WEBXR NEEDS HTTPS"):(e.href="https://immersiveweb.dev/",e.innerHTML="WEBXR NOT AVAILABLE"),e.style.left="calc(50% - 90px)",e.style.width="180px",e.style.textDecoration="none",r(e),e}}static registerSessionGrantedListener(){if("undefined"!=typeof navigator&&"xr"in navigator){if(/WebXRViewer\//i.test(navigator.userAgent))return;navigator.xr.addEventListener("sessiongranted",()=>{w.xrSessionIsGranted=!0})}}}w.xrSessionIsGranted=!1,w.registerSessionGrantedListener();const v=.0254,x=(e=1024,t=1024)=>{const _=document.createElement("canvas");_.width=e,_.height=t;const n=_.getContext("2d");return[_,n]},C={},M=new e.Color,I=(t,_)=>{const n=1==_?.glow,r=`color-${t}-${n}`;if(C[r])return C[r];const o=new(n?e.MeshBasicMaterial:e.MeshStandardMaterial)({color:t,side:e.FrontSide});return C[r]=o,o},F=(t,_)=>{const{color:n,bgColor:r,textAlign:o,ratio:s,fontSize:a}=_;M.set(n);const c="string"==typeof n?n:`#${M.getHexString()}`,l=`text-${c}-${t.join("")}`;if(C[l])return C[l];const u=1024,d=s?u/s:u,[h,p]=x(u,d);p.textAlign=o||"center";let m=16;"center"===p.textAlign&&(m=512),t.forEach((e,t)=>{const _=void 0!==a?a:64;p.strokeStyle=i,p.font=`${_}px monospace`,p.textBaseline="top",p.lineWidth=8,p.strokeText(e,m,16+_*t),p.fillStyle=c,p.fillText(e,m,16+_*t)});const g=new e.CanvasTexture(h),f=new e.MeshBasicMaterial({map:g,transparent:!0});return C[l]=f,f},B=e=>e*e,T=e=>e<.5?4*e*e*e:1-Math.pow(-2*e+2,3)/2;class E{static _instance;animations;scene;clock;constructor(){this.animations=[],this.scene=null,this.clock=new e.Clock}static get Instance(){return E._instance||(E._instance=new E),E._instance}initScene(e){this.scene||(this.scene=e,this.clock.start())}update(){const t=1e3*this.clock.getElapsedTime();this.animations=this.animations.filter(_=>{const n=t-_.startTime,r=_.endTime-_.startTime,o=(s=n/r,Math.min(Math.max(s,0),1));var s;if(t>=_.endTime)return _.loop?(_.startTime=t,_.endTime=t+r,_.end.position&&_.mesh.position.copy(_.start.position),_.end.rotation&&_.mesh.rotation.copy(_.start.rotation),_.end.scaling&&_.mesh.scale.copy(_.start.scaling),!0):(_.end.position&&_.mesh.position.copy(_.end.position),_.end.rotation&&_.mesh.rotation.copy(_.end.rotation),_.end.scaling&&_.mesh.scale.copy(_.end.scaling),_.resolve&&(_.resolve(),_.resolve=void 0,_.reject=void 0),!1);if(_.end.position&&_.mesh.position.lerpVectors(_.start.position,_.end.position,_.easeFunc(o)),_.end.rotation){const t=_.start.rotation,n=_.end.rotation,r=new e.Euler;r.order=t.order||e.Euler.DefaultOrder,r.x=t.x+(n.x-t.x)*_.easeFunc(o),r.y=t.y+(n.y-t.y)*_.easeFunc(o),r.z=t.z+(n.z-t.z)*_.easeFunc(o),_.mesh.rotation.copy(r)}return _.end.scaling&&_.mesh.scale.lerpVectors(_.start.scaling,_.end.scaling,_.easeFunc(o)),!0})}animateTransform(e){const{mesh:t,end:_}=e,n=e.duration||1e3,r=e.delay||0,o=e.ease||B,s=1e3*this.clock.getElapsedTime();let a,i;const c=new Promise((e,t)=>{a=e,i=t});return this.animations.push({mesh:t,start:{position:t.position.clone(),rotation:t.rotation.clone(),scaling:t.scale.clone()},end:_,easeFunc:o,startTime:s+r,endTime:s+r+n,loop:e.loop||!1,resolve:a,reject:i}),c}cancelAnimation(e,t=!1){const _=this.animations.filter(t=>t.mesh===e);_.length&&(_.forEach(_=>{t&&(_.end.position&&e.position.copy(_.end.position),_.end.rotation&&e.rotation.copy(_.end.rotation),_.end.scaling&&e.scale.copy(_.end.scaling)),_.reject&&(_.reject(),_.resolve=void 0,_.reject=void 0)}),this.animations=this.animations.filter(t=>t.mesh!==e))}}class S{constructor(){this.mOscillators=[this.osc_sin.bind(this),this.osc_square.bind(this),this.osc_saw.bind(this),this.osc_tri.bind(this)],this.mSong=null,this.mLastRow=0,this.mCurrentCol=0,this.mNumWords=0,this.mMixBuf=null}osc_sin(e){return Math.sin(6.283184*e)}osc_saw(e){return e%1*2-1}osc_square(e){return e%1<.5?1:-1}osc_tri(e){var t=e%1*4;return t<2?t-1:3-t}getnotefreq(e){return.003959503758*2**((e-128)/12)}createNote(e,t,_){var n,r,o,s,a,i,c=this.mOscillators[e.i[0]],l=e.i[1],u=e.i[3]/32,d=this.mOscillators[e.i[4]],h=e.i[5],p=e.i[8]/32,m=e.i[9],g=e.i[10]*e.i[10]*4,f=e.i[11]*e.i[11]*4,b=e.i[12]*e.i[12]*4,y=1/b,w=-e.i[13]/16,v=e.i[14],x=_*2**(2-e.i[15]),C=new Int32Array(g+f+b),M=0,I=0;for(n=0,r=0;n<g+f+b;n++,r++)r>=0&&(v=v>>8|(255&v)<<4,r-=x,a=this.getnotefreq(t+(15&v)+e.i[2]-128),i=this.getnotefreq(t+(15&v)+e.i[6]-128)*(1+8e-4*e.i[7])),o=1,n<g?o=n/g:n>=g+f&&(o=(1-(o=(n-g-f)*y))*3**(w*o)),s=c(M+=a*o**u)*l,s+=d(I+=i*o**p)*h,m&&(s+=(2*Math.random()-1)*m),C[n]=80*s*o|0;return C}async init(e){return new Promise(t=>{this.mSong=e,this.mLastRow=e.endPattern,this.mCurrentCol=0,this.mNumWords=e.rowLen*e.patternLen*(this.mLastRow+1)*2,this.mMixBuf=new Int32Array(this.mNumWords),t()})}generateChannel(e){return new Promise(t=>{var _,n,r,o,s,a,i,c,l,u,d,h,p,m,g=new Int32Array(this.mNumWords),f=this.mSong.songData[e],b=this.mSong.rowLen,y=this.mSong.patternLen,w=0,v=0,x=!1,C=[];for(r=0;r<=this.mLastRow;++r)for(i=f.p[r],o=0;o<y;++o){var M=i?f.c[i-1].f[o]:0;M&&(f.i[M-1]=f.c[i-1].f[o+y]||0,M<17&&(C=[]));var I=this.mOscillators[f.i[16]],F=f.i[17]/512,B=2**(f.i[18]-9)/b,T=f.i[19],E=f.i[20],S=43.23529*f.i[21]*3.141592/44100,P=1-f.i[22]/255,L=1e-5*f.i[23],k=f.i[24]/32,D=f.i[25]/512,R=6.283184*2**(f.i[26]-9)/b,A=f.i[27]/255,O=f.i[28]*b&-2;for(d=(r*y+o)*b,s=0;s<4;++s)if(a=i?f.c[i-1].n[o+s*y]:0){C[a]||(C[a]=this.createNote(f,a,b));var N=C[a];for(n=0,_=2*d;n<N.length;n++,_+=2)g[_]+=N[n]}for(n=0;n<b;n++)(u=g[c=2*(d+n)])||x?(h=S,T&&(h*=I(B*c)*F+.5),v+=(h=1.5*Math.sin(h))*(p=P*(u-v)-(w+=h*v)),u=3==E?v:1==E?p:w,L&&(u=(u*=L)<1?u>-1?this.osc_sin(.25*u):-1:1,u/=L),x=(u*=k)*u>1e-5,m=u*(1-(l=Math.sin(R*c)*D+.5)),u*=l):m=0,c>=O&&(m+=g[c-O+1]*A,u+=g[c-O]*A),g[c]=0|m,g[c+1]=0|u,this.mMixBuf[c]+=0|m,this.mMixBuf[c+1]+=0|u}t()})}async generate(){this.mMixBuf.fill(0),this.mCurrentCol=0;const e=[];for(let t=0;t<this.mSong.numChannels;t++)e.push(this.generateChannel(t));return await Promise.all(e),this.mCurrentCol=this.mSong.numChannels,1}createAudioBuffer(e){for(var t=e.createBuffer(2,this.mNumWords/2,44100),_=0;_<2;_++)for(var n=t.getChannelData(_),r=_;r<this.mNumWords;r+=2)n[r>>1]=this.mMixBuf[r]/65536;return t}createAudioBufferRange(e,t=0,_=null){(null===_||_>this.mNumWords/2)&&(_=this.mNumWords/2),t<0&&(t=0),t>=_&&(t=_-1);const n=_-t;for(var r=e.createBuffer(2,n,44100),o=0;o<2;o++)for(var s=r.getChannelData(o),a=0;a<n;a++){var i=2*(t+a)+o;s[a]=this.mMixBuf[i]/65536}return r}createWave(){var e=44+2*this.mNumWords-8,t=e-36,_=new Uint8Array(44+2*this.mNumWords);_.set([82,73,70,70,255&e,e>>8&255,e>>16&255,e>>24&255,87,65,86,69,102,109,116,32,16,0,0,0,1,0,2,0,68,172,0,0,16,177,2,0,4,0,16,0,100,97,116,97,255&t,t>>8&255,t>>16&255,t>>24&255]);for(var n=0,r=44;n<this.mNumWords;++n){var o=this.mMixBuf[n];o=o<-32767?-32767:o>32767?32767:o,_[r++]=255&o,_[r++]=o>>8&255}return _}createWaveRange(e=0,t=null){(null===t||t>this.mNumWords/2)&&(t=this.mNumWords/2),e<0&&(e=0),e>=t&&(e=t-1);const _=t-e;var n=44+2*_-8,r=n-36,o=new Uint8Array(44+2*_);o.set([82,73,70,70,255&n,n>>8&255,n>>16&255,n>>24&255,87,65,86,69,102,109,116,32,16,0,0,0,1,0,2,0,68,172,0,0,16,177,2,0,4,0,16,0,100,97,116,97,255&r,r>>8&255,r>>16&255,r>>24&255]);for(var s=0,a=44;s<_;++s){var i=this.mMixBuf[2*(e+s)];i=i<-32767?-32767:i>32767?32767:i,o[a++]=255&i,o[a++]=i>>8&255}return o}getData(e,t){for(var _=2*Math.floor(44100*e),n=new Array(t),r=0;r<2*t;r+=1){var o=_+r;n[r]=e>0&&o<this.mMixBuf.length?this.mMixBuf[o]/32768:0}return n}}const P=44100,L=new(window.AudioContext||window.webkitAudioContext),k=(...e)=>((...e)=>{let t=L.createBufferSource(),_=L.createBuffer(e.length,e[0].length,P);return e.map((e,t)=>_.getChannelData(t).set(e)),t.buffer=_,t.connect(L.destination),t.start(),t})(((e=1,t=.05,_=220,n=0,r=0,o=.1,s=0,a=1,i=0,c=0,l=0,u=0,d=0,h=0,p=0,m=0,g=0,f=1,b=0,y=0)=>{let w,v,x=2*Math.PI,C=i*=500*x/P**2,M=(0<p?1:-1)*x/4,I=_*=(1+2*t*Math.random()-t)*x/P,F=[],B=0,T=0,E=0,S=1,L=0,k=0,D=0;for(c*=500*x/P**3,p*=x/P,l*=x/P,u*=P,d=P*d|0,v=(n=99+P*n)+(b*=P)+(r*=P)+(o*=P)+(g*=P)|0;E<v;F[E++]=D)++k%(100*m|0)||(D=s?1<s?2<s?3<s?Math.sin((B%x)**3):Math.max(Math.min(Math.tan(B),1),-1):1-(2*B/x%2+2)%2:1-4*Math.abs(Math.round(B/x)-B/x):Math.sin(B),D=(d?1-y+y*Math.sin(2*Math.PI*E/d):1)*(0<D?1:-1)*Math.abs(D)**a*e*.3*(E<n?E/n:E<n+b?1-(E-n)/b*(1-f):E<n+b+r?f:E<v-g?(v-E-g)/o*f:0),D=g?D/2+(g>E?0:(E<v-g?1:(v-E)/g)*F[E-g|0]/2):D),w=(_+=i+=c)*Math.sin(T*p-M),B+=w-w*h*(1-1e9*(Math.sin(E)+1)%2),T+=w-w*h*(1-1e9*(Math.sin(E)**2+1)%2),S&&++S>u&&(_+=l,I+=l,S=0),!d||++L%d||(_=I,i=C,S=S||1);return F})(...e));var D={songData:[{i:[0,255,116,85,0,255,116,0,37,14,4,6,73,99,0,0,0,0,0,0,2,136,15,0,32,0,0,0,6],p:[1,1,1,2,,,1,1,2,2],c:[{n:[139,,,,139,,,,139,,,,139,,,,139,,,,139,,,,139,,139,,139,,139],f:[]},{n:[140,,140,,,,140,,,,140,,140,,140,,,,140,,140,,,,140,,140,,,,140],f:[]}]},{i:[0,160,128,64,0,160,128,0,64,210,4,7,52,85,0,0,0,60,4,1,2,255,0,0,32,61,5,0,6],p:[,1,2,1,2,1,2,1,1,1],c:[{n:[,,,,139,,,,,,,,139,,,,,,,,139,,,,,,,,139,,139],f:[]},{n:[,,,,,,,,,,,,139,,139,,,,,,,,,,,,,,139,,139],f:[]}]},{i:[0,255,106,64,0,255,106,0,64,0,5,7,164,0,0,0,0,0,0,0,2,255,0,2,32,83,5,25,1],p:[,,,,1,,2,1,1,2],c:[{n:[144,,,,,,,,,,,,,,,,144],f:[]},{n:[,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,156,,,,,,,,,,,,,,,,156],f:[]}]},{i:[0,91,128,0,0,95,128,12,0,0,12,0,72,0,0,0,0,0,0,0,2,255,0,0,32,83,3,130,4],p:[,,,,1,1,1,1,2,2],c:[{n:[132,,,,,,,,132,,,,,,,,144,,,,,,,,144],f:[]},{n:[],f:[]}]},{i:[1,192,128,0,1,191,116,9,0,0,6,22,34,0,0,0,0,69,3,1,1,23,167,0,32,77,6,25,6],p:[,,2,1,,2,1,2,2,1],c:[{n:[144,,,,144,,,,144,,,,142,,142,,144,,144,,144,,,,144,,,,144,,,,147,,,,151,,,,147,,,,149,,149,,147,,147,,151,,,,147,,,,147,,,,151,,,,154,,,,151,,,,151,,151,,151,,151,,154,,,,151,,,,151],f:[]},{n:[144,144,144,,144,,,,,,,,,,,,,,,,,,,,,,,,,,,,147,147,147,,147,,,,,,,,,,,,,,,,,,,,,,,,,,,,151,151,151,,151],f:[]}]}],rowLen:5513,patternLen:32,endPattern:9,numChannels:5};const R=new AudioContext;let A=0;t.Instance.on("progress",e=>{const t=e.bestComboCount||0;A=Math.min(t,6)});const O={uDirLightPos:{value:new e.Vector3},uDirLightColor:{value:new e.Color(15658734)},uAmbientLightColor:{value:new e.Color(328965)},uBaseColor:{value:new e.Color(16777215)},uLineColor1:{value:new e.Color(0)}},N=["Light Blue","Yellow","Orange","Red","Purple","Blue","Green","Lime","Pink","Silver"],W={"Light Blue":"#9999ff",Yellow:"#fffb00",Orange:"#ff7300",Red:"#ff0000",Purple:"#c300ff",Blue:"#0000ff",Green:"#00ff00",Lime:"#b0ffb0",Pink:"#ff00ff",Silver:"#d3d3d3"},G=(t,_)=>{const n=new e.Group;n.position.set(0,0,0),n.rotation.set(0,0,0),n.scale.set(1,1,1);const r={...W,..._};return t.forEach(t=>{if(null!==t)if(Array.isArray(t))n.add(G(t,r));else{const[_,o,s,a,i,c,l,u,d,h,p,m,g,f,b]=t.split("_"),y=(t=>{const[_]=t.split("_");switch(_){case"cube":return(t=>{const[_,n,r,o,s,a,i,c,l,u,d,h,p,m,g]=t.split("_"),f=parseFloat(r),b=parseFloat(o),y=parseFloat(s),w=parseFloat(a),v=parseFloat(i),x=parseFloat(c),C=parseFloat(h),M=parseFloat(p),I=parseFloat(m),F=parseFloat(l),B=parseFloat(u),T=parseFloat(d),E=new e.BoxGeometry(f,b,y);return E.translate(w-C,v-M,x-I),E.rotateX(e.MathUtils.degToRad(F)),E.rotateY(e.MathUtils.degToRad(B)),E.rotateZ(e.MathUtils.degToRad(T)),E.computeBoundingBox(),E})(t);case"sphere":return(t=>{const[_,n,r,o,s,a,i,c,l,u,d,h,p,m,g]=t.split("_"),f=parseFloat(r),b=parseFloat(o),y=parseFloat(s),w=parseFloat(a),v=parseFloat(i),x=parseFloat(c),C=parseFloat(h),M=parseFloat(p),I=parseFloat(m),F=parseFloat(l),B=parseFloat(u),T=parseFloat(d),E=new e.SphereGeometry(f/2,32,16);return E.scale(f/f,b/f,y/f),E.translate(w-C,v-M,x-I),E.rotateX(e.MathUtils.degToRad(F)),E.rotateY(e.MathUtils.degToRad(B)),E.rotateZ(e.MathUtils.degToRad(T)),E})(t);case"plane":return(t=>{const[_,n,r,o,s,a,i,c,l,u,d,h,p,m,g]=t.split("_"),f=parseFloat(r),b=parseFloat(o),y=parseFloat(a),w=parseFloat(i),v=parseFloat(c),x=parseFloat(h),C=parseFloat(p),M=parseFloat(m),I=parseFloat(l),F=parseFloat(u),B=parseFloat(d),T=new e.PlaneGeometry(f,b);return T.rotateX(e.MathUtils.degToRad(-90)),T.translate(y-x,w-C,v-M),T.rotateX(e.MathUtils.degToRad(I)),T.rotateY(e.MathUtils.degToRad(F)),T.rotateZ(e.MathUtils.degToRad(B)),T.computeBoundingBox(),T})(t);case"cylinder":return(t=>{const[_,n,r,o,s,a,i,c,l,u,d,h,p,m,g]=t.split("_"),f=parseFloat(r),b=parseFloat(o),y=parseFloat(s),w=parseFloat(a),v=parseFloat(i),x=parseFloat(c),C=parseFloat(h),M=parseFloat(p),I=parseFloat(m),F=parseFloat(l),B=parseFloat(u),T=parseFloat(d),E=f/2,S=new e.CylinderGeometry(E,E,b,32);S.translate(w-C,v-M,x-I),S.scale(1,1,y/f);const P=e.MathUtils.degToRad(F),L=e.MathUtils.degToRad(B),k=e.MathUtils.degToRad(T),D=new e.Euler(P,L,k);return S.applyQuaternion((new e.Quaternion).setFromEuler(D)),S.computeBoundingBox(),S})(t);case"pyramid":return(t=>{const[_,n,r,o,s,a,i,c,l,u,d,h,p,m,g]=t.split("_"),f=parseFloat(r),b=parseFloat(o),y=parseFloat(s),w=parseFloat(a),v=parseFloat(i),x=parseFloat(c),C=parseFloat(h),M=parseFloat(p),I=parseFloat(m),F=parseFloat(l),B=parseFloat(u),T=parseFloat(d),E=Math.sqrt(f*f+f*f)/2,S=new e.CylinderGeometry(0,E,b,4,1,!1,Math.PI/4);return S.scale(1,1,y/f),S.translate(w-C,v-M+.3*b,x-I),S.rotateX(e.MathUtils.degToRad(F)),S.rotateY(e.MathUtils.degToRad(B)),S.rotateZ(e.MathUtils.degToRad(T)),S})(t);default:throw new Error(`Unknown shape: ${_}`)}})(t);let w=null;w="string"==typeof o&&o.startsWith("case")?new e.ShaderMaterial({uniforms:{...O},vertexShader:"\n\n\t\tvarying vec3 vNormal;\n\n\t\tvoid main() {\n\n\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\t\t\tvNormal = normalize( normalMatrix * normal );\n\n\t\t}",fragmentShader:"\n\n\t\tuniform vec3 uBaseColor;\n\t\tuniform vec3 uLineColor1;\n\t\tuniform vec3 uLineColor2;\n\t\tuniform vec3 uLineColor3;\n\t\tuniform vec3 uLineColor4;\n\n\t\tuniform vec3 uDirLightPos;\n\t\tuniform vec3 uDirLightColor;\n\n\t\tuniform vec3 uAmbientLightColor;\n\n\t\tvarying vec3 vNormal;\n\n\t\tvoid main() {\n\n\t\t\tfloat directionalLightWeighting = max( dot( normalize(vNormal), uDirLightPos ), 0.0);\n\t\t\tvec3 lightWeighting = uAmbientLightColor + uDirLightColor * directionalLightWeighting;\n\n\t\t\tgl_FragColor = vec4( uBaseColor, 1.0 );\n\n\t\t\tif ( length(lightWeighting) < 1.00 ) {\n\n\t\t\t\tif ( ( mod(gl_FragCoord.x, 4.001) + mod(gl_FragCoord.y, 4.0) ) > 6.00 ) {\n\n\t\t\t\t\tgl_FragColor = vec4( uLineColor1, 1.0 );\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\tif ( length(lightWeighting) < 0.50 ) {\n\n\t\t\t\tif ( ( mod(gl_FragCoord.x + 2.0, 4.001) + mod(gl_FragCoord.y + 2.0, 4.0) ) > 6.00 ) {\n\n\t\t\t\t\tgl_FragColor = vec4( uLineColor1, 1.0 );\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\t#include <colorspace_fragment>\n\n\t\t}"}):new e.MeshStandardMaterial({color:r[N[b]],side:e.DoubleSide});const v=new e.Mesh(y,w);v.name=o,v.position.set(m,g,f),n.add(v)}}),n},V=(e,t)=>{if("cassette"===e){const e=G([["cube_case1_1_8_2_7.5_4_0_0_0_0_7.5_4_0_5","cube_case2_3_9_2_5.5_4.5_0_0_0_0_5.5_4.5_0_5","cube_case3_8_4_2_0_7_0_0_0_0_0_8.5_0_5","cube_case4_8_1_2_0_2.5_0_0_0_0_0_2.5_0_5","cube_case5_3_9_2_-5.5_4.5_0_0_0_0_-5.5_4.5_0_5","cube_case6_1_8_2_-7.5_4_0_0_0_0_-7.5_4_0_5"],"cube_base_12_2.1_2.4_0_0.95_0_0_0_0_0_0_0_3","cube_rightReel_2_2_1_2.72_3.89_0_0_0_-45_2.72_3.89_0_2","cube_rightTape_4_4_0.2_2.81_3.91_-0.1_0_0_-45_2.81_3.91_-0.1_4","cube_leftReel_2_2_1_-2.69_3.91_0_0_0_-45_-2.75_4_0_2","sphere_dot_1_1_1_0_4_0_0_0_0_0_4_0_0","plane_label_12_3_0_0_7_1.01_90_0_0_0_7_1.01_9","cylinder_base_16_8_16_0_-4_0_0_0_0_0_-4_0_6"],t);return e.name="cassette",e}if("arena"===e){const e=G([[["cube_complete-0_0.3_0.1_0.1_-0.75_1.05_-0.45_0_0_0_-0.75_1.05_-0.45_3","cube_complete-1_0.3_0.1_0.1_-0.75_1.05_-0.35_0_0_0_-0.75_1.05_-0.35_6","cube_complete-2_0.3_0.1_0.1_-0.75_1.05_-0.25_0_0_0_-0.75_1.05_-0.25_5"],[],"cube_desk_2_0.1_1_0_0.85_-0.5_0_0_0_0_-0.1_0_6","cube_leg_0.1_0.8_0.1_-0.85_0.4_-0.85_0_0_0_0.1_0_-0.9_6","cube_leg_0.1_0.8_0.1_-0.85_0.4_-0.15_0_0_0_0.1_0_-0.2_6","cube_leg_0.1_0.8_0.1_0.85_0.4_-0.15_0_0_0_1.8_0_-0.2_6","cube_leg_0.1_0.8_0.1_0.85_0.4_-0.85_0_0_0_1.8_0_-0.9_6","cube_record-rack_0.4_0.1_0.8_0.7_0.95_-0.5_0_0_0_0.7_0.95_-0.5_0","cube_cube_0.3_0.1_0.4_-0.75_0.95_-0.3_0_0_0_-0.75_0.95_-0.3_9","cube_cube_0.4_0.1_0.4_-0.3_0.95_-0.3_0_0_0_-0.3_0.95_-0.3_9","cube_tableA_0.4_0.1_0.4_0.2_0.95_-0.3_0_0_0_0.2_1.01_-0.3_0","cylinder_pad_0.4_0.02_0.4_0.2_1_-0.3_0_0_0_0.2_1_-0.3_3"],"cube_cube_22_1_4_0_-1.5_-23_0_0_0_0_-2_-15_2","cube_floor_20_1_20_0_-2.5_-11_0_0_0_0_-3_-4_3","cube_cube_20_1_6_0_-2.5_2_0_0_0_0_-3_5_3","cube_cube_8_2_3_0_-1_0.5_0_0_0_0_-1_-4_2","cube_pillar_1_4_1_6.5_0_-6.5_0_0_0_7_0_-7_6","cube_pillar_1_4_1_6.5_0_-10.5_0_0_0_7_0_-11_6","cube_pillar_1_3_1_6.5_0.5_-14.5_0_0_0_7_0_-15_6","cube_pillar_1_4_1_6.5_0_-18.5_0_0_0_7_0_-19_6","cube_pillar_1_4_1_6.5_0_-14.5_0_0_0_7_0_-15_6","cube_pillar_1_4_1_-6.5_0_-6.5_0_0_0_-6_0_-7_6","cube_pillar_1_4_1_-6.5_0_-2.5_0_0_0_-6_0_-3_6","cube_pillar_1_4_1_6.5_0_-2.5_0_0_0_7_0_-3_6","cube_pillar_1_4_1_-6.5_0_-10.5_0_0_0_-6_0_-11_6","cube_pillar_1_4_1_-6.5_0_-14.5_0_0_0_-6_0_-15_6","cube_pillar_1_4_1_-6.5_0_-18.5_0_0_0_-6_0_-19_6","cube_cube_4_1_20_8_2.5_-11_0_0_0_7_2_-3_1","cube_cube_4_1_20_-8_2.5_-11_0_0_0_-9_2_-3_1"],t);return e.name="arena",e}if("cat"===e){const e=G(["sphere_head_20_16_16_0_8_0_0_0_0_0_8_0_4","sphere_head_16_16_16_0_-5_0_0_0_0_0_-5_0_4",["cylinder_leftEye_4_1_4_-3_10_-7.1_-71_-5_16_-3_10_-7.1_1","sphere_leftPupil_2_2_4_-2.8_10.1_-7_-75_7_10_-2.8_10.1_-7_4","cylinder_rightEye_4_1_4_3_10_-7.2_-71_5_-17_3_10_-7.2_1","sphere_rightPupil_2_2_4_2.9_10_-7.1_-74_-4_-12_2.9_10_-7.1_4"],["cube_rightCheek_4_4_2_1.84_6.03_-7.5_-25_0_80_2.34_6.53_-7.5_9","cube_leftCheek_4_4_2_-2.91_5.98_-7.5_0_23_10_-2.41_6.48_-7.5_9","cube_tongue_2_2_2_0_5_-7_0_0_0_0_4_-7_3","pyramid_pyramid_3_1.6_1_0_8.2_-8_-180_0_0_0_8.2_-8_8"],["pyramid_ear_6_7_4_-4.86_13.55_-1.28_-14_20_31_-4.86_13.55_-1.28_4","pyramid_ear_6_7_4_5.14_13.55_-1.28_-11_-15_-33_5.14_13.55_-1.28_4","pyramid_ear_5.2_6.2_3.4_5.14_13.15_-1.78_-9_-16_-33_5.14_13.15_-1.78_1","pyramid_ear_5_5.5_3.8_-5.04_13.54_-1.59_-17_19_32_-5.04_13.54_-1.59_1"],["cylinder_cylinder_0.2_11_0.2_-7.93_6_-10.12_0_-15_90_-7.93_6_-10.12_9","cylinder_cylinder_0.2_9.2_0.2_-6.87_7.72_-9_0_-15_75_-6.87_7.72_-9_9","cylinder_cylinder_0.2_9_0.2_-7.07_3.78_-9.3_0_-15_105_-7.07_3.78_-9.3_9","cylinder_cylinder_0.2_7.8_0.2_6.87_7.62_-8.9_180_-15_-105_6.87_7.62_-8.9_9","cylinder_cylinder_0.2_9.4_0.2_6.93_6_-9.52_0_-165_90_6.93_6_-9.52_9","cylinder_cylinder_0.2_8.8_0.2_6.87_3.88_-9.1_180_-15_-75_6.87_3.88_-9.1_9"]],t);return e.name="cat",e}if("paw"===e){const e=G(["cylinder_cylinder_4_6_2_0_-1_0_0_0_0_0_-1_0_4","sphere_sphere_4_4_2_0_2_0_0_0_0_0_2_0_4","cube_cube_0.3_1_0.3_-1.15_3.5_-0.55_-77_0_0_-1.15_3.5_-0.55_9","cube_cube_0.3_1_0.3_-0.45_3.9_-0.55_-77_0_0_-0.45_3.9_-0.55_9","cube_cube_0.3_1_0.3_0.45_3.9_-0.55_-77_0_0_0.45_3.9_-0.55_9","cube_cube_0.3_1_0.3_1.05_3.6_-0.55_-77_0_0_1.05_3.6_-0.55_9","cube_cube_2_0.7_0.4_0_1.85_-0.9_0_0_0_0_1.5_-0.1_3","cube_cube_0.8_0.5_1.1_0_2.45_-0.55_0_0_0_0_2.2_-0.1_3","cube_cube_0.3_0.6_0.6_-1.15_2.7_-0.8_0_0_0_-1.15_2.7_-0.1_3","cube_cube_0.3_0.6_0.6_-0.45_3.1_-0.8_0_0_0_-0.45_3.1_-0.1_3","cube_cube_0.3_0.6_0.6_0.45_3.1_-0.8_0_0_0_0.45_3.1_-0.1_3","cube_cube_0.3_0.6_0.6_1.05_2.7_-0.8_0_0_0_1.05_2.7_-0.1_3"],t);return e.name="paw",e.scale.set(.03125,.03125,.03125),e}if("goldfish"===e){const e=G(["cube_cube_6_6_8_0_0_0_0_0_0_0_-3_0_2","cube_cube_4_4_11.1_0_0_-0.55_0_0_0_0_-3_0_2","cube_cube_2_2_2_-2_0_-5_0_0_0_-2_-1_-5_4","cube_cube_2_2_2_2_0_-5_0_0_0_2_-1_-5_4","cube_cube_2_6_2_0_0_6_0_0_0_0_-3_7_2","cube_cube_1_4_6_0_-3_9.5_15_0_0_0_-3_8.5_9","cube_cube_1_5_7_0_2.5_9.9_-15_0_0_0_2_8.4_2","cube_cube_2_5_6_0_2.2_0_-30_0_0_0_2.7_0_2","cube_cube_1_2_2_-2.5_-4_-2_0_0_-40_-3_-3_-2_9","cube_cube_3_1_4_-4.5_-3.5_4_0_0_20_-3_-3_3_9","cube_cube_1_2_2_2.5_-4_-2_0_0_40_3_-3_-2_9","cube_cube_3_1_4_4.5_-3.5_4_0_0_-25_3_-3_3_9"],t);return e.name="goldfish",e}if("progress"===e){const e=G(["cube_base_13_1_3_-1.5_0.5_-0.5_0_0_0_0_0_0_5",["cube_panel_12.4_2.7_1_-1.5_2.45_0.3_-60_0_0_-1.5_1.1_0.88_6","cube_display-back_11.8_0.8_0.1_-1.5_3.2_0.85_-60_0_0_-1.5_1.1_0.88_3","cube_progress-color-0_1.8_0.3_0.1_-6.5_2.45_0.85_-60_0_0_-11.5_1.1_0.88_9","cube_progress-color-1_1.8_0.3_0.1_-4.5_2.45_0.85_-60_0_0_0.5_1.1_0.88_9","cube_progress-color-2_1.8_0.3_0.1_-2.5_2.45_0.85_-60_0_0_0.5_1.1_0.88_9","cube_progress-color-3_1.8_0.3_0.1_-0.5_2.45_0.85_-60_0_0_0.5_1.1_0.88_9","cube_progress-color-4_1.8_0.3_0.1_1.5_2.45_0.85_-60_0_0_0.5_1.1_0.88_9","cube_progress-color-5_1.8_0.3_0.1_3.5_2.45_0.85_-60_0_0_0.5_1.1_0.88_9","cube_progress-artist-1_1.8_0.3_0.1_-4.5_1.95_0.85_-60_0_0_0.5_1.1_0.88_9","cube_progress-artist-2_1.8_0.3_0.1_-2.5_1.95_0.85_-60_0_0_0.5_1.1_0.88_9","cube_progress-artist-3_1.8_0.3_0.1_-0.5_1.95_0.85_-60_0_0_0.5_1.1_0.88_9","cube_progress-artist-4_1.8_0.3_0.1_1.5_1.95_0.85_-60_0_0_0.5_1.1_0.88_9","cube_progress-artist-5_1.8_0.3_0.1_3.5_1.95_0.85_-60_0_0_0.5_1.1_0.88_9","cube_progress-artist-0_1.8_0.3_0.1_-6.5_1.95_0.85_-60_0_0_-11.5_1.1_0.88_9","cube_progress-title-1_1.8_0.3_0.1_-4.5_1.45_0.85_-60_0_0_0.5_1.1_0.88_9","cube_progress-title-2_1.8_0.3_0.1_-2.5_1.45_0.85_-60_0_0_0.5_1.1_0.88_9","cube_progress-title-3_1.8_0.3_0.1_-0.5_1.45_0.85_-60_0_0_0.5_1.1_0.88_9","cube_progress-title-4_1.8_0.3_0.1_1.5_1.45_0.85_-60_0_0_0.5_1.1_0.88_9","cube_progress-title-5_1.8_0.3_0.1_3.5_1.45_0.85_-60_0_0_0.5_1.1_0.88_9","cube_progress-title-0_1.8_0.3_0.1_-6.5_1.45_0.85_-60_0_0_-11.5_1.1_0.88_9","plane_display_11.8_0.8_0_-1.5_2.22_-0.88_30_0_0_-1.5_2.22_-0.88_8"]],t);return e.name="progress",e}return null},U=[{Purple:l,Silver:"#888888",Yellow:c}];class j{clock;parent;_mesh;geometry;constructor(){this.clock=new e.Clock,this.parent=new e.Group,this.parent.name="Grid",this.geometry=new e.PlaneGeometry(20,26,20,26),this.geometry.rotateX(Math.PI/2),this._mesh=new e.Mesh(this.geometry,new e.MeshBasicMaterial({color:"#ff00ff",wireframe:!0})),this.parent.add(this._mesh),t.Instance.on("tick",e=>{const t=this.geometry.getAttribute("position");for(let _=0;_<t.array.length;_+=3){const e=t.array[_],n=t.array[_+2];t.array[_+1]=Math.sin(Math.sqrt(e*e+n*n)-4*this.clock.getElapsedTime())}t.needsUpdate=!0}),t.Instance.on("progress",t=>{!this._mesh.material.visible&&t.bestComboCount>5&&(this._mesh.position.set(0,-5,0),E.Instance.animateTransform({mesh:this._mesh,end:{position:new e.Vector3(0,0,0)},ease:T,duration:2e3})),this._mesh.material.visible=t.bestComboCount>5})}get mesh(){return this.parent}}const z=new e.Clock;let q,$,H,X,Y,Q,K,Z,J=0;const ee=new e.Vector3(0,0,.3),te=async()=>{document.getElementById("playButton").setAttribute("disabled","true"),document.getElementById("playButton").innerHTML="LOADING...",X=new e.WebGLRenderer({antialias:!0}),X.setPixelRatio(window.devicePixelRatio),X.setSize(window.innerWidth,window.innerHeight),X.setClearColor("#000000"),X.xr.addEventListener("sessionstart",_e),X.xr.enabled=!0,X.setAnimationLoop(ie),document.body.appendChild(w.createButton(X)),document.body.appendChild(X.domElement);const h=new y;$=new e.Scene,q=new e.PerspectiveCamera(75,window.innerWidth/window.innerHeight,.1,1e3),q.position.set(0,2,1),q.rotation.set(-1*Math.PI/12,0,0),q.name="camera",$.add(q),E.Instance.initScene($);const p=new e.AmbientLight(16777215,.8);$.add(p);const m=new e.DirectionalLight(16777215,.8);m.position.set(6,10,8),m.castShadow=!0,m.target.position.set(0,0,0),$.add(m),$.add(m.target);const f=(h=>{const p=V("arena",{Green:"#93e0a8",Yellow:c,Orange:"#687793",Red:"#42485d"}),m=(()=>{const e=V("progress",{Red:i,Green:c,Blue:s,Silver:i});return e.scale.set(.1,.1,.1),t.Instance.on("progress",t=>{e.getObjectByName("display").material=F([t.displayText],{color:u[t.bestComboType],textAlign:"left",ratio:14.75,fontSize:g[t.bestComboType]}),b.forEach(_=>{for(let n=0;n<6;n++){const r=e.getObjectByName(`progress-${_}-${n}`);if(!r)continue;let o=l;(t[_].solved||n<t[_].correctCount)&&(o=u[_]),(t[_].solved||n<t[_].correctCount)&&"color"===_&&(o=d[n]),r.material.color.set(o),r.material.emissive.set(o),r.material.needsUpdate=!0}})}),e})();p.add(m),m.position.set(-.1,.9,-.7);const f=(_=>{const n=[];let r=0;const o=[],s=new e.Group,a=V("cat",U[0]);a.scale.set(.03125,.03125,.03125);for(let t=0;t<10;t++){const t=a.clone();s.add(t),t.position.set(10*Math.random()-5,2+1*Math.random()-.5,10*Math.random()-5),t.userData.offset=60*e.MathUtils.randInt(0,1e3),t.lookAt(0,6,0),n.push(t)}return t.Instance.on("tick",()=>{if(!_.xr?.getCamera())return;const t=_.xr?.getCamera();if(t){r++;const _=(new e.Quaternion).setFromEuler(new e.Euler(0,Math.PI,0)).multiply(t.quaternion.clone());o.push(_)}n.forEach(e=>{const t=o[(e.userData.offset+r)%o.length];t&&e.quaternion.copy(t)})}),s})(h);f.name="Crowd",p.getObjectByName("floor").add(f);const y=V("cat",{Purple:"#333333",Silver:"#888888"});y.name="catMesh",y.position.set(-3,1,0),y.scale.set(.1,.1,.1),y.rotation.set(0,-Math.PI/4,0),p.attach(y);const w=y.clone(!0);w.name="catMesh2",w.position.set(3,1,0),w.rotation.set(0,Math.PI/4,0),p.attach(w);const v=(()=>{const t=V("cassette");return E.Instance.animateTransform({mesh:t,end:{rotation:new e.Euler(0,2*Math.PI-.01,0)},duration:3e3,ease:e=>e,loop:!0}),t})();p.add(v),v.position.set(0,0,-30);const x=new j;p.add(x.mesh),x.mesh.position.set(0,-1,-7);const C=(()=>{const _=new e.Group;_.name="debugScreen",_.renderOrder=1;const n=new e.PlaneGeometry(5,5);n.translate(0,-2,0);const r=F(["You win!","Thanks for playing","Created by Alex Swan"],{color:"white"}),o=new e.Mesh(n,r);return _.add(o),o.position.set(0,0,-20),o.scale.set(.1,.1,.1),o.rotation.set(-Math.PI/2,0,0),o.visible=!1,t.Instance.on("progress",t=>{t.color.solved&&t.artist.solved&&t.title.solved&&(o.userData.solved=!0,o.visible=!0,o.material.needsUpdate=!0,E.Instance.animateTransform({mesh:o,end:{position:{x:0,y:0,z:0},scaling:{x:1,y:1,z:1},rotation:new e.Euler(0,0,0)},duration:1e3}))}),_})();p.add(C),C.position.set(0,2,-1);const M=(()=>{const c=new e.Group;c.name="Runner";let l=[_,n,r,o,s,a],u=[(e,t)=>0===e||0===t,(e,t)=>1===e||1===t,(e,t)=>2===e||2===t,(e,t)=>3===e||3===t,(e,t)=>4===e||4===t,(e,t)=>5===e||5===t,(e,t)=>t+e===0||12-e-t-2==0,(e,t)=>t+e===1||12-e-t-2==1,(e,t)=>t+e===2||12-e-t-2==2,(e,t)=>t+e===3||12-e-t-2==3,(e,t)=>t+e===4||12-e-t-2==4,(e,t)=>t+e===5||12-e-t-2==5,(e,t)=>(e+t)%2==0,(e,t)=>(e+t)%2==1,(e,t)=>(e+t)%2==0,(e,t)=>(e+t)%2==1,(e,t)=>(e+t)%2==0,(e,t)=>(e+t)%2==1];for(;l.length<6;)l.push(...l);l=l.slice(0,6);let d=-2;const h=new e.BoxGeometry;h.translate(.5,.5,.5),h.scale(.9,1.1,.9);for(let t=0;t<6;t++)for(let _=0;_<6;_++){const n=new e.MeshBasicMaterial({color:i}),r=new e.Mesh(h,n);r.name=`runner-${_}-${t}`,r.userData.x=_,r.userData.y=t,r.position.set(-3+_,0,-3+t),c.attach(r)}return t.Instance.on("beat",()=>{d+=1,d<0||c.children.forEach(e=>{const{x:t,y:_}=e.userData,n=u[d%u.length](t,_)?l[d%l.length]:i;l[e.userData.index],e.material.color.set(n)})}),c})();return p.add(M),M.position.set(0,-3,-10),M.scale.set(2,1,2),p})(X);$.add(f);const C=f.getObjectByName("tableA"),M=(()=>{new e.Vector3(1,0,0);const _=new e.Group;_.name="FishSwirl";const n=[];let r=!0;const o=new e.Group,s=V("goldfish");for(let t=0;t<10;t++){const t=s.clone(!0);t.position.set(10*Math.random()-5,0,0),n.push(t),o.attach(t),t.userData.velocity=new e.Vector3(0,5+3*Math.random(),-5),t.scale.set(0,0,0)}return o.rotation.set(0,0,0),_.attach(o),t.Instance.on("tick",t=>{n.forEach(_=>{if(_.userData.velocity.y-=10*t,_.position.addScaledVector(_.userData.velocity,t),_.position.y<0){const t=new e.Vector3(4*Math.random()-2,0,4*Math.random()-2).sub(_.position).normalize(),n=new e.Quaternion;n.setFromUnitVectors(new e.Vector3(0,0,-1),t),_.quaternion.copy(n),_.position.y=0;const r=new e.Vector3(0,0,-1);r.applyQuaternion(_.quaternion),r.multiplyScalar(5),_.userData.velocity.x=r.x,_.userData.velocity.z=r.z,_.userData.velocity.y=5+6*Math.random()}const n=new e.Quaternion;n.setFromUnitVectors(new e.Vector3(0,0,-1),_.userData.velocity),_.quaternion.copy(n)})}),t.Instance.on("progress",t=>{n.forEach(_=>{t.bestComboCount>=3&&!r?(E.Instance.cancelAnimation(_),E.Instance.animateTransform({mesh:_,end:{scaling:new e.Vector3(v,v,v)},duration:2e3})):t.bestComboCount<3&&r&&(E.Instance.cancelAnimation(_),E.Instance.animateTransform({mesh:_,end:{scaling:new e.Vector3(0,0,0)},duration:1e3}))}),r=t.bestComboCount>=3}),_})();M.position.set(0,0,-10),$.attach(M),h.vinyls.forEach((t,_)=>{const n=(({color:t,artist:_,title:n})=>{const r=new e.Group,a=new e.RingGeometry(4,7,32);a.scale(v,v,v);const c=I(t,{glow:!0});r.add(new e.Mesh(a,c));const l=new e.RingGeometry(.25,4,32);l.scale(v,v,v);const u=I(16777215,{});r.add(new e.Mesh(l,u));const d=new e.PlaneGeometry(14,14);d.translate(0,0,.001),d.scale(v,v,v);const h=((t,_)=>{const[n,r]=x();r.fillStyle=i,r.strokeStyle=i,r.lineWidth=8,r.beginPath(),r.arc(512,512,20,0,2*Math.PI),r.stroke(),r.beginPath(),r.arc(512,512,288,0,2*Math.PI),r.stroke(),r.textAlign="center",t&&(r.font="64px monospace",r.textBaseline="middle",r.strokeStyle=i,r.lineWidth=8,r.strokeText(t,512,430.08),r.fillStyle=o,r.fillText(t,512,430.08)),_&&(r.font="96px monospace",r.textBaseline="bottom",r.fillStyle=s,r.strokeText(_,512,696.32),r.fillText(_,512,696.32));const a=new e.CanvasTexture(n);return a.encoding=e.LinearSRGBColorSpace,new e.MeshBasicMaterial({map:a,transparent:!0})})(_,n);r.add(new e.Mesh(d,h));const p=r.clone();return p.rotation.set(0,Math.PI,0),p.position.set(0,0,-.002),r.add(p),r})(t);n.name=`vinyl-${_}`;const r=new e.Vector3(.7,1.15,-.2-.125*_);n.position.copy(r),n.userData.originalPosition=r,n.userData.isPickable=!0,n.userData.recordIndex=_,n.userData.returnToOriginalPosition=()=>{$.attach(n),E.Instance.cancelAnimation(n),E.Instance.animateTransform({mesh:n,end:{position:n.userData.originalPosition,rotation:new e.Euler(0,0,0)},duration:100})},n.onPointerPick=t=>{if(t.userData.selected)return;h.selected[t.id]=_;const r=t.getObjectByName("target");r&&(E.Instance.cancelAnimation(n),r.attach(n),E.Instance.animateTransform({mesh:n,end:{position:new e.Vector3(0,0,0),rotation:new e.Euler(0,Math.PI/2,0)},duration:60}),t.userData.selected=n)},n.onPointerDrop=t=>{if(E.Instance.cancelAnimation(n,!0),n.getWorldPosition(new e.Vector3).distanceTo(C.getWorldPosition(new e.Vector3))<.3)return h.addVinylByIndex(n.userData.recordIndex),delete h.selected[t.id],t.userData.selected=void 0,C.children.forEach(e=>{e.userData.returnToOriginalPosition&&e.userData.returnToOriginalPosition()}),C.attach(n),k(...[1.01,,275,.01,.01,.15,1,1.03,-3.7,,-93,.07,,,,-.1,,.5,.04,.09]),void E.Instance.animateTransform({mesh:n,end:{position:new e.Vector3(0,.01,0),rotation:new e.Euler(-1*Math.PI/2,0,0)},duration:60}).then(()=>{E.Instance.animateTransform({mesh:n,end:{rotation:new e.Euler(-1*Math.PI/2,0,-2*Math.PI)},ease:e=>e,duration:1800,loop:!0})});n.userData.returnToOriginalPosition(),t.userData.selected=void 0},$.add(n)}),Q=X.xr.getController(0),Q.addEventListener("connected",ne),Q.addEventListener("selectstart",re),Q.addEventListener("selectend",oe),Q.addEventListener("squeezestart",re),Q.addEventListener("squeezeend",oe),$.add(Q),K=X.xr.getController(1),K.addEventListener("connected",ne),K.addEventListener("selectstart",re),K.addEventListener("selectend",oe),K.addEventListener("squeezestart",re),K.addEventListener("squeezeend",oe),$.add(K),H=new e.Raycaster,window.addEventListener("resize",ce,!1),t.Instance.on("comboBroken",()=>{k(...[,,143,.03,.17,.09,2,1.5,10,-17,,,,,4,,,.73,.09])}),t.Instance.on("progress",e=>{const t=Object.keys(e);for(let _=0;_<t.length;_++){const n=t[_],r=f.getObjectByName(`complete-${_}`),o=e[n].solved?u[n]:0;r&&(r.visible=!0,r.material.color.set(o),r.material.emissive.set(o),r.material.needsUpdate=!0)}}),(async()=>{const e=new S;await e.init(D),await e.generate();const t=[];for(let a=0;a<6;a++){const _=176400*a,n=_+176400,r=e.createAudioBufferRange(R,_,n);t.push(r)}const _=e.createAudioBufferRange(R,1058400,1764e3),n=[...t,_];let r=null,o=!1;const s=e=>{let t;r&&(r.stop(),r.disconnect()),t=e<6?e:6;const _=n[t];r=R.createBufferSource(),r.buffer=_,r.connect(R.destination),r.loop=!0,r.start();const a=setInterval(()=>{A!==e&&(clearInterval(a),s(A))},2e3);o=!0};s(A)})(),h.reset(),document.getElementById("intro").style.display="none",document.getElementById("c").style.display="block"};function _e(){Z=X.xr.getReferenceSpace();const t={x:-1*ee.x,y:-1*ee.y,z:-1*ee.z,w:1},_=new e.Quaternion,n=new XRRigidTransform(t,_),r=Z.getOffsetReferenceSpace(n);X.xr.setReferenceSpace(r)}function ne(_){const n=_.target,r="left"===_.data.handedness?-1:1,o=_.data.hand?0:r*Math.PI/2;if(t.Instance.emit("debug",`Hand: ${_.data.hand}`),!n.getObjectByName("target")){const t=new e.Group;t.name="target",t.rotation.set(0,0,0),t.position.set(-1*r*.035,.05,-.12),n.add(t)}let s=n.getObjectByName("paw");s||(s=V("paw"),s.position.set(0,0,.15),s.rotation.set(3*Math.PI/2,o,0),n.add(s));let a=n.getObjectByName("line");if(!a){const t=(new e.BufferGeometry).setFromPoints([new e.Vector3(0,0,0),new e.Vector3(0,0,-1)]);a=new e.Line(t),a.material.color.set(16711680),a.name="line",a.scale.z=5,n.add(a)}}function re(e){Y=e.target;const t=se(Y);if(t.length>0){let e=!1;t.forEach(({object:t,distance:_})=>{if(e)return;let n=t;for(;n;){if(n.onPointerPick){n.onPointerPick(Y),e=!0,Y.getObjectByName("line").visible=!1;break}n=n.parent}})}Y.userData.targetRayMode=e.data.targetRayMode}function oe(e){Y=e.target;const t=Y.userData.selected;t?.onPointerDrop&&t.onPointerDrop(Y),Y.getObjectByName("line").visible=!0}function se(e){return e.updateMatrixWorld(),H.setFromXRController(e),H.intersectObjects($.children,!0)}function ae(e){if("screen"===e.userData.targetRayMode)return;if(void 0!==e.userData.selected)return;const t=e.getObjectByName("line"),_=se(e);if(t&&(t.scale.z=5),_.length>0){let e=!1;_.forEach(({object:_,distance:n})=>{if(e)return;let r=_;for(;r;){if(r.userData.isPickable){t&&(t.scale.z=n),e=!0;break}r=r.parent}})}}function ie(){const e=z.getDelta();J+=e,J>=1&&(t.Instance.emit("beat"),J-=1),E.Instance.update(),t.Instance.emit("tick",e),ae(Q),ae(K),X.render($,q)}const ce=()=>{q.aspect=window.innerWidth/window.innerHeight,q.updateProjectionMatrix(),X.setSize(window.innerWidth,window.innerHeight)};window.addEventListener("DOMContentLoaded",()=>{document.getElementById("playButton").onclick=te});

import*as c from"https://js13kgames.com/2025/webxr/three.module.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))r(t);new MutationObserver(t=>{for(const a of t)if(a.type==="childList")for(const n of a.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&r(n)}).observe(document,{childList:!0,subtree:!0});function o(t){const a={};return t.integrity&&(a.integrity=t.integrity),t.referrerPolicy&&(a.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?a.credentials="include":t.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function r(t){if(t.ep)return;t.ep=!0;const a=o(t);fetch(t.href,a)}})();class N{static _instance;callbacks;constructor(){this.callbacks={}}static get Instance(){return N._instance||(N._instance=new N),N._instance}on(e,o){this.callbacks[e]=this.callbacks[e]||[],this.callbacks[e].push(o)}off(e,o){this.callbacks[e]=(this.callbacks[e]||[]).filter(r=>r!==o)}emit(e,...o){(this.callbacks[e]||[]).forEach(r=>r(...o))}_reset(){Object.keys(this.callbacks).forEach(e=>{delete this.callbacks[e]})}getCallbacks(){return this.callbacks}}const we="#e81416",ye="#ffa500",be="#faeb36",le="#79c314",H="#487de7",Le="#70369d",Ye="#1aff1a",ie="#ffffff",We="#666666",G="#000000",ne="#abb7d0",Xe="#687793",qe="#42485d",je="#93e0a8",F="#ff3b94",Be="#ffcc00",Me="#f6ff00",ve="#8ea5ff",Ze="#af3dff",Fe="#39013a",ce="#333333",He="#888888",$e={"Light Blue":"#9999ff",Yellow:"#fffb00",Orange:"#ff7300",Red:"#ff0000",Purple:"#c300ff",Blue:"#0000ff",Green:"#00ff00",Lime:"#b0ffb0",Pink:"#ff00ff",Silver:"#d3d3d3"},fe={color:we,artist:le,title:H},Ke=[we,ye,be,le,H,Le],J=["Red","Orange","Yellow","Green","Blue","Violet"],ee=["Shiny Toy Guns","B.B. King","Jack White","Black Sabbath","Faith Hill","Cliff Sheen"],te=["OFFSIDE","SHOWCASE","LOADOUT","BACKHAND","BOOKMARKS","MANPOWER"],Qe={color:J,artist:ee,title:te},Je={color:42,artist:24,title:34},et=[[0,1,2,3,4,5],[0,2,4,1,5,3],[0,3,5,1,4,2]],tt=["color","artist","title"];class ot{queue;selected;vinyls;progress;constructor(){this.queue=[],this.selected={},this.vinyls=[],this.reset(),this.progress.bestComboType="color"}addVinylByIndex(e){if(this.queue[0]===e)return;const{color:o,artist:r,title:t}=this.vinyls[e],a=J.indexOf(o),n=ee.indexOf(r),s=te.indexOf(t);a===this.progress.color.currentIndex+1?(this.progress.color.correctCount++,this.progress.color.correctCount===J.length&&(this.progress.color.solved=!0),this.progress.color.currentIndex=a):(this.progress.color.currentIndex=-1,this.progress.color.correctCount=0),n===(this.progress.artist.currentIndex+1)%ee.length?(this.progress.artist.correctCount++,this.progress.artist.correctCount===ee.length&&(this.progress.artist.solved=!0)):this.progress.artist.correctCount=1,this.progress.artist.currentIndex=n,s===(this.progress.title.currentIndex+1)%te.length?(this.progress.title.correctCount++,this.progress.title.correctCount===te.length&&(this.progress.title.solved=!0)):this.progress.title.correctCount=1,this.progress.title.currentIndex=s;const u=Math.max(this.progress.color.correctCount,this.progress.artist.correctCount,this.progress.title.correctCount);this.progress.bestComboCount<6&&u<this.progress.bestComboCount?N.Instance.emit("comboBroken",!0):N.Instance.emit("comboBroken",!1),this.progress.bestComboCount=u,this.progress.bestComboType=this.progress.color.correctCount===this.progress.bestComboCount?"color":this.progress.artist.correctCount===this.progress.bestComboCount?"artist":"title",this.queue.unshift(e),this.progress.bestComboUsedVinyls=this.queue.slice(0,this.progress.bestComboCount),console.log(`bestComboUsedVinyls=${this.progress.bestComboUsedVinyls} bestComboCount=${this.progress.bestComboCount} queue=${this.queue}`),this.progress.displayText=this.getDisplayText(),N.Instance.emit("progress",this.progress)}getVinylInQueue(e){return this.vinyls[this.queue[e]]}isSolved(e){if(e)return this.progress.color.solved&&this.progress.artist.solved&&this.progress.title.solved,this.progress[e].solved}getDisplayText(){let e=[];const{currentIndex:o,correctCount:r,solved:t}=this.progress[this.progress.bestComboType],a=Qe[this.progress.bestComboType];for(let n=0;n<r;n++){let s=o-n;s<0&&(s+=a.length),e.unshift(a[s])}return e.join("→")}reset(){this.queue=[],this.selected={};const[e,o,r]=et;this.progress={color:{currentIndex:-1,correctCount:0,solved:!1},artist:{currentIndex:-2,correctCount:0,solved:!1},title:{currentIndex:-2,correctCount:0,solved:!1},bestComboType:"color",bestComboCount:0,bestComboUsedVinyls:[],displayText:"Select a record to play → → → → →"},this.vinyls=J.map((t,a)=>({index:a,color:t,artist:"",title:""})),e.forEach((t,a)=>{this.vinyls[t].color=J[a]}),o.forEach((t,a)=>{this.vinyls[t].artist=ee[a]}),r.forEach((t,a)=>{this.vinyls[t].title=te[a]}),N.Instance.emit("progress",this.progress)}}class Q{static createButton(e,o={}){const r=document.createElement("button");function t(){let u=null;async function h(l){l.addEventListener("end",d),await e.xr.setSession(l),r.textContent="EXIT VR",u=l}function d(){u.removeEventListener("end",d),r.textContent="ENTER VR",u=null}r.style.display="block",r.removeAttribute("data-disabled"),r.textContent="ENTER VR";const f={...o,optionalFeatures:["local-floor","bounded-floor","layers",...o.optionalFeatures||[]]};r.onclick=function(){u===null?navigator.xr.requestSession("immersive-vr",f).then(h):(u.end(),navigator.xr.offerSession!==void 0&&navigator.xr.offerSession("immersive-vr",f).then(h).catch(l=>{console.warn(l)}))},navigator.xr.offerSession!==void 0&&navigator.xr.offerSession("immersive-vr",f).then(h).catch(l=>{console.warn(l)})}function a(){r.style.display="block",r.setAttribute("data-disabled","true"),r.onmouseenter=null,r.onmouseleave=null,r.onclick=null}function n(){a(),r.textContent="VR NOT SUPPORTED"}function s(u){a(),console.warn("Exception when trying to call xr.isSessionSupported",u),r.textContent="VR NOT ALLOWED"}if("xr"in navigator)return r.id="VRButton",r.style.display="none",navigator.xr.isSessionSupported("immersive-vr").then(function(u){u?t():n(),u&&Q.xrSessionIsGranted&&r.click()}).catch(s),r;{const u=document.createElement("a");return window.isSecureContext===!1?(u.href=document.location.href.replace(/^http:/,"https:"),u.innerHTML="WEBXR NEEDS HTTPS"):(u.href="https://immersiveweb.dev/",u.innerHTML="WEBXR NOT AVAILABLE"),u.className="webxr-message",u}}static registerSessionGrantedListener(){if(typeof navigator<"u"&&"xr"in navigator){if(/WebXRViewer\//i.test(navigator.userAgent))return;navigator.xr.addEventListener("sessiongranted",()=>{Q.xrSessionIsGranted=!0})}}}Q.xrSessionIsGranted=!1;Q.registerSessionGrantedListener();const _=.0254,Ae=(i=1024,e=1024)=>{const o=document.createElement("canvas");o.width=i,o.height=e;const r=o.getContext("2d");return[o,r]},xe=(i,e,o)=>{const r=new c.Vector3(1,0,0),t=new c.Euler(0,i,-Math.PI/2+e);return r.applyEuler(t).normalize().multiplyScalar(o)},p=i=>parseFloat(`${i||0}`),nt=i=>i[Math.floor(Math.random()*i.length)],K={},Ee=new c.Color,de=(i,e)=>{const o=e?.glow==!0,r=`color-${i}-${o}`;if(K[r])return K[r];const t=o?c.MeshBasicMaterial:c.MeshStandardMaterial,a=new t({color:i,side:c.FrontSide});return K[r]=a,a},De=(i,e)=>{const{color:o,bgColor:r,textAlign:t,ratio:a,fontSize:n}=e;Ee.set(o);const s=typeof o=="string"?o:`#${Ee.getHexString()}`,u=`text-${s}-${i.join("")}`;if(K[u])return K[u];const h=1024,d=a?h/a:h,[f,l]=Ae(h,d);l.textAlign=t||"center";let w=16;l.textAlign==="center"&&(w=.5*h);let g=16;i.forEach((v,b)=>{const S=n!==void 0?n:64;l.strokeStyle=G,l.font=`${S}px monospace`,l.textBaseline="top",l.lineWidth=8,l.strokeText(v,w,g+S*b),l.fillStyle=s,l.fillText(v,w,g+S*b)});const M=new c.CanvasTexture(f),m=new c.MeshBasicMaterial({map:M,transparent:!0});return K[u]=m,m},st=(i,e)=>{const[r,t]=Ae();t.fillStyle=G,t.strokeStyle=G,t.lineWidth=8,t.beginPath(),t.arc(1024/2,1024/2,20,0,2*Math.PI),t.stroke(),t.save(),t.translate(1024/2,1024/2),t.beginPath();for(var a=4.5,n=60,s=2*Math.PI/n,u=3/2*Math.PI+s;u<20*Math.PI;){var h=u*Math.cos(u)*a,d=u*Math.sin(u)*a;t.lineTo(h,d),u=u+s}t.stroke(),t.restore(),t.beginPath(),t.arc(1024/2,1024/2,288,0,2*Math.PI),t.stroke(),t.lineWidth=32,t.beginPath(),t.arc(1024/2,1024/2,496,0,2*Math.PI),t.stroke(),t.textAlign="center",i&&(t.font="64px monospace",t.textBaseline="middle",t.strokeStyle=G,t.lineWidth=8,t.strokeText(i,.5*1024,.42*1024),t.fillStyle=le,t.fillText(i,.5*1024,.42*1024)),e&&(t.font="96px monospace",t.textBaseline="bottom",t.fillStyle=H,t.strokeText(e,.5*1024,.68*1024),t.fillText(e,.5*1024,.68*1024));const f=new c.CanvasTexture(r);return f.encoding=c.LinearSRGBColorSpace,new c.MeshBasicMaterial({map:f,transparent:!0})},rt=({color:i,artist:e,title:o})=>{const r=new c.Group,t=new c.RingGeometry(4,7,32);t.translate(0,0,-.001),t.scale(_,_,_);const a=de(i,{glow:!0});r.add(new c.Mesh(t,a));const n=new c.RingGeometry(.25,4,32);n.scale(_,_,_),n.translate(0,0,-.001);const s=de(new c.Color(ie),{});r.add(new c.Mesh(n,s));const u=new c.PlaneGeometry(14.2,14.2);u.translate(0,0,.102),u.scale(_,_,_);const h=st(e,o);r.add(new c.Mesh(u,h));const d=r.clone();d.rotation.set(0,Math.PI,0),r.add(d);const f=new c.RingGeometry(7,7.5,32);f.scale(_,_,_);const l=de(ie,{glow:!0});l.emissiveIntensity=1;const w=new c.Mesh(f,l);w.visible=!1,w.name="highlight",r.add(w);const g=w.clone();return g.name="combo",g.material=g.material.clone(),r.add(g),N.Instance.on("progress",M=>{g.visible=M.bestComboUsedVinyls.includes(r.userData.recordIndex),g.material.color.set(fe[M.bestComboType]),g.material.needsUpdate=!0}),r},at=i=>i*i,it=i=>i<.5?4*i*i*i:1-Math.pow(-2*i+2,3)/2,ct=i=>.5*Math.cos(2*i*Math.PI+Math.PI)+.5;class O{static _instance;animations;scene;clock;constructor(){this.animations=[],this.scene=null,this.clock=new c.Clock}static get Instance(){return O._instance||(O._instance=new O),O._instance}initScene(e){this.scene||(this.scene=e,this.clock.start())}update(){const e=this.clock.getElapsedTime()*1e3;this.animations=this.animations.filter(o=>{const{mesh:r,start:t,end:a,easeFunc:n,loop:s}=o,u=e-o.startTime,h=o.endTime-o.startTime,d=c.MathUtils.clamp(u/h,0,1);if(a.position&&r.position.lerpVectors(t.position,a.position,n(d)),a.rotation){const f=t.rotation,l=a.rotation,w=new c.Euler;w.order=f.order||c.Euler.DefaultOrder,w.x=f.x+(l.x-f.x)*n(d),w.y=f.y+(l.y-f.y)*n(d),w.z=f.z+(l.z-f.z)*n(d),r.rotation.copy(w)}return a.scaling&&r.scale.lerpVectors(t.scaling,a.scaling,n(d)),e>=o.endTime?s?(o.startTime=e,o.endTime=e+h,a.position&&r.position.copy(t.position),a.rotation&&r.rotation.copy(t.rotation),a.scaling&&r.scale.copy(t.scaling),!0):(o.resolve&&(o.resolve(),o.resolve=void 0,o.reject=void 0),!1):!0})}animateTransform(e){const{mesh:o,end:r}=e,t=e.duration||1e3,a=e.delay||0,n=e.ease||at,s=this.clock.getElapsedTime()*1e3;let u,h;const d=new Promise((f,l)=>{u=f,h=l});return this.animations.push({mesh:o,start:{position:o.position.clone(),rotation:o.rotation.clone(),scaling:o.scale.clone()},end:r,easeFunc:n,startTime:s+a,endTime:s+a+t,loop:e.loop||!1,resolve:u,reject:h}),d}cancelAnimation(e,o=!1){const r=this.animations.filter(t=>t.mesh===e);r.length&&(r.forEach(t=>{const{end:a}=t;o&&(a.position&&e.position.copy(a.position),a.rotation&&e.rotation.copy(a.rotation),a.scaling&&e.scale.copy(a.scaling)),t.reject&&(t.reject(),t.resolve=void 0,t.reject=void 0)}),this.animations=this.animations.filter(t=>t.mesh!==e))}}class lt{constructor(){this.mOscillators=[this.osc_sin.bind(this),this.osc_square.bind(this),this.osc_saw.bind(this),this.osc_tri.bind(this)],this.mSong=null,this.mLastRow=0,this.mCurrentCol=0,this.mNumWords=0,this.mMixBuf=null}osc_sin(e){return Math.sin(e*6.283184)}osc_saw(e){return 2*(e%1)-1}osc_square(e){return e%1<.5?1:-1}osc_tri(e){var o=e%1*4;return o<2?o-1:3-o}getnotefreq(e){return .003959503758*2**((e-128)/12)}createNote(e,o,r){var t=this.mOscillators[e.i[0]],a=e.i[1],n=e.i[3]/32,s=this.mOscillators[e.i[4]],u=e.i[5],h=e.i[8]/32,d=e.i[9],f=e.i[10]*e.i[10]*4,l=e.i[11]*e.i[11]*4,w=e.i[12]*e.i[12]*4,g=1/w,M=-e.i[13]/16,m=e.i[14],v=r*2**(2-e.i[15]),b=new Int32Array(f+l+w),S=0,y=0,E,I,C,T,P,L;for(E=0,I=0;E<f+l+w;E++,I++)I>=0&&(m=m>>8|(m&255)<<4,I-=v,P=this.getnotefreq(o+(m&15)+e.i[2]-128),L=this.getnotefreq(o+(m&15)+e.i[6]-128)*(1+8e-4*e.i[7])),C=1,E<f?C=E/f:E>=f+l&&(C=(E-f-l)*g,C=(1-C)*3**(M*C)),S+=P*C**n,T=t(S)*a,y+=L*C**h,T+=s(y)*u,d&&(T+=(2*Math.random()-1)*d),b[E]=80*T*C|0;return b}async init(e){return new Promise(o=>{this.mSong=e,this.mLastRow=e.endPattern,this.mCurrentCol=0,this.mNumWords=e.rowLen*e.patternLen*(this.mLastRow+1)*2,this.mMixBuf=new Int32Array(this.mNumWords),o()})}generateChannel(e){return new Promise(o=>{var r,t,a,n,s,u,h,d,f,l,w,g,M=new Int32Array(this.mNumWords),m=this.mSong.songData[e],v=this.mSong.rowLen,b=this.mSong.patternLen,S=0,y=0,E,I,C=!1,T=[];for(a=0;a<=this.mLastRow;++a)for(h=m.p[a],n=0;n<b;++n){var P=h?m.c[h-1].f[n]:0;P&&(m.i[P-1]=m.c[h-1].f[n+b]||0,P<17&&(T=[]));var L=this.mOscillators[m.i[16]],x=m.i[17]/512,R=2**(m.i[18]-9)/v,B=m.i[19],$=m.i[20],U=m.i[21]*43.23529*3.141592/44100,V=1-m.i[22]/255,z=m.i[23]*1e-5,ze=m.i[24]/32,_e=m.i[25]/512,Ve=6.283184*2**(m.i[26]-9)/v,Se=m.i[27]/255,ue=m.i[28]*v&-2;for(w=(a*b+n)*v,s=0;s<4;++s)if(u=h?m.c[h-1].n[n+s*b]:0,u){T[u]||(T[u]=this.createNote(m,u,v));var Ce=T[u];for(t=0,r=w*2;t<Ce.length;t++,r+=2)M[r]+=Ce[t]}for(t=0;t<v;t++)d=(w+t)*2,l=M[d],l||C?(g=U,B&&(g*=L(R*d)*x+.5),g=1.5*Math.sin(g),S+=g*y,E=V*(l-y)-S,y+=g*E,l=$==3?y:$==1?E:S,z&&(l*=z,l=l<1?l>-1?this.osc_sin(l*.25):-1:1,l/=z),l*=ze,C=l*l>1e-5,f=Math.sin(Ve*d)*_e+.5,I=l*(1-f),l*=f):I=0,d>=ue&&(I+=M[d-ue+1]*Se,l+=M[d-ue]*Se),M[d]=I|0,M[d+1]=l|0,this.mMixBuf[d]+=I|0,this.mMixBuf[d+1]+=l|0}o()})}async generate(){this.mMixBuf.fill(0),this.mCurrentCol=0;const e=[];for(let o=0;o<this.mSong.numChannels;o++)e.push(this.generateChannel(o));return await Promise.all(e),this.mCurrentCol=this.mSong.numChannels,1}createAudioBuffer(e){for(var o=e.createBuffer(2,this.mNumWords/2,44100),r=0;r<2;r++)for(var t=o.getChannelData(r),a=r;a<this.mNumWords;a+=2)t[a>>1]=this.mMixBuf[a]/65536;return o}createAudioBufferRange(e,o=0,r=null){(r===null||r>this.mNumWords/2)&&(r=this.mNumWords/2),o<0&&(o=0),o>=r&&(o=r-1);const t=r-o;for(var a=e.createBuffer(2,t,44100),n=0;n<2;n++)for(var s=a.getChannelData(n),u=0;u<t;u++){var h=(o+u)*2+n;s[u]=this.mMixBuf[h]/65536}return a}createWave(){var e=44,o=e+this.mNumWords*2-8,r=o-36,t=new Uint8Array(e+this.mNumWords*2);t.set([82,73,70,70,o&255,o>>8&255,o>>16&255,o>>24&255,87,65,86,69,102,109,116,32,16,0,0,0,1,0,2,0,68,172,0,0,16,177,2,0,4,0,16,0,100,97,116,97,r&255,r>>8&255,r>>16&255,r>>24&255]);for(var a=0,n=e;a<this.mNumWords;++a){var s=this.mMixBuf[a];s=s<-32767?-32767:s>32767?32767:s,t[n++]=s&255,t[n++]=s>>8&255}return t}createWaveRange(e=0,o=null){(o===null||o>this.mNumWords/2)&&(o=this.mNumWords/2),e<0&&(e=0),e>=o&&(e=o-1);const r=o-e;var t=44,a=t+r*2-8,n=a-36,s=new Uint8Array(t+r*2);s.set([82,73,70,70,a&255,a>>8&255,a>>16&255,a>>24&255,87,65,86,69,102,109,116,32,16,0,0,0,1,0,2,0,68,172,0,0,16,177,2,0,4,0,16,0,100,97,116,97,n&255,n>>8&255,n>>16&255,n>>24&255]);for(var u=0,h=t;u<r;++u){var d=this.mMixBuf[(e+u)*2];d=d<-32767?-32767:d>32767?32767:d,s[h++]=d&255,s[h++]=d>>8&255}return s}getData(e,o){for(var r=2*Math.floor(e*44100),t=new Array(o),a=0;a<2*o;a+=1){var n=r+a;t[a]=e>0&&n<this.mMixBuf.length?this.mMixBuf[n]/32768:0}return t}}const ut=.3,k=44100,he=new(window.AudioContext||window.webkitAudioContext),dt=(i=1,e=.05,o=220,r=0,t=0,a=.1,n=0,s=1,u=0,h=0,d=0,f=0,l=0,w=0,g=0,M=0,m=0,v=1,b=0,S=0)=>{let y=2*Math.PI,E=u*=500*y/k**2,I=(0<g?1:-1)*y/4,C=o*=(1+2*e*Math.random()-e)*y/k,T=[],P=0,L=0,x=0,R=1,B=0,$=0,U=0,V,z;for(r=99+k*r,b*=k,t*=k,a*=k,m*=k,h*=500*y/k**3,g*=y/k,d*=y/k,f*=k,l=k*l|0,z=r+b+t+a+m|0;x<z;T[x++]=U)++$%(100*M|0)||(U=n?1<n?2<n?3<n?Math.sin((P%y)**3):Math.max(Math.min(Math.tan(P),1),-1):1-(2*P/y%2+2)%2:1-4*Math.abs(Math.round(P/y)-P/y):Math.sin(P),U=(l?1-S+S*Math.sin(2*Math.PI*x/l):1)*(0<U?1:-1)*Math.abs(U)**s*i*ut*(x<r?x/r:x<r+b?1-(x-r)/b*(1-v):x<r+b+t?v:x<z-m?(z-x-m)/a*v:0),U=m?U/2+(m>x?0:(x<z-m?1:(z-x)/m)*T[x-m|0]/2):U),V=(o+=u+=h)*Math.sin(L*g-I),P+=V-V*w*(1-1e9*(Math.sin(x)+1)%2),L+=V-V*w*(1-1e9*(Math.sin(x)**2+1)%2),R&&++R>f&&(o+=d,C+=d,R=0),!l||++B%l||(o=C,u=E,R=R||1);return T},ht=(...i)=>{let e=he.createBufferSource(),o=he.createBuffer(i.length,i[0].length,k);return i.map((r,t)=>o.getChannelData(t).set(r)),e.buffer=o,e.connect(he.destination),e.start(),e},ke=(...i)=>ht(dt(...i));var mt={songData:[{i:[0,255,116,85,0,255,116,0,37,14,4,6,73,99,0,0,0,0,0,0,2,136,15,0,32,0,0,0,6],p:[1,1,1,2,,,1,1,2,2],c:[{n:[139,,,,139,,,,139,,,,139,,,,139,,,,139,,,,139,,139,,139,,139],f:[]},{n:[140,,140,,,,140,,,,140,,140,,140,,,,140,,140,,,,140,,140,,,,140],f:[]}]},{i:[0,160,128,64,0,160,128,0,64,210,4,7,52,85,0,0,0,60,4,1,2,255,0,0,32,61,5,0,6],p:[,1,2,1,2,1,2,1,1,1],c:[{n:[,,,,139,,,,,,,,139,,,,,,,,139,,,,,,,,139,,139],f:[]},{n:[,,,,,,,,,,,,139,,139,,,,,,,,,,,,,,139,,139],f:[]}]},{i:[0,255,106,64,0,255,106,0,64,0,5,7,164,0,0,0,0,0,0,0,2,255,0,2,32,83,5,25,1],p:[,,,,1,,2,1,1,2],c:[{n:[144,,,,,,,,,,,,,,,,144],f:[]},{n:[,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,156,,,,,,,,,,,,,,,,156],f:[]}]},{i:[0,91,128,0,0,95,128,12,0,0,12,0,72,0,0,0,0,0,0,0,2,255,0,0,32,83,3,130,4],p:[,,,,1,1,1,1,2,2],c:[{n:[132,,,,,,,,132,,,,,,,,144,,,,,,,,144],f:[]},{n:[],f:[]}]},{i:[1,192,128,0,1,191,116,9,0,0,6,22,34,0,0,0,0,69,3,1,1,23,167,0,32,77,6,25,6],p:[,,2,1,,2,1,2,2,1],c:[{n:[144,,,,144,,,,144,,,,142,,142,,144,,144,,144,,,,144,,,,144,,,,147,,,,151,,,,147,,,,149,,149,,147,,147,,151,,,,147,,,,147,,,,151,,,,154,,,,151,,,,151,,151,,151,,151,,154,,,,151,,,,151],f:[]},{n:[144,144,144,,144,,,,,,,,,,,,,,,,,,,,,,,,,,,,147,147,147,,147,,,,,,,,,,,,,,,,,,,,,,,,,,,,151,151,151,,151],f:[]}]}],rowLen:5513,patternLen:32,endPattern:9,numChannels:5};const se=new AudioContext;let Z=0;N.Instance.on("progress",i=>{const e=i.bestComboCount||0;Z=Math.min(e,6)});const Ge=()=>ke(void 0,void 0,143,.03,.17,.09,2,1.5,10,-17,void 0,void 0,void 0,void 0,4,void 0,void 0,.73,.09),ft=()=>ke(void 0,0,void 0,void 0,.07,.12,void 0,3.4,void 0,void 0,109,.07,void 0,void 0,void 0,void 0,void 0,.6,.05,void 0,-1428),pt=async()=>{const i=new lt;await i.init(mt),await i.generate();const e=[];for(let d=0;d<6;d++){const f=d*176400,l=f+176400,w=i.createAudioBufferRange(se,f,l);e.push(w)}const o=6*176400,r=o+705600,t=i.createAudioBufferRange(se,o,r),a=[...e,t];let n=null,s=!1;const u=d=>{n&&(n.stop(),n.disconnect());let f;d<6?f=d:f=6;const l=a[f];n=se.createBufferSource(),n.buffer=l,n.connect(se.destination),n.loop=!0,n.start();const w=setInterval(()=>{N.Instance.emit("downbeat"),Z!==d&&(console.log("Sequence change detected:",d,"→",Z),clearInterval(w),u(Z))},2e3);s=!0};return u(Z),{source:n,stop:()=>{s=!1,n&&(n.stop(),n.disconnect(),n=null)},playSequence:d=>{Z=d,u(d)},getCurrentSequence:()=>Z,isPlaying:()=>s}},Ie=["Light Blue","Yellow","Orange","Red","Purple","Blue","Green","Lime","Pink","Silver"],gt=i=>{const[e,o,r,t,a,n,s,u,h,d,f,l,w,g,M]=i.split(","),m=p(r),v=p(t),b=p(a),S=p(n),y=p(s),E=p(u),I=p(l),C=p(w),T=p(g),P=p(h),L=p(d),x=p(f),R=Math.sqrt(m*m+m*m)/2,B=new c.CylinderGeometry(0,R,v,4,1,!1,Math.PI/4);return B.scale(1,1,b/m),B.translate(S-I,y-C+.3*v,E-T),B.rotateX(c.MathUtils.degToRad(P)),B.rotateY(c.MathUtils.degToRad(L)),B.rotateZ(c.MathUtils.degToRad(x)),B},wt=i=>{const[e,o,r,t,a,n,s,u,h,d,f,l,w,g,M]=i.split(","),m=p(r),v=p(t),b=p(a),S=p(n),y=p(s),E=p(u),I=p(l),C=p(w),T=p(g),P=p(h),L=p(d),x=p(f),R=new c.BoxGeometry(m,v,b);return R.translate(S-I,y-C,E-T),R.rotateX(c.MathUtils.degToRad(P)),R.rotateY(c.MathUtils.degToRad(L)),R.rotateZ(c.MathUtils.degToRad(x)),R.computeBoundingBox(),R},yt=i=>{const[e,o,r,t,a,n,s,u,h,d,f,l,w,g,M]=i.split(","),m=p(r),v=p(t),b=p(a),S=p(n),y=p(s),E=p(u),I=p(l),C=p(w),T=p(g),P=p(h),L=p(d),x=p(f),R=new c.SphereGeometry(m/2,32,16);return R.scale(m/m,v/m,b/m),R.translate(S-I,y-C,E-T),R.rotateX(c.MathUtils.degToRad(P)),R.rotateY(c.MathUtils.degToRad(L)),R.rotateZ(c.MathUtils.degToRad(x)),R},bt=i=>{const[e,o,r,t,a,n,s,u,h,d,f,l,w,g,M]=i.split(","),m=p(r),v=p(t),b=p(n),S=p(s),y=p(u),E=p(l),I=p(w),C=p(g),T=p(h),P=p(d),L=p(f),x=new c.PlaneGeometry(m,v);return x.rotateX(c.MathUtils.degToRad(-90)),x.translate(b-E,S-I,y-C),x.rotateX(c.MathUtils.degToRad(T)),x.rotateY(c.MathUtils.degToRad(P)),x.rotateZ(c.MathUtils.degToRad(L)),x.computeBoundingBox(),x},Mt=i=>{const[e,o,r,t,a,n,s,u,h,d,f,l,w,g,M]=i.split(","),m=p(r),v=p(t),b=p(a),S=p(n),y=p(s),E=p(u),I=p(l),C=p(w),T=p(g),P=p(h),L=p(d),x=p(f),R=m/2,B=new c.CylinderGeometry(R,R,v,32);B.translate(S-I,y-C,E-T),B.scale(1,1,b/m);const $=c.MathUtils.degToRad(P),U=c.MathUtils.degToRad(L),V=c.MathUtils.degToRad(x),z=new c.Euler($,U,V);return B.applyQuaternion(new c.Quaternion().setFromEuler(z)),B.computeBoundingBox(),B},vt=i=>{const[e]=i.split(",");switch(e){case"c":return wt(i);case"s":return yt(i);case"p":return bt(i);case"cy":return Mt(i);case"py":return gt(i);default:throw new Error(`Unknown shape: ${e}`)}},j=(i,e)=>{const{palette:o={},glow:r=!1}=e,t=new c.Group;t.position.set(0,0,0),t.rotation.set(0,0,0),t.scale.set(1,1,1);const a={...$e,...o};return i.forEach(n=>{if(n===null){console.error("ITEM IS NULL");return}if(Array.isArray(n))t.add(j(n,{palette:a,glow:r}));else{const[s,u,h,d,f,l,w,g,M,m,v,b,S,y,E]=n.split(","),I=vt(n);let C=new c.MeshStandardMaterial({color:a[Ie[E]],side:c.DoubleSide});r&&(C.emissive=new c.Color(a[Ie[E]]),C.emissiveIntensity=1);const T=new c.Mesh(I,C);T.name=u,T.position.set(b,S,y),t.add(T)}}),t},St=()=>[["c,desk,2,0.1,1,,0.85,-0.5,,,,,-0.1,,6","c,leg,0.1,0.8,0.1,-0.85,0.4,-0.85,,,,0.1,,-0.9,6","c,leg,0.1,0.8,0.1,-0.85,0.4,-0.15,,,,0.1,,-0.2,6","c,leg,0.1,0.8,0.1,0.85,0.4,-0.15,,,,1.8,,-0.2,6","c,leg,0.1,0.8,0.1,0.85,0.4,-0.85,,,,1.8,,-0.9,6","c,record-rack,0.4,0.1,0.8,0.7,0.95,-0.5,,,,0.7,0.95,-0.5,0","c,cube,0.3,0.1,0.4,-0.75,0.95,-0.3,,,,-0.75,0.95,-0.3,9","c,cube,0.4,0.1,0.4,-0.3,0.95,-0.3,,,,-0.3,0.95,-0.3,9","c,tableA,0.4,0.1,0.4,0.2,0.95,-0.3,,,,0.2,1.01,-0.3,0","cy,pad,0.4,0.02,0.4,0.2,1,-0.3,,,,0.2,1,-0.3,3"],"c,cube,22,1,4,,-1.5,-23,,,,,-2,-15,2","c,floor,20,1,20,,-2.5,-11,,,,,-3,-4,3","c,cube,20,1,6,,-2.5,2,,,,,-3,5,3","c,cube,8,2,3,,-1,0.5,,,,,-1,-4,2","c,pillar,1,4,1,6.5,,-6.5,,,,7,,-7,6","c,pillar,1,4,1,6.5,,-10.5,,,,7,,-11,6","c,pillar,1,3,1,6.5,0.5,-14.5,,,,7,,-15,6","c,pillar,1,4,1,6.5,,-18.5,,,,7,,-19,6","c,pillar,1,4,1,6.5,,-14.5,,,,7,,-15,6","c,pillar,1,4,1,-6.5,,-6.5,,,,-6,,-7,6","c,pillar,1,4,1,-6.5,,-2.5,,,,-6,,-3,6","c,pillar,1,4,1,6.5,,-2.5,,,,7,,-3,6","c,pillar,1,4,1,-6.5,,-10.5,,,,-6,,-11,6","c,pillar,1,4,1,-6.5,,-14.5,,,,-6,,-15,6","c,pillar,1,4,1,-6.5,,-18.5,,,,-6,,-19,6","c,cube,4,1,20,8,2.5,-11,,,,7,2,-3,1","c,cube,4,1,20,-8,2.5,-11,,,,-9,2,-3,1"],Ct=()=>["s,head,20,16,16,,8,,,,,,8,,4","s,head,16,16,16,,-5,,,,,,-5,,4",["cy,leftEye,4,1,4,-3,10,-7.1,-71,-5,16,-3,10,-7.1,1","s,leftPupil,2,2,4,-2.8,10.1,-7,-75,7,10,-2.8,10.1,-7,4","cy,rightEye,4,1,4,3,10,-7.2,-71,5,-17,3,10,-7.2,1","s,rightPupil,2,2,4,2.9,10,-7.1,-74,-4,-12,2.9,10,-7.1,4"],["c,rightCheek,4,4,2,1.84,6.03,-7.5,-25,,80,2.34,6.53,-7.5,9","c,leftCheek,4,4,2,-2.91,5.98,-7.5,,23,10,-2.41,6.48,-7.5,9","c,tongue,2,2,2,,5,-7,,,,,4,-7,3","py,pyramid,3,1.6,1,,8.2,-8,-180,,,,8.2,-8,8"],["py,ear,6,7,4,-4.86,13.55,-1.28,-14,20,31,-4.86,13.55,-1.28,4","py,ear,6,7,4,5.14,13.55,-1.28,-11,-15,-33,5.14,13.55,-1.28,4","py,ear,5.2,6.2,3.4,5.14,13.15,-1.78,-9,-16,-33,5.14,13.15,-1.78,1","py,ear,5,5.5,3.8,-5.04,13.54,-1.59,-17,19,32,-5.04,13.54,-1.59,1"],["cy,cylinder,0.2,11,0.2,-7.93,6,-10.12,,-15,90,-7.93,6,-10.12,9","cy,cylinder,0.2,9.2,0.2,-6.87,7.72,-9,,-15,75,-6.87,7.72,-9,9","cy,cylinder,0.2,9,0.2,-7.07,3.78,-9.3,,-15,105,-7.07,3.78,-9.3,9","cy,cylinder,0.2,7.8,0.2,6.87,7.62,-8.9,180,-15,-105,6.87,7.62,-8.9,9","cy,cylinder,0.2,9.4,0.2,6.93,6,-9.52,,-165,90,6.93,6,-9.52,9","cy,cylinder,0.2,8.8,0.2,6.87,3.88,-9.1,180,-15,-75,6.87,3.88,-9.1,9"]],xt=[{Purple:ce,Silver:He,Yellow:ne,Red:F},{Purple:ye,Silver:be,Yellow:Ye,Red:F},{Purple:We,Silver:ne,Yellow:Me,Red:F}],Et=i=>{const e=new c.Group;e.name="Crowd";const o=new c.Object3D,r=8,t=10,a=new c.BoxGeometry(.5,.5,.5),n=new c.MeshStandardMaterial,s=new c.InstancedMesh(a,n,r*t);s.instanceMatrix.setUsage(c.DynamicDrawUsage);const u=new c.BoxGeometry(.2,.2,.6),h=new c.MeshStandardMaterial,d=new c.InstancedMesh(u,h,r*t*2);d.instanceMatrix.setUsage(c.DynamicDrawUsage);const f=new c.Color,l=new c.Color;e.add(s),e.add(d);const w=new c.Vector3(0,-1,0),g=[],M=[];for(let m=0;m<r;m++)for(let v=0;v<t;v++){const b=v+m*r,S=nt(xt),y=new c.Vector3(2*v-t+.5+m%2*1,0,2*m-r+.5);Math.abs(y.x)>=5&&(y.y+=5);const E=new c.Vector3(c.MathUtils.randFloatSpread(.3),c.MathUtils.randFloatSpread(.1),c.MathUtils.randFloatSpread(.3));y.add(E),o.position.copy(y).add(w),o.lookAt(0,6,0),o.updateMatrix(),s.setMatrixAt(b,o.matrix),f.setStyle(S.Purple),s.setColorAt(b,f);for(let I=0;I<2;I++){const C=b*2+I;o.position.copy(y),o.updateMatrix(),d.setMatrixAt(C,o.matrix),l.setStyle(S.Purple),d.setColorAt(C,l)}g.push({positionOffset:y,poseDelay:c.MathUtils.randInt(0,15),palette:S})}return N.Instance.on("tick",()=>{if(!i.xr?.getCamera())return;const m=i.xr?.getCamera(),v={controllers:[]};if([0,1].forEach(b=>{const S=i.xr?.getController(b);if(S){const y=S.getObjectByName("paw");y&&v.controllers.push(y.matrixWorld.clone())}}),m&&(v.camera=m.matrix.clone(),M.push(v),M.length>60&&M.shift()),M.length==0){s.visible=!1,d.visible=!1;return}g.forEach((b,S)=>{const y=M[Math.max(0,M.length-1-b.poseDelay)];y?.camera&&(o.matrix.copy(y.camera),o.matrix.decompose(o.position,o.quaternion,o.scale),o.position.add(b.positionOffset).add(w),o.updateMatrix(),s.setMatrixAt(S,o.matrix),y.controllers.forEach((E,I)=>{const C=S*2+I;o.matrix.copy(E),o.matrix.decompose(o.position,o.quaternion,o.scale),o.position.add(b.positionOffset).add(w),o.position.add(new c.Vector3(I===0?-.1:.1,.2,-.3)),o.updateMatrix(),d.setMatrixAt(C,o.matrix)}))}),s.instanceMatrix.needsUpdate=!0,d.instanceMatrix.needsUpdate=!0}),e},It=()=>[["c,case1,1,8,2,7.5,7,,,,,7.5,7,,5","c,case2,3,9,2,5.5,7.5,,,,,5.5,7.5,,5","c,case3,8,4,2,,10,,,,,,11.5,,5","c,case4,8,1,2,,5.5,,,,,,5.5,,5","c,case5,3,9,2,-5.5,7.5,,,,,-5.5,7.5,,5","c,case6,1,8,2,-7.5,7,,,,,-7.5,7,,5"],"c,base,12,2.1,2.8,,3.95,,,,,,3,,3","c,rightReel,2,2,1,2.72,6.89,,,,-45,2.72,6.89,,2","c,rightTape,4,4,0.2,2.81,6.91,-0.1,,,-45,2.81,6.91,-0.1,4","c,leftReel,2,2,1,-2.69,6.91,,,,-45,-2.75,7,,2","cy,base,16,8,16,,-4,,,,,,-4,,6","c,label,12,2,2.2,,10,,,,,,9,1,9"],Nt=()=>{const i=j(It(),{palette:{Blue:Be,Silver:Me,Red:F,Orange:ne,Purple:Fe,Green:H},glow:!0});return O.Instance.animateTransform({mesh:i,end:{rotation:new c.Euler(0,2*Math.PI-.01,0)},duration:16e3,ease:e=>e,loop:!0}),i},Tt=()=>["cy,lid,3.9,0.1,3.9,-0.27,2.1,,,,30,-0.27,2.1,,9","cy,label,4,0.8,4,,0.5,,,,,,0.5,,5","cy,can,3.9,1,3.9,,0.5,,,,,,0.5,,9","cy,tuna,3.8,0.6,3.8,,0.8,,,,,,0.8,,8"],Rt=()=>{const i=j(Tt(),{palette:{Blue:ve,Red:F,Silver:ie}});return i.scale.set(.03125,.03125,.03125),i.userData.isPickable=!0,i.onPointerPick=e=>{Ge()},i};class Pt{clock;parent;_mesh;geometry;constructor(){this.clock=new c.Clock,this.parent=new c.Group,this.parent.name="Grid",this.geometry=new c.PlaneGeometry(20,26,20,26),this.geometry.rotateX(Math.PI/2),this._mesh=new c.Mesh(this.geometry,new c.MeshBasicMaterial({color:"#ff00ff",wireframe:!0})),this.parent.add(this._mesh),N.Instance.on("tick",e=>{const o=this.geometry.getAttribute("position");for(let r=0;r<o.array.length;r+=3){const t=o.array[r],a=o.array[r+2];o.array[r+1]=.5*Math.sin(Math.sqrt(t*t+a*a)-2*this.clock.getElapsedTime())}o.needsUpdate=!0}),N.Instance.on("progress",e=>{!this._mesh.material.visible&&e.bestComboCount>5&&(this._mesh.position.set(0,-5,0),O.Instance.animateTransform({mesh:this._mesh,end:{position:new c.Vector3(0,0,0)},ease:it,duration:2e3})),this._mesh.material.visible=e.bestComboCount>5})}get mesh(){return this.parent}}const Ot=()=>{const i=new c.Group;i.name="debugScreen",i.renderOrder=1;const e=["You win!","Thanks for playing","Created by Alex Swan"],o=new c.PlaneGeometry(5,5);o.translate(0,-2,0);const r=De(e,{color:"white"}),t=new c.Mesh(o,r);return i.add(t),t.position.set(0,0,-20),t.scale.set(.1,.1,.1),t.rotation.set(-Math.PI/2,0,0),t.visible=!1,N.Instance.on("progress",a=>{a.color.solved&&a.artist.solved&&a.title.solved&&(console.log("time to show"),t.userData.solved=!0,t.visible=!0,t.material.needsUpdate=!0,O.Instance.animateTransform({mesh:t,end:{position:{x:0,y:0,z:0},scaling:{x:1,y:1,z:1},rotation:new c.Euler(0,0,0)},duration:1e3}))}),i},Lt=()=>["c,base,13,1,3,-1.5,0.5,-0.5,,,,,,,5",["c,panel,12.4,2.7,1,-1.5,2.45,0.3,-60,,,-1.5,1.1,0.88,6","c,display-back,11.8,0.8,0.1,-1.5,3.2,0.85,-60,,,-1.5,1.1,0.88,3","c,progress-color-0,1.8,0.3,0.1,-6.5,2.45,0.85,-60,,,-11.5,1.1,0.88,9","c,progress-color-1,1.8,0.3,0.1,-4.5,2.45,0.85,-60,,,0.5,1.1,0.88,9","c,progress-color-2,1.8,0.3,0.1,-2.5,2.45,0.85,-60,,,0.5,1.1,0.88,9","c,progress-color-3,1.8,0.3,0.1,-0.5,2.45,0.85,-60,,,0.5,1.1,0.88,9","c,progress-color-4,1.8,0.3,0.1,1.5,2.45,0.85,-60,,,0.5,1.1,0.88,9","c,progress-color-5,1.8,0.3,0.1,3.5,2.45,0.85,-60,,,0.5,1.1,0.88,9","c,progress-artist-1,1.8,0.3,0.1,-4.5,1.95,0.85,-60,,,0.5,1.1,0.88,9","c,progress-artist-2,1.8,0.3,0.1,-2.5,1.95,0.85,-60,,,0.5,1.1,0.88,9","c,progress-artist-3,1.8,0.3,0.1,-0.5,1.95,0.85,-60,,,0.5,1.1,0.88,9","c,progress-artist-4,1.8,0.3,0.1,1.5,1.95,0.85,-60,,,0.5,1.1,0.88,9","c,progress-artist-5,1.8,0.3,0.1,3.5,1.95,0.85,-60,,,0.5,1.1,0.88,9","c,progress-artist-0,1.8,0.3,0.1,-6.5,1.95,0.85,-60,,,-11.5,1.1,0.88,9","c,progress-title-1,1.8,0.3,0.1,-4.5,1.45,0.85,-60,,,0.5,1.1,0.88,9","c,progress-title-2,1.8,0.3,0.1,-2.5,1.45,0.85,-60,,,0.5,1.1,0.88,9","c,progress-title-3,1.8,0.3,0.1,-0.5,1.45,0.85,-60,,,0.5,1.1,0.88,9","c,progress-title-4,1.8,0.3,0.1,1.5,1.45,0.85,-60,,,0.5,1.1,0.88,9","c,progress-title-5,1.8,0.3,0.1,3.5,1.45,0.85,-60,,,0.5,1.1,0.88,9","c,progress-title-0,1.8,0.3,0.1,-6.5,1.45,0.85,-60,,,-11.5,1.1,0.88,9","p,display,11.8,0.8,,-1.5,2.22,-0.88,30,,,-1.5,2.22,-0.88,8"]],Bt=()=>{const i=j(Lt(),{palette:{Red:G,Green:ne,Blue:H,Silver:G}});return i.scale.set(.1,.1,.1),N.Instance.on("progress",e=>{console.log(e);const o=i.getObjectByName("display");o.material=De([e.displayText],{color:fe[e.bestComboType],textAlign:"left",ratio:11.8/.8,fontSize:Je[e.bestComboType]}),tt.forEach(r=>{for(let t=0;t<6;t++){const a=i.getObjectByName(`progress-${r}-${t}`);if(!a)continue;let n=ce;(e[r].solved||t<e[r].correctCount)&&(n=fe[r]),(e[r].solved||t<e[r].correctCount)&&r==="color"&&(n=Ke[t]);const s=n!==ce;a.material.color.set(n),a.material.emissive.set(s?n:G),a.material.emissiveIntensity=s?1:0,a.material.needsUpdate=!0}})}),i},At=i=>{const e=new c.Group;e.name="Runner";let o=[we,ye,be,le,H,Le],r=[(n,s)=>n===0||s===0,(n,s)=>n===1||s===1,(n,s)=>n===2||s===2,(n,s)=>n===3||s===3,(n,s)=>n===4||s===4,(n,s)=>n===5||s===5,(n,s)=>s+n===0||2*i-n-s-2===0,(n,s)=>s+n===1||2*i-n-s-2===1,(n,s)=>s+n===2||2*i-n-s-2===2,(n,s)=>s+n===3||2*i-n-s-2===3,(n,s)=>s+n===4||2*i-n-s-2===4,(n,s)=>s+n===5||2*i-n-s-2===5,(n,s)=>(n+s)%2===0,(n,s)=>(n+s)%2===1,(n,s)=>(n+s)%2===0,(n,s)=>(n+s)%2===1,(n,s)=>(n+s)%2===0,(n,s)=>(n+s)%2===1];for(;o.length<i;)o.push(...o);o=o.slice(0,i);let t=-2;const a=new c.BoxGeometry;a.translate(.5,.5,.5),a.scale(.9,1.1,.9);for(let n=0;n<i;n++)for(let s=0;s<i;s++){const u=new c.MeshStandardMaterial({color:G}),h=new c.Mesh(a,u);h.name=`runner-${s}-${n}`,h.userData.x=s,h.userData.y=n,h.position.set(-i/2+s,0,-i/2+n),e.attach(h)}return N.Instance.on("beat",()=>{if(t+=1,t<0)return;const n=o[t%o.length];e.children.forEach(s=>{const{x:u,y:h}=s.userData,d=r[t%r.length](u,h),f=d?n:G;s.material.needsUpdate=!0,s.material.color.set(f),s.material.emissive.set(d?f:G),s.material.needsUpdate=!0,s.material.emissiveIntensity=d?1:0,d&&O.Instance.animateTransform({mesh:s,end:{scaling:new c.Vector3(1,d?1.1:1,1)},duration:500,ease:ct})}),N.Instance.emit("roomGlow",n)}),e},Dt=i=>{const e=j(St(),{palette:{Green:je,Yellow:ne,Orange:Xe,Red:qe,"Light Blue":H}}),o=Bt();e.add(o),o.position.set(-.1,.9,-.7);const r=Rt();e.add(r),r.position.set(-.4,1,-.3);const t=Et(i);t.name="Crowd",e.add(t),t.position.set(0,-1,-10),t.rotation.set(0,Math.PI,0);const a=j(Ct(),{palette:{Purple:"#333333",Silver:"#888888"}});a.name="catMesh",a.position.set(-3,1,0),a.scale.set(.1,.1,.1),a.rotation.set(0,-Math.PI/4,0),e.attach(a);const n=a.clone(!0);n.name="catMesh2",n.position.set(3,1,0),n.rotation.set(0,Math.PI/4,0),e.attach(n);const s=Nt();e.add(s),s.position.set(0,0,-30);const u=new Pt;e.add(u.mesh),u.mesh.position.set(0,-1,-7);const h=Ot();e.add(h),h.position.set(0,2,-1);const d=At(6);return e.add(d),d.position.set(0,-3,-10),d.scale.set(2,1,2),e},kt=()=>["cy,cylinder,4,6,2,,-1,,,,,,-1,,4","s,sphere,4,4,2,,2,,,,,,2,,4","c,cube,0.3,1,0.3,-1.15,3.5,-0.55,-77,,,-1.15,3.5,-0.55,9","c,cube,0.3,1,0.3,-0.45,3.9,-0.55,-77,,,-0.45,3.9,-0.55,9","c,cube,0.3,1,0.3,0.45,3.9,-0.55,-77,,,0.45,3.9,-0.55,9","c,cube,0.3,1,0.3,1.05,3.6,-0.55,-77,,,1.05,3.6,-0.55,9","c,cube,2,0.7,0.4,,1.85,-0.9,,,,,1.5,-0.1,3","c,cube,0.8,0.5,1.1,,2.45,-0.55,,,,,2.2,-0.1,3","c,cube,0.3,0.6,0.6,-1.15,2.7,-0.8,,,,-1.15,2.7,-0.1,3","c,cube,0.3,0.6,0.6,-0.45,3.1,-0.8,,,,-0.45,3.1,-0.1,3","c,cube,0.3,0.6,0.6,0.45,3.1,-0.8,,,,0.45,3.1,-0.1,3","c,cube,0.3,0.6,0.6,1.05,2.7,-0.8,,,,1.05,2.7,-0.1,3"],Gt={Purple:ce,Red:F,Silver:ie},Ut=(i={})=>{const e=new c.Group;e.name="paw";const o=j(kt(),{palette:{...Gt,...i}});o.scale.set(.03125,.03125,.03125),o.rotation.set(3*Math.PI/2,0,0),e.attach(o);const r=new c.PointLight(F,.5,4);return e.attach(r),e},zt=()=>["c,cube,6,6,8,,,,,,,,-3,,2","c,cube,4,4,11.1,,,-0.55,,,,,-3,,2","c,cube,2,2,2,-2,,-5,,,,-2,-1,-5,4","c,cube,2,2,2,2,,-5,,,,2,-1,-5,4","c,cube,2,6,2,,,6,,,,,-3,7,2","c,cube,1,4,6,,-3,9.5,15,,,,-3,8.5,9","c,cube,1,5,7,,2.5,9.9,-15,,,,2,8.4,2","c,cube,2,5,6,,2.2,,-30,,,,2.7,,2","c,cube,1,2,2,-2.5,-4,-2,,,-40,-3,-3,-2,9","c,cube,3,1,4,-4.5,-3.5,4,,,20,-3,-3,3,9","c,cube,1,2,2,2.5,-4,-2,,,40,3,-3,-2,9","c,cube,3,1,4,4.5,-3.5,4,,,-25,3,-3,3,9"],Ne=[{Orange:Be,Purple:G,Silver:Me},{Orange:Ze,Purple:G,Silver:ve}],_t=new c.Vector3(.05,.05,.05),Vt=()=>{new c.Vector3(1,0,0);const i=new c.Group;i.name="FishSwirl";const e=[];let o=!0;const r=new c.Group,t=Ne[c.MathUtils.randInt(0,Ne.length-1)],a=j(zt(),{palette:t,glow:!0});for(let n=0;n<10;n++){const s=a.clone(!0);s.position.set(Math.random()*10-5,0,0),e.push(s),r.attach(s),s.userData.velocity=new c.Vector3(0,5+3*Math.random(),-5),s.scale.set(0,0,0)}return r.rotation.set(0,0,0),i.attach(r),N.Instance.on("tick",n=>{e.forEach(s=>{if(s.userData.velocity.y-=10*n,s.position.addScaledVector(s.userData.velocity,n),s.position.y<-2){const h=new c.Vector3(Math.random()*4-2,0,Math.random()*4-2).sub(s.position).normalize(),d=new c.Quaternion;d.setFromUnitVectors(new c.Vector3(0,0,-1),h),s.quaternion.copy(d),s.position.y=-2;const f=new c.Vector3(0,0,-1);f.applyQuaternion(s.quaternion),f.multiplyScalar(5),s.userData.velocity.x=f.x,s.userData.velocity.z=f.z,s.userData.velocity.y=7+6*Math.random()}const u=new c.Quaternion;u.setFromUnitVectors(new c.Vector3(0,0,-1),s.userData.velocity),s.quaternion.copy(u)})}),N.Instance.on("progress",n=>{const s=n.bestComboCount>=4,u=s!==o;e.forEach(h=>{u&&(O.Instance.cancelAnimation(h),O.Instance.animateTransform({mesh:h,end:{scaling:s?_t:new c.Vector3(0,0,0)},duration:s?2e3:1e3}))}),o=s}),i},Yt=()=>{const i=new c.Group;i.name="Sky";const e=new c.Object3D,o=30,r=.05,t=new c.BoxGeometry,a=new c.MeshStandardMaterial;a.emissive=new c.Color(255),a.emissiveIntensity=1;const n=[];let s=0,u=0;const h=new c.InstancedMesh(t,a,o*o);h.instanceMatrix.setUsage(c.DynamicDrawUsage);const d=new c.Color,f=[new c.Color(65535),new c.Color(16776960),new c.Color(16711935)];let l=0;for(let w=0;w<o;w++)for(let g=0;g<o;g++){const M=xe(0,2*g*Math.PI/o,15);M.z=-w*4,e.position.copy(M),e.scale.set(1,1,2),e.updateMatrix(),d.setHSL(1,.5+Math.random()*.5,.5+Math.random()*.5),n.push(d.getHex()),h.setMatrixAt(l,e.matrix),h.setColorAt(l,d.multiply(f[0])),l++}return i.add(h),N.Instance.on("tick",w=>{s+=w;for(let g=0;g<h.count;g++){h.getMatrixAt(g,e.matrix),e.matrix.decompose(e.position,e.quaternion,e.scale);const M=Math.floor(g/o),m=M%2?1:-1,v=g%o,b=-M*4,S=2*v*Math.PI/o,y=r*m*s;e.position.copy(xe(0,S+y,15)),e.position.z=b+u*m*Math.sin(s),e.updateMatrix(),h.setMatrixAt(g,e.matrix)}h.instanceMatrix.needsUpdate=!0}),N.Instance.on("progress",w=>{u=w.bestComboCount>=2?1:0}),i},Wt=new c.Clock;let oe=0,q,A,pe,D,Y,W,X;const ge=[];let Te;const me=new c.Vector3(0,0,.3),Re=new c.Color,Xt=async()=>{document.getElementById("p").setAttribute("disabled","true"),document.getElementById("p").innerHTML="LOADING...",D=new c.WebGLRenderer({antialias:!0}),D.setPixelRatio(window.devicePixelRatio),D.setSize(window.innerWidth,window.innerHeight),D.setClearColor("#000000"),D.xr.addEventListener("sessionstart",qt),D.xr.enabled=!0,D.setAnimationLoop(Zt),document.body.appendChild(Q.createButton(D)),document.body.appendChild(D.domElement);const i=new ot;A=new c.Scene,q=new c.PerspectiveCamera(75,window.innerWidth/window.innerHeight,.1,1e3),q.position.set(0,2,1),q.rotation.set(-1*Math.PI/12,0,0),q.name="camera",A.add(q),O.Instance.initScene(A);const e=new c.Color().setStyle("#888888"),o=new c.AmbientLight(e,.2);o.name="ambientLight",A.add(o);const r=new c.Color().setStyle("#ffffff"),t=new c.DirectionalLight(r,.3);t.name="directionalLight",t.position.set(6,10,8),t.castShadow=!0,t.target.position.set(0,0,0),A.add(t),A.add(t.target);const a=Yt();a.position.set(0,0,5),A.add(a);const n=Dt(D);A.add(n);const s=n.getObjectByName("tableA"),u=n.getObjectByName("pad"),h=Vt();h.position.set(0,0,-10),A.attach(h),i.vinyls.forEach((d,f)=>{const l=rt(d);l.name=`vinyl-${f}`;const w=new c.Vector3(.7,1.15,-.2-.125*f);l.position.copy(w),l.userData.originalPosition=w,l.userData.isPickable=!0,l.userData.recordIndex=f,l.userData.returnToOriginalPosition=()=>{A.attach(l),O.Instance.cancelAnimation(l),O.Instance.animateTransform({mesh:l,end:{position:l.userData.originalPosition,rotation:new c.Euler(0,0,0)},duration:100})},l.onPointerPick=g=>{if(g.userData.selected||i.isSolved())return;i.selected[g.id]=f;const M=g.getObjectByName("target");M&&(O.Instance.cancelAnimation(l),M.attach(l),O.Instance.animateTransform({mesh:l,end:{position:new c.Vector3(0,0,0),rotation:new c.Euler(0,Math.PI/2,0)},duration:60}),g.userData.selected=l,u.material.emissive.setStyle(ve))},l.onPointerDrop=g=>{if(O.Instance.cancelAnimation(l,!0),u.material.emissive.setStyle(G),l.getWorldPosition(new c.Vector3).distanceTo(s.getWorldPosition(new c.Vector3))<.3){i.addVinylByIndex(l.userData.recordIndex),delete i.selected[g.id],g.userData.selected=void 0,s.children.forEach(m=>{m.userData.returnToOriginalPosition&&m.userData.returnToOriginalPosition()}),s.attach(l),O.Instance.animateTransform({mesh:l,end:{position:new c.Vector3(0,.01,0),rotation:new c.Euler(-1*Math.PI/2,0,0)},duration:60}).then(()=>{O.Instance.animateTransform({mesh:l,end:{rotation:new c.Euler(-1*Math.PI/2,0,-2*Math.PI)},ease:m=>m,duration:1800,loop:!0})});return}else l.userData.returnToOriginalPosition(),g.userData.selected=void 0},A.add(l)}),W=D.xr.getController(0),W.addEventListener("connected",Pe),W.addEventListener("selectstart",re),W.addEventListener("selectend",ae),W.addEventListener("squeezestart",re),W.addEventListener("squeezeend",ae),A.add(W),X=D.xr.getController(1),X.addEventListener("connected",Pe),X.addEventListener("selectstart",re),X.addEventListener("selectend",ae),X.addEventListener("squeezestart",re),X.addEventListener("squeezeend",ae),A.add(X),pe=new c.Raycaster,window.addEventListener("resize",Ft,!1),N.Instance.on("comboBroken",d=>{d?Ge():ft()}),N.Instance.on("roomGlow",d=>{const f=A.getObjectByName("ambientLight");Re.setStyle(d),f.color.set(Re.add(e).multiplyScalar(.5))}),pt(),N.Instance.on("downbeat",()=>{oe>100&&(N.Instance.emit("beat"),oe=0)}),i.reset(),document.getElementById("intro").style.display="none",document.getElementById("c").style.display="block"};function qt(){Te=D.xr.getReferenceSpace();const i={x:-1*me.x,y:-1*me.y,z:-1*me.z,w:1},e=new c.Quaternion,o=new XRRigidTransform(i,e),r=Te.getOffsetReferenceSpace(o);D.xr.setReferenceSpace(r)}function Pe(i){console.log("controller connected",i);const e=i.target,o=i.data.handedness==="left"?-1:1;if(!e.getObjectByName("target")){const n=new c.Group;n.name="target",n.rotation.set(0,0,0),n.position.set(-1*o*.035,.05,-.12),e.add(n)}let t=e.getObjectByName("paw");t||(t=Ut(),t.position.set(0,0,.15),e.add(t));let a=e.getObjectByName("line");if(!a){const n=new c.BufferGeometry().setFromPoints([new c.Vector3(0,0,0),new c.Vector3(0,0,-1)]);a=new c.Line(n),a.material.color.set(16711680),a.name="line",a.scale.z=5,e.add(a)}}function re(i){Y=i.target;const e=Ue(Y);if(e.length>0){let o=!1;e.forEach(({object:r,distance:t})=>{if(o)return;let a=r;for(;a;){if(a.onPointerPick){a.onPointerPick(Y),o=!0;const n=Y.getObjectByName("line");n.visible=!1;break}a=a.parent}})}Y.userData.targetRayMode=i.data.targetRayMode}function ae(i){Y=i.target;const e=Y.userData.selected;e?.onPointerDrop&&e.onPointerDrop(Y);const o=Y.getObjectByName("line");o.visible=!0}function Ue(i){return i.updateMatrixWorld(),pe.setFromXRController(i),pe.intersectObjects(A.children,!0)}function Oe(i){if(i.userData.targetRayMode==="screen"||i.userData.selected!==void 0)return;const e=i.getObjectByName("line"),o=Ue(i);if(e&&(e.scale.z=5),o.length>0){let r=!1;o.forEach(({object:t,distance:a})=>{if(r)return;let n=t;for(;n;){if(n.userData.isPickable){const s=n.getObjectByName("highlight");s&&(s.visible=!0),e&&(e.scale.z=a),ge.push(n),r=!0;break}n=n.parent}})}}function jt(){for(;ge.length;){const e=ge.pop().getObjectByName("highlight");e&&(e.visible=!1)}}function Zt(){const i=Wt.getDelta();oe+=i,oe>=.5&&(N.Instance.emit("beat"),oe-=.5),O.Instance.update(),N.Instance.emit("tick",i),jt(),Oe(W),Oe(X),D.render(A,q)}const Ft=()=>{q.aspect=window.innerWidth/window.innerHeight,q.updateProjectionMatrix(),D.setSize(window.innerWidth,window.innerHeight)};window.addEventListener("DOMContentLoaded",()=>{const i=document.getElementById("p");i.onclick=Xt});

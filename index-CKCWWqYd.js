import*as c from"https://js13kgames.com/2025/webxr/three.module.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))s(o);new MutationObserver(o=>{for(const a of o)if(a.type==="childList")for(const n of a.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&s(n)}).observe(document,{childList:!0,subtree:!0});function t(o){const a={};return o.integrity&&(a.integrity=o.integrity),o.referrerPolicy&&(a.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?a.credentials="include":o.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(o){if(o.ep)return;o.ep=!0;const a=t(o);fetch(o.href,a)}})();class T{static _instance;callbacks;constructor(){this.callbacks={}}static get Instance(){return T._instance||(T._instance=new T),T._instance}on(e,t){this.callbacks[e]=this.callbacks[e]||[],this.callbacks[e].push(t)}off(e,t){this.callbacks[e]=(this.callbacks[e]||[]).filter(s=>s!==t)}emit(e,...t){(this.callbacks[e]||[]).forEach(s=>s(...t))}_reset(){Object.keys(this.callbacks).forEach(e=>{delete this.callbacks[e]})}getCallbacks(){return this.callbacks}}const pe="#e81416",ge="#ffa500",we="#faeb36",ce="#79c314",H="#487de7",Oe="#70369d",Ye="#1aff1a",ye="#ffffff",We="#666666",_="#000000",ne="#abb7d0",Xe="#687793",qe="#42485d",Ze="#93e0a8",F="#ff3b94",Le="#ffcc00",be="#f6ff00",Be="#8ea5ff",je="#af3dff",Fe="#39013a",ie="#333333",He="#888888",$e={"Light Blue":"#9999ff",Yellow:"#fffb00",Orange:"#ff7300",Red:"#ff0000",Purple:"#c300ff",Blue:"#0000ff",Green:"#00ff00",Lime:"#b0ffb0",Pink:"#ff00ff",Silver:"#d3d3d3"},Se={color:pe,artist:ce,title:H},K=[pe,ge,we,ce,H,Oe],ee=["Shiny Toy Guns","B.B. King","Jack White","Black Sabbath","Faith Hill","Cliff Sheen"],te=["OFFSIDE","SHOWCASE","LOADOUT","BACKHAND","BOOKMARKS","MANPOWER"],Ke={color:K,artist:ee,title:te},Qe={color:0,artist:24,title:34},Je=[[0,1,2,3,4,5],[0,2,4,1,5,3],[0,3,5,1,4,2]],et=["color","artist","title"];class tt{queue;selected;vinyls;progress;constructor(){this.queue=[],this.selected={},this.vinyls=[],this.reset(),this.progress.bestComboType="color"}addVinylByIndex(e){if(this.queue[0]===e)return;const{color:t,artist:s,title:o}=this.vinyls[e],a=K.indexOf(t),n=ee.indexOf(s),r=te.indexOf(o);a===this.progress.color.currentIndex+1?(this.progress.color.correctCount++,this.progress.color.correctCount===K.length&&(this.progress.color.solved=!0),this.progress.color.currentIndex=a):(this.progress.color.currentIndex=-1,this.progress.color.correctCount=0),n===(this.progress.artist.currentIndex+1)%ee.length?(this.progress.artist.correctCount++,this.progress.artist.correctCount===ee.length&&(this.progress.artist.solved=!0)):this.progress.artist.correctCount=1,this.progress.artist.currentIndex=n,r===(this.progress.title.currentIndex+1)%te.length?(this.progress.title.correctCount++,this.progress.title.correctCount===te.length&&(this.progress.title.solved=!0)):this.progress.title.correctCount=1,this.progress.title.currentIndex=r;const u=Math.max(this.progress.color.correctCount,this.progress.artist.correctCount,this.progress.title.correctCount);this.progress.bestComboCount<6&&u<this.progress.bestComboCount&&T.Instance.emit("comboBroken"),this.progress.bestComboCount=u,this.progress.bestComboType=this.progress.color.correctCount===this.progress.bestComboCount?"color":this.progress.artist.correctCount===this.progress.bestComboCount?"artist":"title",this.queue.unshift(e),this.progress.displayText=this.getDisplayText(),T.Instance.emit("progress",this.progress)}getVinylInQueue(e){return this.vinyls[this.queue[e]]}isSolved(e){if(e)return this.progress.color.solved&&this.progress.artist.solved&&this.progress.title.solved,this.progress[e].solved}getDisplayText(){let e="";const{currentIndex:t,correctCount:s,solved:o}=this.progress[this.progress.bestComboType],a=Ke[this.progress.bestComboType];for(let n=0;n<s;n++){let r=t-n;r<0&&(r+=a.length),e=`${a[r]}â†’${e}`}return e}reset(){this.queue=[],this.selected={};const[e,t,s]=Je;this.progress={color:{currentIndex:-1,correctCount:0,solved:!1},artist:{currentIndex:-2,correctCount:0,solved:!1},title:{currentIndex:-2,correctCount:0,solved:!1},bestComboType:"color",bestComboCount:0},this.vinyls=K.map((o,a)=>({index:a,color:o,artist:"",title:""})),e.forEach((o,a)=>{this.vinyls[o].color=K[a]}),t.forEach((o,a)=>{this.vinyls[o].artist=ee[a]}),s.forEach((o,a)=>{this.vinyls[o].title=te[a]}),T.Instance.emit("progress",this.progress)}}class J{static createButton(e,t={}){const s=document.createElement("button");function o(){let u=null;async function f(h){h.addEventListener("end",l),await e.xr.setSession(h),s.textContent="EXIT VR",u=h}function l(){u.removeEventListener("end",l),s.textContent="ENTER VR",u=null}s.style.display="block",s.removeAttribute("data-disabled"),s.textContent="ENTER VR";const d={...t,optionalFeatures:["local-floor","bounded-floor","layers",...t.optionalFeatures||[]]};s.onclick=function(){u===null?navigator.xr.requestSession("immersive-vr",d).then(f):(u.end(),navigator.xr.offerSession!==void 0&&navigator.xr.offerSession("immersive-vr",d).then(f).catch(h=>{console.warn(h)}))},navigator.xr.offerSession!==void 0&&navigator.xr.offerSession("immersive-vr",d).then(f).catch(h=>{console.warn(h)})}function a(){s.style.display="block",s.setAttribute("data-disabled","true"),s.onmouseenter=null,s.onmouseleave=null,s.onclick=null}function n(){a(),s.textContent="VR NOT SUPPORTED"}function r(u){a(),console.warn("Exception when trying to call xr.isSessionSupported",u),s.textContent="VR NOT ALLOWED"}if("xr"in navigator)return s.id="VRButton",s.style.display="none",navigator.xr.isSessionSupported("immersive-vr").then(function(u){u?o():n(),u&&J.xrSessionIsGranted&&s.click()}).catch(r),s;{const u=document.createElement("a");return window.isSecureContext===!1?(u.href=document.location.href.replace(/^http:/,"https:"),u.innerHTML="WEBXR NEEDS HTTPS"):(u.href="https://immersiveweb.dev/",u.innerHTML="WEBXR NOT AVAILABLE"),u.className="webxr-message",u}}static registerSessionGrantedListener(){if(typeof navigator<"u"&&"xr"in navigator){if(/WebXRViewer\//i.test(navigator.userAgent))return;navigator.xr.addEventListener("sessiongranted",()=>{J.xrSessionIsGranted=!0})}}}J.xrSessionIsGranted=!1;J.registerSessionGrantedListener();const U=.0254,Ae=(i=1024,e=1024)=>{const t=document.createElement("canvas");t.width=i,t.height=e;const s=t.getContext("2d");return[t,s]},xe=(i,e,t)=>{const s=new c.Vector3(1,0,0),o=new c.Euler(0,i,-Math.PI/2+e);return s.applyEuler(o).normalize().multiplyScalar(t)},g=i=>parseFloat(`${i||0}`),ot=i=>i[Math.floor(Math.random()*i.length)],Q={},Ce=new c.Color,ue=(i,e)=>{const t=e?.glow==!0,s=`color-${i}-${t}`;if(Q[s])return Q[s];const o=t?c.MeshBasicMaterial:c.MeshStandardMaterial,a=new o({color:i,side:c.FrontSide});return Q[s]=a,a},De=(i,e)=>{const{color:t,bgColor:s,textAlign:o,ratio:a,fontSize:n}=e;Ce.set(t);const r=typeof t=="string"?t:`#${Ce.getHexString()}`,u=`text-${r}-${i.join("")}`;if(Q[u])return Q[u];const f=1024,l=a?f/a:f,[d,h]=Ae(f,l);h.textAlign=o||"center";let p=16;h.textAlign==="center"&&(p=.5*f);let y=16;i.forEach((M,b)=>{const v=n!==void 0?n:64;h.strokeStyle=_,h.font=`${v}px monospace`,h.textBaseline="top",h.lineWidth=8,h.strokeText(M,p,y+v*b),h.fillStyle=r,h.fillText(M,p,y+v*b)});const S=new c.CanvasTexture(d),m=new c.MeshBasicMaterial({map:S,transparent:!0});return Q[u]=m,m},nt=(i,e)=>{const[s,o]=Ae();o.fillStyle=_,o.strokeStyle=_,o.lineWidth=8,o.beginPath(),o.arc(1024/2,1024/2,20,0,2*Math.PI),o.stroke(),o.beginPath(),o.arc(1024/2,1024/2,288,0,2*Math.PI),o.stroke(),o.textAlign="center",i&&(o.font="64px monospace",o.textBaseline="middle",o.strokeStyle=_,o.lineWidth=8,o.strokeText(i,.5*1024,.42*1024),o.fillStyle=ce,o.fillText(i,.5*1024,.42*1024)),e&&(o.font="96px monospace",o.textBaseline="bottom",o.fillStyle=H,o.strokeText(e,.5*1024,.68*1024),o.fillText(e,.5*1024,.68*1024));const a=new c.CanvasTexture(s);return a.encoding=c.LinearSRGBColorSpace,new c.MeshBasicMaterial({map:a,transparent:!0})},st=({color:i,artist:e,title:t})=>{const s=new c.Group,o=new c.RingGeometry(4,7,32);o.translate(0,0,-.001),o.scale(U,U,U);const a=ue(i,{glow:!0});s.add(new c.Mesh(o,a));const n=new c.RingGeometry(.25,4,32);n.scale(U,U,U),n.translate(0,0,-.001);const r=ue(16777215,{});s.add(new c.Mesh(n,r));const u=new c.PlaneGeometry(14,14);u.translate(0,0,-.002),u.scale(U,U,U);const f=nt(e,t);s.add(new c.Mesh(u,f));const l=s.clone();l.rotation.set(0,Math.PI,0),s.add(l);const d=new c.RingGeometry(7,7.5,32);d.scale(U,U,U);const h=ue(ye,{glow:!0});h.emissiveIntensity=1;const p=new c.Mesh(d,h);return p.visible=!1,p.name="highlight",s.add(p),s},rt=i=>i*i,at=i=>i<.5?4*i*i*i:1-Math.pow(-2*i+2,3)/2,it=i=>.5*Math.cos(2*i*Math.PI+Math.PI)+.5;class O{static _instance;animations;scene;clock;constructor(){this.animations=[],this.scene=null,this.clock=new c.Clock}static get Instance(){return O._instance||(O._instance=new O),O._instance}initScene(e){this.scene||(this.scene=e,this.clock.start())}update(){const e=this.clock.getElapsedTime()*1e3;this.animations=this.animations.filter(t=>{const{mesh:s,start:o,end:a,easeFunc:n,loop:r}=t,u=e-t.startTime,f=t.endTime-t.startTime,l=c.MathUtils.clamp(u/f,0,1);if(a.position&&s.position.lerpVectors(o.position,a.position,n(l)),a.rotation){const d=o.rotation,h=a.rotation,p=new c.Euler;p.order=d.order||c.Euler.DefaultOrder,p.x=d.x+(h.x-d.x)*n(l),p.y=d.y+(h.y-d.y)*n(l),p.z=d.z+(h.z-d.z)*n(l),s.rotation.copy(p)}return a.scaling&&s.scale.lerpVectors(o.scaling,a.scaling,n(l)),e>=t.endTime?r?(t.startTime=e,t.endTime=e+f,a.position&&s.position.copy(o.position),a.rotation&&s.rotation.copy(o.rotation),a.scaling&&s.scale.copy(o.scaling),!0):(t.resolve&&(t.resolve(),t.resolve=void 0,t.reject=void 0),!1):!0})}animateTransform(e){const{mesh:t,end:s}=e,o=e.duration||1e3,a=e.delay||0,n=e.ease||rt,r=this.clock.getElapsedTime()*1e3;let u,f;const l=new Promise((d,h)=>{u=d,f=h});return this.animations.push({mesh:t,start:{position:t.position.clone(),rotation:t.rotation.clone(),scaling:t.scale.clone()},end:s,easeFunc:n,startTime:r+a,endTime:r+a+o,loop:e.loop||!1,resolve:u,reject:f}),l}cancelAnimation(e,t=!1){const s=this.animations.filter(o=>o.mesh===e);s.length&&(s.forEach(o=>{const{end:a}=o;t&&(a.position&&e.position.copy(a.position),a.rotation&&e.rotation.copy(a.rotation),a.scaling&&e.scale.copy(a.scaling)),o.reject&&(o.reject(),o.resolve=void 0,o.reject=void 0)}),this.animations=this.animations.filter(o=>o.mesh!==e))}}class ct{constructor(){this.mOscillators=[this.osc_sin.bind(this),this.osc_square.bind(this),this.osc_saw.bind(this),this.osc_tri.bind(this)],this.mSong=null,this.mLastRow=0,this.mCurrentCol=0,this.mNumWords=0,this.mMixBuf=null}osc_sin(e){return Math.sin(e*6.283184)}osc_saw(e){return 2*(e%1)-1}osc_square(e){return e%1<.5?1:-1}osc_tri(e){var t=e%1*4;return t<2?t-1:3-t}getnotefreq(e){return .003959503758*2**((e-128)/12)}createNote(e,t,s){var o=this.mOscillators[e.i[0]],a=e.i[1],n=e.i[3]/32,r=this.mOscillators[e.i[4]],u=e.i[5],f=e.i[8]/32,l=e.i[9],d=e.i[10]*e.i[10]*4,h=e.i[11]*e.i[11]*4,p=e.i[12]*e.i[12]*4,y=1/p,S=-e.i[13]/16,m=e.i[14],M=s*2**(2-e.i[15]),b=new Int32Array(d+h+p),v=0,w=0,E,N,x,I,P,L;for(E=0,N=0;E<d+h+p;E++,N++)N>=0&&(m=m>>8|(m&255)<<4,N-=M,P=this.getnotefreq(t+(m&15)+e.i[2]-128),L=this.getnotefreq(t+(m&15)+e.i[6]-128)*(1+8e-4*e.i[7])),x=1,E<d?x=E/d:E>=d+h&&(x=(E-d-h)*y,x=(1-x)*3**(S*x)),v+=P*x**n,I=o(v)*a,w+=L*x**f,I+=r(w)*u,l&&(I+=(2*Math.random()-1)*l),b[E]=80*I*x|0;return b}async init(e){return new Promise(t=>{this.mSong=e,this.mLastRow=e.endPattern,this.mCurrentCol=0,this.mNumWords=e.rowLen*e.patternLen*(this.mLastRow+1)*2,this.mMixBuf=new Int32Array(this.mNumWords),t()})}generateChannel(e){return new Promise(t=>{var s,o,a,n,r,u,f,l,d,h,p,y,S=new Int32Array(this.mNumWords),m=this.mSong.songData[e],M=this.mSong.rowLen,b=this.mSong.patternLen,v=0,w=0,E,N,x=!1,I=[];for(a=0;a<=this.mLastRow;++a)for(f=m.p[a],n=0;n<b;++n){var P=f?m.c[f-1].f[n]:0;P&&(m.i[P-1]=m.c[f-1].f[n+b]||0,P<17&&(I=[]));var L=this.mOscillators[m.i[16]],C=m.i[17]/512,R=2**(m.i[18]-9)/M,B=m.i[19],$=m.i[20],G=m.i[21]*43.23529*3.141592/44100,V=1-m.i[22]/255,z=m.i[23]*1e-5,Ue=m.i[24]/32,_e=m.i[25]/512,Ve=6.283184*2**(m.i[26]-9)/M,Me=m.i[27]/255,le=m.i[28]*M&-2;for(p=(a*b+n)*M,r=0;r<4;++r)if(u=f?m.c[f-1].n[n+r*b]:0,u){I[u]||(I[u]=this.createNote(m,u,M));var ve=I[u];for(o=0,s=p*2;o<ve.length;o++,s+=2)S[s]+=ve[o]}for(o=0;o<M;o++)l=(p+o)*2,h=S[l],h||x?(y=G,B&&(y*=L(R*l)*C+.5),y=1.5*Math.sin(y),v+=y*w,E=V*(h-w)-v,w+=y*E,h=$==3?w:$==1?E:v,z&&(h*=z,h=h<1?h>-1?this.osc_sin(h*.25):-1:1,h/=z),h*=Ue,x=h*h>1e-5,d=Math.sin(Ve*l)*_e+.5,N=h*(1-d),h*=d):N=0,l>=le&&(N+=S[l-le+1]*Me,h+=S[l-le]*Me),S[l]=N|0,S[l+1]=h|0,this.mMixBuf[l]+=N|0,this.mMixBuf[l+1]+=h|0}t()})}async generate(){this.mMixBuf.fill(0),this.mCurrentCol=0;const e=[];for(let t=0;t<this.mSong.numChannels;t++)e.push(this.generateChannel(t));return await Promise.all(e),this.mCurrentCol=this.mSong.numChannels,1}createAudioBuffer(e){for(var t=e.createBuffer(2,this.mNumWords/2,44100),s=0;s<2;s++)for(var o=t.getChannelData(s),a=s;a<this.mNumWords;a+=2)o[a>>1]=this.mMixBuf[a]/65536;return t}createAudioBufferRange(e,t=0,s=null){(s===null||s>this.mNumWords/2)&&(s=this.mNumWords/2),t<0&&(t=0),t>=s&&(t=s-1);const o=s-t;for(var a=e.createBuffer(2,o,44100),n=0;n<2;n++)for(var r=a.getChannelData(n),u=0;u<o;u++){var f=(t+u)*2+n;r[u]=this.mMixBuf[f]/65536}return a}createWave(){var e=44,t=e+this.mNumWords*2-8,s=t-36,o=new Uint8Array(e+this.mNumWords*2);o.set([82,73,70,70,t&255,t>>8&255,t>>16&255,t>>24&255,87,65,86,69,102,109,116,32,16,0,0,0,1,0,2,0,68,172,0,0,16,177,2,0,4,0,16,0,100,97,116,97,s&255,s>>8&255,s>>16&255,s>>24&255]);for(var a=0,n=e;a<this.mNumWords;++a){var r=this.mMixBuf[a];r=r<-32767?-32767:r>32767?32767:r,o[n++]=r&255,o[n++]=r>>8&255}return o}createWaveRange(e=0,t=null){(t===null||t>this.mNumWords/2)&&(t=this.mNumWords/2),e<0&&(e=0),e>=t&&(e=t-1);const s=t-e;var o=44,a=o+s*2-8,n=a-36,r=new Uint8Array(o+s*2);r.set([82,73,70,70,a&255,a>>8&255,a>>16&255,a>>24&255,87,65,86,69,102,109,116,32,16,0,0,0,1,0,2,0,68,172,0,0,16,177,2,0,4,0,16,0,100,97,116,97,n&255,n>>8&255,n>>16&255,n>>24&255]);for(var u=0,f=o;u<s;++u){var l=this.mMixBuf[(e+u)*2];l=l<-32767?-32767:l>32767?32767:l,r[f++]=l&255,r[f++]=l>>8&255}return r}getData(e,t){for(var s=2*Math.floor(e*44100),o=new Array(t),a=0;a<2*t;a+=1){var n=s+a;o[a]=e>0&&n<this.mMixBuf.length?this.mMixBuf[n]/32768:0}return o}}const lt=.3,k=44100,de=new(window.AudioContext||window.webkitAudioContext),ut=(i=1,e=.05,t=220,s=0,o=0,a=.1,n=0,r=1,u=0,f=0,l=0,d=0,h=0,p=0,y=0,S=0,m=0,M=1,b=0,v=0)=>{let w=2*Math.PI,E=u*=500*w/k**2,N=(0<y?1:-1)*w/4,x=t*=(1+2*e*Math.random()-e)*w/k,I=[],P=0,L=0,C=0,R=1,B=0,$=0,G=0,V,z;for(s=99+k*s,b*=k,o*=k,a*=k,m*=k,f*=500*w/k**3,y*=w/k,l*=w/k,d*=k,h=k*h|0,z=s+b+o+a+m|0;C<z;I[C++]=G)++$%(100*S|0)||(G=n?1<n?2<n?3<n?Math.sin((P%w)**3):Math.max(Math.min(Math.tan(P),1),-1):1-(2*P/w%2+2)%2:1-4*Math.abs(Math.round(P/w)-P/w):Math.sin(P),G=(h?1-v+v*Math.sin(2*Math.PI*C/h):1)*(0<G?1:-1)*Math.abs(G)**r*i*lt*(C<s?C/s:C<s+b?1-(C-s)/b*(1-M):C<s+b+o?M:C<z-m?(z-C-m)/a*M:0),G=m?G/2+(m>C?0:(C<z-m?1:(z-C)/m)*I[C-m|0]/2):G),V=(t+=u+=f)*Math.sin(L*y-N),P+=V-V*p*(1-1e9*(Math.sin(C)+1)%2),L+=V-V*p*(1-1e9*(Math.sin(C)**2+1)%2),R&&++R>d&&(t+=l,x+=l,R=0),!h||++B%h||(t=x,u=E,R=R||1);return I},dt=(...i)=>{let e=de.createBufferSource(),t=de.createBuffer(i.length,i[0].length,k);return i.map((s,o)=>t.getChannelData(o).set(s)),e.buffer=t,e.connect(de.destination),e.start(),e},ke=(...i)=>dt(ut(...i));var ht={songData:[{i:[0,255,116,85,0,255,116,0,37,14,4,6,73,99,0,0,0,0,0,0,2,136,15,0,32,0,0,0,6],p:[1,1,1,2,,,1,1,2,2],c:[{n:[139,,,,139,,,,139,,,,139,,,,139,,,,139,,,,139,,139,,139,,139],f:[]},{n:[140,,140,,,,140,,,,140,,140,,140,,,,140,,140,,,,140,,140,,,,140],f:[]}]},{i:[0,160,128,64,0,160,128,0,64,210,4,7,52,85,0,0,0,60,4,1,2,255,0,0,32,61,5,0,6],p:[,1,2,1,2,1,2,1,1,1],c:[{n:[,,,,139,,,,,,,,139,,,,,,,,139,,,,,,,,139,,139],f:[]},{n:[,,,,,,,,,,,,139,,139,,,,,,,,,,,,,,139,,139],f:[]}]},{i:[0,255,106,64,0,255,106,0,64,0,5,7,164,0,0,0,0,0,0,0,2,255,0,2,32,83,5,25,1],p:[,,,,1,,2,1,1,2],c:[{n:[144,,,,,,,,,,,,,,,,144],f:[]},{n:[,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,156,,,,,,,,,,,,,,,,156],f:[]}]},{i:[0,91,128,0,0,95,128,12,0,0,12,0,72,0,0,0,0,0,0,0,2,255,0,0,32,83,3,130,4],p:[,,,,1,1,1,1,2,2],c:[{n:[132,,,,,,,,132,,,,,,,,144,,,,,,,,144],f:[]},{n:[],f:[]}]},{i:[1,192,128,0,1,191,116,9,0,0,6,22,34,0,0,0,0,69,3,1,1,23,167,0,32,77,6,25,6],p:[,,2,1,,2,1,2,2,1],c:[{n:[144,,,,144,,,,144,,,,142,,142,,144,,144,,144,,,,144,,,,144,,,,147,,,,151,,,,147,,,,149,,149,,147,,147,,151,,,,147,,,,147,,,,151,,,,154,,,,151,,,,151,,151,,151,,151,,154,,,,151,,,,151],f:[]},{n:[144,144,144,,144,,,,,,,,,,,,,,,,,,,,,,,,,,,,147,147,147,,147,,,,,,,,,,,,,,,,,,,,,,,,,,,,151,151,151,,151],f:[]}]}],rowLen:5513,patternLen:32,endPattern:9,numChannels:5};const se=new AudioContext;let j=0;T.Instance.on("progress",i=>{const e=i.bestComboCount||0;j=Math.min(e,6)});const Ge=()=>ke(void 0,void 0,143,.03,.17,.09,2,1.5,10,-17,void 0,void 0,void 0,void 0,4,void 0,void 0,.73,.09),ft=()=>ke(1.01,void 0,275,.01,.01,.15,1,1.03,-3.7,void 0,-93,.07,void 0,void 0,void 0,-.1,void 0,.5,.04,.09),mt=async()=>{const i=new ct;await i.init(ht),await i.generate();const e=[];for(let l=0;l<6;l++){const d=l*176400,h=d+176400,p=i.createAudioBufferRange(se,d,h);e.push(p)}const t=6*176400,s=t+705600,o=i.createAudioBufferRange(se,t,s),a=[...e,o];let n=null,r=!1;const u=l=>{n&&(n.stop(),n.disconnect());let d;l<6?d=l:d=6;const h=a[d];n=se.createBufferSource(),n.buffer=h,n.connect(se.destination),n.loop=!0,n.start();const p=setInterval(()=>{T.Instance.emit("downbeat"),j!==l&&(console.log("Sequence change detected:",l,"â†’",j),clearInterval(p),u(j))},2e3);r=!0};return u(j),{source:n,stop:()=>{r=!1,n&&(n.stop(),n.disconnect(),n=null)},playSequence:l=>{j=l,u(l)},getCurrentSequence:()=>j,isPlaying:()=>r}},Ee=["Light Blue","Yellow","Orange","Red","Purple","Blue","Green","Lime","Pink","Silver"],pt=i=>{const[e,t,s,o,a,n,r,u,f,l,d,h,p,y,S]=i.split(","),m=g(s),M=g(o),b=g(a),v=g(n),w=g(r),E=g(u),N=g(h),x=g(p),I=g(y),P=g(f),L=g(l),C=g(d),R=Math.sqrt(m*m+m*m)/2,B=new c.CylinderGeometry(0,R,M,4,1,!1,Math.PI/4);return B.scale(1,1,b/m),B.translate(v-N,w-x+.3*M,E-I),B.rotateX(c.MathUtils.degToRad(P)),B.rotateY(c.MathUtils.degToRad(L)),B.rotateZ(c.MathUtils.degToRad(C)),B},gt=i=>{const[e,t,s,o,a,n,r,u,f,l,d,h,p,y,S]=i.split(","),m=g(s),M=g(o),b=g(a),v=g(n),w=g(r),E=g(u),N=g(h),x=g(p),I=g(y),P=g(f),L=g(l),C=g(d),R=new c.BoxGeometry(m,M,b);return R.translate(v-N,w-x,E-I),R.rotateX(c.MathUtils.degToRad(P)),R.rotateY(c.MathUtils.degToRad(L)),R.rotateZ(c.MathUtils.degToRad(C)),R.computeBoundingBox(),R},wt=i=>{const[e,t,s,o,a,n,r,u,f,l,d,h,p,y,S]=i.split(","),m=g(s),M=g(o),b=g(a),v=g(n),w=g(r),E=g(u),N=g(h),x=g(p),I=g(y),P=g(f),L=g(l),C=g(d),R=new c.SphereGeometry(m/2,32,16);return R.scale(m/m,M/m,b/m),R.translate(v-N,w-x,E-I),R.rotateX(c.MathUtils.degToRad(P)),R.rotateY(c.MathUtils.degToRad(L)),R.rotateZ(c.MathUtils.degToRad(C)),R},yt=i=>{const[e,t,s,o,a,n,r,u,f,l,d,h,p,y,S]=i.split(","),m=g(s),M=g(o),b=g(n),v=g(r),w=g(u),E=g(h),N=g(p),x=g(y),I=g(f),P=g(l),L=g(d),C=new c.PlaneGeometry(m,M);return C.rotateX(c.MathUtils.degToRad(-90)),C.translate(b-E,v-N,w-x),C.rotateX(c.MathUtils.degToRad(I)),C.rotateY(c.MathUtils.degToRad(P)),C.rotateZ(c.MathUtils.degToRad(L)),C.computeBoundingBox(),C},bt=i=>{const[e,t,s,o,a,n,r,u,f,l,d,h,p,y,S]=i.split(","),m=g(s),M=g(o),b=g(a),v=g(n),w=g(r),E=g(u),N=g(h),x=g(p),I=g(y),P=g(f),L=g(l),C=g(d),R=m/2,B=new c.CylinderGeometry(R,R,M,32);B.translate(v-N,w-x,E-I),B.scale(1,1,b/m);const $=c.MathUtils.degToRad(P),G=c.MathUtils.degToRad(L),V=c.MathUtils.degToRad(C),z=new c.Euler($,G,V);return B.applyQuaternion(new c.Quaternion().setFromEuler(z)),B.computeBoundingBox(),B},Mt=i=>{const[e]=i.split(",");switch(e){case"c":return gt(i);case"s":return wt(i);case"p":return yt(i);case"cy":return bt(i);case"py":return pt(i);default:throw new Error(`Unknown shape: ${e}`)}},Z=(i,e)=>{const{palette:t={},glow:s=!1}=e,o=new c.Group;o.position.set(0,0,0),o.rotation.set(0,0,0),o.scale.set(1,1,1);const a={...$e,...t};return i.forEach(n=>{if(n===null){console.error("ITEM IS NULL");return}if(Array.isArray(n))o.add(Z(n,{palette:a,glow:s}));else{const[r,u,f,l,d,h,p,y,S,m,M,b,v,w,E]=n.split(","),N=Mt(n);let x=new c.MeshStandardMaterial({color:a[Ee[E]],side:c.DoubleSide});s&&(x.emissive=new c.Color(a[Ee[E]]),x.emissiveIntensity=1);const I=new c.Mesh(N,x);I.name=u,I.position.set(b,v,w),o.add(I)}}),o},vt=()=>[["c,desk,2,0.1,1,,0.85,-0.5,,,,,-0.1,,6","c,leg,0.1,0.8,0.1,-0.85,0.4,-0.85,,,,0.1,,-0.9,6","c,leg,0.1,0.8,0.1,-0.85,0.4,-0.15,,,,0.1,,-0.2,6","c,leg,0.1,0.8,0.1,0.85,0.4,-0.15,,,,1.8,,-0.2,6","c,leg,0.1,0.8,0.1,0.85,0.4,-0.85,,,,1.8,,-0.9,6","c,record-rack,0.4,0.1,0.8,0.7,0.95,-0.5,,,,0.7,0.95,-0.5,0","c,cube,0.3,0.1,0.4,-0.75,0.95,-0.3,,,,-0.75,0.95,-0.3,9","c,cube,0.4,0.1,0.4,-0.3,0.95,-0.3,,,,-0.3,0.95,-0.3,9","c,tableA,0.4,0.1,0.4,0.2,0.95,-0.3,,,,0.2,1.01,-0.3,0","cy,pad,0.4,0.02,0.4,0.2,1,-0.3,,,,0.2,1,-0.3,3"],"c,cube,22,1,4,,-1.5,-23,,,,,-2,-15,2","c,floor,20,1,20,,-2.5,-11,,,,,-3,-4,3","c,cube,20,1,6,,-2.5,2,,,,,-3,5,3","c,cube,8,2,3,,-1,0.5,,,,,-1,-4,2","c,pillar,1,4,1,6.5,,-6.5,,,,7,,-7,6","c,pillar,1,4,1,6.5,,-10.5,,,,7,,-11,6","c,pillar,1,3,1,6.5,0.5,-14.5,,,,7,,-15,6","c,pillar,1,4,1,6.5,,-18.5,,,,7,,-19,6","c,pillar,1,4,1,6.5,,-14.5,,,,7,,-15,6","c,pillar,1,4,1,-6.5,,-6.5,,,,-6,,-7,6","c,pillar,1,4,1,-6.5,,-2.5,,,,-6,,-3,6","c,pillar,1,4,1,6.5,,-2.5,,,,7,,-3,6","c,pillar,1,4,1,-6.5,,-10.5,,,,-6,,-11,6","c,pillar,1,4,1,-6.5,,-14.5,,,,-6,,-15,6","c,pillar,1,4,1,-6.5,,-18.5,,,,-6,,-19,6","c,cube,4,1,20,8,2.5,-11,,,,7,2,-3,1","c,cube,4,1,20,-8,2.5,-11,,,,-9,2,-3,1"],St=()=>["s,head,20,16,16,,8,,,,,,8,,4","s,head,16,16,16,,-5,,,,,,-5,,4",["cy,leftEye,4,1,4,-3,10,-7.1,-71,-5,16,-3,10,-7.1,1","s,leftPupil,2,2,4,-2.8,10.1,-7,-75,7,10,-2.8,10.1,-7,4","cy,rightEye,4,1,4,3,10,-7.2,-71,5,-17,3,10,-7.2,1","s,rightPupil,2,2,4,2.9,10,-7.1,-74,-4,-12,2.9,10,-7.1,4"],["c,rightCheek,4,4,2,1.84,6.03,-7.5,-25,,80,2.34,6.53,-7.5,9","c,leftCheek,4,4,2,-2.91,5.98,-7.5,,23,10,-2.41,6.48,-7.5,9","c,tongue,2,2,2,,5,-7,,,,,4,-7,3","py,pyramid,3,1.6,1,,8.2,-8,-180,,,,8.2,-8,8"],["py,ear,6,7,4,-4.86,13.55,-1.28,-14,20,31,-4.86,13.55,-1.28,4","py,ear,6,7,4,5.14,13.55,-1.28,-11,-15,-33,5.14,13.55,-1.28,4","py,ear,5.2,6.2,3.4,5.14,13.15,-1.78,-9,-16,-33,5.14,13.15,-1.78,1","py,ear,5,5.5,3.8,-5.04,13.54,-1.59,-17,19,32,-5.04,13.54,-1.59,1"],["cy,cylinder,0.2,11,0.2,-7.93,6,-10.12,,-15,90,-7.93,6,-10.12,9","cy,cylinder,0.2,9.2,0.2,-6.87,7.72,-9,,-15,75,-6.87,7.72,-9,9","cy,cylinder,0.2,9,0.2,-7.07,3.78,-9.3,,-15,105,-7.07,3.78,-9.3,9","cy,cylinder,0.2,7.8,0.2,6.87,7.62,-8.9,180,-15,-105,6.87,7.62,-8.9,9","cy,cylinder,0.2,9.4,0.2,6.93,6,-9.52,,-165,90,6.93,6,-9.52,9","cy,cylinder,0.2,8.8,0.2,6.87,3.88,-9.1,180,-15,-75,6.87,3.88,-9.1,9"]],xt=[{Purple:ie,Silver:He,Yellow:ne,Red:F},{Purple:ge,Silver:we,Yellow:Ye,Red:F},{Purple:We,Silver:ne,Yellow:be,Red:F}],Ct=i=>{const e=new c.Group;e.name="Crowd";const t=new c.Object3D,s=8,o=10,a=new c.BoxGeometry(.5,.5,.5),n=new c.MeshStandardMaterial,r=new c.InstancedMesh(a,n,s*o);r.instanceMatrix.setUsage(c.DynamicDrawUsage);const u=new c.BoxGeometry(.2,.2,.6),f=new c.MeshStandardMaterial,l=new c.InstancedMesh(u,f,s*o*2);l.instanceMatrix.setUsage(c.DynamicDrawUsage);const d=new c.Color,h=new c.Color;e.add(r),e.add(l);const p=new c.Vector3(0,-1,0),y=[],S=[];for(let m=0;m<s;m++)for(let M=0;M<o;M++){const b=M+m*s,v=ot(xt),w=new c.Vector3(2*M-o+.5+m%2*1,0,2*m-s+.5);Math.abs(w.x)>=5&&(w.y+=5);const E=new c.Vector3(c.MathUtils.randFloatSpread(.3),c.MathUtils.randFloatSpread(.1),c.MathUtils.randFloatSpread(.3));w.add(E),t.position.copy(w).add(p),t.lookAt(0,6,0),t.updateMatrix(),r.setMatrixAt(b,t.matrix),d.setStyle(v.Purple),r.setColorAt(b,d);for(let N=0;N<2;N++){const x=b*2+N;t.position.copy(w),t.updateMatrix(),l.setMatrixAt(x,t.matrix),h.setStyle(v.Purple),l.setColorAt(x,h)}y.push({positionOffset:w,poseDelay:c.MathUtils.randInt(0,15),palette:v})}return T.Instance.on("tick",()=>{if(!i.xr?.getCamera())return;const m=i.xr?.getCamera(),M={controllers:[]};if([0,1].forEach(b=>{const v=i.xr?.getController(b);if(v){const w=v.getObjectByName("paw");w&&M.controllers.push(w.matrixWorld.clone())}}),m&&(M.camera=m.matrix.clone(),S.push(M),S.length>60&&S.shift()),S.length==0){r.visible=!1,l.visible=!1;return}y.forEach((b,v)=>{const w=S[Math.max(0,S.length-1-b.poseDelay)];w?.camera&&(t.matrix.copy(w.camera),t.matrix.decompose(t.position,t.quaternion,t.scale),t.position.add(b.positionOffset).add(p),t.updateMatrix(),r.setMatrixAt(v,t.matrix),w.controllers.forEach((E,N)=>{const x=v*2+N;t.matrix.copy(E),t.matrix.decompose(t.position,t.quaternion,t.scale),t.position.add(b.positionOffset).add(p),t.position.add(new c.Vector3(N===0?-.1:.1,.2,-.3)),t.updateMatrix(),l.setMatrixAt(x,t.matrix)}))}),r.instanceMatrix.needsUpdate=!0,l.instanceMatrix.needsUpdate=!0}),e},Et=()=>[["c,case1,1,8,2,7.5,7,,,,,7.5,7,,5","c,case2,3,9,2,5.5,7.5,,,,,5.5,7.5,,5","c,case3,8,4,2,,10,,,,,,11.5,,5","c,case4,8,1,2,,5.5,,,,,,5.5,,5","c,case5,3,9,2,-5.5,7.5,,,,,-5.5,7.5,,5","c,case6,1,8,2,-7.5,7,,,,,-7.5,7,,5"],"c,base,12,2.1,2.8,,3.95,,,,,,3,,3","c,rightReel,2,2,1,2.72,6.89,,,,-45,2.72,6.89,,2","c,rightTape,4,4,0.2,2.81,6.91,-0.1,,,-45,2.81,6.91,-0.1,4","c,leftReel,2,2,1,-2.69,6.91,,,,-45,-2.75,7,,2","cy,base,16,8,16,,-4,,,,,,-4,,6","c,label,12,2,2.2,,10,,,,,,9,1,9"],Nt=()=>{const i=Z(Et(),{palette:{Blue:Le,Silver:be,Red:F,Orange:ne,Purple:Fe,Green:H},glow:!0});return O.Instance.animateTransform({mesh:i,end:{rotation:new c.Euler(0,2*Math.PI-.01,0)},duration:16e3,ease:e=>e,loop:!0}),i},It=()=>["cy,lid,3.9,0.1,3.9,-0.27,2.1,,,,30,-0.27,2.1,,9","cy,label,4,0.8,4,,0.5,,,,,,0.5,,5","cy,can,3.9,1,3.9,,0.5,,,,,,0.5,,9","cy,tuna,3.8,0.6,3.8,,0.8,,,,,,0.8,,8"],Tt=()=>{const i=Z(It(),{palette:{Blue:Be,Red:F,Silver:ye}});return i.scale.set(.03125,.03125,.03125),i.userData.isPickable=!0,i.onPointerPick=e=>{Ge()},i};class Rt{clock;parent;_mesh;geometry;constructor(){this.clock=new c.Clock,this.parent=new c.Group,this.parent.name="Grid",this.geometry=new c.PlaneGeometry(20,26,20,26),this.geometry.rotateX(Math.PI/2),this._mesh=new c.Mesh(this.geometry,new c.MeshBasicMaterial({color:"#ff00ff",wireframe:!0})),this.parent.add(this._mesh),T.Instance.on("tick",e=>{const t=this.geometry.getAttribute("position");for(let s=0;s<t.array.length;s+=3){const o=t.array[s],a=t.array[s+2];t.array[s+1]=.5*Math.sin(Math.sqrt(o*o+a*a)-2*this.clock.getElapsedTime())}t.needsUpdate=!0}),T.Instance.on("progress",e=>{!this._mesh.material.visible&&e.bestComboCount>5&&(this._mesh.position.set(0,-5,0),O.Instance.animateTransform({mesh:this._mesh,end:{position:new c.Vector3(0,0,0)},ease:at,duration:2e3})),this._mesh.material.visible=e.bestComboCount>5})}get mesh(){return this.parent}}const Pt=()=>{const i=new c.Group;i.name="debugScreen",i.renderOrder=1;const e=["You win!","Thanks for playing","Created by Alex Swan"],t=new c.PlaneGeometry(5,5);t.translate(0,-2,0);const s=De(e,{color:"white"}),o=new c.Mesh(t,s);return i.add(o),o.position.set(0,0,-20),o.scale.set(.1,.1,.1),o.rotation.set(-Math.PI/2,0,0),o.visible=!1,T.Instance.on("progress",a=>{a.color.solved&&a.artist.solved&&a.title.solved&&(console.log("time to show"),o.userData.solved=!0,o.visible=!0,o.material.needsUpdate=!0,O.Instance.animateTransform({mesh:o,end:{position:{x:0,y:0,z:0},scaling:{x:1,y:1,z:1},rotation:new c.Euler(0,0,0)},duration:1e3}))}),i},Ot=()=>["c,base,13,1,3,-1.5,0.5,-0.5,,,,,,,5",["c,panel,12.4,2.7,1,-1.5,2.45,0.3,-60,,,-1.5,1.1,0.88,6","c,display-back,11.8,0.8,0.1,-1.5,3.2,0.85,-60,,,-1.5,1.1,0.88,3","c,progress-color-0,1.8,0.3,0.1,-6.5,2.45,0.85,-60,,,-11.5,1.1,0.88,9","c,progress-color-1,1.8,0.3,0.1,-4.5,2.45,0.85,-60,,,0.5,1.1,0.88,9","c,progress-color-2,1.8,0.3,0.1,-2.5,2.45,0.85,-60,,,0.5,1.1,0.88,9","c,progress-color-3,1.8,0.3,0.1,-0.5,2.45,0.85,-60,,,0.5,1.1,0.88,9","c,progress-color-4,1.8,0.3,0.1,1.5,2.45,0.85,-60,,,0.5,1.1,0.88,9","c,progress-color-5,1.8,0.3,0.1,3.5,2.45,0.85,-60,,,0.5,1.1,0.88,9","c,progress-artist-1,1.8,0.3,0.1,-4.5,1.95,0.85,-60,,,0.5,1.1,0.88,9","c,progress-artist-2,1.8,0.3,0.1,-2.5,1.95,0.85,-60,,,0.5,1.1,0.88,9","c,progress-artist-3,1.8,0.3,0.1,-0.5,1.95,0.85,-60,,,0.5,1.1,0.88,9","c,progress-artist-4,1.8,0.3,0.1,1.5,1.95,0.85,-60,,,0.5,1.1,0.88,9","c,progress-artist-5,1.8,0.3,0.1,3.5,1.95,0.85,-60,,,0.5,1.1,0.88,9","c,progress-artist-0,1.8,0.3,0.1,-6.5,1.95,0.85,-60,,,-11.5,1.1,0.88,9","c,progress-title-1,1.8,0.3,0.1,-4.5,1.45,0.85,-60,,,0.5,1.1,0.88,9","c,progress-title-2,1.8,0.3,0.1,-2.5,1.45,0.85,-60,,,0.5,1.1,0.88,9","c,progress-title-3,1.8,0.3,0.1,-0.5,1.45,0.85,-60,,,0.5,1.1,0.88,9","c,progress-title-4,1.8,0.3,0.1,1.5,1.45,0.85,-60,,,0.5,1.1,0.88,9","c,progress-title-5,1.8,0.3,0.1,3.5,1.45,0.85,-60,,,0.5,1.1,0.88,9","c,progress-title-0,1.8,0.3,0.1,-6.5,1.45,0.85,-60,,,-11.5,1.1,0.88,9","p,display,11.8,0.8,,-1.5,2.22,-0.88,30,,,-1.5,2.22,-0.88,8"]],Lt=()=>{const i=Z(Ot(),{palette:{Red:_,Green:ne,Blue:H,Silver:_}});return i.scale.set(.1,.1,.1),T.Instance.on("progress",e=>{const t=i.getObjectByName("display");t.material=De([e.displayText],{color:Se[e.bestComboType],textAlign:"left",ratio:11.8/.8,fontSize:Qe[e.bestComboType]}),et.forEach(s=>{for(let o=0;o<6;o++){const a=i.getObjectByName(`progress-${s}-${o}`);if(!a)continue;let n=ie;(e[s].solved||o<e[s].correctCount)&&(n=Se[s]),(e[s].solved||o<e[s].correctCount)&&s==="color"&&(n=K[o]);const r=n!==ie;a.material.color.set(n),a.material.emissive.set(r?n:_),a.material.emissiveIntensity=r?1:0,a.material.needsUpdate=!0}})}),i},Bt=i=>{const e=new c.Group;e.name="Runner";let t=[pe,ge,we,ce,H,Oe],s=[(n,r)=>n===0||r===0,(n,r)=>n===1||r===1,(n,r)=>n===2||r===2,(n,r)=>n===3||r===3,(n,r)=>n===4||r===4,(n,r)=>n===5||r===5,(n,r)=>r+n===0||2*i-n-r-2===0,(n,r)=>r+n===1||2*i-n-r-2===1,(n,r)=>r+n===2||2*i-n-r-2===2,(n,r)=>r+n===3||2*i-n-r-2===3,(n,r)=>r+n===4||2*i-n-r-2===4,(n,r)=>r+n===5||2*i-n-r-2===5,(n,r)=>(n+r)%2===0,(n,r)=>(n+r)%2===1,(n,r)=>(n+r)%2===0,(n,r)=>(n+r)%2===1,(n,r)=>(n+r)%2===0,(n,r)=>(n+r)%2===1];for(;t.length<i;)t.push(...t);t=t.slice(0,i);let o=-2;const a=new c.BoxGeometry;a.translate(.5,.5,.5),a.scale(.9,1.1,.9);for(let n=0;n<i;n++)for(let r=0;r<i;r++){const u=new c.MeshStandardMaterial({color:_}),f=new c.Mesh(a,u);f.name=`runner-${r}-${n}`,f.userData.x=r,f.userData.y=n,f.position.set(-i/2+r,0,-i/2+n),e.attach(f)}return T.Instance.on("beat",()=>{if(o+=1,o<0)return;const n=t[o%t.length];e.children.forEach(r=>{const{x:u,y:f}=r.userData,l=s[o%s.length](u,f),d=l?n:_;r.material.needsUpdate=!0,r.material.color.set(d),r.material.emissive.set(l?d:_),r.material.needsUpdate=!0,r.material.emissiveIntensity=l?1:0,l&&O.Instance.animateTransform({mesh:r,end:{scaling:new c.Vector3(1,l?1.1:1,1)},duration:500,ease:it})}),T.Instance.emit("roomGlow",n)}),e},At=i=>{const e=Z(vt(),{palette:{Green:Ze,Yellow:ne,Orange:Xe,Red:qe,"Light Blue":H}}),t=Lt();e.add(t),t.position.set(-.1,.9,-.7);const s=Tt();e.add(s),s.position.set(-.4,1,-.3);const o=Ct(i);o.name="Crowd",e.add(o),o.position.set(0,-1,-10),o.rotation.set(0,Math.PI,0);const a=Z(St(),{palette:{Purple:"#333333",Silver:"#888888"}});a.name="catMesh",a.position.set(-3,1,0),a.scale.set(.1,.1,.1),a.rotation.set(0,-Math.PI/4,0),e.attach(a);const n=a.clone(!0);n.name="catMesh2",n.position.set(3,1,0),n.rotation.set(0,Math.PI/4,0),e.attach(n);const r=Nt();e.add(r),r.position.set(0,0,-30);const u=new Rt;e.add(u.mesh),u.mesh.position.set(0,-1,-7);const f=Pt();e.add(f),f.position.set(0,2,-1);const l=Bt(6);return e.add(l),l.position.set(0,-3,-10),l.scale.set(2,1,2),e},Dt=()=>["cy,cylinder,4,6,2,,-1,,,,,,-1,,4","s,sphere,4,4,2,,2,,,,,,2,,4","c,cube,0.3,1,0.3,-1.15,3.5,-0.55,-77,,,-1.15,3.5,-0.55,9","c,cube,0.3,1,0.3,-0.45,3.9,-0.55,-77,,,-0.45,3.9,-0.55,9","c,cube,0.3,1,0.3,0.45,3.9,-0.55,-77,,,0.45,3.9,-0.55,9","c,cube,0.3,1,0.3,1.05,3.6,-0.55,-77,,,1.05,3.6,-0.55,9","c,cube,2,0.7,0.4,,1.85,-0.9,,,,,1.5,-0.1,3","c,cube,0.8,0.5,1.1,,2.45,-0.55,,,,,2.2,-0.1,3","c,cube,0.3,0.6,0.6,-1.15,2.7,-0.8,,,,-1.15,2.7,-0.1,3","c,cube,0.3,0.6,0.6,-0.45,3.1,-0.8,,,,-0.45,3.1,-0.1,3","c,cube,0.3,0.6,0.6,0.45,3.1,-0.8,,,,0.45,3.1,-0.1,3","c,cube,0.3,0.6,0.6,1.05,2.7,-0.8,,,,1.05,2.7,-0.1,3"],kt={Purple:ie,Red:F,Silver:ye},Gt=(i={})=>{const e=new c.Group;e.name="paw";const t=Z(Dt(),{palette:{...kt,...i}});t.scale.set(.03125,.03125,.03125),t.rotation.set(3*Math.PI/2,0,0),e.attach(t);const s=new c.PointLight(F,.5,4);return e.attach(s),e},zt=()=>["c,cube,6,6,8,,,,,,,,-3,,2","c,cube,4,4,11.1,,,-0.55,,,,,-3,,2","c,cube,2,2,2,-2,,-5,,,,-2,-1,-5,4","c,cube,2,2,2,2,,-5,,,,2,-1,-5,4","c,cube,2,6,2,,,6,,,,,-3,7,2","c,cube,1,4,6,,-3,9.5,15,,,,-3,8.5,9","c,cube,1,5,7,,2.5,9.9,-15,,,,2,8.4,2","c,cube,2,5,6,,2.2,,-30,,,,2.7,,2","c,cube,1,2,2,-2.5,-4,-2,,,-40,-3,-3,-2,9","c,cube,3,1,4,-4.5,-3.5,4,,,20,-3,-3,3,9","c,cube,1,2,2,2.5,-4,-2,,,40,3,-3,-2,9","c,cube,3,1,4,4.5,-3.5,4,,,-25,3,-3,3,9"],Ne=[{Orange:Le,Purple:_,Silver:be},{Orange:je,Purple:_,Silver:Be}],Ut=new c.Vector3(.05,.05,.05),_t=()=>{new c.Vector3(1,0,0);const i=new c.Group;i.name="FishSwirl";const e=[];let t=!0;const s=new c.Group,o=Ne[c.MathUtils.randInt(0,Ne.length-1)];console.log(o);const a=Z(zt(),{palette:o,glow:!0});for(let n=0;n<10;n++){const r=a.clone(!0);r.position.set(Math.random()*10-5,0,0),e.push(r),s.attach(r),r.userData.velocity=new c.Vector3(0,5+3*Math.random(),-5),r.scale.set(0,0,0)}return s.rotation.set(0,0,0),i.attach(s),T.Instance.on("tick",n=>{e.forEach(r=>{if(r.userData.velocity.y-=10*n,r.position.addScaledVector(r.userData.velocity,n),r.position.y<-2){const f=new c.Vector3(Math.random()*4-2,0,Math.random()*4-2).sub(r.position).normalize(),l=new c.Quaternion;l.setFromUnitVectors(new c.Vector3(0,0,-1),f),r.quaternion.copy(l),r.position.y=-2;const d=new c.Vector3(0,0,-1);d.applyQuaternion(r.quaternion),d.multiplyScalar(5),r.userData.velocity.x=d.x,r.userData.velocity.z=d.z,r.userData.velocity.y=7+6*Math.random()}const u=new c.Quaternion;u.setFromUnitVectors(new c.Vector3(0,0,-1),r.userData.velocity),r.quaternion.copy(u)})}),T.Instance.on("progress",n=>{const r=n.bestComboCount>=4,u=r!==t;e.forEach(f=>{u&&(O.Instance.cancelAnimation(f),O.Instance.animateTransform({mesh:f,end:{scaling:r?Ut:new c.Vector3(0,0,0)},duration:r?2e3:1e3}))}),t=r}),i},Vt=()=>{const i=new c.Group;i.name="Sky";const e=new c.Object3D,t=30,s=.05,o=new c.BoxGeometry,a=new c.MeshStandardMaterial;a.emissive=new c.Color(255),a.emissiveIntensity=1;const n=[];let r=0,u=0;const f=new c.InstancedMesh(o,a,t*t);f.instanceMatrix.setUsage(c.DynamicDrawUsage);const l=new c.Color,d=[new c.Color(65535),new c.Color(16776960),new c.Color(16711935)];let h=0;for(let p=0;p<t;p++)for(let y=0;y<t;y++){const S=xe(0,2*y*Math.PI/t,15);S.z=-p*4,e.position.copy(S),e.scale.set(1,1,2),e.updateMatrix(),l.setHSL(1,.5+Math.random()*.5,.5+Math.random()*.5),n.push(l.getHex()),f.setMatrixAt(h,e.matrix),f.setColorAt(h,l.multiply(d[0])),h++}return i.add(f),T.Instance.on("tick",p=>{r+=p;for(let y=0;y<f.count;y++){f.getMatrixAt(y,e.matrix),e.matrix.decompose(e.position,e.quaternion,e.scale);const S=Math.floor(y/t),m=S%2?1:-1,M=y%t,b=-S*4,v=2*M*Math.PI/t,w=s*m*r;e.position.copy(xe(0,v+w,15)),e.position.z=b+u*m*Math.sin(r),e.updateMatrix(),f.setMatrixAt(y,e.matrix)}f.instanceMatrix.needsUpdate=!0}),T.Instance.on("progress",p=>{u=p.bestComboCount>=2?1:0}),i},Yt=new c.Clock;let oe=0,q,A,fe,D,Y,W,X;const me=[];let Ie;const he=new c.Vector3(0,0,.3),Te=new c.Color,Wt=async()=>{document.getElementById("p").setAttribute("disabled","true"),document.getElementById("p").innerHTML="LOADING...",D=new c.WebGLRenderer({antialias:!0}),D.setPixelRatio(window.devicePixelRatio),D.setSize(window.innerWidth,window.innerHeight),D.setClearColor("#000000"),D.xr.addEventListener("sessionstart",Xt),D.xr.enabled=!0,D.setAnimationLoop(Zt),document.body.appendChild(J.createButton(D)),document.body.appendChild(D.domElement);const i=new tt;A=new c.Scene,q=new c.PerspectiveCamera(75,window.innerWidth/window.innerHeight,.1,1e3),q.position.set(0,2,1),q.rotation.set(-1*Math.PI/12,0,0),q.name="camera",A.add(q),O.Instance.initScene(A);const e=new c.Color().setStyle("#888888"),t=new c.AmbientLight(e,.2);t.name="ambientLight",A.add(t);const s=new c.Color().setStyle("#ffffff"),o=new c.DirectionalLight(s,.3);o.name="directionalLight",o.position.set(6,10,8),o.castShadow=!0,o.target.position.set(0,0,0),A.add(o),A.add(o.target);const a=Vt();a.position.set(0,0,5),A.add(a);const n=At(D);A.add(n);const r=n.getObjectByName("tableA"),u=_t();u.position.set(0,0,-10),A.attach(u),i.vinyls.forEach((f,l)=>{const d=st(f);d.name=`vinyl-${l}`;const h=new c.Vector3(.7,1.15,-.2-.125*l);d.position.copy(h),d.userData.originalPosition=h,d.userData.isPickable=!0,d.userData.recordIndex=l,d.userData.returnToOriginalPosition=()=>{A.attach(d),O.Instance.cancelAnimation(d),O.Instance.animateTransform({mesh:d,end:{position:d.userData.originalPosition,rotation:new c.Euler(0,0,0)},duration:100})},d.onPointerPick=p=>{if(p.userData.selected||i.isSolved())return;i.selected[p.id]=l;const y=p.getObjectByName("target");y&&(O.Instance.cancelAnimation(d),y.attach(d),O.Instance.animateTransform({mesh:d,end:{position:new c.Vector3(0,0,0),rotation:new c.Euler(0,Math.PI/2,0)},duration:60}),p.userData.selected=d)},d.onPointerDrop=p=>{if(O.Instance.cancelAnimation(d,!0),d.getWorldPosition(new c.Vector3).distanceTo(r.getWorldPosition(new c.Vector3))<.3){i.addVinylByIndex(d.userData.recordIndex),delete i.selected[p.id],p.userData.selected=void 0,r.children.forEach(S=>{S.userData.returnToOriginalPosition&&S.userData.returnToOriginalPosition()}),r.attach(d),ft(),O.Instance.animateTransform({mesh:d,end:{position:new c.Vector3(0,.01,0),rotation:new c.Euler(-1*Math.PI/2,0,0)},duration:60}).then(()=>{O.Instance.animateTransform({mesh:d,end:{rotation:new c.Euler(-1*Math.PI/2,0,-2*Math.PI)},ease:S=>S,duration:1800,loop:!0})});return}else d.userData.returnToOriginalPosition(),p.userData.selected=void 0},A.add(d)}),W=D.xr.getController(0),W.addEventListener("connected",Re),W.addEventListener("selectstart",re),W.addEventListener("selectend",ae),W.addEventListener("squeezestart",re),W.addEventListener("squeezeend",ae),A.add(W),X=D.xr.getController(1),X.addEventListener("connected",Re),X.addEventListener("selectstart",re),X.addEventListener("selectend",ae),X.addEventListener("squeezestart",re),X.addEventListener("squeezeend",ae),A.add(X),fe=new c.Raycaster,window.addEventListener("resize",jt,!1),T.Instance.on("comboBroken",()=>{Ge()}),T.Instance.on("roomGlow",f=>{const l=A.getObjectByName("ambientLight");Te.setStyle(f),l.color.set(Te.add(e).multiplyScalar(.5))}),mt(),T.Instance.on("downbeat",()=>{oe>100&&(T.Instance.emit("beat"),oe=0)}),i.reset(),document.getElementById("intro").style.display="none",document.getElementById("c").style.display="block"};function Xt(){Ie=D.xr.getReferenceSpace();const i={x:-1*he.x,y:-1*he.y,z:-1*he.z,w:1},e=new c.Quaternion,t=new XRRigidTransform(i,e),s=Ie.getOffsetReferenceSpace(t);D.xr.setReferenceSpace(s)}function Re(i){console.log("controller connected",i);const e=i.target,t=i.data.handedness==="left"?-1:1;if(!e.getObjectByName("target")){const n=new c.Group;n.name="target",n.rotation.set(0,0,0),n.position.set(-1*t*.035,.05,-.12),e.add(n)}let o=e.getObjectByName("paw");o||(o=Gt(),o.position.set(0,0,.15),e.add(o));let a=e.getObjectByName("line");if(!a){const n=new c.BufferGeometry().setFromPoints([new c.Vector3(0,0,0),new c.Vector3(0,0,-1)]);a=new c.Line(n),a.material.color.set(16711680),a.name="line",a.scale.z=5,e.add(a)}}function re(i){Y=i.target;const e=ze(Y);if(e.length>0){let t=!1;e.forEach(({object:s,distance:o})=>{if(t)return;let a=s;for(;a;){if(a.onPointerPick){a.onPointerPick(Y),t=!0;const n=Y.getObjectByName("line");n.visible=!1;break}a=a.parent}})}Y.userData.targetRayMode=i.data.targetRayMode}function ae(i){Y=i.target;const e=Y.userData.selected;e?.onPointerDrop&&e.onPointerDrop(Y);const t=Y.getObjectByName("line");t.visible=!0}function ze(i){return i.updateMatrixWorld(),fe.setFromXRController(i),fe.intersectObjects(A.children,!0)}function Pe(i){if(i.userData.targetRayMode==="screen"||i.userData.selected!==void 0)return;const e=i.getObjectByName("line"),t=ze(i);if(e&&(e.scale.z=5),t.length>0){let s=!1;t.forEach(({object:o,distance:a})=>{if(s)return;let n=o;for(;n;){if(n.userData.isPickable){const r=n.getObjectByName("highlight");r&&(r.visible=!0),e&&(e.scale.z=a),me.push(n),s=!0;break}n=n.parent}})}}function qt(){for(;me.length;){const e=me.pop().getObjectByName("highlight");e&&(e.visible=!1)}}function Zt(){const i=Yt.getDelta();oe+=i,oe>=.5&&(T.Instance.emit("beat"),oe-=.5),O.Instance.update(),T.Instance.emit("tick",i),qt(),Pe(W),Pe(X),D.render(A,q)}const jt=()=>{q.aspect=window.innerWidth/window.innerHeight,q.updateProjectionMatrix(),D.setSize(window.innerWidth,window.innerHeight)};window.addEventListener("DOMContentLoaded",()=>{const i=document.getElementById("p");i.onclick=Wt});
